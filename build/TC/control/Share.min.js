TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control"),TC.control.Share=function(t){var e=this;e._classSelector="."+e.CLASS,TC.Control.apply(e,arguments);var a=t||{};e._$dialogDiv=$(TC.Util.getDiv(a.dialogDiv)),a.dialogDiv||e._$dialogDiv.appendTo("body"),e.render()},TC.inherit(TC.control.Share,TC.Control),function(){var t=TC.control.Share.prototype;t.CLASS="tc-ctl-share",t.QR_MAX_LENGTH=150,t.IFRAME_WIDTH="600px",t.IFRAME_HEIGHT="450px",t.MOBILEFAV="Siga las instrucciones del navegador del dispositivo m칩vil para a침adir como favorito. Se guardar치 el estado actual del mapa.",t.NAVALERT=" +D para guardar en marcadores.",t.render=function(t){var e=this;e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._$dialogDiv.html(t)}).then(function(){TC.Control.prototype.render.call(e,function(){if(TC.Util.detectChrome()||TC.Util.detectIE()>=10||TC.Util.detectFirefox()>=41){e._$div.find("button").removeClass("hide");var a=e._$div.find("input[type=text]");a.removeAttr("data-original-title")}TC.Util.detectMobile()||e._$div.find(".share-whatsapp").addClass(TC.Consts.classes.HIDDEN);var i=e._$div.find("."+e.CLASS+"-url-box");e._$div.find("span").on(TC.Consts.event.CLICK,function(t){var e=$(this).closest("label").find("input[type=radio][name=format]"),a=e.val();i.removeClass(TC.Consts.classes.HIDDEN),i.not(".tc-"+a).addClass(TC.Consts.classes.HIDDEN)}),$.isFunction(t)&&t()})})},t.getLocation=function(){var t=window.location.href;return window.location.hash&&(t=t.substr(0,t.indexOf(window.location.hash))),t},t.generateLink=function(){var t=this,e=window.location.href,a=e.indexOf("#");if(a>0&&(e=e.substring(0,a)),t.extraParams){var i=TC.Util.getQueryStringParams(e);$.extend(i,t.extraParams);var n=e.indexOf("?");n>=0&&(e=e.substring(0,n)),e=e.concat("?",$.param(i))}TC.Util.getParameterByName("lang").length>0&&(e=e.indexOf("&")>-1?e.replace("lang="+TC.Util.getParameterByName("lang")+"&",""):e.replace("?lang="+TC.Util.getParameterByName("lang"),""));var o=t.map.getMapState(),r=e.concat("#",o);return r.length>TC.Consts.URL_MAX_LENGTH?void t.disableButtons():(t.enableButtons(r),r)},t.generateIframe=function(t){var e=this,a=t||this.generateLink();return a?'<iframe style="width:'+e.IFRAME_WIDTH+";height:"+e.IFRAME_HEIGHT+';" src="'+a+'"></iframe>':void 0},t.register=function(e){var a=this;TC.Control.prototype.register.call(a,e),a.MOBILEFAV=a.getLocaleString("mobileBookmarks.instructions"),a.NAVALERT=a.getLocaleString("bookmarks.instructions");var i=function(t){var e=$(t).parent().find("input[type=text]");e.val(e.hasClass("tc-url")?a.generateLink():a.generateIframe()),e.select()},n=function(){document.getSelection().removeAllRanges(),document.getSelection().addRange(document.createRange())};a._$div.on("click","h2",function(t){a._$div.find(".tc-url input[type=text]").val(a.generateLink()),a._$div.find(".tc-iframe input[type=text]").val(a.generateIframe())}),a._$div.on("click",".tc-ctl-share-url-box button",function(t){i(t.target),document.execCommand("copy");var e=$(this);e.text(a.getLocaleString("copied")),setTimeout(function(){e.text(a.getLocaleString("copy")),n()},1e3)}),a._$div.on("click","input[type=text]",function(t){i(t.target)}),a._$div.on("click",".ga-share-icon.disabled",function(t){return t.stopImmediatePropagation(),t.preventDefault(),!1}),a._$div.on("click","a.share-email",function(t){t.preventDefault();var e=a.generateLink();e&&(window.location.href="mailto:?body="+encodeURIComponent(e+"\n"))}),a._$div.on("click","a.qr-generator",function(t){t.preventDefault();var e=a.generateLink();e&&TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){e.length>a.QR_MAX_LENGTH&&(e=TC.Util.shortenUrl(e)),TC.Util.showModal(a._$dialogDiv.find(a._classSelector+"-qr-dialog"));var t=a._$dialogDiv.find(".qrcode");t.empty(),new QRCode(t[0],e)})}),a._$div.on("click","a.share-fb",function(t){t.preventDefault();var e=a.generateLink();return e?(window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(e)),!1):void 0}),a._$div.on("click","a.share-twitter",function(t){t.preventDefault();var e=a.generateLink();if(e){var i=TC.Util.shortenUrl(e);if(void 0!==i){var n=encodeURIComponent(window.document.title?window.document.title:"Visor API SITNA");return window.open("https://twitter.com/intent/tweet?text="+n+"&amp;url="+encodeURIComponent(i)),!1}TC.error("La URL "+e+" no ha podido ser acortada por ser no v치lida")}}),TC.Util.detectMobile()&&a._$div.on("click","a.share-whatsapp",function(t){t.preventDefault();var e=a.generateLink();if(e){var i=TC.Util.shortenUrl(e),n="whatsapp://send?text=";return location.href=void 0!==i?n+encodeURIComponent(i):n+encodeURIComponent(e),!1}}),a._$div.on("click","a.share-star",function(e){e.preventDefault();var i=a.generateLink(),n=document.title;return TC.Util.detectMobile()?alert(t.MOBILEFAV):window.sidebar&&window.sidebar.addPanel?window.sidebar.addPanel(n,i,""):window.sidebar&&/Firefox/i.test(navigator.userAgent)||window.opera&&window.print?(window.location.href=i,alert((/Mac/i.test(navigator.userAgent)?"Cmd":"Ctrl")+t.NAVALERT)):window.external&&"AddFavorite"in window.external?window.external.AddFavorite(i,n):(window.location.href=i,alert((/Mac/i.test(navigator.userAgent)?"Cmd":"Ctrl")+t.NAVALERT)),!1})},t.enableButtons=function(t){var e=this;TC.Control.prototype.enable.call(e);var a=e._$div.find("."+e.CLASS+"-alert"),i=e._$div.find(".tc-button"),n=e._$div.find(".ga-share-icon"),o=e._$div.find(".tc-textbox");a.toggleClass(TC.Consts.classes.HIDDEN,!0),i.toggleClass("disabled",!1),i.removeAttr("disabled"),$.each(n,function(t,e){$(e).toggleClass("disabled",!1)}),o.filter(".tc-url").val(t),o.filter(".tc-iframe").val(e.generateIframe(t))},t.disableButtons=function(){var t=this;TC.Control.prototype.disable.call(t);var e=t._$div.find("."+t.CLASS+"-alert"),a=t._$div.find(".tc-button"),i=t._$div.find(".ga-share-icon"),n=t._$div.find(".tc-textbox");e.toggleClass(TC.Consts.classes.HIDDEN,!1),a.toggleClass("disabled",!0),a.attr("disabled","disabled"),$.each(i,function(t,e){$(e).toggleClass("disabled",!0)}),n.val()},t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/Share.html",t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/ShareDialog.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"share"}).w('</h2><div><div class="ga-share-icons"><a class="ga-share-icon share-email" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"sendMapByEmail"}).w('"href="#"><i class="icon-envelope-alt"></i></a><a class="ga-share-icon qr-generator" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"createQrCode"}).w('"href="#"><i class="icon-qrcode"></i></a><a class="ga-share-icon share-fb" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"shareMapToFacebook"}).w('"href="#"><i class="icon-facebook"></i></a><a class="ga-share-icon share-twitter" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"shareMapToTwitter"}).w('"href="#"><i class="icon-twitter"></i></a><a class="ga-share-icon share-whatsapp" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"shareMapToWhatsapp"}).w('"href="#"><i class="icon-whatsapp"></i></a><a class="ga-share-icon share-star" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"addToBookmarks"}).w('"href="#"><i class="icon-star"></i></a></div><div class="tc-ctl-share-select"><form><label class="tc-ctl-share-btn-url"><input type="radio" checked="checked" name="format" value="url" /><span>').h("i18n",e,{},{$key:"shareLink"}).w('</span></label><label class="tc-ctl-share-btn-iframe"><input type="radio" name="format" value="iframe" /><span>').h("i18n",e,{},{$key:"embedMap"}).w('</span></label></form></div><div class="tc-ctl-share-url-box tc-group tc-url"><input type="text" class="tc-textbox tc-url" readonly data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"shareLink.tip.1"}).w('" /><button class="tc-button hide" title="').h("i18n",e,{},{$key:"shareLink.tip.2"}).w('">').h("i18n",e,{},{$key:"copy"}).w('</button></div><div class="tc-ctl-share-url-box tc-group tc-iframe tc-hidden"><input type="text" class="tc-textbox tc-iframe" readonly data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"embedMap.tip.1"}).w('" /><button class="tc-button hide" title="').h("i18n",e,{},{$key:"embedMap.tip.2"}).w('">').h("i18n",e,{},{$key:"copy"}).w('</button></div><div class="tc-ctl-share-alert tc-alert alert-warning tc-hidden"><p>').h("i18n",e,{},{$key:"tooManyLayersLoaded|s"}).w("</p> </div></div>")}return dust.register(t.CLASS,e),e.__dustBody=!0,e},t.template[t.CLASS+"-dialog"]=function(){function e(t,e){return t.w('<div class="tc-ctl-share-qr-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"qrCode"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="qrcode"></div></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}return dust.register(t.CLASS+"-dialog",e),e.__dustBody=!0,e})}();