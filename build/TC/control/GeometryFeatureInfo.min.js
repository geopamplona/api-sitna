TC.control=TC.control||{},TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons"),function(){TC.control.GeometryFeatureInfo=function(){var e=this;TC.control.FeatureInfoCommons.apply(this,arguments),e.wrap=new TC.wrap.control.GeometryFeatureInfo(e),e.lineColor=e.options.lineColor?e.options.lineColor:"#c00",e.callback=function(t,o){if(!e._drawToken){e.closeResults();for(var r=!1,n=0;n<e.map.workLayers.length;n++){var a=e.map.workLayers[n];if(a.type===TC.Consts.layerType.WMS&&a.getVisibility()&&a.names.length>0){r=!0;break}}r&&(e.closeResults(),e.wrap.beginDraw({geometryType:e.geometryType,xy:t,layer:e.filterLayer,callback:function(t){e.wrap.getFeaturesByGeometry(t)}}))}},e._isDrawing=!1,e._isSearching=!1,e._drawToken=!1},TC.inherit(TC.control.GeometryFeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.GeometryFeatureInfo.prototype;e.register=function(e){var t=this;TC.control.FeatureInfoCommons.prototype.register.call(t,e),e.on(TC.Consts.event.FEATUREINFOERROR,function(o){o.xhr&&404===o.xhr.status&&e.toast(o.control.getLocaleString("featureInfo.tooManyLayers"),{type:TC.Consts.msgType.ERROR}),t.lastFeatureCount=0,t.closeResults()}),t.$events.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){t.wrap.cancelDraw()})},e.responseCallback=function(e){var t=this;if(t.filterFeature){var o=e.services;t.info={services:o};for(var r=0;r<o.length;r++){var n=o[r];if(n.hasLimits)delete n.layers,n.hasLimits=n.hasLimits;else{for(var a=0;a<n.layers.length;a++)n.layers[a].features.length||(n.layers.splice(a,1),a-=1);n.layers.length||(o.splice(r,1),r-=1)}}o.length?t.renderData(e,function(){t._$div.find("td."+t.CLASS+"-val").each(function(e,t){var o=$(t),r=o.text();TC.Util.isURL(r)&&o.html('<a href="'+r+'" target="_blank">'+r+"</a>")}),t.displayResults()}):t.resultsLayer.clearFeatures()}}}();