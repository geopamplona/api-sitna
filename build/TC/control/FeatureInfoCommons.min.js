TC.control=TC.control||{},TC.control.Click||TC.syncLoadJS(TC.apiLocation+"TC/control/Click"),TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc",TC.Consts.event.RESULTSPANELCLOSE=TC.Consts.event.RESULTSPANELCLOSE||"resultspanelclose.tc",TC.control.FeatureInfoCommons=function(){var t=this;TC.control.Click.apply(t,arguments),t.resultsLayer=null,t.filterLayer=null,t._layersDeferred=$.Deferred(),t.filterFeature=null,t.info=null,t.popup=null,t.resultsPanel=null,t.lastFeatureCount=null,t._$dialogDiv=$(TC.Util.getDiv(t.options.dialogDiv)),t.options.dialogDiv||t._$dialogDiv.appendTo("body")},TC.control.FeatureInfoCommons.displayMode={POPUP:"popup",RESULTS_PANEL:"resultsPanel"},function(){var t="ul.tc-ctl-finfo-features li",e=function(t){t.getDisplayTarget().find("ul."+t.CLASS+"-services li").removeClass(TC.Consts.classes.CHECKED).removeClass(TC.Consts.classes.DISABLED).removeClass(TC.Consts.classes.FROMLEFT).removeClass(TC.Consts.classes.FROMRIGHT)},o=function(o,n){if(!o._zooming){var s,a,l,r;this instanceof TC.Feature?(s=this,o.getDisplayTarget().find(t).each(function(t,e){var n=$(e),i=n.parents("li").first(),c=i.parents("li").first(),u=o.getFeature(o.info,c.index(),i.index(),n.index());u===s&&(a=n,l=i,r=c)})):a=$(this),l=l||a.parents("li").first(),r=r||l.parents("li").first(),e(o),a.addClass(TC.Consts.classes.CHECKED),l.addClass(TC.Consts.classes.CHECKED),r.addClass(TC.Consts.classes.CHECKED),n>0?(a.addClass(TC.Consts.classes.FROMLEFT),l.addClass(TC.Consts.classes.FROMLEFT),r.addClass(TC.Consts.classes.FROMLEFT)):0>n&&(a.addClass(TC.Consts.classes.FROMRIGHT),l.addClass(TC.Consts.classes.FROMRIGHT),r.addClass(TC.Consts.classes.FROMRIGHT)),s=s||o.getFeature(o.info,r.index(),l.index(),a.index());var i=o.resultsLayer.features.slice(),c=i.filter(function(t){return s&&s.id===t.id});if(c.length>0)return;for(var u=0;u<i.length;u++){var d=i[u];d!==o.filterFeature&&o.resultsLayer.removeFeature(d)}s&&s.geometry?o.resultsLayer.addFeature(s):a.addClass(TC.Consts.classes.DISABLED)}},n=function(t,e){var o=t.getDisplayTarget().find("ul."+t.CLASS+"-features > li"),n=o.length,s=o.filter("."+TC.Consts.classes.CHECKED),a=o.index(s.get(0));return o.get((a+e+n)%n)};TC.inherit(TC.control.FeatureInfoCommons,TC.control.Click);var s=TC.control.FeatureInfoCommons.prototype;s.CLASS="tc-ctl-finfo",s.template={},TC.isDebug?(s.template[s.CLASS]=TC.apiLocation+"TC/templates/FeatureInfo.html",s.template[s.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/FeatureInfoDialog.html",s.template[s.CLASS+"-del-btn"]=TC.apiLocation+"TC/templates/FeatureInfoDeleteButton.html"):(s.template[s.CLASS]=function(){function t(t,n){return t.w('<ul class="tc-ctl-finfo-services">').s(n.get(["services"],!1),n,{"else":e,block:o},{}).w("</ul>").x(n.get(["featureCount"],!1),n,{block:F},{})}function e(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noData"}).w("</li>")}function o(t,e){return t.w("<li><h3>").x(e.getPath(!1,["mapLayer","title"]),e,{"else":n,block:a},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(e.get(["hasLimits"],!1),e,{"else":l,block:S},{}).w("</div></li>")}function n(t,e){return t.f(e.getPath(!1,["mapLayer","id"]),e,"h")}function a(t,e){return t.f(e.getPath(!1,["mapLayer","title"]),e,"h")}function l(t,e){return t.w('<ul class="tc-ctl-finfo-layers">').s(e.get(["layers"],!1),e,{"else":r,block:i},{}).w("</ul>")}function r(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataAtThisService"}).w("</li>")}function i(t,e){return t.w("<li><h4>").s(e.get(["path"],!1),e,{block:c},{}).w(' <span class="tc-ctl-finfo-layer-n">').f(e.getPath(!1,["features","length"]),e,"h").w('</span> </h4> <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(e.get(["features"],!1),e,{"else":d,block:f},{}).w("</ul></div></li>")}function c(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:u},{})}function u(t,e){return t.w(" &bull; ")}function d(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataInThisLayer"}).w("</li>")}function f(t,e){return t.w("<li>").x(e.get(["rawContent"],!1),e,{"else":C,block:m},{}).w("</li>")}function C(t,e){return t.x(e.get(["error"],!1),e,{"else":p,block:T},{})}function p(t,e){return t.w("<h5>").f(e.get(["id"],!1),e,"h").w("</h5><table").x(e.get(["geometry"],!1),e,{block:y},{}).w("><tbody>").s(e.get(["attributes"],!1),e,{block:v},{}).w("</tbody></table>").x(e.get(["geometry"],!1),e,{block:h},{})}function y(t,e){return t.w(' title="').h("i18n",e,{},{$key:"clickToCenter"}).w('"')}function v(t,e){return t.w('<tr><th class="tc-ctl-finfo-attr">').f(e.get(["name"],!1),e,"h").w('</th><td class="tc-ctl-finfo-val">').f(e.get(["value"],!1),e,"h").w("</td></tr>")}function h(t,e){return t.w('<div class="tc-ctl-finfo-tools"><button class="tc-ctl-finfo-tools-btn" title="').h("i18n",e,{},{$key:"tools"}).w('">').h("i18n",e,{},{$key:"tools"}).w("</button></div>")}function T(t,e){return t.w('<span class="tc-ctl-finfo-errors">').h("i18n",e,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(e.get(["error"],!1),e,"h").w("</span></span>")}function m(t,e){return t.w("<h5>").h("i18n",e,{},{$key:"feature"}).w("</h5>").h("eq",e,{"else":g,block:L},{key:e.get(["rawFormat"],!1),value:"text/html"})}function g(t,e){return t.w("<pre>").f(e.get(["rawContent"],!1),e,"h").w("</pre>")}function L(t,e){return t.w(" ").x(e.get(["expandUrl"],!1),e,{block:w},{})}function w(t,e){return t.h("ne",e,{"else":b,block:_},{key:e.get(["expandUrl"],!1),value:""})}function b(t,e){return t.w('<iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('" />')}function _(t,e){return t.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('" /><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(e.get(["expandUrl"],!1),e,"h").w("', '_blank')\" title=\"").h("i18n",e,{},{$key:"expand"}).w('"></a></div>')}function S(t,e){return t.w('<span class="tc-ctl-finfo-errors">').f(e.get(["hasLimits"],!1),e,"h").w("</span>")}function F(t,e){return t.h("gt",e,{block:k},{key:e.get(["featureCount"],!1),value:"1",type:"number"})}function k(t,e){return t.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",e,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-idx"></span>/').f(e.get(["featureCount"],!1),e,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",e,{},{$key:"next"}).w("</a>")}return dust.register(s.CLASS,t),t.__dustBody=!0,e.__dustBody=!0,o.__dustBody=!0,n.__dustBody=!0,a.__dustBody=!0,l.__dustBody=!0,r.__dustBody=!0,i.__dustBody=!0,c.__dustBody=!0,u.__dustBody=!0,d.__dustBody=!0,f.__dustBody=!0,C.__dustBody=!0,p.__dustBody=!0,y.__dustBody=!0,v.__dustBody=!0,h.__dustBody=!0,T.__dustBody=!0,m.__dustBody=!0,g.__dustBody=!0,L.__dustBody=!0,w.__dustBody=!0,b.__dustBody=!0,_.__dustBody=!0,S.__dustBody=!0,F.__dustBody=!0,k.__dustBody=!0,t},s.template[s.CLASS+"-dialog"]=function(){function t(t,e){return t.w('<div class="tc-ctl-finfo-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"feature"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-finfo-dialog-dl"><h2>').h("i18n",e,{},{$key:"download"}).w('</h2><div><button class="tc-button tc-ctl-finfo-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-ctl-finfo-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-ctl-finfo-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-ctl-finfo-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button></div></div><div class="tc-ctl-finfo-dialog-share"></div></div></div></div>')}return dust.register(s.CLASS+"-dialog",t),t.__dustBody=!0,t},s.template[s.CLASS+"-del-btn"]=function(){function t(t,e){return t.w('<button class="tc-ctl-finfo-del-btn" title="').h("i18n",e,{},{$key:"deleteFeature"}).w('">').h("i18n",e,{},{$key:"deleteFeature"}).w("</button>")}return dust.register(s.CLASS+"-del-btn",t),t.__dustBody=!0,t}),s.register=function(t){var e=this;TC.control.Click.prototype.register.call(e,t);var o;o=e.options.resultsLayer?e.options.resultsLayer:{id:TC.getUID(),title:e.CLASS+": Results layer",type:TC.Consts.layerType.VECTOR,stealth:!0};var n;n=e.options.filterLayer?e.options.filterLayer:{id:TC.getUID(),title:e.CLASS+": Filter layer",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{line:{strokeColor:e.lineColor,strokeWidth:2},polygon:{strokeColor:e.lineColor,strokeWidth:2,fillColor:"#000",fillOpacity:.3}}},t.loaded(function(){$.when(t.addLayer(o),t.addLayer(n)).then(function(t,o){e.resultsLayer=t,e.filterLayer=o,e._layersDeferred.resolve()})}),e.displayMode=e.options.displayMode||TC.control.FeatureInfoCommons.displayMode.POPUP,e.setDisplayMode(e.displayMode),t.on(TC.Consts.event.BEFOREFEATUREINFO,function(t){e.querying=!0,e.beforeGetFeatureInfo(t)}).on(TC.Consts.event.FEATUREINFO,function(t){e.querying=!1,e.isActive&&(e.lastFeatureCount=e.countFeatures(t),e.responseCallback(t))}).on(TC.Consts.event.NOFEATUREINFO,function(t){e.querying=!1,e.lastFeatureCount=0,e.closeResults()}).on(TC.Consts.event.POPUPHIDE+" "+TC.Consts.event.RESULTSPANELCLOSE,function(t){t.control===e.getDisplayControl()&&e.resultsLayer&&(e.resultsLayer.clearFeatures(),clearTimeout(e._removeFilterFeatureTimeout),e._removeFilterFeatureTimeout=setTimeout(function(){e.querying||e.filterLayer.clearFeatures()},50))})},s.render=function(t){var e=this;e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._$dialogDiv.html(t).on(TC.Consts.event.CLICK,"button[data-format]",function(t){TC.Util.closeModal();var o=e.resultsLayer.features[e.resultsLayer.features.length-1];e.map.exportFeatures([o],{fileName:o.id,format:$(t.target).data("format")})})})},s.markerStyle={cssClass:TC.Consts.classes.POINT,anchor:[.5,.5],width:15,height:15,noPrint:!0},s.setDisplayMode=function(t){var e=this;e.displayMode=t;var o=e.map;switch(t){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:if(!e.resultsPanel){var n=o.getControlsByClass("TC.control.ResultsPanel")[0];if(n)e.resultsPanel=n;else{var s=function a(t){TC.control.ResultsPanel&&t.control instanceof TC.control.ResultsPanel&&(e.resultsPanel=t.control,o.off(TC.Consts.event.CONTROLADD,a))};o.on(TC.Consts.event.CONTROLADD,s)}}break;default:e.displayMode=TC.control.FeatureInfoCommons.displayMode.POPUP,e.popup||$.when(o.addControl("popup",{closeButton:!0,draggable:e.options.draggable})).then(function(t){e.popup=t,t.caller=e,o.on(TC.Consts.event.POPUP,function(t){e.onShowPopUp(t)}),o.on(TC.Consts.event.POPUPHIDE,function(o){o.control===t&&e.popup.$popupDiv.css("width","auto")})})}},s.getDisplayControl=function(){var t=this;switch(t.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return t.resultsPanel;default:return t.popup}},s.getDisplayTarget=function(){var t=this;switch(t.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return t.resultsPanel.$divTable;default:return t.popup.$popupDiv}},s.displayResults=function(){var t=this;switch(t.filterFeature.data=$("<div>").append(t._$div.clone()).html(),t.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:t.getDisplayTarget().html(t.filterFeature.data),t.resultsPanel.open(),t.displayResultsCallback();break;default:t.popup&&t.filterFeature.showPopup(t.popup)}},s.closeResults=function(){var t=this;switch(t.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:t.resultsPanel&&t.resultsPanel.close();break;default:t.popup&&t.popup.isVisible()&&t.popup.hide()}},s.displayResultsCallback=function(){var s=this,a=s.getDisplayTarget(),l="ficHandlers",r=a.data(l);if(!r){var i,c="click";a.on(c,t,function(t){o.call(this,s.map.activeControl)}),c="mouseenter";a.on(c,t,function(t){var e=this;$(e).parents("."+s.CLASS+"-layers > li").hasClass(TC.Consts.classes.CHECKED)&&o.call(e,s.map.activeControl)}),c=TC.Consts.event.CLICK,i="."+s.CLASS+"-btn-next",a.on(c,i,function(t){return o.call(n(s.map.activeControl,1),s.map.activeControl,1),!1}),i="."+s.CLASS+"-btn-prev",a.on(c,i,function(t){return o.call(n(s.map.activeControl,-1),s.map.activeControl,-1),!1}),i="ul."+s.CLASS+"-layers h4",a.on(c,i,function(n){var l=$(n.target).parent();l.hasClass(TC.Consts.classes.CHECKED)?"none"===a.find(".tc-ctl-finfo-btn-next").css("display")&&e(s.map.activeControl):(o.call(l.find(t).first()[0],s.map.activeControl),s.displayMode===TC.control.FeatureInfoCommons.displayMode.POPUP&&s.popup.fitToView(!0))}),i="."+s.CLASS+"-tools-btn",a.on(c,i,function(t){var e=new $.Deferred;s.map.activeControl._shareCtl?e.resolve():s.map.addControl("share",{div:s.map.activeControl._$dialogDiv.find(".tc-modal-body .tc-ctl-finfo-dialog-share")}).then(function(t){s.map.activeControl._shareCtl=t,e.resolve()}),$.when(e).then(function(){TC.Util.showModal(s.map.activeControl._$dialogDiv.find("."+s.map.activeControl.CLASS+"-dialog"),{openCallback:function(){s.map.activeControl.onShowModal()}})})}),a.data(l,!0)}s.info&&(s.info.defaultFeature?o.call(s.info.defaultFeature,s):o.call(a.find(t).first()[0],s)),a.find("table").on("click",function(t){if(!$(this).parent().hasClass(TC.Consts.classes.DISABLED)){if(s.resultsLayer.features[0]){var e=function o(){s._zooming=!1,s.map.off(TC.Consts.event.ZOOM,o)};s.map.on(TC.Consts.event.ZOOM,e),s._zooming=!0,s.map.zoomToFeatures([s.resultsLayer.features[0]],{animate:!0})}t.stopPropagation()}}),a.find("table a").on("click",function(t){t.stopPropagation()})},s.onShowPopUp=function(t){{var e=this;e.map}t.control===e.popup&&(e.displayResultsCallback(),e.fitSize())},s.onShowModal=function(){},s.highlightFeature=function(t){o.call(t,this)},s.fitSize=function(){var t=this,e=t.getDisplayTarget(),o=0;e.find(".tc-ctl-finfo-features li").each(function(t,e){o=Math.max(o,$(e).position().left+$(e).width())}),o&&e.width(o+50)},s.countFeatures=function(t){for(var e=0,o=0;o<t.services.length;o++)t.services[o].layers.forEach(function(t){e+=t.features.length});return e},s.getFeature=function(t,e,o,n){var s;return t&&(s=t.services[e],s&&(s=s.layers[o],s&&(s=s.features[n]))),s},s.getFeatureIdx=function(t,e,o,n){var s=-1;if(t)for(var a=0;e>a;a++)for(var l=t.services[a],r=a===e-1?o:l.layers.length,i=0;r>i;i++)for(var c=l.layers[i],u=i===o-1?n:c.features.length,d=0;u>d;d++)s+=1;return s},s.beforeGetFeatureInfo=function(t){var e=this;e.closeResults(),t.control===e&&e.map&&e.resultsLayer&&(e.lastFeatureCount=null,e.resultsLayer.clearFeatures(),e.info=null)},s.activate=function(){var t=this;t.wrap&&t.wrap.activate(),TC.Control.prototype.activate.call(t)},s.deactivate=function(t){var e=this;e.popup&&e.popup.hide(),e.resultsLayer.clearFeatures(),e.filterLayer.clearFeatures(),e.wrap&&e.wrap.deactivate(),TC.Control.prototype.deactivate.call(e,t)}}();