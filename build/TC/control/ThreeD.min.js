TC.control=TC.control||{},TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/Control"),function(){Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),i=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var r=[],a=arguments.length>=2?arguments[1]:void 0,o=0;i>o;o++)if(o in t){var n=t[o];e.call(a,n,o,t)&&r.push(n)}return r})}(),function(){for(var e=0,t=["ms","moz","webkit","o"],i=!(!window.performance||!window.performance.now),r=0,a=t.length;a>r&&!window.requestAnimationFrame;r+=1)window.requestAnimationFrame=window[t[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[r]+"CancelAnimationFrame"]||window[t[r]+"CancelRequestAnimationFrame"];if(window.requestAnimationFrame||(window.requestAnimationFrame=function(t,i){var r=(new Date).getTime(),a=Math.max(0,16-(r-e)),o=window.setTimeout(function(){t(r+a)},a);return e=r+a,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),!i){var o=window.requestAnimationFrame,n=+new Date;window.requestAnimationFrame=function(e,t){var i=function(t){var i=1e12>t?t:t-n;return e(i)};o(i,t)}}}(),function(){TC.Consts.classes.THREED=TC.Consts.classes.THREED||"tc-threed",TC.Consts.event.TERRAINLOADED=TC.Consts.event.TERRAINLOADED||"terrainloaded.tc.threed",TC.Consts.event.TERRAINRECEIVING=TC.Consts.event.TERRAINRECEIVING||"terrainreceiving.tc.threed",TC.control.ThreeD=function(){var e=this;TC.Control.apply(e,arguments),e.$events=$(e),e.selectors={divThreedMap:e.options.divMap},e.Consts={BLANK_BASE:"blank",DEFAULT_TILE_SIZE:256,TERRAIN_URL:"https://pmpwvinet18.tcsa.local/customcesiumterrain/epsg3857/geodetic/_5m/5m",events:{GFI:"gfi.tc.threed"}},e.options.terrainURL&&(e.Consts.TERRAIN_URL=e.options.terrainURL),e.options.isDebug&&(TC.Consts.url.CESIUM=TC.apiLocation+"lib/cesium/debug/Cesium.js")},TC.inherit(TC.control.ThreeD,TC.Control);var e=TC.control.ThreeD.prototype;e.CLASS="tc-ctl-threed",e.classes={MAPTHREED:"tc-map-threed",LOADING:"tc-loading",BTNACTIVE:"active",CAMERACTRARROWDISABLED:"disabled-arrow",BETA:"tc-beta-button",FOCUS:"focus",HIGHLIGHTED:"highlighted",DISABLED:"disabled",OUTFOCUS:"outfocus",GFIRESULTSTR:"-gfiTR",GFIRESULTSTH:"-gfiTH",GFIRESULTSTD:"-gfiTD"},e.direction={TO_TWO_D:"two_d",TO_THREE_D:"three_d"},e.threeDControls=["search","attribution","basemapSelector","listTOC","selectContainer","externalWMS","fileImport","layerCatalog","click","fullScreen","loadingIndicator","navBar","overviewMap","legend","fullScreen","threeD"],e.template={},TC.isDebug?(e.template[e.CLASS]=TC.apiLocation+"TC/templates/ThreeD.html",e.template[e.CLASS+"-overlay"]=TC.apiLocation+"TC/templates/ThreeDOverlay.html",e.template[e.CLASS+"-cm-ctls"]=TC.apiLocation+"TC/templates/ThreeDCameraControls.html"):(e.template[e.CLASS+"-cm-ctls"]=function(){function t(e,t){return e.w('<div><svg xmlns:dc="http://purl.org/dc/elements/1.1/"xmlns:cc="http://creativecommons.org/ns#"xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"xmlns:svg="http://www.w3.org/2000/svg"xmlns="http://www.w3.org/2000/svg"xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"width="220"height="135"viewBox="0 0 63.40233 35.531682"version="1.1"id="threedControls"><g inkscape:groupmode="layer"id="backgroundLayer"inkscape:label="backgroundLayer"transform="translate(-2.3693123,-42.387899)"><path style="fill:#ffffff;fill-opacity:0.23999999;stroke:none;stroke-width:0.2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:0.3169643;paint-order:stroke fill markers"d="M 48.005285,42.387899 A 17.766048,17.766048 0 0 0 34.067635,49.16888 17.754217,17.754217 0 0 0 20.123267,42.399784 17.754217,17.754217 0 0 0 2.3693123,60.153739 a 17.754217,17.754217 0 0 0 17.7539547,17.75447 17.754217,17.754217 0 0 0 13.923699,-6.76961 17.766048,17.766048 0 0 0 13.958319,6.78098 17.766048,17.766048 0 0 0 17.766357,-17.76584 17.766048,17.766048 0 0 0 -17.766357,-17.76584 z"id="background"inkscape:connector-curvature="0" /></g><g inkscape:label="tiltLayer"inkscape:groupmode="layer"id="tiltLayer"transform="translate(-26.69084,-42.254264)"style="display:inline"><g class="tc-ctl-threed-cm-tilt-indicator"><path class="tc-ctl-threed-cm-tilt-inner"id="tiltInner"d="m 44.44423,52.861576 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.reset"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-inner-image"d="m 40.116095,64.124648 c -0.12075,-0.119221 -0.171366,-0.928328 -0.171366,-2.739326 0,-2.143319 0.03709,-2.606753 0.223349,-2.79065 0.19727,-0.194769 0.269957,-0.196719 0.622509,-0.01671 0.219537,0.112088 0.761654,0.542242 1.204705,0.955894 l 0.805547,0.752098 v 0.939855 c 0,0.51692 -0.06955,1.085596 -0.154558,1.263727 -0.173436,0.363428 -1.919571,1.804317 -2.186551,1.804317 -0.09475,0 -0.249383,-0.07614 -0.343635,-0.169192 z m 3.287741,-0.05029 c -0.307698,-0.212789 -0.317387,-0.295835 -0.317387,-2.721198 0,-1.757783 0.05096,-2.552024 0.171366,-2.670904 0.120776,-0.119243 0.941399,-0.169194 2.779684,-0.169194 2.432612,0 2.618273,0.01838 2.756146,0.27272 0.08484,0.156511 0.147831,1.267987 0.147831,2.608402 0,3.088986 0.189068,2.899662 -2.895738,2.899662 -1.872744,0 -2.3862,-0.04266 -2.641902,-0.219488 z m 0.586357,-6.180807 c -0.314529,-0.267117 -0.397432,-0.458143 -0.397432,-0.915756 0,-0.785501 0.427643,-1.207722 1.223233,-1.207722 1.162181,0 1.675866,1.23538 0.851939,2.048861 -0.522115,0.515494 -1.126934,0.542392 -1.67774,0.07462 z m 2.780604,-0.09201 c -0.374474,-0.369724 -0.423284,-0.501051 -0.3506,-0.943285 0.118405,-0.72038 0.53618,-1.088187 1.236028,-1.088187 0.699848,0 1.117624,0.367807 1.236028,1.088187 0.07269,0.442234 0.02388,0.573561 -0.3506,0.943285 -0.300932,0.297119 -0.573881,0.429526 -0.885428,0.429526 -0.311544,0 -0.584496,-0.132407 -0.885428,-0.429526 z"id="tiltImage"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.reset"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-outer tc-ctl-threed-cm-tilt-outer-circle"id="tiltOuter"d="m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.tilt.drag"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-outer tc-ctl-threed-cm-tilt-outer-shell-circle"sodipodi:nodetypes="ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc"inkscape:connector-curvature="0"id="tiltShell"d="m 44.44423,48.705554 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 C 37.721509,56.11715 36.90502,57.97796 36.90502,60.0297 c 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 h 3.029207 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z"><title>').h("i18n",t,{},{$key:"threed.tilt.drag"}).w('</title></path></g></g><g id="rotateLayer"inkscape:groupmode="layer"inkscape:label="rotateLayer"style="display:inline"transform="translate(-2.3693123,-42.387899)"><path class="tc-ctl-threed-cm-rotate-right"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="right"d="m 53.241331,72.907368 0.900176,1.930847 c 3.602027,-1.827343 6.291427,-4.493353 8.092762,-8.066897 l 0.969844,0.452626 -0.663464,-4.788009 -3.222445,2.974451 0.983506,0.459005 c -1.447339,3.107391 -3.949649,5.598011 -7.060379,7.037977 z"><title>').h("i18n",t,{},{$key:"threed.rotate.right"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-left"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="left"d="m 42.795431,72.906221 -0.900176,1.930846 c -3.602027,-1.827342 -6.291427,-4.493352 -8.092762,-8.066896 l -0.969844,0.452626 0.663465,-4.788009 3.222444,2.974451 -0.983506,0.459005 c 1.44734,3.107391 3.949649,5.598011 7.060379,7.037977 z"><title>').h("i18n",t,{},{$key:"threed.rotate.left"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-up"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="up"d="M 7.737296,54.610066 5.80645,53.70989 c 1.827342,-3.602027 4.493352,-6.291427 8.066896,-8.092762 l -0.452626,-0.969844 4.788009,0.663465 -2.974451,3.222444 -0.459005,-0.983506 c -3.107391,1.44734 -5.598011,3.949649 -7.037977,7.060379 z"><title>').h("i18n",t,{},{$key:"threed.tilt.left"}).w('</title></path><path class="tc-ctl-threed-cm-tilt-down"sodipodi:nodetypes="cccccccc"inkscape:connector-curvature="0"id="down"d="m 7.684579,65.708846 -1.930847,0.900176 c 1.827343,3.602027 4.493353,6.291427 8.066897,8.092762 l -0.452626,0.969844 4.788009,-0.663464 -2.974451,-3.222445 -0.459005,0.983506 C 11.615165,71.321886 9.124545,68.819576 7.684579,65.708846 Z"><title>').h("i18n",t,{},{$key:"threed.tilt.right"}).w('</title></path><g class="tc-ctl-threed-cm-rotate-indicator"><path class="tc-ctl-threed-cm-rotate-inner"inkscape:connector-curvature="0"d="m 48.010487,52.995444 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"id="rotateInner"><title>').h("i18n",t,{},{$key:"threed.rotate.reset"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-inner-image"d="m 45.461645,60.604061 c 0.860585,-1.857231 1.777009,-3.864779 2.036499,-4.461218 0.471802,-1.084433 0.471802,-1.084433 0.66474,-0.667935 2.070474,4.46957 3.86201,8.443545 3.825603,8.485934 -0.02561,0.02982 -0.943964,-0.165127 -2.040793,-0.433206 -1.994234,-0.487419 -1.994234,-0.487419 -3.881098,-0.01711 -1.037775,0.258673 -1.950491,0.470314 -2.028258,0.470314 -0.07777,0 0.562721,-1.519553 1.423307,-3.376784 z m 1.23418,2.027617 c 1.353421,-0.310159 1.353421,-0.310159 1.353421,-2.998288 0,-1.534227 -0.05572,-2.627602 -0.129797,-2.547123 -0.101525,0.110295 -2.316061,4.831583 -2.659547,5.670031 -0.09645,0.23543 -0.15884,0.240844 1.435923,-0.12462 z"id="rotateImage"inkscape:connector-curvature="0"><title>').h("i18n",t,{},{$key:"threed.rotate.reset"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-outer tc-ctl-threed-cm-rotate-outer-circle"inkscape:connector-curvature="0"d="m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,4.156022 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z"id="rotateOuter"><title>').h("i18n",t,{},{$key:"threed.rotate.drag"}).w('</title></path><path class="tc-ctl-threed-cm-rotate-outer tc-ctl-threed-cm-rotate-outer-shell-circle"d="m 48.010487,48.839422 c -6.246102,0 -11.312196,5.070128 -11.312196,11.324146 0,6.254017 5.066094,11.330914 11.312196,11.330914 6.246102,0 11.312196,-5.076897 11.312196,-11.330914 0,-6.254018 -5.066094,-11.324146 -11.312196,-11.324146 z m 0,0.379051 c 2.995132,0 5.705501,1.203885 7.681205,3.154245 l -2.386853,2.382605 0.135232,0.135376 2.386853,-2.382606 c 1.930016,1.972963 3.12387,4.674054 3.12387,7.655475 0,2.981421 -1.193854,5.680844 -3.12387,7.655474 l -2.386853,-2.382605 -0.135232,0.135375 2.386853,2.382606 c -1.975664,1.951759 -4.686314,3.161013 -7.681205,3.161013 -1.94179,0 -3.766282,-0.506879 -5.347316,-1.395323 -0.850442,-0.477894 -1.630441,-1.06619 -2.320365,-1.745384 l 2.407138,-2.402912 c 1.358381,1.325983 3.214811,2.145699 5.260543,2.145699 4.163407,0 7.545972,-3.385283 7.545972,-7.553943 0,-4.168661 -3.382565,-7.547175 -7.545972,-7.547175 -2.045732,0 -3.902162,0.81461 -5.260543,2.13893 l -2.407138,-2.402912 c 1.972594,-1.940536 4.681097,-3.133938 7.667681,-3.133938 z m -0.189325,0.182756 v 3.01887 h 0.378651 v -3.01887 z m -7.606826,3.086558 2.400376,2.402912 c -1.326946,1.360319 -2.143435,3.221129 -2.143435,5.272869 0,2.05174 0.816489,3.910884 2.143435,5.272869 l -2.400376,2.402912 c -0.435151,-0.44326 -0.832923,-0.923297 -1.188195,-1.435068 -0.462681,-0.666492 -0.853281,-1.386809 -1.160484,-2.149815 -0.508689,-1.263436 -0.788715,-2.64392 -0.788715,-4.090898 0,-2.99182 1.197141,-5.70104 3.137394,-7.675781 z m 7.796151,0.507657 c 3.959106,0 7.167321,3.203889 7.167321,7.168124 0,3.964234 -3.208215,7.174892 -7.167321,7.174892 -3.959106,0 -7.160559,-3.210658 -7.160559,-7.174892 0,-3.964235 3.201453,-7.168124 7.160559,-7.168124 z m -10.744219,6.978598 v 0.379051 h 3.022445 v -0.379051 z m 18.513325,0 v 0.379051 H 58.8088 v -0.379051 z m -7.931385,7.932994 v 3.01887 h 0.37189 v -3.01887 z"id="rotateShell"inkscape:connector-curvature="0"sodipodi:nodetypes="ssssssccccsccccssccsssccscccccccsccssscsssssccccccccccccccc"><title>').h("i18n",t,{},{$key:"threed.rotate.drag"}).w("</title></path></g></g></svg></div>")}return dust.register(e.CLASS+"-cm-ctls",t),t.__dustBody=!0,t},e.template[e.CLASS+"-overlay"]=function(){function t(e,t){return e.w('<div class="tc-ctl-threed-overlay" hidden><svg class="tc-ctl-threed-overlay-svg"><defs><filter id="fGaussian" x="0" y="0"><feGaussianBlur in="SourceGraphic" stdDeviation="3" /></filter></defs><rect width="100%" height="100%" fill="white" fill-opacity="0.5" filter="url(#fGaussian)" /> </svg> </div>')}return dust.register(e.CLASS+"-overlay",t),t.__dustBody=!0,t},e.template[e.CLASS]=function(){function t(e,t){return e.w('<button class="tc-ctl-threed-btn tc-beta-button" title="').h("i18n",t,{},{$key:"threed.tip"}).w('"></button>')}return dust.register(e.CLASS,t),t.__dustBody=!0,t}),e.viewer,e.mapView,e.terrainProvider,e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t.mapView=new MapView(e,t)},e.renderData=function(e,t){var i=this;TC.Control.prototype.renderData.call(i,e,function(){i.getRenderedHtml(i.CLASS+"-overlay",{},function(e){i.overlay=$(e)}),i.$button=i._$div.find("."+i.CLASS+"-btn"),i.$button.on(TC.Consts.event.CLICK,function(){i.$button.attr("disabled","disabled"),i.waiting||(i.waiting=i.map.getLoadingIndicator().addWait());for(var e=[],t=0,r=i.threeDControls.length;r>t;t++){var a=i.threeDControls[t];a=a.substr(0,1).toUpperCase()+a.substr(1),e=e.concat(i.map.getControlsByClass("TC.control."+a))}i.ctrlsToMng=e,i.mapIs3D?(i.deactivate(),i.cameraControls.resetRotation({duration:1e3}).then(function(){var e=function(){i.mapIs3D=!1,i.map._$div.removeClass(TC.Consts.classes.THREED),i.$button.attr("title",i.getLocaleString("threed.tip")),i.map3D.destroy.call(i),i.map3D.setViewFromCameraView.call(i).then(function(){i.$divThreedMap.removeClass(i.classes.MAPTHREED),i.$divThreedMap.removeClass("tc-ctl-threed-divMap-fadeIn").addClass("tc-ctl-threed-divMap-fadeOut"),$(i.mapView.viewHTML).removeClass("tc-ctl-threed-divMap-fadeOut").addClass("tc-ctl-threed-divMap-fadeIn"),i.viewer.destroy(),i.viewer=null,i.$button.removeAttr("disabled"),i.$button.toggleClass(i.classes.BTNACTIVE),i.map.getLoadingIndicator().removeWait(i.waiting),delete i.waiting}),i.mapView.setRotation(0),i._ovMap.wrap.draw3DCamera(null)},t=p(i.viewer.scene),r=Cesium.Matrix4.fromTranslation(t),a=v(i.viewer.scene,t);i.map3D.rotateAroundAxis(i.viewer.scene.camera,-a,i.viewer.scene.camera.right,r,{duration:1500,callback:e})})):(i.activate(),(i.browserSupportWebGL.call(i)||!i.browserSupportWebGL.call(i))&&(i.mapIs3D=!0,i.overlay.removeAttr("hidden"),i.overlay.appendTo(i.map._$div.parent()),i.map._$div.addClass(TC.Consts.classes.THREED),i.$divThreedMap=$("#"+i.selectors.divThreedMap),i.$divThreedMap.addClass(i.classes.MAPTHREED),i.$divThreedMap.addClass(i.classes.LOADING),i.$button.attr("title",i.getLocaleString("threed.two.tip")),i.$button.removeClass(i.classes.BETA),i.map3D.loadViewer.call(i).then(function(){if(i.$divThreedMap.removeClass("tc-ctl-threed-divMap-fadeOut").addClass("tc-ctl-threed-divMap-fadeIn"),$(i.mapView.viewHTML).removeClass("tc-ctl-threed-divMap-fadeIn").addClass("tc-ctl-threed-divMap-fadeOut"),i.$divThreedMap.removeClass(i.classes.LOADING),i.$button.toggleClass(i.classes.BTNACTIVE),i.options.allowedGFI){i.map3D.linked2DControls.featureInfo=new TwoDLinkedFeatureInfo(i);var e=new Cesium.ScreenSpaceEventHandler(i.viewer.canvas,!1);e.setInputAction(function(e){var t=i.viewer.camera.getPickRay(e.position),r=i.viewer.scene.globe.pick(t,i.viewer.scene);r&&i.map3D.getInfoOnPickedPosition.call(i,r)},Cesium.ScreenSpaceEventType.LEFT_CLICK)}i.map3D.setCameraFromMapView.call(i),i.map3D.setBaseLayer.call(i,i.map.baseLayer),i.map.workLayers.filter(function(e){return e instanceof TC.layer.Raster}).reverse().forEach(function(e){i.map3D.addLayer.call(i,e)}),$.when(i.viewer.readyPromise).then(function(){i.cameraControls?i.cameraControls.render.call(i.cameraControls):i.cameraControls=new CameraControls(i);var e=Cesium.Math.toRadians(50),t=p(i.viewer.scene);t=Cesium.Matrix4.fromTranslation(t);var r=function(){Cesium.Camera.DEFAULT_VIEW_RECTANGLE=i.map3D.initialRectangle=i.viewer.camera.computeViewRectangle(),Cesium.Camera.DEFAULT_VIEW_FACTOR=0,i.$button.removeAttr("disabled"),i.overlay.attr("hidden","hidden"),i.map.getLoadingIndicator().removeWait(i.waiting),delete i.waiting,i.$events.on(TC.Consts.event.TERRAINLOADED,function(){if(i.viewer.billboardCollection){for(var e=0;e<i.viewer.billboardCollection.length;e++){var t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(i.viewer.billboardCollection.get(e).position),r=i.viewer.scene.globe.getHeight(t),a={longitude:t.longitude,latitude:t.latitude,height:t.height+r};i.viewer.billboardCollection.get(e).position=Cesium.Ellipsoid.WGS84.cartographicToCartesian(a)}i.map3D.customRender.restart()}})};i.map3D.rotateAroundAxis(i.viewer.scene.camera,-e,i.viewer.scene.camera.right,t,{duration:2e3,callback:r})}.bind(i))})))})}),$.isFunction(t)&&t()},e.activate=function(){var e=this;TC.Control.prototype.activate.call(e)},e.deactivate=function(){var e=this;TC.Control.prototype.deactivate.call(e)},MapView=function(e,t){var i=this;i.map=e,i.parent=t,$.when(i.map.getViewHTML()).then(function(e){i.viewHTML=e}.bind(i)),i.proj4Obj=proj4(i.map.crs),i.proj4Obj.oProj.METERS_PER_UNIT=1,i.maxResolution,i._oldMapSetCenter=e.setCenter,e.setCenter=function(r,a){t.mapIs3D?t.map3D.flyToMapCoordinates.call(t,r):i._oldMapSetCenter.call(e,r,a)}},MapView.prototype.getCenter=function(){return this.map.getCenter()},MapView.prototype.getExtent=function(){return this.map.getExtent()},MapView.prototype.getResolution=function(){return this.map.getResolution()},MapView.prototype.getRotation=function(){return this.map.getRotation()},MapView.prototype.getMaxResolution=function(){if(this.maxResolution)return this.maxResolution;if(null!==this.map.getResolutions())this.maxResolution=this.map.getResolutions()[0];else{var e=this.map.options.baselayerExtent;this.maxResolution=(e[2]-e[0])/this.parent.Consts.DEFAULT_TILE_SIZE}return this.maxResolution},MapView.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)},MapView.prototype.setCenter=function(e){this._oldMapSetCenter.call(this.map,e)},MapView.prototype.setExtent=function(e){this.map.setExtent(e)},MapView.prototype.setResolution=function(e){this.map.setResolution(e)},MapView.prototype.setRotation=function(e){this.map.setRotation(e)};var t=function(e,t){var i=1e6,r=t[0]-e[0],a=t[1]-e[1],o=Math.atan(a/r);return 0>r&&(o+=Math.PI),[e[0]+i*Math.cos(o),e[1]+i*Math.sin(o)]},i=function(e,t){var i=t[0]-e[0],r=t[1]-e[1];return i*i+r*r},r=function(e){var r=this;if(e=e||{},e.nearMapCoords){var o=e.bottomPixel.clone();o.y=Math.round(9*o.y/10);var n=a.call(r,o);if(n){var s=[e.nearMapCoords,n].sort(function(t,r){return i(e.cameraPosition,t)-i(e.cameraPosition,r)});return t.apply(this,s)}}return null},a=function(e){var t=this,i=c(t.viewer.scene,e);return i?(i=Cesium.Cartographic.fromCartesian(i),TC.Util.reproject([Cesium.Math.toDegrees(i.longitude),Cesium.Math.toDegrees(i.latitude)],t.map3D.crs,t.map.crs)):null},o=function(e,t){var i=this,r=i.viewer.camera.frustum.fovy,a=i.mapView.proj4Obj.oProj.METERS_PER_UNIT,o=e*i.mapView.viewHTML.getBoundingClientRect().height,n=Math.cos(Math.abs(t)),s=o*a*n;return s/2/Math.tan(r/2)},n=function(e,t){var i=this,r=i.viewer.scene.canvas,a=i.viewer.camera.frustum.fovy,o=i.mapView.proj4Obj.oProj.METERS_PER_UNIT,n=2*e*Math.tan(a/2),s=Math.cos(Math.abs(t)),l=n/o/s,c=l/r.clientHeight,u=i.map.getResolutions();if(null==u){u=new Array(22);for(var p=0,m=u.length;m>p;++p)u[p]=i.mapView.getMaxResolution()/Math.pow(2,p)}for(var p=0;p<u.length;p++){if(u[p]<Math.abs(c)){c=u[p-1];break}if(u[p]===Math.abs(c)){c=u[p];break}p===u.length-1&&(c=u[p])}return c},l=function(e,t,i,r,a){function o(a){n||(n=a);var l=m(s((a-n)/u,0,1));e.transform.clone(v);var c=(l-C)*t;C=l,e.lookAtTransform(r),e.rotate(i,c),e.lookAtTransform(v),1>l?requestAnimationFrame(o):(d&&d(),h.resolve())}var n,s=Cesium.Math.clamp,l=Cesium.defaultValue,c=a||{},u=l(c.duration,500),p=function(e){return e},m=l(c.easing,p),d=c.callback,C=0,v=new Cesium.Matrix4,h=new $.Deferred;return requestAnimationFrame(o),h},c=function(e,t){var i=e.camera.getPickRay(t),r=e.globe.pick(i,e);return r||e.camera.pickEllipsoid(t)},u=function(e){var t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight/2);return c(e,i)},p=function(e){var t=e.canvas,i=new Cesium.Cartesian2(t.clientWidth/2,t.clientHeight);return c(e,i)},m=function(e){var t=e.camera,i=t.frustum.fovy/2,r=t.direction,a=Cesium.Quaternion.fromAxisAngle(t.right,i),o=Cesium.Matrix3.fromQuaternion(a),n=new Cesium.Cartesian3;return Cesium.Matrix3.multiplyByVector(o,r,n),new Cesium.Ray(t.position,n)},d=function(e,t,i,r){var a=e.camera,o=v(e,i),n=a.right,s=Cesium.Quaternion.fromAxisAngle(n,o),c=Cesium.Matrix3.fromQuaternion(s),u=new Cesium.Cartesian3;Cesium.Cartesian3.subtract(a.position,i,u);var p=new Cesium.Cartesian3;Cesium.Matrix3.multiplyByVector(c,u,p),Cesium.Cartesian3.add(p,i,p);var m=Cesium.Matrix4.fromTranslation(p);l(a,t,p,m,r)},C=function(e,t,i){var r=new Cesium.Cartesian3,a=new Cesium.Cartesian3,o=new Cesium.Cartesian3;Cesium.Cartesian3.normalize(e,r),Cesium.Cartesian3.normalize(t,a),Cesium.Cartesian3.cross(r,a,o);var n=Cesium.Cartesian3.dot(r,a),s=Cesium.Cartesian3.magnitude(o),l=Cesium.Cartesian3.dot(i,o),c=Math.atan2(s,n);return l>=0?c:-c},v=function(e,t){var i=e.camera,r=i.frustum.fovy/2,a=m(e),o=Cesium.Cartesian3.clone(a.direction);Cesium.Cartesian3.negate(o,o);var n=new Cesium.Cartesian3;Cesium.Ellipsoid.WGS84.geocentricSurfaceNormal(t,n);var s=new Cesium.Cartesian3;Cesium.Cartesian3.negate(i.right,s);var l=C(n,o,s);return l+r};CameraControls=function(e){var t=this;t.parent=e;var i=function(e){var t=this;t.isFocusingCameraCtrls=!1},o=function(){var e=this;e.isFocusingCameraCtrls=!0,e.lastFocused=performance.now(),e.$div.hasClass(e.parent.classes.OUTFOCUS)&&(e.$div.removeClass(e.parent.classes.OUTFOCUS),e.$tiltIndicatorOuterCircle.attr("class",e.$tiltIndicatorOuterCircle.attr("class").replace(e.parent.classes.OUTFOCUS,"")),e.$tiltIndicatorOuterShellCircle.attr("class",e.$tiltIndicatorOuterShellCircle.attr("class").replace(e.parent.classes.OUTFOCUS,"")),e.$rotateIndicatorOuterCircle.attr("class",e.$rotateIndicatorOuterCircle.attr("class").replace(e.parent.classes.OUTFOCUS,"")),e.$rotateIndicatorOuterShellCircle.attr("class",e.$rotateIndicatorOuterShellCircle.attr("class").replace(e.parent.classes.OUTFOCUS,"")))},s=function(){var e=this;e.moving=!0},l=function(){var e=this;e.moving=!1},c=function(){var e=this,t=e.parent;e.parent.map3D.isLoadingTiles.call(e.parent)&&e.customCollisionDetection();var i=e.getCamera(),o=i.positionCartographic;if(e.moving&&(u(e.$tiltIndicator,i.pitch),u(e.$rotateIndicator,-i.heading),e.disableTilt(5),e._coordsXY=TC.Util.reproject([Cesium.Math.toDegrees(o.longitude),Cesium.Math.toDegrees(o.latitude)],t.map3D.crs,t.map.crs),t.mapView.setCenter(e._coordsXY),t.mapView.setResolution(n.call(t,o.height,o.latitude))),e._coordsXY&&(t._ovMap=t._ovMap||t.map.getControlsByClass("TC.control.OverviewMap")[0],t._ovMap)){var s=t.viewer.scene,l=s.canvas,c=new Cesium.Cartesian2(0,l.clientHeight-1),p=new Cesium.Cartesian2(l.clientWidth-1,l.clientHeight-1),m=[c,p,new Cesium.Cartesian2(l.clientWidth-1,0),new Cesium.Cartesian2(0,0)].map(function(e){return a.call(t,e)}).filter(function(e){return null!==e});if(m.length&&m.length<4){var d=r.call(t,{nearMapCoords:m[0],bottomPixel:c,cameraPosition:e._coordsXY}),C=r.call(t,{nearMapCoords:m[1],bottomPixel:p,cameraPosition:e._coordsXY});d&&C&&(m[2]=C,m[3]=d)}t._ovMap.wrap.draw3DCamera({position:e._coordsXY,heading:i.heading,fov:m})}},u=function(e,t){var i=$(e)[0].getBBox();value="rotate("+Cesium.Math.toDegrees(t)+" "+(i.x+i.width/2)+" "+(i.y+i.height/2)+")",document.getElementsByClassName(e[0].className.baseVal)[0].setAttribute("transform",value)};t.outControlsEvents=TC.Util.detectMouse()?"mouseleave":"touchleave, touchend",t.outControls=i.bind(t),t.inControlsEvents=TC.Util.detectMouse()?"mouseenter":"touchmove, touchstart",t.inControls=o.bind(t),t.moveStart=s.bind(t),t.moveEnd=l.bind(t),t.postRender=c.bind(t),t.selectors={tilt:"-cm-tilt",rotate:"-cm-rotate",indicator:"-indicator",leftArrow:"-left",rightArrow:"-right",downArrow:"-down",upArrow:"-up"},t.render()},CameraControls.prototype.bind=function(){function e(){t.lastFocused||(t.lastFocused=performance.now());var i=performance.now()-t.lastFocused;i>5e3&&t.isFocusingCameraCtrls!==!0&&(t.$div.hasClass(t.parent.classes.OUTFOCUS)||(t.$div.addClass(t.parent.classes.OUTFOCUS),t.$tiltIndicatorOuterCircle.attr("class",t.$tiltIndicatorOuterCircle.attr("class")+" "+t.parent.classes.OUTFOCUS),t.$tiltIndicatorOuterShellCircle.attr("class",t.$tiltIndicatorOuterShellCircle.attr("class")+" "+t.parent.classes.OUTFOCUS),t.$rotateIndicatorOuterCircle.attr("class",t.$rotateIndicatorOuterCircle.attr("class")+" "+t.parent.classes.OUTFOCUS),t.$rotateIndicatorOuterShellCircle.attr("class",t.$rotateIndicatorOuterShellCircle.attr("class")+" "+t.parent.classes.OUTFOCUS))),t.rAFInOutControls=requestAnimationFrame(e)}var t=this;t.getCamera().moveStart.addEventListener(t.moveStart),t.getCamera().moveEnd.addEventListener(t.moveEnd),t.parent.viewer.scene.postRender.addEventListener(t.postRender),t.$div.on(t.outControlsEvents,t.outControls),t.$div.on(t.inControlsEvents,t.inControls),t.rAFInOutControls=requestAnimationFrame(e)},CameraControls.prototype.unbind=function(){var e=this;e.$div.addClass(TC.Consts.classes.HIDDEN),e.getCamera().moveStart.removeEventListener(e.moveStart),e.getCamera().moveEnd.removeEventListener(e.moveEnd),e.parent.viewer.scene.postRender.removeEventListener(e.postRender),e.$div.off(e.outControlsEvents,e.outControls),e.$div.off(e.inControlsEvents,e.inControls),window.cancelAnimationFrame(e.rAFInOutControls),e.lastFocused=void 0,e.rAFInOutControls=void 0},CameraControls.prototype.getCamera=function(){var e=this;return e.parent.viewer.scene.camera},CameraControls.prototype.render=function(){var e=this;e.$div?(e.$div.removeClass(TC.Consts.classes.HIDDEN),e.bind()):e.parent.getRenderedHtml(e.parent.CLASS+"-cm-ctls",{},function(t){e.$div=$('<div class="'+e.parent.CLASS+'-cm-ctls"></div>'),e.$div.appendTo(e.parent.map._$div),$(t).appendTo(e.$div);var i="."+e.parent.CLASS+e.selectors.tilt;e.$tiltIndicatorInner=e.$div.find("[class^="+i.replace(".","")+"-inner]"),e.$tiltIndicatorInner.on(TC.Consts.event.CLICK,e.resetTilt.bind(e)),e.$tiltIndicator=e.$div.find(i+"-indicator"),e.$tiltIndicatorOuterCircle=e.$div.find(i+"-outer-circle"),e.$tiltIndicatorOuterShellCircle=e.$div.find(i+"-outer-shell-circle"),e.$tiltIndicatorCircle=e.$div.find("[class^="+i.replace(".","")+"-outer]"),e.$tiltIndicatorCircle.on("mousedown",function(e){var t=this;e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault();var i=new Cesium.Cartesian2,r=e.currentTarget,a=e.currentTarget.getBoundingClientRect(),o=new Cesium.Cartesian2((a.right-a.left)/2,(a.bottom-a.top)/2),n=new Cesium.Cartesian2(e.clientX-a.left,e.clientY-a.top),s=Cesium.Cartesian2.subtract(n,o,i);return t.draggingTilt.call(t,r,s),e.cancelBubble=!0,e.returnValue=!1,!1}.bind(e)),e.$tiltUp=e.$div.find(i+e.selectors.upArrow),e.$tiltUp.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){if(void 0!==$(t.target).attr("disabled"))return t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1,!1;t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";return document.removeEventListener(i,e.tiltUpMouseUpFunction,!1),e.tiltUpMouseUpFunction=void 0,e.tilt.call(e,5),e.tiltUpInterval=setInterval(function(){e.isTiltUpDisabled?e.tiltUpMouseUpFunction():e.tilt.call(e,5)}.bind(e),101),e.tiltUpMouseUpFunction=function(){clearInterval(e.tiltUpInterval),e.tiltUpInterval=void 0,document.removeEventListener(i,e.tiltUpMouseUpFunction,!1),e.tiltUpMouseUpFunction=void 0},document.addEventListener(i,e.tiltUpMouseUpFunction,!1),t.cancelBubble=!0,t.returnValue=!1,!1}.bind(e)),e.$tiltDown=e.$div.find(i+e.selectors.downArrow),e.$tiltDown.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){if(void 0!==$(t.target).attr("disabled"))return t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1,!1;t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";return document.removeEventListener(i,e.tiltDownMouseUpFunction,!1),e.tiltDownMouseUpFunction=void 0,e.tilt.call(e,-5),e.tiltDownInterval=setInterval(function(){e.isTiltDownDisabled?e.tiltDownMouseUpFunction():e.tilt.call(e,-5)}.bind(e),101),e.tiltDownMouseUpFunction=function(){clearInterval(e.tiltDownInterval),e.tiltDownInterval=void 0,document.removeEventListener(i,e.tiltDownMouseUpFunction,!1),e.tiltDownMouseUpFunction=void 0},document.addEventListener(i,e.tiltDownMouseUpFunction,!1),t.cancelBubble=!0,t.returnValue=!1,!1}.bind(e));var r="."+e.parent.CLASS+e.selectors.rotate;e.$rotateIndicatorInner=e.$div.find("[class^="+r.replace(".","")+"-inner]"),
e.$rotateIndicatorInner.on(TC.Consts.event.CLICK,e.resetRotation.bind(e)),e.$rotateIndicator=e.$div.find(r+"-indicator"),e.$rotateIndicatorOuterCircle=e.$div.find(r+"-outer-circle"),e.$rotateIndicatorOuterShellCircle=e.$div.find(r+"-outer-shell-circle"),e.$rotateIndicatorCircle=e.$div.find("[class^="+r.replace(".","")+"-outer]"),e.$rotateIndicatorCircle.on("mousedown",function(e){var t=this;e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault();var i=new Cesium.Cartesian2,r=e.currentTarget,a=e.currentTarget.getBoundingClientRect(),o=new Cesium.Cartesian2((a.right-a.left)/2,(a.bottom-a.top)/2),n=new Cesium.Cartesian2(e.clientX-a.left,e.clientY-a.top),s=Cesium.Cartesian2.subtract(n,o,i);return t.draggingRotate.call(t,r,s),e.cancelBubble=!0,e.returnValue=!1,!1}.bind(e)),e.$rotateLeft=e.$div.find(r+e.selectors.leftArrow),e.$rotateLeft.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";return document.removeEventListener(i,e.rotateLeftMouseUpFunction,!1),e.rotateLeftMouseUpFunction=void 0,e.rotate.call(e,-15),e.rotateLeftInterval=setInterval(function(){e.rotate.call(e,-15)}.bind(e),101),e.rotateLeftMouseUpFunction=function(){clearInterval(e.rotateLeftInterval),e.rotateLeftInterval=void 0,document.removeEventListener(i,e.rotateLeftMouseUpFunction,!1),e.rotateLeftMouseUpFunction=void 0},document.addEventListener(i,e.rotateLeftMouseUpFunction,!1),t.cancelBubble=!0,t.returnValue=!1,!1}.bind(e)),e.$rotateRight=e.$div.find(r+e.selectors.rightArrow),e.$rotateRight.on(TC.Util.detectMouse()?"mousedown":"touchstart",function(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),e.inControls(t);var i=TC.Util.detectMouse()?"mouseup":"touchend";return document.removeEventListener(i,e.rotateRightMouseUpFunction,!1),e.rotateRightMouseUpFunction=void 0,e.rotate.call(e,15),e.rotateRightInterval=setInterval(function(){e.rotate.call(e,15)}.bind(e),101),e.rotateRightMouseUpFunction=function(){clearInterval(e.rotateRightInterval),e.rotateRightInterval=void 0,document.removeEventListener(i,e.rotateRightMouseUpFunction,!1),e.rotateRightMouseUpFunction=void 0},document.addEventListener(i,e.rotateRightMouseUpFunction,!1),t.cancelBubble=!0,t.returnValue=!1,!1}.bind(e)),e.bind()}.bind(this))},CameraControls.prototype.disableTilt=function(e){var t=this,i=Cesium.Math.toRadians(Math.abs(e));t.isTiltUpDisabled=void 0==p(t.parent.viewer.scene)?!0:t.getCamera().pitch+i>=Cesium.Math.PI_OVER_TWO,t.isTiltDownDisabled=t.getCamera().pitch-i<=-Cesium.Math.PI_OVER_TWO,t.$tiltUp.attr("disabled",t.isTiltUpDisabled),t.isTiltUpDisabled?-1==t.$tiltUp.attr("class").indexOf(t.parent.classes.CAMERACTRARROWDISABLED)&&t.$tiltUp.attr("class",t.$tiltUp.attr("class")+" "+t.parent.classes.CAMERACTRARROWDISABLED):t.$tiltUp.attr("class",t.$tiltUp.attr("class").replace(" "+t.parent.classes.CAMERACTRARROWDISABLED,"")),t.$tiltDown.attr("disabled",t.isTiltDownDisabled),t.isTiltDownDisabled?-1==t.$tiltDown.attr("class").indexOf(t.parent.classes.CAMERACTRARROWDISABLED)&&t.$tiltDown.attr("class",t.$tiltDown.attr("class")+" "+t.parent.classes.CAMERACTRARROWDISABLED):t.$tiltDown.attr("class",t.$tiltDown.attr("class").replace(" "+t.parent.classes.CAMERACTRARROWDISABLED,""))},CameraControls.prototype.tilt=function(e){var t=this;if(t.disableTilt(e),void 0==u(t.parent.viewer.scene)&&(e>0?t.getCamera().lookUp():t.getCamera().lookDown()),!(e>=Cesium.Math.PI_OVER_TWO&&t.isTiltUpDisabled||e<=-Cesium.Math.PI_OVER_TWO&&t.isTiltDownDisabled)){var i=Cesium.Math.toRadians(e),r=u(t.parent.viewer.scene);if(r){var a=Cesium.Matrix4.fromTranslation(r);t.parent.map3D.rotateAroundAxis(t.getCamera(),-i,t.getCamera().right,a,{duration:100})}}},CameraControls.prototype.rotate=function(e){var t=this;e=Cesium.Math.toRadians(e);var i=p(t.parent.viewer.scene);i&&d(t.parent.viewer.scene,e,i,{duration:100})},CameraControls.prototype.draggingTilt=function(e,t){var i=this;i.$tiltIndicatorOuterCircle.attr("class",i.$tiltIndicatorOuterCircle.attr("class")+" "+i.parent.classes.HIGHLIGHTED);var r=new Cesium.Matrix4,a=new Cesium.Matrix4,o=new Cesium.Cartesian2;document.removeEventListener("mousemove",i.tiltMouseMoveFunction,!1),document.removeEventListener("mouseup",i.tiltMouseUpFunction,!1),i.tiltTickFunction&&i.parent.viewer.clock.onTick.removeEventListener(i.tiltTickFunction),i.tiltMouseMoveFunction=void 0,i.tiltMouseUpFunction=void 0,i.tiltTickFunction=void 0,i.isTilting=!0,i.tiltLastTimestamp=performance.now();var n=i.parent.viewer.scene,s=n.camera,l=u(n);l?(i.tiltFrame=Cesium.Transforms.eastNorthUpToFixedFrame(l,Cesium.Ellipsoid.WGS84,a),i.tiltIsLook=!1):(i.tiltFrame=Cesium.Transforms.eastNorthUpToFixedFrame(s.positionWC,Cesium.Ellipsoid.WGS84,a),i.tiltIsLook=!0);var c=Math.atan2(-t.y,t.x);i.tiltInitialCursorAngle=Cesium.Math.zeroToTwoPi(c-Cesium.Math.PI_OVER_TWO),i.tiltInitialCameraAngle=Math.atan2(s.position.y,s.position.x),i.tiltTickFunction=function(e){var t=this,i=performance.now(),a=(i-t.tiltLastTimestamp,u(n));if(a&&!t.tiltLastPivot&&(t.tiltLastPivot=a),!a&&t.tiltLastPivot)a=t.tiltLastPivot;else if(!t.tiltLastPivot)return;var o=t.tiltCursorAngle+Cesium.Math.PI_OVER_TWO,l=o-t.tiltInitialCursorAngle;n=t.parent.viewer.scene,s=n.camera;var c=Cesium.Matrix4.clone(s.transform,r);s.lookAtTransform(t.tiltFrame);var p=Cesium.Math.zeroToTwoPi(t.tiltInitialCameraAngle-l),m=Math.atan2(s.position.y,s.position.x),d=.02*Math.sin(p-m);t.tiltIsLook?s.look(s.right,-d):s.rotateUp(d),s.lookAtTransform(c),t.tiltLastTimestamp=i}.bind(i),i.tiltMouseMoveFunction=function(t){var i=this,r=e.getBoundingClientRect();center=new Cesium.Cartesian2((r.right-r.left)/2,(r.bottom-r.top)/2);var a=new Cesium.Cartesian2(t.clientX-r.left,t.clientY-r.top),n=Cesium.Cartesian2.subtract(a,center,o),s=Math.atan2(-n.y,n.x);i.tiltCursorAngle=Cesium.Math.zeroToTwoPi(s-Cesium.Math.PI_OVER_TWO)}.bind(i),i.tiltMouseUpFunction=function(e){i.$tiltIndicatorOuterCircle.attr("class",i.$tiltIndicatorOuterCircle.attr("class").replace(i.parent.classes.HIGHLIGHTED,"")),i.isTilting=!1,document.removeEventListener("mousemove",i.tiltMouseMoveFunction,!1),document.removeEventListener("mouseup",i.tiltMouseUpFunction,!1),void 0!==i.tiltTickFunction&&i.parent.viewer.clock.onTick.removeEventListener(i.tiltTickFunction),i.tiltMouseMoveFunction=void 0,i.tiltMouseUpFunction=void 0,i.tiltTickFunction=void 0},document.addEventListener("mousemove",i.tiltMouseMoveFunction,!1),document.addEventListener("mouseup",i.tiltMouseUpFunction,!1),i._unsubscribeFromClockTick=i.parent.viewer.clock.onTick.addEventListener(i.tiltTickFunction);var c=Math.atan2(-t.y,t.x);i.tiltCursorAngle=Cesium.Math.zeroToTwoPi(c-Cesium.Math.PI_OVER_TWO)},CameraControls.prototype.draggingRotate=function(e,t){var i=this;i.$rotateIndicatorOuterCircle.attr("class",i.$rotateIndicatorOuterCircle.attr("class")+" "+i.parent.classes.HIGHLIGHTED);var r=new Cesium.Matrix4,a=new Cesium.Matrix4,o=new Cesium.Cartesian2;document.removeEventListener("mousemove",i.rotateMouseMoveFunction,!1),document.removeEventListener("mouseup",i.rotateMouseUpFunction,!1),i.rotateMouseMoveFunction=void 0,i.rotateMouseUpFunction=void 0,i.isRotating=!0,i.rotateInitialCursorAngle=Math.atan2(-t.y,t.x);var n=i.parent.viewer.scene,s=n.camera,l=u(i.parent.viewer.scene);null==l||void 0==l?(l=p(i.parent.viewer.scene),null==l||void 0==l?(i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(s.positionWC,Cesium.Ellipsoid.WGS84,a),i.rotateIsLook=!0):(i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(l,Cesium.Ellipsoid.WGS84,a),i.rotateIsLook=!1)):(i.rotateFrame=Cesium.Transforms.eastNorthUpToFixedFrame(l,Cesium.Ellipsoid.WGS84,a),i.rotateIsLook=!1);try{var c=Cesium.Matrix4.clone(s.transform,r);s.lookAtTransform(i.rotateFrame),i.rotateInitialCameraAngle=Math.atan2(s.position.y,s.position.x),i.rotateInitialCameraDistance=Cesium.Cartesian3.magnitude(new Cesium.Cartesian3(s.position.x,s.position.y,0)),s.lookAtTransform(c)}catch(m){i.rotateMouseUpFunction()}i.rotateMouseMoveFunction=function(t){var a=e.getBoundingClientRect(),n=new Cesium.Cartesian2((a.right-a.left)/2,(a.bottom-a.top)/2),l=new Cesium.Cartesian2(t.clientX-a.left,t.clientY-a.top),u=Cesium.Cartesian2.subtract(l,n,o),p=Math.atan2(-u.y,u.x),m=p-i.rotateInitialCursorAngle,d=Cesium.Math.zeroToTwoPi(i.rotateInitialCameraAngle-m);s=i.parent.viewer.scene.camera;try{c=Cesium.Matrix4.clone(s.transform,r),s.lookAtTransform(i.rotateFrame);var C=Math.atan2(s.position.y,s.position.x);s.rotateRight(d-C),s.lookAtTransform(c)}catch(t){i.rotateMouseUpFunction()}},i.rotateMouseUpFunction=function(e){i.isRotating=!1,i.$rotateIndicatorOuterCircle.attr("class",i.$rotateIndicatorOuterCircle.attr("class").replace(i.parent.classes.HIGHLIGHTED,"")),document.removeEventListener("mousemove",i.rotateMouseMoveFunction,!1),document.removeEventListener("mouseup",i.rotateMouseUpFunction,!1),i.rotateMouseMoveFunction=void 0,i.rotateMouseUpFunction=void 0},document.addEventListener("mousemove",i.rotateMouseMoveFunction,!1),document.addEventListener("mouseup",i.rotateMouseUpFunction,!1)},CameraControls.prototype.resetTilt=function(){var e=this,t=-e.getCamera().pitch-Cesium.Math.toRadians(50);e.tilt(Cesium.Math.toDegrees(t))},CameraControls.prototype.resetRotation=function(e){var t,i=this,r=new $.Deferred;for(t=-i.getCamera().heading;t<-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;e?e.callback=function(){r.resolve()}:r.resolve();var a=p(i.parent.viewer.scene);return a&&d(i.parent.viewer.scene,t,a,e),r},CameraControls.prototype.customCollisionDetection=function(){{var e,t,i=this,r=new Cesium.Matrix4,a=new Cesium.Cartographic,o=i.parent.viewer.scene,n=i.parent.viewer.scene.camera,s=o.screenSpaceCameraController,l=(s.enableCollisionDetection,s.minimumCollisionTerrainHeight),c=s.minimumZoomDistance,u=o.globe,p=u.ellipsoid;o.mapProjection}Cesium.Matrix4.equals(n.transform,Cesium.Matrix4.IDENTITY)||(e=Cesium.Matrix4.clone(n.transform,r),t=Cesium.Cartesian3.magnitude(n.position),n._setTransform(Cesium.Matrix4.IDENTITY));var m=a;p.cartesianToCartographic(n.position,m);var d=!1;if(m.height<l){var C=u.getHeight(m);void 0!==C&&null!==C&&(C+=c,m.height<C&&(m.height=C,p.cartographicToCartesian(m,n.position),d=!0))}void 0!==e&&null!==e&&(n._setTransform(e),d&&(Cesium.Cartesian3.normalize(n.position,n.position),Cesium.Cartesian3.negate(n.position,n.direction),Cesium.Cartesian3.multiplyByScalar(n.position,Math.max(t,c),n.position),Cesium.Cartesian3.normalize(n.direction,n.direction),Cesium.Cartesian3.cross(n.direction,n.up,n.right),Cesium.Cartesian3.cross(n.right,n.direction,n.up)))},CameraControls.prototype.limitCameraToInitExtent=function(){var e=this,t=e.viewer.camera.positionCartographic.clone();if(!(t.longitude>=e.initExtent.west&&t.longitude<=e.initExtent.east&&t.latitude>=e.initExtent.south&&t.latitude<=e.initExtent.north)){var i=e.viewer.scene.screenSpaceCameraController.maximumZoomDistance,r=.05*t.height/i;t.longitude=Math.max(e.initExtent.west-r,t.longitude),t.latitude=Math.max(e.initExtent.south-r,t.latitude),t.longitude=Math.min(e.initExtent.east+r,t.longitude),t.latitude=Math.min(e.initExtent.north+r,t.latitude),e.viewer.camera.setView({destination:Cesium.Ellipsoid.WGS84.cartographicToCartesian(t),orientation:{heading:e.viewer.camera.heading,pitch:e.viewer.camera.pitch}})}e.viewer.scene.screenSpaceCameraController.minimumZoomDistance=t.height>1800?400:200},CustomRenderLoop=function(e,t,i){this.map2D=e,this.listentTo=[TC.Consts.event.LAYERADD,TC.Consts.event.LAYERORDER,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYEROPACITY,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.ZOOM,TC.Consts.event.BASELAYERCHANGE,TC.Consts.event.FEATUREADD,TC.Consts.event.FEATUREREMOVE,TC.Consts.event.LAYERUPDATE,TC.Consts.event.TERRAINLOADED,TC.Consts.event.ZOOMTO].join(" "),this.map3D=t,this.scene_=this.map3D.scene,this.verboseRendering=i,this._boundNotifyRepaintRequired=this.notifyRepaintRequired.bind(this),this.lastCameraViewMatrix_=new Cesium.Matrix4,this.lastCameraMoveTime_=0,this.stoppedRendering=!1,this._removeTileLoadProgressListener=this.scene_.globe.tileLoadProgressEvent.addEventListener(function(e){this.tilesWaiting=0===e?!1:!0}.bind(this)),this._removePostRenderListener=this.scene_.postRender.addEventListener(this.postRender.bind(this)),this._wheelEvent="",this._wheelEvent="onwheel"in this.scene_.canvas?"wheel":document.onmousewheel?"mousewheel":"DOMMouseScroll",this._originalLoadWithXhr=Cesium.loadWithXhr.load,this._originalScheduleTask=Cesium.TaskProcessor.prototype.scheduleTask,this._originalCameraSetView=Cesium.Camera.prototype.setView,this._originalCameraMove=Cesium.Camera.prototype.move,this._originalCameraRotate=Cesium.Camera.prototype.rotate,this._originalCameraLookAt=Cesium.Camera.prototype.lookAt,this._originalCameraFlyTo=Cesium.Camera.prototype.flyTo,this.enable()},CustomRenderLoop.prototype.repaintOn_=function(e,t){var i=this.scene_.canvas;i.addEventListener(e,this._boundNotifyRepaintRequired,t)},CustomRenderLoop.prototype.removeRepaintOn_=function(e,t){var i=this.scene_.canvas;i.removeEventListener(e,this._boundNotifyRepaintRequired,t)},CustomRenderLoop.prototype.enable=function(){this.repaintOn_("mousemove",!1),this.repaintOn_("mousedown",!1),this.repaintOn_("mouseup",!1),this.repaintOn_("touchstart",!1),this.repaintOn_("touchend",!1),this.repaintOn_("touchmove",!1),window.PointerEvent&&(this.repaintOn_("pointerdown",!1),this.repaintOn_("pointerup",!1),this.repaintOn_("pointermove",!1)),this.repaintOn_(this._wheelEvent,!1),window.addEventListener("resize",this._boundNotifyRepaintRequired,!1);var e=this;Cesium.loadWithXhr.load=function(t,i,r,a,o,n,s,l,c){n.promise.always(e._boundNotifyRepaintRequired),e._originalLoadWithXhr(t,i,r,a,o,n,s,l,c)},Cesium.TaskProcessor.prototype.scheduleTask=function(t,i){var r=e._originalScheduleTask.call(this,t,i),a=this;if(!a._originalWorkerMessageSinkRepaint){var o=a._worker;a._originalWorkerMessageSinkRepaint=o.onmessage,o.onmessage=function(t){a._originalWorkerMessageSinkRepaint(t),e.notifyRepaintRequired()}}return r},Cesium.Camera.prototype.setView=function(){e._originalCameraSetView.apply(this,arguments),e.notifyRepaintRequired()},Cesium.Camera.prototype.move=function(){e._originalCameraMove.apply(this,arguments),e.notifyRepaintRequired()},Cesium.Camera.prototype.rotate=function(){e._originalCameraRotate.apply(this,arguments),e.notifyRepaintRequired()},Cesium.Camera.prototype.lookAt=function(){e._originalCameraLookAt.apply(this,arguments),e.notifyRepaintRequired()},Cesium.Camera.prototype.flyTo=function(){e._originalCameraFlyTo.apply(this,arguments),e.notifyRepaintRequired()},this.map2D.on(this.listentTo,this._boundNotifyRepaintRequired)},CustomRenderLoop.prototype.disable=function(){this._removePostRenderListener&&(this._removePostRenderListener(),this._removePostRenderListener=void 0),this._removeTileLoadProgressListener&&(this._removeTileLoadProgressListener(),this._removeTileLoadProgressListener=void 0),this.removeRepaintOn_("mousemove",!1),this.removeRepaintOn_("mousedown",!1),this.removeRepaintOn_("mouseup",!1),this.removeRepaintOn_("touchstart",!1),this.removeRepaintOn_("touchend",!1),this.removeRepaintOn_("touchmove",!1),window.PointerEvent&&(this.removeRepaintOn_("pointerdown",!1),this.removeRepaintOn_("pointerup",!1),this.removeRepaintOn_("pointermove",!1)),this.removeRepaintOn_(this._wheelEvent,!1),window.removeEventListener("resize",this._boundNotifyRepaintRequired,!1),Cesium.loadWithXhr.load=this._originalLoadWithXhr,Cesium.TaskProcessor.prototype.scheduleTask=this._originalScheduleTask,Cesium.Camera.prototype.setView=this._originalCameraSetView,Cesium.Camera.prototype.move=this._originalCameraMove,Cesium.Camera.prototype.rotate=this._originalCameraRotate,Cesium.Camera.prototype.lookAt=this._originalCameraLookAt,Cesium.Camera.prototype.flyTo=this._originalCameraFlyTo,this.map2D.off(this.listentTo,this._boundNotifyRepaintRequired)},CustomRenderLoop.prototype.postRender=function(e){var t=Date.now(),i=this.scene_,r=i.camera;Cesium.Matrix4.equalsEpsilon(this.lastCameraViewMatrix_,r.viewMatrix,1e-5)||(this.lastCameraMoveTime_=t);var a=t-this.lastCameraMoveTime_<3e3,o=i.tweens;a||this.tilesWaiting||0!=o.length||(this.verboseRendering&&console.log("stopping rendering @ "+Date.now()),this.parent.setBlockRendering(!0),this.stoppedRendering=!0),Cesium.Matrix4.clone(r.viewMatrix,this.lastCameraViewMatrix_)},CustomRenderLoop.prototype.restart=function(){this.notifyRepaintRequired()},CustomRenderLoop.prototype.notifyRepaintRequired=function(){this.verboseRendering&&this.stoppedRendering&&console.log("starting rendering @ "+Date.now()),this.lastCameraMoveTime_=Date.now(),this.parent.setBlockRendering(!1),this.stoppedRendering=!1},CustomRenderLoop.prototype.setDebug=function(e){this.verboseRendering=e},CustomRender=function(e,t,i){this.idRequestAnimationFrame=null,this._blockRendering=!1,this._canvasClientWidth=0,this._canvasClientHeight=0,this._resolutionScale=1,this._viewer=t,this._canvas=t.scene.canvas,this._clock=t.clock||new Cesium.Clock,this._handleResize=function(e){var t=this._canvas.clientWidth,i=this._canvas.clientHeight;if(!(0===t|0===i||t===this._canvasClientWidth&&i===this._canvasClientHeight)){var r=this._resolutionScale;this._canvasClientWidth=t,this._canvasClientHeight=i,t*=r,i*=r,this._canvas.width=t,this._canvas.height=i,e.scene.camera.frustum.aspectRatio=t/i}},this._renderingAnimation=function(){function e(){if(this._blockRendering)this._clock.tick();else{this._viewer.scene.initializeFrame(),this._handleResize(this._viewer);var t=this._clock.tick()||Cesium.JulianDate.now();this._viewer.scene.render(t)}this.idRequestAnimationFrame=requestAnimationFrame(e.bind(this))}this.idRequestAnimationFrame=requestAnimationFrame(e.bind(this))},i&&(this._resolutionScale=.5),this.renderLoop=new CustomRenderLoop(e,t,!1),this.renderLoop.parent=this},CustomRender.prototype.start=function(e){this.renderLoop.setDebug(e||!1),this._renderingAnimation()},CustomRender.prototype.stop=function(){window.cancelAnimationFrame(this.idRequestAnimationFrame)},CustomRender.prototype.restart=function(){this.renderLoop.restart()},CustomRender.prototype.setBlockRendering=function(e){this._blockRendering=e},CustomRender.prototype.getCanvas=function(){return this._canvas},TwoDLinkedFeatureInfo=function(e){this.layer=null;var t=null,i=null,r=null,a=null,o=function(){var t=new $.Deferred;return i?t.resolve():(TC.control.ResultsPanel||TC.syncLoadJS(TC.apiLocation+"TC/control/ResultsPanel"),i=new TC.control.ResultsPanel({div:"results-panel",content:"table",titles:{main:e.getLocaleString("threed.rs.panel.gfi"),max:e.getLocaleString("threed.rs.panel.gfi")},openOn:e.Consts.events.GFI}),i.register(e.map),i.render(function(){i.onClose=function(){c(),e.map.$events.trigger($.Event(TC.Consts.event.POPUPHIDE,{control:r.popup}))}.bind(this),e.map.on(TC.Consts.event.RESULTSPANELCLOSE,i.onClose),t.resolve()})),t},l=function(i){if(t)t.position=i;else{var r=(TC.control.FeatureInfoCommons.prototype.markerStyle,{position:i,billboard:{image:TC.Util.getBackgroundUrlFromCss(e.CLASS+"-marker"),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}});t=e.map3D.addNativeFeature.call(e,r)}},c=function(){e.map3D.removeFeature.call(e,t),t=null};r=e.map.getControlsByClass(TC.control.FeatureInfo)[0],r&&(r.marker=!0,a=r.popup.$popupDiv,r.popup.hide(),this.layer=r.layer,e.map3D.vector2DLayers.push(this.layer)),this.clear=function(){this.layer=null,c(),i&&(i.onClose&&e.map.off(TC.Consts.event.RESULTSPANELCLOSE,i.onClose),i.close()),r&&(r.popup.$popupDiv=a,r.popup.hide())},this.send=function(t){var u=new $.Deferred;return e.waiting||(e.waiting=e.map.getLoadingIndicator().addWait()),r.popup.$popupDiv=a,l(t),$.when(o()).then(function(){for(var a,o=Cesium.Ellipsoid.WGS84.cartesianToCartographic(t),l=TC.Util.reproject([Cesium.Math.toDegrees(o.longitude),Cesium.Math.toDegrees(o.latitude)],e.map3D.crs,e.map.crs),p=e.map.options.pixelTolerance||TC.Cfg.pixelTolerance,m=2*p+1,d=e.viewer.scene.globe._surface._tilesToRender,C=0;!a&&C<d.length;++C){var v=d[C];Cesium.Rectangle.contains(v.rectangle,o)&&(a=v)}if(!a)return u;for(var h=a.data.imagery,f=h.length-1;f>=0;--f){var g=h[f],w=g.readyImagery;if(!w)return u}var y=n.call(e,e.viewer.camera.positionCartographic.height,e.viewer.camera.positionCartographic.latitude),T=m*y/2,D=[l[0]-T,l[1]-T,l[0]+T,l[1]+T],L=[p,p];e.map.one(TC.Consts.event.POPUP,function(e){i.open(e.control.$popupDiv.find("."+r.CLASS).clone(!0,!0)),r.popup.$popupDiv=i.$divTable,r.onShowPopUp(e),r.popup.$popupDiv.removeAttr("style"),u.resolve(e)}),e.map.one(TC.Consts.event.NOFEATUREINFO,function(e){r.isActive=savedIsActive,c(s),i&&i.close(),u.resolve(e)}),e.map.one(TC.Consts.event.FEATUREINFO,function(e){r.isActive=savedIsActive,0==e.featureCount&&(c(),i&&i.close()),u.resolve(e)}),savedIsActive=r.isActive,r.isActive=!0,r.beforeGetFeatureInfo({xy:L,control:r}),r.wrap.getFeatureInfo(L,{mapSize:[m,m],boundingBox:D})}),u}},TwoDLinkedLegend=function(e){var t=e.map.getControlsByClass(TC.control.Legend)[0];this.refresh=function(){t&&e.map3D.workLayers.length>0&&t.loadGraphics()}},RasterConverter=function(e){this.layerCrs=null;var e=e,t={CRS:["Capability","Layer","CRS"],TILEMATRIXSET:["Contents","TileMatrixSet","Identifier"],TILEMATRIXSETLABELS:["Contents","TileMatrixSet"]},i=function(e,t,r){if(r<t.length-1)return e.hasOwnProperty(t[r])?i(e[t[r]],t,++r):null;if(e instanceof Array){for(var a=[],o=0;o<e.length;o++)e[o].hasOwnProperty(t[r])&&a.push(e[o][t[r]]);return a}return e[t[r]]},r=function(e){return(capsURL=TC.Util.isOnCapabilities(e.url))&&(caps=TC.capabilities[capsURL])?i(caps,t.CRS,0)||i(caps,t.TILEMATRIXSET,0):null},a=function(e,r){if((capsURL=TC.Util.isOnCapabilities(e.url))&&(caps=TC.capabilities[capsURL]))for(var a=i(caps,t.TILEMATRIXSETLABELS,0),o=0;o<a.length;o++)if(a[o].Identifier===r)return i(a[o],["TileMatrix","Identifier"],0);return null},o=function(e){var t=a(e,this.layerCrs),i={url:e.options.urlPattern,layer:e.layerNames,style:"default",format:e.format||e.options.format,tileMatrixSetID:this.layerCrs,tileMatrixLabels:t,tilingScheme:new Cesium.GeographicTilingScheme};return e.usesProxy&&(i.proxy={getURL:function(e){return TC.proxify(e)}}),new Cesium.WebMapTileServiceImageryProvider(i)},n=function(e){var t={url:e.url,layers:e.layerNames,parameters:{version:"1.3.0",transparent:!0,format:e.format||e.options.format}};return(e.usesProxy||e.usesSSL&&!TC.Util.isSameOrigin(e.url))&&(t.proxy={getURL:function(e){return TC.proxify(e)}}),new Cesium.WebMapServiceImageryProvider(t)};this.isCompatible=function(t){var i=r(t);return i&&i.length&&e.test(i.join(","))?(this.layerCrs=i.join(",").match(e)[0],!0):!1},this.convert=function(e){var t;if(this.isCompatible(e),null!=this.layerCrs){switch(!0){case TC.Consts.layerType.WMTS==e.type:t=o.call(this,e);break;case TC.Consts.layerType.WMS==e.type:t=n(e)}if(t)return void 0!==t.enablePickFeatures&&(t.enablePickFeatures=!1,t.tcLayer=e),t}return null}},FeatureConverter=function(){var e=null,t=function(e,t){e instanceof Array&&(e="rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")");var i=Cesium.Color.fromCssColorString(e);return t?i.withAlpha(t):i},i=function(e,t,i){for(var r in t){var a=e[t[r].prop];if(a)if("function"==typeof a){var o=a(i);o&&(t[r].val=o)}else t[r].val=a}},r=function(t){var i;if(1==t.length){var r,a,o,n,s=t[0],l=1e3;r=new Cesium.Cartesian3(s.x-l,s.y,s.z),a=new Cesium.Cartesian3(s.x,s.y-l,s.z),o=new Cesium.Cartesian3(s.x+l,s.y,s.z),n=new Cesium.Cartesian3(s.x,s.y+l,s.z),i=Cesium.Rectangle.fromCartesianArray([r,a,o,n],Cesium.Ellipsoid.WGS84)}else i=Cesium.Rectangle.fromCartesianArray(t,Cesium.Ellipsoid.WGS84);var c=e.camera.getRectangleCameraCoordinates(i),u=Cesium.Cartesian3.distance(c,Cesium.BoundingSphere.fromPoints(t).center),p=e.camera.frustum.getPixelDimensions(e.drawingBufferWidth,e.drawingBufferHeight,u,new Cesium.Cartesian2);return p=Math.max(p.x,p.y),0==Math.round(p)?1:p},a=function(e){var t;return t=e.layer.hasOwnProperty("styles")?e.layer.styles:TC.Defaults.styles,t=void 0==t[e.STYLETYPE]?t["polyline"===e.STYLETYPE?"line":e.STYLETYPE]:t["multipolygon"===e.STYLETYPE?"polygon":e.STYLETYPE],t=$.extend({},t,e.options,e.getStyle())},o=function(e){var o={},n=a(e);return o.options=function(){var r={},a={color:{prop:"fillColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"strokeColor"},outlineOpacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(n,a,e);var o;return a.color.hasOwnProperty("val")&&(o=a.opacity.hasOwnProperty("val")?t(a.color.val,a.opacity.val):t(a.color.val)),r.color=Cesium.ColorGeometryInstanceAttribute.fromColor(o),a.outlineColor.hasOwnProperty("val")&&(o=a.outlineOpacity.hasOwnProperty("val")?t(a.outlineColor.val,a.outlineOpacity.val):t(a.outlineColor.val)),r.outlineColor=Cesium.ColorGeometryInstanceAttribute.fromColor(o),a.width.hasOwnProperty("val")&&(r.width=a.width.val),r},TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon?o.geometryType=function(t,i){for(var a=[],o=[],n=function(t){return new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.PolygonGeometry({polygonHierarchy:t}),attributes:{color:i.color}})},s=function(t){return new Cesium.GeometryInstance({id:e.id+"outLine",geometry:new Cesium.CorridorGeometry({positions:t,width:r(t)*i.width}),attributes:{color:i.outlineColor}})},l=0;l<t.length;l++){for(var c=0;c<t[l].length;c++){var u;0==c?(o.push(s(t[l][0])),u=new Cesium.PolygonHierarchy(t[l][0])):(o.push(s(t[l][c])),u.holes.push(new Cesium.PolygonHierarchy(t[l][c])))}a.push(n(u))}return[new Cesium.GroundPrimitive({geometryInstances:a}),new Cesium.GroundPrimitive({geometryInstances:o})]}:TC.feature.Polygon&&e instanceof TC.feature.Polygon&&(o.geometryType=function(t,i){return[new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.PolygonGeometry({polygonHierarchy:new Cesium.PolygonHierarchy(t)}),attributes:{color:i.color}})}),new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({id:e.id+"outLine",geometry:new Cesium.CorridorGeometry({positions:t,width:r(t)*i.width}),attributes:{color:i.outlineColor}})})]}),o},n=function(e){var o={},n=a(e);return o.options=function(){var r={},a={color:{prop:"strokeColor"},opacity:{prop:"strokeOpacity"},width:{prop:"strokeWidth"}};i(n,a,e),a.width.hasOwnProperty("val")&&(r.width=a.width.val);var o;return a.color.hasOwnProperty("val")&&(o=a.opacity.hasOwnProperty("val")?t(a.color.val,a.opacity.val):t(a.color.val)),r.color=Cesium.ColorGeometryInstanceAttribute.fromColor(o),r},TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline?o.geometryType=function(t,i){return 1==t.length&&(t=t[0]),new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.CorridorGeometry({positions:t,width:r(t)*i.width}),attributes:{color:i.color}})})}:TC.feature.Polyline&&e instanceof TC.feature.Polyline&&(o.geometryType=function(t,i){return new Cesium.GroundPrimitive({geometryInstances:new Cesium.GeometryInstance({id:e.id,geometry:new Cesium.CorridorGeometry({positions:t,width:r(t)*i.width}),attributes:{color:i.color}})})}),o},s=function(e){var r={},o=a(e);if(r.options=function(){var r={},a={rotation:{prop:"angle"},label:{prop:"label"},fontSize:{prop:"fontSize"},fontColor:{prop:"fontColor"},outlineLabelColor:{prop:"labelOutlineColor"},outlineLabelWidth:{prop:"labelOutlineWidth"},anchor:{prop:"anchor"},height:{prop:"height"},width:{prop:"width"},url:{prop:"url"},color:{prop:"fillColor"},opacity:{prop:"fillOpacity"},outlineColor:{prop:"strokeColor"},outlineOpacity:{prop:"strokeOpacity"},outlineWidth:{prop:"strokeWidth"},radius:{prop:"radius"}};i(o,a,e),a.anchor.hasOwnProperty("val")&&(r.url=!a.url.hasOwnProperty("val")&&e.options.url?e.options.url:a.url.val,r.anchor=a.anchor.val),a.height.hasOwnProperty("val")&&(r.height=a.height.val),a.width.hasOwnProperty("val")&&(r.width=a.width.val),a.rotation.hasOwnProperty("val")&&(r.rotation=a.rotation.val),a.label.hasOwnProperty("val")&&(r.label=a.label.val),a.fontSize.hasOwnProperty("val")&&(r.fontSize=a.fontSize.val),a.fontColor.hasOwnProperty("val")&&(r.fontColor=t(a.fontColor.val)),a.outlineLabelColor.hasOwnProperty("val")&&(r.outlineLabelColor=t(a.outlineLabelColor.val)),a.outlineLabelWidth.hasOwnProperty("val")&&(r.outlineLabelWidth=a.outlineLabelWidth.val);return a.color.hasOwnProperty("val")&&(r.color=a.opacity.hasOwnProperty("val")?t(a.color.val,a.opacity.val):t(a.color.val)),a.outlineColor.hasOwnProperty("val")&&(r.outlineColor=a.outlineOpacity.hasOwnProperty("val")?t(a.outlineColor.val,a.outlineOpacity.val):t(a.outlineColor.val)),a.outlineWidth.hasOwnProperty("val")&&(r.outlineWidth=a.outlineWidth.val),a.radius.hasOwnProperty("val")&&(r.radius=a.radius.val),r},TC.feature.Marker&&e instanceof TC.feature.Marker)r.geometryType=function(t,i){var r={id:e.id,name:e.id,position:t[0],billboard:{image:i.url,width:i.width,height:i.height,eyeOffset:new Cesium.Cartesian3(0,0,-100),pixelOffset:new Cesium.Cartesian2(i.anchor[0],i.anchor[1]),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}};return i.label?[r,{id:e.id,name:e.id,position:t[0],label:{text:i.label,font:"14pt sans-serif",heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,fillColor:i.fontColor,showBackground:!0,eyeOffset:new Cesium.Cartesian3(0,0,-100)}}]:r};else if(TC.feature.Point&&e instanceof TC.feature.Point){var n=new Cesium.PinBuilder;r.geometryType=function(t,i){var r=i.label;return r&&!/^[0-9]*\-{0,1}[a-z]{0,4}$/gi.test(r)?{id:e.id,name:e.id,position:t[0],label:{text:i.label,font:"14px san-serif Arial",showBackground:!0,eyeOffset:new Cesium.Cartesian3(0,0,-100),heightReference:Cesium.HeightReference.CLAMP_TO_GROUND,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,verticalOrigin:Cesium.VerticalOrigin.BASELINE,fillColor:Cesium.Color.WHITE}}:/^[0-9]*\-{0,1}[a-z]{0,4}$/gi.test(r)?{id:e.id,name:e.id,position:t[0],billboard:{image:n.fromText(r,i.fontColor,48).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}}:{id:e.id,name:e.id,position:t[0],billboard:{image:n.fromColor(Cesium.Color.fromCssColorString(TC.Cfg.styles.point.fillColor),24).toDataURL(),eyeOffset:new Cesium.Cartesian3(0,0,-100),verticalOrigin:Cesium.VerticalOrigin.BOTTOM,heightReference:Cesium.HeightReference.CLAMP_TO_GROUND}}}}return r};this.convert=function(t,i,r,a){e=t;var l,c,u,p,m,d=[],C=function(e,t){e=TC.Util.reproject(e,r,a),t.push(e.length>2?Cesium.Cartesian3.fromDegrees(e[0],e[1],e[2]):Cesium.Cartesian3.fromDegrees(e[0],e[1]))},v=i.geometry,h=function(e,t){if($.isArray(e))for(var i=0;i<e.length;i++)C(e[i],t)},f=function(e,t){if($.isArray(e))for(var i=0;i<e.length;i++)t.push([]),h(e[i],t[t.length-1])},g=function(e){if($.isArray(e))for(var t=0;t<e.length;t++)d.push([]),f(e[t],d[d.length-1])};switch(!0){case TC.feature.MultiPolygon&&i instanceof TC.feature.MultiPolygon:m=v,$.isArray(m)&&(g(m),c=o.call(self,i));break;case TC.feature.Polygon&&i instanceof TC.feature.Polygon||TC.feature.MultiPolyline&&i instanceof TC.feature.MultiPolyline:p=v,$.isArray(p)&&(f(p,d),i instanceof TC.feature.Polygon?c=o(i):i instanceof TC.feature.MultiPolyline&&(c=n(i)));break;case TC.feature.Polyline&&i instanceof TC.feature.Polyline:u=v,$.isArray(u)&&(h(u,d),c=n(i));break;case TC.feature.Marker&&i instanceof TC.feature.Marker:u=[v],h(u,d),c=s(i);break;case TC.feature.Point&&i instanceof TC.feature.Point:u=[v],h(u,d),c=s(i)}return 0==d.length?null:l={id:i.id,attributes:i.data,geometry:c.geometryType(d,c.options()),boundigSphere:Cesium.BoundingSphere.fromPoints(d)}}},e.map3D=function(){var e={baseMap:"",baseMaps:[],baseVector:""},t={layers:[],getProperties:function(e){return e.options&&e.options.hasOwnProperty("4326")?(t.layers.push({
id:e.id,opts:e.options[4326]}),t.layers[t.layers.length-1].opts):null},findById:function(e){if(0==this.layers.length)return null;for(var t=0;t<this.layers.length;t++)if(this.layers[t].id.toLowerCase().trim()===e.toLowerCase().trim())return this.layers[t].opts;return null}},i=function(i){var r=this,a=i.baseLayer instanceof TC.layer.Raster;if(a?null==(crs=s.isCompatible(i.baseLayer))&&null==t.getProperties.call(r,r.map.baseLayer)&&i.toast(r.getLocaleString("threed.baseLayerNoCompatible",{name:i.baseLayer.layerNames})):e.baseVector=i.baseLayer,0===e.baseMaps.length)for(var o=0;o<i.baseLayers.length;o++)i.baseLayers[o]instanceof TC.layer.Raster&&!s.isCompatible(i.baseLayers[o])&&null==t.getProperties.call(r,i.baseLayers[o])&&e.baseMaps.push({l:i.baseLayers[o],i:o});e.baseMap=a?i.baseLayer:r.Consts.BLANK_BASE},r=function(t){var i=!1;if(e.baseMaps&&e.baseMaps.length){for(var r=0;r<e.baseMaps.length;r++)for(var a=0;a<t.baseLayers.length;a++)if(t.baseLayers[a]===e.baseMaps[r].l){e.baseMap==t.baseLayers[a]&&(i=!0),t.$events.trigger($.Event(TC.Consts.event.LAYERREMOVE,{layer:t.baseLayers[a]})),t.baseLayers.splice(a,1);break}i&&(t.baseLayer=t.baseLayers[0],t.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:t.baseLayer})))}},a=function(t){if(e.baseMaps&&e.baseMaps.length)for(var i=0;i<e.baseMaps.length;i++)t.$events.trigger($.Event(TC.Consts.event.LAYERADD,{layer:e.baseMaps[i].l})),t.baseLayers.splice(e.baseMaps[i].i,0,e.baseMaps[i].l)},s=new RasterConverter(/(EPSG\:?4326)/i),c=new FeatureConverter,m=function(){var e=new $.Deferred;return window.Cesium?e.resolve():TC.loadJS(!window.Cesium,[TC.Consts.url.CESIUM],function(){e.resolve()}),e},d=function(){var e=this;if(!TC.Util.detectMobile()){e.viewer.scene.screenSpaceCameraController.enableZoom=!1;var t,i=e.viewer.scene.canvas;t="onwheel"in i?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll",i.addEventListener(t,function(t){var i;if(t.deltaY){var r=t.deltaMode;i=r===t.DOM_DELTA_PIXEL?-t.deltaY:r===t.DOM_DELTA_LINE?40*-t.deltaY:120*-t.deltaY}else i=t.detail>0?-120*t.detail:t.wheelDelta;e.map3D.zoomToCartesian.call(e,e.map3D._lastMousePosition,i)},!1);var r=new Cesium.ScreenSpaceEventHandler(e.viewer.scene.canvas);r.setInputAction(function(t){e.map3D._lastMousePosition=t},Cesium.ScreenSpaceEventType.MOUSE_MOVE),r.setInputAction(function(t){e.map3D.zoomToCartesian.call(e,e.map3D._lastMousePosition,t)},Cesium.ScreenSpaceEventType.WHEEL);var a=new Cesium.Cartesian2,o=0;r.setInputAction(function(e){Cesium.Cartesian2.lerp(e.position1,e.position2,.5,a)},Cesium.ScreenSpaceEventType.PINCH_START),r.setInputAction(function(t){var i=t.distance.endPosition.y-t.distance.startPosition.y,r=i/e.viewer.scene.canvas.clientHeight;r=Math.min(r,e.viewer.scene.screenSpaceCameraController.maximumMovementRatio),o=r},Cesium.ScreenSpaceEventType.PINCH_MOVE),r.setInputAction(function(t){e.map3D.zoomToCartesian.call(e,{endPosition:a},o)},Cesium.ScreenSpaceEventType.PINCH_END)}},C=function(e){var t=e;switch(!0){case e instanceof Cesium.GroundPrimitive:this.viewer.scene.groundPrimitives.add(e);break;case e instanceof Object&&e.hasOwnProperty("billboard"):this.viewer.billboardCollection||(this.viewer.billboardCollection=this.viewer.scene.primitives.add(new Cesium.BillboardCollection({scene:this.viewer.scene})));var i=this.viewer.billboardCollection.add({position:e.position,image:e.billboard.image,verticalOrigin:e.billboard.verticalOrigin,heightReference:e.billboard.heightReference});t=i;break;case e instanceof Object:t=this.viewer.entities.add(e)}return t},v=function(e,t,i){e.vector2DFeatures.hasOwnProperty(t)?e.vector2DFeatures[t].push(i):e.vector2DFeatures[t]=[i]},h=[TC.Consts.event.BEFOREBASELAYERCHANGE,TC.Consts.event.BASELAYERCHANGE,TC.Consts.event.LAYERADD,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.LAYEROPACITY,TC.Consts.event.LAYERORDER,TC.Consts.event.FEATUREADD,TC.Consts.event.FEATUREREMOVE,TC.Consts.event.FEATURESCLEAR,TC.Consts.event.ZOOM,TC.Consts.event.ZOOMTO],f=function(e){var t=this,i=e.type+".tc";switch(!0){case i==TC.Consts.event.BEFOREBASELAYERCHANGE:t.waiting||(t.waiting=t.map.getLoadingIndicator().addWait());break;case i==TC.Consts.event.BASELAYERCHANGE:t.map3D.setBaseLayer.call(t,e.layer);break;case i==TC.Consts.event.LAYERADD:t.map3D.addLayer.call(t,e.layer);break;case i==TC.Consts.event.LAYERREMOVE:t.map3D.removeLayer.call(t,e.layer);break;case i==TC.Consts.event.LAYERVISIBILITY:t.map3D.setRenderOptionsLayer.call(t,e.layer,{visibility:e.layer.getVisibility()});break;case i==TC.Consts.event.LAYEROPACITY:t.map3D.setRenderOptionsLayer.call(t,e.layer,{opacity:e.layer.getOpacity()});break;case i==TC.Consts.event.LAYERORDER:for(var r=0;r<t.map3D.workLayers.length;r++)if(t.map3D.workLayers[r].imageryProvider&&t.map3D.workLayers[r].imageryProvider.layers.join(",")===e.layer.names.join(",")){if(e.oldIndex>e.newIndex)for(var a=e.oldIndex-e.newIndex,o=0;a>o;o++)t.viewer.scene.imageryLayers.lower(t.map3D.workLayers[r]);else for(var a=e.newIndex-e.oldIndex,o=0;a>o;o++)t.viewer.scene.imageryLayers.raise(t.map3D.workLayers[r]);t.map3D.workLayers.splice(e.newIndex,0,t.map3D.workLayers.splice(e.oldIndex,1)[0]);break}break;case i==TC.Consts.event.FEATUREADD:t.map3D.addFeature.call(t,e.feature);break;case i==TC.Consts.event.FEATUREREMOVE:if(t.map3D.vector2DFeatures&&t.map3D.vector2DFeatures.hasOwnProperty(e.layer.id)){for(var n=t.map3D.vector2DFeatures[e.layer.id],r=0;r<n.length;r++)t.map3D.removeFeature.call(t,n[r]);delete t.map3D.vector2DFeatures[e.layer.id]}break;case i==TC.Consts.event.FEATURESCLEAR:if(t.map3D.vector2DFeatures&&t.map3D.vector2DFeatures.hasOwnProperty(e.layer.id)){for(var n=t.map3D.vector2DFeatures[e.layer.id],r=0;r<n.length;r++)t.map3D.removeFeature.call(t,n[r]);delete t.map3D.vector2DFeatures[e.layer.id]}break;case i==TC.Consts.event.ZOOM:t.cameraControls&&!t.cameraControls.moving&&t.map3D.flyToMapCoordinates.call(t,t.mapView.getCenter());break;case i==TC.Consts.event.ZOOMTO:if(t.lastZoom&&performance.now()-t.lastZoom<50)return;t.lastZoom=performance.now();var s=TC.Util.reproject(e.extent.slice(0,2),t.map.crs,t.map3D.crs),l=TC.Util.reproject(e.extent.slice(2),t.map.crs,t.map3D.crs),c=Cesium.Rectangle.fromDegrees(s[0],s[1],l[0],l[1]);t.map3D.flyToRectangle.call(t,c)}},g=function(e){for(var t=this,i=0,r=t.map.controls.length;r>i;i++){var a=t.map.controls[i];if(t.ctrlsToMng.indexOf(a)<0)switch(!0){case t.direction.TO_TWO_D==e:a.enable();break;case t.direction.TO_THREE_D==e:a.disable()}}switch(!0){case t.direction.TO_TWO_D==e:$("[data-no-3d]").removeClass(TC.Consts.classes.HIDDEN),t.ctrlsToMng.forEach(function(e){e._$div.removeClass(TC.Consts.classes.THREED)});break;case t.direction.TO_THREE_D==e:$("[data-no-3d]").addClass(TC.Consts.classes.HIDDEN),t.ctrlsToMng.forEach(function(e){e._$div.addClass(TC.Consts.classes.THREED)})}t.map3D.linked2DControls.legend=new TwoDLinkedLegend(t)},w=function(){for(var e=this,t=new $.Deferred,i=[],r=0;r<e.threeDControls.length;r++){var a=e.threeDControls[r];a=a.substr(0,1).toUpperCase()+a.substr(1);var o=e.map.getControlsByClass("TC.control."+a);o&&o.length&&o[0].getLayer?i.push(o[0].getLayer()):o[0].layer?i.push(o[0].layer):o[0].layers&&o[0].layers.forEach(function(e){e instanceof TC.layer.Vector&&i.push(e)})}return $.when.apply($,i).then(function(){arguments&&arguments.length&&(e.map3D.vector2DLayers=Array.prototype.slice.call(arguments,0).filter(function(e){return e instanceof TC.layer.Vector}),e.map3D.vector2DLayers.forEach(function(t){t.features&&t.features.length&&t.features.forEach(function(t){e.map3D.addFeature.call(e,t)})})),t.resolve()}),t},y=function(e){var t,i,r,a=this,o=200,n=function(e){var t=this,i=new Cesium.Cartesian2(t.viewer.scene.canvas.clientWidth/2,t.viewer.scene.canvas.clientHeight/2);t.map3D.zoomToCartesian.call(t,{endPosition:i},e)};e?(t=function(e){var t=this;e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault();var i=TC.Util.reproject(t.map.options.initialExtent.slice(0,2),t.map.crs,t.map3D.crs),r=TC.Util.reproject(t.map.options.initialExtent.slice(2),t.map.crs,t.map3D.crs),a=Cesium.Rectangle.fromDegrees(i[0],i[1],r[0],r[1]);return t.map3D.flyToRectangle.call(t,a,{duration:.1}),!1}.bind(a),i=function(e){n.call(a,o)}.bind(a),r=function(e){n.call(a,-o)}.bind(a),$("."+TC.control.NavBar.prototype.CLASS+"-btn-home").on("click",t),$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomin").on("click",i),$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomout").on("click",r)):($("."+TC.control.NavBar.prototype.CLASS+"-btn-home").off("click",t),$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomin").off("click",i),$("."+TC.control.NavBar.prototype.CLASS+"-btn-zoomout").off("click",r))};return{crs:"EPSG:4326",crsPattern:/(EPSG\:?4326)/i,customRender:null,baseLayer:null,workLayers:[],vector2DLayers:[],vector2DFeatures:{},linked2DControls:{},isLoadingTiles:function(){var e=this,t=e.viewer.scene.globe._surface;return!t._tileProvider.ready||t._tileLoadQueueHigh.length>0||t._tileLoadQueueMedium.length>0||t._tileLoadQueueLow.length>0||t._debug.tilesWaitingForChildren>0},loadTerrainProvider:function(){var e=this;return e.terrainProvider||(e.terrainProvider=new Cesium.CesiumTerrainProvider({url:e.Consts.TERRAIN_URL,requestWaterMask:!0,requestVertexNormals:!0})),e.terrainProvider},loadViewer:function(){var e=this,t=new $.Deferred;return e.viewer?t.resolve(e.viewer):m().then(function(){var i=new Cesium.Globe;i.baseColor=Cesium.Color.WHITE,i.enableLighting=!0,e.viewer=e.map3D.viewer=new Cesium.Viewer(e.selectors.divThreedMap,{terrainProvider:e.map3D.loadTerrainProvider.call(e),terrainExaggeration:1,terrainShadows:Cesium.ShadowMode.ENABLED,animation:!1,timeline:!1,fullscreenButton:!1,baseLayerPicker:!1,imageryProvider:!1,navigationInstructionsInitiallyVisible:!1,navigationHelpButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,sceneModePicker:!1,selectionIndicator:!1,globe:i,useDefaultRenderLoop:!e.options.customRender}),e.options.customRender&&(e.map3D.customRender=new CustomRender(e.map,e.viewer,e.isSlower),e.map3D.customRender.start(e.options.isDebug||!1),e.map3D.customRender.parent=e),e.viewer.readyPromise=new $.Deferred,e.viewer.scene.backgroundColor=Cesium.Color.WHITE,e.viewer.scene.screenSpaceCameraController.enableCollisionDetection=!0,e.viewer.scene.screenSpaceCameraController.maximumZoomDistance=5e5,e.viewer.scene.globe.depthTestAgainstTerrain=!0,e.viewer.scene.imageryLayers.removeAll(),e.viewer.terrainProvider.errorEvent.addEventListener(function(e){if(e.error)switch(e.error.statusCode){case 403:case 404:}},e),e.viewer.scene.renderError.addEventListener(function(e){var t=this;t.$divThreedMap.addClass(t.classes.LOADING),t.map.toast("Error",{type:TC.Consts.msgType.ERROR})},e),e.map3D.tileLoadingHandler=new Cesium.EventHelper,e.map3D.tileLoadingHandler.add(e.viewer.scene.globe.tileLoadProgressEvent,function(t){e.waiting||(e.waiting=e.map.getLoadingIndicator().addWait()),0===t?(e.map.getLoadingIndicator().removeWait(e.waiting),delete e.waiting,e.viewer.readyPromise.resolve(),e.$events.trigger(TC.Consts.event.TERRAINLOADED,{})):e.$events.trigger(TC.Consts.event.TERRAINRECEIVING,{})}.bind(e)),d.call(e),y.call(e,!0),$(".cesium-viewer-bottom").remove(),e.map3D._event2DHandler=f.bind(e),e.map.on(h.join(" "),e.map3D._event2DHandler),g.call(e,e.direction.TO_THREE_D),w.call(e),t.resolve(e.viewer)}),t},setBaseLayer:function(a){var o=this;o.map3D.baseLayer?(o.map3D.baseLayer!==o.Consts.BLANK_BASE&&(o.viewer.scene.imageryLayers.raiseToTop(o.map3D.baseLayer),o.viewer.scene.imageryLayers.remove(o.map3D.baseLayer,!0)),a instanceof TC.layer.Vector?(o.map3D.baseLayer=o.Consts.BLANK_BASE,o.map.getLoadingIndicator().removeWait(o.waiting),delete o.waiting):(null!=(obj=t.findById(a.id))&&($.extend(obj,{map:o.map}),a=new TC.layer.Raster(obj),a.isBase=!0),o.map3D.addLayer.call(o,a))):(i.call(o,o.map),r.call(o,o.map),a instanceof TC.layer.Raster?(a.options.relatedWMTS?(o.map.baseLayer=a=o.map.getLayer(a.options.relatedWMTS),o.map.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:o.map.baseLayer}))):null!=(obj=t.findById(o.map.baseLayer.id))&&($.extend(obj,{map:o.map}),a=new TC.layer.Raster(obj),a.isBase=!0),o.map3D.addLayer.call(o,a)):o.map3D.baseLayer=o.Consts.BLANK_BASE),e.baseMap=o.map.baseLayer},addLayer:function(e){var t=this;switch(!0){case TC.Consts.layerType.VECTOR==e.type:t.map3D.vector2DLayers.push(e);break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:if(s.isCompatible(e)){var i=s.convert(e);if(i){var r=t.viewer.scene.imageryLayers.addImageryProvider(i);e.isBase?(t.map3D.baseLayer=r,t.viewer.scene.imageryLayers.lowerToBottom(r)):(r.show=e.getVisibility(),r.alpha=e.getOpacity(),t.map3D.workLayers.push(r),t.map3D.linked2DControls.legend.refresh())}}else t.map.toast(t.getLocaleString("threed.crsNoCompatible",{name:e.layerNames}))}},removeLayer:function(e){var t=this;switch(!0){case TC.Consts.layerType.VECTOR==e.type:if(t.map3D.vector2DFeatures&&t.map3D.vector2DFeatures.hasOwnProperty(e.id)){for(var i=t.map3D.vector2DFeatures[e.id],r=0;r<i.length;r++)t.map3D.removeFeature.call(t,i[r]);delete t.map3D.vector2DFeatures[e.id]}break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:for(var r=0;r<t.map3D.workLayers.length;r++)if(e.names&&t.map3D.workLayers[r].imageryProvider.layers.join(",")===e.names.join(",")||e.title&&t.map3D.workLayers[r].imageryProvider.layers.join(",")===e.title){t.viewer.scene.imageryLayers.raiseToTop(t.map3D.workLayers[r]),t.viewer.scene.imageryLayers.remove(t.map3D.workLayers[r],!0),t.map3D.workLayers.splice(r,1);break}}},setRenderOptionsLayer:function(e,t){var i=this;switch(!0){case TC.Consts.layerType.Vector==e.type:if(i.map3D.vector2DFeatures[e.id])for(var r=i.map3D.vector2DFeatures[e.id],a=0;a<r.length;a++)i.map3D.setRenderOptionsFeature(r[a],{show:!r[a].show});break;case TC.Consts.layerType.WMTS==e.type:case TC.Consts.layerType.WMS==e.type:for(var a=0;a<i.map3D.workLayers.length;a++)if(e.names&&i.map3D.workLayers[a].imageryProvider.layers.join(",")===e.names.join(",")||e.title&&i.map3D.workLayers[a].imageryProvider.layers.join(",")===e.title){t.hasOwnProperty("visibility")&&(i.map3D.workLayers[a].show=t.visibility),t.hasOwnProperty("opacity")&&(i.map3D.workLayers[a].alpha=t.opacity);break}}},flyToMapCoordinates:function(e){var t=this,i=TC.Util.reproject(e,t.map.crs,t.map3D.crs),r=t.viewer.camera.positionCartographic.height,a=Cesium.Cartesian3.fromDegrees(i[0],i[1],r),o=t.viewer.camera;o.flyTo({destination:a,orientation:{heading:o.heading,pitch:o.pitch}})},flyToRectangle:function(e,t){var i=this,r=$.Deferred();t=t||{};var a=Cesium.Math.EPSILON3;e.east===e.west&&(e.east+=a,e.west-=a),e.north===e.south&&(e.north+=a,e.south-=a);var o=.2,n=e.width*o/2,s=e.height*o/2;e.east-=n,e.west+=s,e.north+=s,e.south-=s;var l=i.viewer.scene,c=l.camera,u=c.getRectangleCameraCoordinates(e),m=Cesium.Ellipsoid.WGS84.cartesianToCartographic(u),d=l.globe.terrainProvider,C=6,v=[Cesium.Rectangle.center(e)];return Cesium.sampleTerrain(d,C,v).then(function(a){var o={longitude:m.longitude,latitude:m.latitude,height:m.height+a[0].height},n=Cesium.Ellipsoid.WGS84.cartographicToCartesian(o);i.$events.one(TC.Consts.event.TERRAINLOADED,function(){var t=c.getRectangleCameraCoordinates(e),a=Cesium.Ellipsoid.WGS84.cartesianToCartographic(t),o=i.viewer.scene.globe.getHeight(a),n={longitude:a.longitude,latitude:a.latitude,height:a.height+o},s=Cesium.Ellipsoid.WGS84.cartographicToCartesian(n);c.flyTo({duration:3,destination:s,complete:function(){var e=Cesium.Math.toRadians(50),t=p(this.viewer.scene);t=Cesium.Matrix4.fromTranslation(t),this.map3D.rotateAroundAxis(this.viewer.scene.camera,-e,this.viewer.scene.camera.right,t,{duration:250,callback:function(){r.resolve()}})}.bind(i)})}),c.flyTo({duration:t.duration||1,destination:n,complete:function(){i.map3D.isLoadingTiles.call(i)||i.$events.trigger(TC.Consts.event.TERRAINLOADED,{})}})}),r},zoomToCartesian:function(e,t){var i=this,r=i.viewer.scene;if(!e||!e.endPosition){var a=r.canvas,o=new Cesium.Cartesian2(a.clientWidth/2,a.clientHeight/2);e={endPosition:o}}var n=r.camera.getPickRay(e.endPosition),s=r.globe.pick(n,r);if(s){var l=Cesium.Cartesian3.distance(n.origin,s);if(1>l)return;i.map3D._zoomTo||(i.map3D._zoomTo={amount:0}),i.map3D._zoomTo.direction=t>0?1:0,i.map3D._zoomTo.amount+=5*l/100,i.map3D._zoomTo.endPosition=e.endPosition}var c=function(t){var i=this,r=i.viewer.scene,a=r.camera.getPickRay(e.endPosition||t.endPosition),o=r.globe.pick(a,r);if(o){var n=Cesium.Cartesian3.distance(a.origin,o);if(1>n)return;var s=r.camera.position,l=(r.camera.direction,toGo=new Cesium.Cartesian3);Cesium.Cartesian3.multiplyByScalar(a.direction,1==t.direction?t.amount:-t.amount,l),Cesium.Cartesian3.add(s,l,toGo);var c=new Cesium.Ray(toGo,a.direction),u=r.globe.pick(c,r);if(u){var p=function(){this.map3D._zoomTo={direction:1,amount:0,endPosition:{}}};Cesium.Cartesian3.distance(toGo,u)<1||Math.abs(Cesium.Ellipsoid.WGS84.cartesianToCartographic(toGo).height)<r.screenSpaceCameraController.minimumZoomDistance?p.call(i):i.viewer.camera.flyTo({destination:toGo,orientation:{heading:r.camera.heading,pitch:r.camera.pitch,roll:r.camera.roll},duration:1,easingFunction:Cesium.EasingFunction.LINEAR_NONE,complete:function(e){this.map3D._zoomTo={direction:1,amount:0,endPosition:{}}}.bind(i,Cesium.Cartesian3.distance(toGo,u))})}}};setTimeout(function(){c.call(i,i.map3D._zoomTo)}.bind(i),50)},rotateAroundAxis:function(e,t,i,r,a){return l(e,t,i,r,a)},addFeature:function(e,t){var i=this;if(!(i.map3D.linked2DControls.featureInfo&&e.layer===i.map3D.linked2DControls.featureInfo.layer&&e instanceof TC.feature.Marker)&&i.map3D.vector2DLayers.indexOf(e.layer)>-1){var r=c.convert(i.viewer.scene,e,i.map.crs,i.map3D.crs);if(r)if(r.geometry instanceof Array)r.geometry.forEach(function(t){t=C.call(i,t),v(i.map3D,e.layer.id,t)});else{var a=C.call(i,r.geometry);v(i.map3D,e.layer.id,a)}}},removeFeature:function(e){var t=this;if(e){switch(!0){case e instanceof Cesium.GroundPrimitive:t.viewer.scene.groundPrimitives.remove(e);break;case e instanceof Cesium.Billboard:t.viewer.billboardCollection.remove(e);break;case e instanceof Object:t.viewer.entities.removeById(e.id)}t.map3D.customRender.restart()}},setRenderOptionsFeature:function(e,t){e&&(e.show=t.show)},addNativeFeature:function(e){return C.call(this,e)},setCameraFromMapView:function(){var e=this,t=e.mapView.getCenter();if(t){var i=TC.Util.reproject(t,e.map.crs,e.map3D.crs),r=o.call(e,e.mapView.getResolution()||0,Cesium.Math.toRadians(i[0])),i=TC.Util.reproject(t,e.map.crs,e.map3D.crs),a=new Cesium.Cartographic(Cesium.Math.toRadians(i[0]),Cesium.Math.toRadians(i[1]));e.viewer.scene.globe&&(a.height=e.viewer.scene.globe.getHeight(a)||0);var n=Cesium.Ellipsoid.WGS84.cartographicToCartesian(a),s={pitch:Cesium.Math.toRadians(-90),heading:-e.mapView.getRotation(),roll:0};e.viewer.camera.setView({destination:n,orientation:s}),e.viewer.camera.moveBackward(r)}},setViewFromCameraView:function(){var e=this;if(!e.setViewFromCameraViewInProgress||"resolved"==e.setViewFromCameraViewInProgress.state()){e.setViewFromCameraViewInProgress=new $.Deferred;{var t=Cesium.Ellipsoid.WGS84,i=e.viewer.scene;target_=u(i)}if(!target_){var r=e.viewer.scene.globe,a=e.viewer.camera.positionCartographic.clone(),o=r.getHeight(a);a.height=o||0,target_=Cesium.Ellipsoid.WGS84.cartographicToCartesian(a)}var s=Cesium.Cartesian3.distance(target_,e.viewer.camera.position),l=t.cartesianToCartographic(target_),c=TC.Util.reproject([Cesium.Math.toDegrees(l.longitude),Cesium.Math.toDegrees(l.latitude)],e.map3D.crs,e.map.crs);e.mapView.setCenter(c),e.mapView.setResolution(n.call(e,s,l?l.latitude:0)),e.setViewFromCameraViewInProgress.resolve()}return e.setViewFromCameraViewInProgress},getInfoOnPickedPosition:function(e){var t=this;e&&(t.map.one(TC.Consts.event.DRAWTABLE,function(e){t.map.getLoadingIndicator().removeWait(t.waiting),delete t.waiting}),t.map3D.linked2DControls.featureInfo.send.call(t,e).then(function(e){t.map.getLoadingIndicator().removeWait(t.waiting),delete t.waiting}))},destroy:function(){var t=this;t.map3D.customRender.stop(),t.map3D.vector2DLayers=[],t.map3D.vector2DFeatures={},t.map.off(h.join(" "),t.map3D._event2DHandler),g.call(t,t.direction.TO_TWO_D),y.call(t,!1),a(),t.map.baseLayer=e.baseMap==t.Consts.BLANK_BASE?e.baseVector:e.baseMap,t.map.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:t.map.baseLayer})),e.baseMap="",t.map3D.baseLayer=null,t.map3D.workLayers=[],t.cameraControls.unbind(),t.map3D.linked2DControls.featureInfo&&t.map3D.linked2DControls.featureInfo.clear(t.map),t.map3D.tileLoadingHandler.removeAll(),delete t.map3D.tileLoadingHandler}}}(),e.browserSupportWebGL=function(){var e=this,t=!1;if(window.WebGLRenderingContext){var i=document.createElement("canvas"),r={alpha:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};try{var a=i.getContext("webgl",r)||i.getContext("experimental-webgl",r)||i.getContext("webkit-3d",r)||i.getContext("moz-webgl",r);a?t=!0:(r.failIfMajorPerformanceCaveat=!1,a=i.getContext("webgl",r)||i.getContext("experimental-webgl",r)||i.getContext("webkit-3d",r)||i.getContext("moz-webgl",r),a?(t="slow",e.isSlower=!0):t=!1)}catch(o){console.log(E)}if("slow"===t||!t){var n="slow"===t?"threed.slowSupport.supported":"threed.not.supported";e.map.toast(e.getLocaleString(n),{type:TC.Consts.msgType.WARNING,duration:1e4})}return t}t=!1}}();