TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control"),TC.control.Download=function(t){var e=this;e._classSelector="."+e.CLASS,TC.Control.apply(e,arguments);var o=t||{};e._$dialogDiv=$(TC.Util.getDiv(o.dialogDiv)),o.dialogDiv||e._$dialogDiv.appendTo("body")},TC.inherit(TC.control.Download,TC.Control),function(){var t=TC.control.Download.prototype;t.CLASS="tc-ctl-download",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/Download.html",t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/DownloadDialog.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"download"}).w(' <span class="tc-beta">').h("i18n",e,{},{$key:"beta"}).w('</span> </h2><div class="tc-ctl-sctnr tc-ctl-sctnr-select"><form><label class="tc-ctl-sctnr-tab tc-ctl-download-image" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="image" /><span>').h("i18n",e,{},{$key:"dl.export.map"}).w('</span></label><label class="tc-ctl-sctnr-tab tc-ctl-download-data" style="width:calc(100%/2 - 1px)"><input type="radio" name="sctnr-sel" value="data" /><span>').h("i18n",e,{},{$key:"dl.export.vector"}).w('</span></label></form></div><div class="tc-ctl tc-ctl-sctnr-elm tc-ctl-sctnr-elm-image tc-group tc-ctl-download-cnt tc-ctl-download-image tc-hidden"><label>').h("i18n",e,{},{$key:"format"}).w(':</label><select id="download-format-image" class="tc-combo"><option value="image/png">PNG</option><option value="image/jpeg">JPEG</option></select><div class="tc-ctl-download-div"><input id="tc-ctl-download-image-qr" class="tc-hidden" type="checkbox" checked style="display:none;" /><label for="tc-ctl-download-image-qr" class="tc-ctl-download-image-qr-label" title="').h("i18n",e,{},{$key:"createQrCodeToImage"}).w('">').h("i18n",e,{},{$key:"appendQRCode"}).w('</label></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"downloadImageFromCurrentMap"}).w('" name="descargar">').h("i18n",e,{},{$key:"download"}).w('</button></div></div><div class="tc-ctl tc-ctl-sctnr-elm tc-ctl-sctnr-elm-data tc-group tc-ctl-download-cnt tc-hidden"><label>').h("i18n",e,{},{$key:"format"}).w(':</label><select id="download-format" class="tc-combo"><option value="GML32">GML</option><option value="application/json">GeoJSON</option><option value="application/vnd.google-earth.kml+xml">KML (Google Earth)</option><option value="shape-zip">Shape (ESRI)</option></select><div class="tc-ctl-download-div"><i class="tc-ctl-download-help icon-question-sign" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"showDownloadHelp"}).w('"></i></div><div class="tc-group tc-group tc-ctl-download-cnt" style="text-align:right;"><button type="button" class="tc-ctl-download-btn tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"downloadLayersFromCurrentExtent"}).w('" name="descargar">').h("i18n",e,{},{$key:"download"}).w('</button></div><div class="tc-alert alert-warning tc-hidden"><p id="zoom-msg"><strong>').h("i18n",e,{},{$key:"tooManyFeatures"}).w(": </strong>").h("i18n",e,{},{$key:"tooManyFeatures.instructions"}).w('</p><p id="layers-msg"><strong>').h("i18n",e,{},{$key:"noLayersLoaded"}).w(": </strong>").h("i18n",e,{},{$key:"noLayersLoaded.instructions"}).w('</p><p id="url-msg"><strong>').h("i18n",e,{},{$key:"tooManySelectedLayers"}).w(": </strong>").h("i18n",e,{},{$key:"tooManySelectedLayers.instructions"}).w('</p><p id="noFeatures-msg"><strong>').h("i18n",e,{},{$key:"noData"}).w(": </strong>").h("i18n",e,{},{$key:"noData.instructions"}).w('</p><p id="novalid-msg"><strong>').h("i18n",e,{},{$key:"noValidService"}).w(": </strong>").h("i18n",e,{},{$key:"noValidService.instructions"}).w("</p></div></div>")}return dust.register(t.CLASS,e),e.__dustBody=!0,e},t.template[t.CLASS+"-dialog"]=function(){function e(t,e){return t.w(' <div class="tc-ctl-download-help-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"downloadData"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><p>').h("i18n",e,{},{$key:"dl.instructions.1|s"}).w("</p><ul><li>").h("i18n",e,{},{$key:"dl.instructions.2|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.3|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.4|s"}).w("<ul><li>").h("i18n",e,{},{$key:"dl.instructions.5|s"}).w("</li><li>").h("i18n",e,{},{$key:"dl.instructions.6|s"}).w('</li></ul></li></ul></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}return dust.register(t.CLASS+"-dialog",e),e.__dustBody=!0,e}),t.render=function(t){var e=this;e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._$dialogDiv.html(t)}).then(function(){TC.Control.prototype.render.call(e,function(){var o=(e.CLASS+"-seldisabled",".tc-ctl-sctnr");e._selectors={TAB:o+"-tab",RADIOBUTTON:"input[type=radio][name=sctnr-sel]",ELEMENT:o+"-elm"};var n=function(t){var o=$(this).closest(e._selectors.TAB).find(e._selectors.RADIOBUTTON),n=o.val(),l=e._$div.find(e._selectors.ELEMENT);e._oldValue===n&&e.options.deselectable?(setTimeout(function(){o.prop("checked",!1)},0),e._oldValue=null,$active=$(),$hidden=l):($active=l.filter(e._selectors.ELEMENT+"-"+n),$hidden=l.not($active),e._oldValue=n),$active.removeClass(TC.Consts.classes.HIDDEN),$hidden.addClass(TC.Consts.classes.HIDDEN),o.prop("checked",!0)};e._$div.find("span").on(TC.Consts.event.CLICK,n),t&&t()})})},t.register=function(t){var e=this;TC.Control.prototype.register.call(e,t);var o=function(){var t=window.location.href,e=t.indexOf("?"),o=t.indexOf("#");return e>0&&(t=o>e?t.replace(t.substring(e,o),""):t.replace(t.substring(e,t.length-1),"")),t},n=function(t){var e=$.Deferred(),o=150;return t?TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){t.length>o&&(t=TC.Util.shortenUrl(t)),$("body").append('<div id="qrcode"></div>');{var n=$("#qrcode");new QRCode(n.get(0),{text:t,width:85,height:85})}setTimeout(function(){var t=n.find("img").attr("src");n.remove(),e.resolve(t)},100)}):e.resolve(imgBase64),e.promise()},l=function(){var t=e.map.getLoadingIndicator().addWait(),l=$active.find("select").val();if($active.find("select").val().indexOf("image")>-1){var d,r=$.Deferred(),c=e.map.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0],s=TC.Util.cloneCanvas(c),p=e.map.getControlsByClass(TC.control.ScaleBar);if(0==p.length&&(p=new TC.control.ScaleBar,p.register(e.map),p.render()),p){var g=s.getContext("2d");g.save();var m=document.getElementsByClassName("ol-scale-line-inner"),u=m.item(0),v=$.extend({},u.getBoundingClientRect());m=document.getElementsByClassName(p[0].CLASS);var h=m.item(0),w=$.extend({},h.getBoundingClientRect()),y=u.textContent;g.beginPath(),g.strokeStyle=window.getComputedStyle(u).borderColor;var C,f;v.width>v.height?(C=v.width,f=v.height):(C=v.height,f=v.width),w.left=v.left=15,w.left=w.left-2,w.top=v.top=15,w.top--,g.moveTo(v.left,v.top),g.lineTo(v.left,v.top+f),g.lineTo(v.left+C,v.top+f),g.lineTo(v.left+C,v.top),g.stroke();var T=(g.measureText(y),{x:v.left+C/2,y:v.top+f/2});g.globalAlpha=.5,g.fillStyle=window.getComputedStyle(h).backgroundColor,C+=4,f+=4,g.fillRect(w.left,w.top,C,f),g.globalAlpha=1,g.fillStyle=window.getComputedStyle(u).color,g.font=window.getComputedStyle(u).fontSize+" "+window.getComputedStyle(u).fontFamily,g.textAlign="center",g.textBaseline="middle",g.fillText(y,T.x,T.y)}$active.find("#tc-ctl-download-image-qr:checked").length>0?$.when(n(o())).then(function(o){if(o){var n=s.getContext("2d");n.fillStyle="#ffffff",n.fillRect(s.width-91,s.height-91,91,91),$.when(TC.Util.addToCanvas(s,o,{x:s.width-88,y:s.height-88})).then(function(t){r.resolve(t)})}else TC.error(e.getLocaleString("dl.export.map.error")+": QR"),e.map.getLoadingIndicator().removeWait(t)}):r.resolve(s),$.when(r).then(function(o){try{d=o.toDataURL(l),TC.Util.downloadDataURI(window.location.hostname+"_"+TC.Util.getFormattedDate((new Date).toString(),!0)+"."+l.split("/")[1],l,d)}catch(n){TC.error(e.getLocaleString("dl.export.map.error")+": "+n.message)}e.map.getLoadingIndicator().removeWait(t)})}else{var b=(a(),e.map.getExtent()),S=TC.WFSGetFeatureBuilder(e.map,b,l,!0);$.when.apply($,S).then(function(){var o=$.grep(arguments,function(t){return null!=t});if(0===o.length)return void i({layers:!0},t);for(var n=[],l=0;l<o.length;l++)if(o[l].err)switch(o[l].err){case"NumMaxFeatures":i({zoom:!0,serviceName:o[l].service.mapLayer.title},t);break;case"NameResolutionFailure":i({noValid:!0,serviceName:o[l].service.mapLayer.title},t);break;default:i({noValid:!0,serviceName:o[l].service.mapLayer.title},t)}else{var a=o[l].data,d=o[l].url;a&&d&&n.push({url:d+"?download=zip",data:a})}TC.Util.downloadFileForm(n),e.map.getLoadingIndicator().removeWait(t)})}},a=function(){for(var t=[],o=0;o<e.map.workLayers.length;o++){var n=e.map.workLayers[o];n.type===TC.Consts.layerType.WMS&&n.getVisibility()&&n.names.length>0&&t.push(n)}return t},i=function(t,o){var n,l=e._$div.find(".alert-warning");t.zoom?n=l.find("#zoom-msg").html().format({serviceName:t.serviceName}):t.layers?n=e.getLocaleString("noLayersLoaded"):t.url?n=e.getLocaleString("tooManySelectedLayers"):t.noFeatures?n=l.find("#noFeatures-msg").html():t.noValid&&(n=l.find("#novalid-msg").html().format({serviceName:t.serviceName})),e.map.toast(n,{type:TC.Consts.msgType.WARNING}),e.map.getLoadingIndicator().removeWait(o)},d=function(t){t.stopPropagation(),TC.Util.showModal(e._$dialogDiv.find(e._classSelector+"-help-dialog"))};e._$div.on(TC.Consts.event.CLICK,".tc-ctl-download-btn",l),e._$div.on(TC.Consts.event.CLICK,".tc-ctl-download-help",d)}}();