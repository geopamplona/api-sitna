TC.control=TC.control||{},TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient"),function(){TC.Consts.classes.CONNECTION_OFFLINE=TC.Consts.classes.CONNECTION_OFFLINE||"tc-conn-offline",TC.Consts.classes.CONNECTION_WIFI=TC.Consts.classes.CONNECTION_WIFI||"tc-conn-wifi",TC.Consts.classes.CONNECTION_MOBILE=TC.Consts.classes.CONNECTION_MOBILE||"tc-conn-mobile",TC.Consts.classes.OFFLINE=TC.Consts.classes.OFFLINE||"tc-offline";var e="already_exists",t=window.applicationCache;TC._appCacheBuilders||(TC._appCacheBuilders=[]),TC._appCacheUpdater||(TC._appCacheUpdater=function(t,a){for(var n=(TC.Util.getQueryStringParams(a),0),s=TC._appCacheBuilders.length;s>n;n++){var r=TC._appCacheBuilders[n];switch(t.type){case"cached":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEDOWNLOAD,{url:a}));break;case"obsolete":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEDELETE,{url:a}));break;case"checking":break;case"progress":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEPROGRESS,{url:a,loaded:t.loaded,total:t.total}));break;case"error":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEERROR,{url:a,reason:t.reason,status:t.status}));break;case"noupdate":case"updateready":r.$events.trigger($.Event(TC.Consts.event.MAPCACHEERROR,{url:a,reason:e,status:t.status}))}}});var a,n=function(){var e=window.parent!==window&&document.referrer&&TC.Util.isSameOrigin(document.referrer)&&parent.TC&&parent.TC._appCacheUpdater;return function(t){e&&parent.TC._appCacheUpdater(t,location.href)}}(),s=function(){var e=$.Deferred();if(a&&a.length)e.resolve(a);else{var t=$("html").attr("manifest");t?$.ajax({url:t,type:"GET",dataType:"text"}).done(function(t){var a=t.indexOf("NETWORK:");a>=0&&(t=t.substr(0,a)),a=t.indexOf("FALLBACK:"),a>=0&&(t=t.substr(0,a)),a=t.indexOf("SETTINGS:"),a>=0&&(t=t.substr(0,a));var n=$.grep(t.split(/[\n\r]/),function(e){return e.length>0&&0!==e.indexOf("#")&&"CACHE:"!==e});n.shift(),e.resolve(n)}).fail(function(){e.reject()}):e.reject()}return e};t.addEventListener("cached",n,!1),t.addEventListener("error",n,!1),t.addEventListener("noupdate",n,!1),t.addEventListener("obsolete",n,!1),t.addEventListener("progress",n,!1),t.addEventListener("updateready",n,!1),TC.control.CacheBuilder=function(){var e=this;TC.control.SWCacheClient.apply(this,arguments);var t=e._classSelector="."+e.CLASS;e._selectors={DRAW:t+"-draw",DRAWING:t+"-drawing",PROGRESS:t+"-progress",NEW:t+"-new",LIST:t+"-list",LISTITEM:t+"-list > li",DELBTN:t+"-btn-del",OKBTN:t+"-btn-ok",NEWBTN:t+"-btn-new",SAVEBTN:".tc-btn-save",CANCELBTN:".tc-btn-cancel",EDITBTN:".tc-btn-edit",VIEWBTN:".tc-btn-view",DELETEBTN:".tc-btn-delete",TILECOUNT:t+"-tile-count",NAMETB:t+"-txt-name",TEXTBOX:"input.tc-textbox",EXIT:t+"-link-exit",OFFPANEL:t+"-off-panel",BLLIST:t+"-bl-list",BLLISTITEM:t+"-bl-list > li",BLLISTTEXT:t+"-bl-panel-txt",RNGMAXRES:t+"-rng-maxres",SEARCH:t+"-map-available-srch",EMPTYLIST:t+"-map-available-empty",OFFLINEHIDDEN:"[data-no-cb]"},e.storedMaps=[],TC._appCacheBuilders.push(e);try{if(window.localStorage){for(var a=0,n=localStorage.length;n>a;a++){var s=localStorage.key(a);if(0===s.indexOf(e.LOCAL_STORAGE_KEY_PREFIX)){var r=localStorage.getItem(s).split(" "),o=i(r.shift()),l=r.join(" "),c={name:l,extent:o,url:decodeURIComponent(s.substr(e.LOCAL_STORAGE_KEY_PREFIX.length))};e.storedMaps.push(c)}}e.storedMaps.sort(function(e,t){return e.name>t.name?1:e.name<t.name?-1:0})}}catch(d){TC.error(e.getLocaleString("couldNotAccessLocalStorage"))}var C=$.extend({},n>1?arguments[1]:arguments[0]);e._$dialogDiv=$(TC.Util.getDiv(C.dialogDiv)),C.dialogDiv||e._$dialogDiv.appendTo("body"),e.mapIsOffline=location.pathname.indexOf("/"+e.CACHE_REQUEST_PATH)===location.pathname.length-e.CACHE_REQUEST_PATH.length-1,e.mapIsOffline&&$(e._selectors.OFFLINEHIDDEN).addClass(TC.Consts.classes.HIDDEN),TC.Control.apply(e,arguments),e.wrap=new TC.wrap.control.CacheBuilder(e),e.isDownloading=!1,e.baseLayers=[],e.options.avgTileSize=e.options.avgTileSize||TC.Cfg.avgTileSize,e.requestSchemas=[],e.minResolution=0,e.currentMap=null,e._loadedCount=0;var u=history.pushState;history.pushState=function(t){var a;if(a=u.apply(history,arguments),e._$offlinePanelDiv){var n=location.pathname.replace("/"+e.CACHE_REQUEST_PATH,"/"),s=TC.Util.getQueryStringParams();delete s[e.MAP_DEFINITION_PARAM_NAME],delete s[e.MAP_EXTENT_PARAM_NAME],delete s[e.SERVICE_WORKER_FLAG];var r=$.param(s);r.length&&(r="?"+r);var i=n+r+location.hash;e._$offlinePanelDiv.find(e._selectors.EXIT).attr("href",i)}return a};var f=navigator.connection||navigator.mozConnection||navigator.webkitConnection||{},p=function(){if(e._$offlinePanelDiv){var t=e._$offlinePanelDiv.find(e._selectors.OFFPANEL);t.removeClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI);var a=f.type;switch(a){case 1:case 2:case void 0:t.addClass(TC.Consts.classes.CONNECTION_WIFI);break;default:t.addClass(TC.Consts.classes.CONNECTION_MOBILE)}}};f.addEventListener&&f.addEventListener("typechange",p),window.addEventListener("online",p),window.addEventListener("offline",function(){e._$offlinePanelDiv&&e._$offlinePanelDiv.find(e._selectors.OFFPANEL).addClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI)})},TC.inherit(TC.control.CacheBuilder,TC.control.SWCacheClient);var r=TC.control.CacheBuilder.prototype;r.CLASS="tc-ctl-cbuild",r.MAP_DEFINITION_PARAM_NAME="map-def",r.MAP_EXTENT_PARAM_NAME="map-extent",r.LOCAL_STORAGE_KEY_PREFIX="TC.offline.map.",r.COOKIE_KEY_PREFIX="TC.offline.map.",r.CACHE_REQUEST_PATH="offline",r.SERVICE_WORKER_FLAG="sw",r._states={READY:"ready",EDIT:"editing",DOWNLOADING:"downloading",DELETING:"deleting"},r._actions={CREATE:"create",DELETE:"delete"},r.offlineControls=["attribution","basemapSelector","cacheBuilder","click","coordinates","draw","edit","geolocation","loadingIndicator","measure","navBar","popup","print","scale","scaleBar","scaleSelector","state","fullScreen"],TC.Consts.event.MAPCACHEDOWNLOAD=TC.Consts.event.MAPCACHEDOWNLOAD||"mapcachedownload.tc",TC.Consts.event.MAPCACHEDELETE=TC.Consts.event.MAPCACHEDELETE||"mapcachedelete.tc",TC.Consts.event.MAPCACHEPROGRESS=TC.Consts.event.MAPCACHEPROGRESS||"mapcacheprogress.tc",TC.Consts.event.MAPCACHEERROR=TC.Consts.event.MAPCACHEERROR||"mapcacheerror.tc",r.template={},TC.isDebug?(r.template[r.CLASS]=TC.apiLocation+"TC/templates/CacheBuilder.html",r.template[r.CLASS+"-map-node"]=TC.apiLocation+"TC/templates/CacheBuilderMapNode.html",r.template[r.CLASS+"-bl-node"]=TC.apiLocation+"TC/templates/CacheBuilderBaseLayerNode.html",r.template[r.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/CacheBuilderDialog.html",r.template[r.CLASS+"-off-panel"]=TC.apiLocation+"TC/templates/CacheBuilderOfflinePanel.html"):(r.template[r.CLASS]=function(){function e(e,r){return e.w("<h2>").h("i18n",r,{},{$key:"offlineMaps"}).w('</h2><div class="tc-ctl-cbuild-content"><div class="tc-ctl-cbuild-draw tc-hidden"></div><i class="tc-ctl-cbuild-map-search-icon"></i><input type="search" list="').f(r.get(["listId"],!1),r,"h").w('" class="tc-ctl-cbuild-map-available-srch tc-textbox" placeholder="').h("i18n",r,{},{$key:"cb.filter.plhr"}).w('"').x(r.get(["storedMaps"],!1),r,{"else":t,block:a},{}).w(' maxlength="200" /> <ul id="').f(r.get(["listId"],!1),r,"h").w('" class="tc-ctl-cbuild-list"><li class="tc-ctl-cbuild-map-available-empty"').x(r.get(["storedMaps"],!1),r,{block:n},{}).w("><span>").h("i18n",r,{},{$key:"cb.noMaps"}).w('</span></li><li class="tc-ctl-cbuild-map-not" hidden><span>').h("i18n",r,{},{$key:"noMatches"}).w("</span></li>").s(r.get(["storedMaps"],!1),r,{block:s},{}).w('</ul><div class="tc-ctl-cbuild-new"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-new" disabled title="').h("i18n",r,{},{$key:"newofflinemap"}).w('">').h("i18n",r,{},{$key:"newOfflineMap"}).w('</button></div><div class="tc-ctl-cbuild-drawing tc-hidden"><div class="tc-ctl-cbuild-tile-cmd"><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-draw" title="').h("i18n",r,{},{$key:"cancel"}).w('">').h("i18n",r,{},{$key:"cancel"}).w('</button></div></div><div class="tc-ctl-cbuild-progress tc-hidden"><p>').h("i18n",r,{},{$key:"cb.DownloadingMap|s"}).w(': <span class="tc-ctl-cbuild-progress-count"></span></p><div class="tc-ctl-cbuild-progress-bar"><div class="tc-ctl-cbuild-progress-ratio" style="width:0"></div></div><button class="tc-button tc-icon-button tc-ctl-cbuild-btn-cancel-dl" title="').h("i18n",r,{},{$key:"cancel"}).w('">').h("i18n",r,{},{$key:"cancel"}).w("</button></div></div>")}function t(e,t){return e.w(" disabled")}function a(e,t){return e}function n(e,t){return e.w(" hidden")}function s(e,t){return e.p("tc-ctl-cbuild-map-node",t,t.rebase(t.getPath(!0,[])),{})}return dust.register(r.CLASS,e),e.__dustBody=!0,t.__dustBody=!0,a.__dustBody=!0,n.__dustBody=!0,s.__dustBody=!0,e},r.template[r.CLASS+"-map-node"]=function(){function e(e,t){return e.w('<li data-extent="').f(t.get(["extent"],!1),t,"h").w('"><span><a href="').f(t.get(["url"],!1),t,"h").w('" title="').f(t.get(["name"],!1),t,"h").w('">').f(t.get(["name"],!1),t,"h").w('</a></span><input class="tc-textbox tc-hidden" type="text" value="').f(t.get(["name"],!1),t,"h").w('" /><button class="tc-btn-save tc-hidden" title="').h("i18n",t,{},{$key:"save"}).w('"></button><button class="tc-btn-cancel tc-hidden" title="').h("i18n",t,{},{$key:"cancel"}).w('"></button><button class="tc-btn-edit" title="').h("i18n",t,{},{$key:"editMapName"}).w('">').h("i18n",t,{},{$key:"editMapName"}).w('</button><button class="tc-btn-view" title="').h("i18n",t,{},{$key:"viewMapExtent"}).w('">').h("i18n",t,{},{$key:"viewMapExtent"}).w('</button><button class="tc-btn-delete" title="').h("i18n",t,{},{$key:"deleteMap"}).w('">').h("i18n",t,{},{$key:"deleteMap"}).w("</button></li>")}return dust.register(r.CLASS+"-map-node",e),e.__dustBody=!0,e},r.template[r.CLASS+"-bl-node"]=function(){function e(e,t){return e.w('<li class="tc-ctl-cbuild-bl-node" data-tc-layer-uid="').f(t.get(["id"],!1),t,"h").w('"><label style="background-size: 100% 100%; background-image: url(').f(t.get(["thumbnail"],!1),t,"h").w(')"><input type="checkbox" name="cbbl" value="').f(t.get(["id"],!1),t,"h").w('" disabled><span>').f(t.get(["title"],!1),t,"h").w("</span></label></li>")}return dust.register(r.CLASS+"-bl-node",e),e.__dustBody=!0,e},r.template[r.CLASS+"-dialog"]=function(){function e(e,t){return e.w('<div class="tc-ctl-cbuild-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",t,{},{$key:"newOfflineMap"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><input type="text" class="tc-ctl-cbuild-txt-name" placeholder="').h("i18n",t,{},{$key:"nameRequired"}).w('" required /><div class="tc-ctl-cbuild-bl-panel"><h4>').h("i18n",t,{},{$key:"availableOfflineMaps"}).w("</h4><p>").h("i18n",t,{},{$key:"selectAtLeastOne"}).w(':</p><ul class="tc-ctl-cbuild-bl-list"></ul></div><div class="tc-ctl-cbuild-res-panel"><h4>').h("i18n",t,{},{$key:"maxRes"}).w('</h4><div class="tc-ctl-cbuild-res"></div><input type="range" class="tc-ctl-cbuild-rng-maxres" disabled value="0" title="').h("i18n",t,{},{$key:"maxRes"}).w('"></div><div class="tc-ctl-cbuild-tile-count"></div></div><div class="tc-modal-footer"><button class="tc-button tc-modal-close tc-ctl-cbuild-btn-ok" disabled>').h("i18n",t,{},{$key:"ok"}).w('</button><button type="button" class="tc-button tc-modal-close tc-ctl-cbuild-btn-cancel">').h("i18n",t,{},{$key:"cancel"}).w("</button></div></div></div>")}return dust.register(r.CLASS+"-dialog",e),e.__dustBody=!0,e},r.template[r.CLASS+"-off-panel"]=function(){function e(e,t){return e.w('<div class="tc-ctl-cbuild-off-panel tc-conn-wifi"><span>').h("i18n",t,{},{$key:"offlineMap"}).w('</span> <a href="" class="tc-ctl-cbuild-link-exit" title="').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w('"><span>').h("i18n",t,{},{$key:"returnToOnlineMaps"}).w("</span></a></div>")}return dust.register(r.CLASS+"-off-panel",e),e.__dustBody=!0,e});var i=function(e){return $.map(decodeURIComponent(e).split(","),function(e){return parseFloat(e)})},o=function(e){e._state=e._states.READY,e.showDownloadProgress(0,1),e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.NEW).removeClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.LISTITEM).removeClass(TC.Consts.classes.DISABLED),e._$div.find(e._selectors.DELBTN).prop("disabled",!1),e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0),e._$div.find(e._selectors.NEWBTN).prop("disabled",!1),e._$dialogDiv.find(e._selectors.TILECOUNT).html(""),e.extent=null,e._loadedCount=0,e.boxDraw&&e.boxDraw.cancel()},l=function(e){e._state=e._states.EDITING,e.showDownloadProgress(0,1),e._$div.find(e._selectors.NEW).addClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.DRAWING).removeClass(TC.Consts.classes.HIDDEN),e.map.toast(e.getLocaleString("clickOnDownloadAreaFirstCorner"),{type:TC.Consts.msgType.INFO}),e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0),e._$div.find(e._selectors.NEWBTN).prop("disabled",!0),e._$dialogDiv.find(e._selectors.NAMETB).val(""),e.boxDraw.activate()},c=function(e){e._state=e._states.DOWNLOADING,TC.Util.closeModal(),e.showDownloadProgress(0,1),e._$div.find(e._selectors.NEW).addClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.PROGRESS).removeClass(TC.Consts.classes.HIDDEN),e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0),e._$div.find(e._selectors.NEWBTN).prop("disabled",!0),e.layer.clearFeatures(),e.boxDraw.cancel()},d=function(e){e._state=e._states.DELETING,e.showDownloadProgress(0,1),e._$div.find(e._selectors.DRAWING).addClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.PROGRESS).addClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.NEW).removeClass(TC.Consts.classes.HIDDEN),e._$div.find(e._selectors.LISTITEM).addClass(TC.Consts.classes.DISABLED),e._$div.find(e._selectors.DELBTN).prop("disabled",!0),e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!0),e._$div.find(e._selectors.NEWBTN).prop("disabled",!1),e._$dialogDiv.find(e._selectors.TILECOUNT).html(""),e.boxDraw.cancel()},C=function(e,t){t.find("span").first().addClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.TEXTBOX).removeClass(TC.Consts.classes.HIDDEN).val(t.find("span a").html()).focus(),t.find(e._selectors.SAVEBTN).removeClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.CANCELBTN).removeClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.EDITBTN).addClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.VIEWBTN).addClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.DELETEBTN).addClass(TC.Consts.classes.HIDDEN)},u=function(e,t){t.find("span").first().removeClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.TEXTBOX).addClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.SAVEBTN).addClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.CANCELBTN).addClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.EDITBTN).removeClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.VIEWBTN).removeClass(TC.Consts.classes.HIDDEN),t.find(e._selectors.DELETEBTN).removeClass(TC.Consts.classes.HIDDEN)},f=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")},p=function(e,t){var a,n,s,r=t||{},i=e._$dialogDiv.find(e._classSelector+"-res"),o=e._$dialogDiv.find(e._selectors.RNGMAXRES),l=e.getResolutions();if(l.length){if(e.minResolution){if(void 0===r.rangeValue)for(var c=0,d=l.length;d>c;c++)if(e.minResolution>=l[c]){o.val(c);break}}else void 0===r.rangeValue&&o.val(Math.floor(l.length/2));n=parseInt(o.attr("max",l.length-1).val());var C=Math.floor(1e3*new Number(l[n]))/1e3;a=e.getLocaleString("metersPerPixel",{value:C.toLocaleString((e.map?e.map.options.locale:TC.Cfg.locale).replace("_","-"))}),s=100*(n+1)/(l.length+1)+"%",o.prop("disabled",!1),e.minResolution=l[o.val()]}else n=0,a="",o.val(0),s="0",e.minResolution=0,o.prop("disabled",!0);i.css("left",s).html(a)},v=function(e,t){for(var a=null,n=0,s=e.tileMatrixLimits.length;s>n&&(a=e.tileMatrixLimits[n],!(a.res<=t));n++);return a},T=function(e){var t=e._$dialogDiv.find(e._classSelector+"-bl-node input[type=checkbox]");t.each(function(t,a){var n=$(a);if(n.prop("checked")){var s=e.requestSchemas.filter(function(e){return e.layerId===n.val()})[0];if(s){var r=v(s,e.minResolution);if(r){var i="{TileMatrix}",o="{TileRow}",l="{TileCol}",c=s.url;if(c.indexOf(i)<0){var d=c.indexOf("?");d>=0&&(c=c.substr(0,d));for(var C=0,u=e.baseLayers.length;u>C;C++){var f=e.baseLayers[C];if(f.id===s.layerId){c=c+"?layer="+f.layerNames+"&style=default&tilematrixset="+f.matrixSet+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+f.format+"&TileMatrix="+i+"&TileRow="+o+"&TileCol="+l;break}}}n.parent("label").css("background-size","auto").css("background-position","left bottom").css("background-image","url("+c.replace("{TileMatrix}",r.mId).replace(o,r.rt).replace(l,r.cl)+")")}}}})},E=function(e,t){var a;return a=1>t?e.getLocaleString("lessThan1Mb"):e.getLocaleString("approxXMb",{quantity:f(t)})},g=function(e){var t="";e.tileCount=0;for(var a=0,n=e.requestSchemas.length;n>a;a++)for(var s=e.requestSchemas[a],r=0,i=s.tileMatrixLimits.length;i>r;r++){var o=s.tileMatrixLimits[r];if(e.tileCount+=(o.cr-o.cl+1)*(o.rb-o.rt+1),o.res<e.minResolution)break}e.tileCount&&(e.estimatedMapSize=Math.round(e.tileCount*e.options.avgTileSize/1048576),t=e.getLocaleString("xTiles",{quantity:f(e.tileCount)})+" ("+E(e,e.estimatedMapSize)+")"),e._$dialogDiv.find(e._selectors.TILECOUNT).html(t)},h=function(e,t){return e._$div.find(e._selectors.LISTITEM).filter(function(e,a){return $(a).find("a").first().html()===t})},_=function(e,t){var a=t.indexOf("#");return a>=0&&(t=t.substr(0,a)),e._$div.find(e._selectors.LISTITEM).filter(function(e,a){return $(a).find("a").first().attr("href")===t})},b=function(e,t){$("<iframe>").css("display","none").attr("src",t).appendTo(e._$div)},N=function(e,t){var a=e._$div.find('iframe[src="'+t+'"]');a.remove()},I=function(e,t){var a=!1;return window.localStorage&&(localStorage.setItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t.url),t.extent+" "+t.name),a=!0),a},L=function(e,t){var a=!1;return window.localStorage&&(localStorage.removeItem(e.LOCAL_STORAGE_KEY_PREFIX+encodeURIComponent(t)),a=!0),a},S=function(e){var t=e.currentMap;I(e,t)&&(e.getRenderedHtml(e.CLASS+"-map-node",{name:t.name,url:t.url},function(t){e._$div.find(e._selectors.LIST).append(t),e._$div.find(e._selectors.EMPTYLIST).attr("hidden","hidden"),e._$div.find(e._selectors.SEARCH).prop("disabled",!1)}),e.storedMaps.push(t))},D=function(e,t){var a=e.findStoredMap({url:t});if(a){L(e,t)&&h(e,a.name).remove();var n=$.inArray(a,e.storedMaps);return e.storedMaps.splice(n,1),e.storedMaps.length||(e._$div.find(e._selectors.SEARCH).prop("disabled",!0),e._$div.find(e._selectors.EMPTYLIST).removeAttr("hidden")),a.name}return null},A=function(e){e._$dialogDiv.find(e._selectors.OKBTN).prop("disabled",!e.extent||0===e._$dialogDiv.find(e._selectors.NAMETB).val().length||e._$dialogDiv.find(e._selectors.RNGMAXRES).prop("disabled"))};r.render=function(e){var t=this,a={storedMaps:t.storedMaps,listId:t.CLASS+"-list-"+TC.getUID()};t.getRenderedHtml(t.CLASS+"-dialog",null,function(e){t._$dialogDiv.html(e),t._$dialogDiv.find(t._selectors.NAMETB).on(TC.Consts.event.CLICK,function(e){e.preventDefault(),this.selectionStart=0,this.selectionEnd=this.value.length,this.focus()})}).then(function(){t.renderData(a,function(){t._$dialogDiv.find(t._selectors.OKBTN).on(TC.Consts.event.CLICK,function(){var e={mapName:t._$dialogDiv.find(t._selectors.NAMETB).val()};if(t.findStoredMap({name:e.mapName}))TC.alert(t.getLocaleString("cb.mapNameAlreadyExists.error",e));else{var a=function(){t._$div.find(t._classSelector+"-name").html(e.mapName),t.map.toast(t.getLocaleString("downloadingMap",{mapName:e.mapName})),c(t),t.requestCache(e)},n=navigator.temporaryStorage||navigator.webkitTemporaryStorage||{};if(n.queryUsageAndQuota)n.queryUsageAndQuota(function(n,s){var r=(s-n)/1048576;t.estimatedMapSize<r?a():TC.confirm(t.getLocaleString("cb.mapCreation.warning.reasonSize",{mapName:e.mapName,mapSize:E(t,t.estimatedMapSize),availableStorage:E(t,Math.round(r))}),a)},function(e){TC.error(e)});else{var r=TC.Util.detectIE();if(r){var i=12>r?1e3:2e3,o=0,l=function(){var n=t.tileCount+o;n>i?TC.confirm(t.getLocaleString("cb.mapCreation.warning.reasonCount",{mapName:e.mapName,resourceCount:f(n),maxResourceCount:f(i)}),a):a()};s().done(function(e){o=e.length,l()}).fail(l)}else a()}}}),t._$dialogDiv.find(t._selectors.NAMETB).on("input",function(){A(t)}),t._$div.find(t._selectors.NEWBTN).on(TC.Consts.event.CLICK,function(){l(t)}),t._$div.find(t._classSelector+"-btn-cancel-draw").on(TC.Consts.event.CLICK,function(){o(t)}),t._$div.find(t._classSelector+"-btn-cancel-dl").on(TC.Consts.event.CLICK,function(){t.cancelCacheRequest()}),t._$div.find(t._selectors.LIST).on(TC.Consts.event.CLICK,t._selectors.DELETEBTN,function(e){if(navigator.onLine){$btn=$(e.target);var a=$btn.parent().find("a").html();if(a){var n=t.getLocaleString("cb.delete.confirm",{mapName:a});t.serviceWorkerEnabled||(n=n+" "+t.getLocaleString("cb.delete.confirm.connect.warning")),confirm(n)&&(navigator.onLine?(d(t),t.deleteMap(a)):TC.alert(t.getLocaleString("cb.delete.conn.alert")))}}else TC.alert(t.getLocaleString("cb.delete.conn.alert"))}).on(TC.Consts.event.CLICK,t._selectors.EDITBTN,function(e){C(t,$(e.target).parent())}).on(TC.Consts.event.CLICK,t._selectors.CANCELBTN,function(e){var a=$(e.target).parent();a.find(t._selectors.TEXTBOX).val(a.find("a").html()),u(t,$(e.target).parent())}).on(TC.Consts.event.CLICK,t._selectors.SAVEBTN,function(e){var a=$(e.target).parent();u(t,a);var n=a.find("a"),s=(n.html(),a.find(t._selectors.TEXTBOX).val()),r=t.findStoredMap({url:n.attr("href")});r&&(r.name=s,n.html(s),n.attr("title",s),I(t,r))}).on(TC.Consts.event.CLICK,t._selectors.VIEWBTN,function(e){$btn=$(e.target);var a=!$btn.hasClass(TC.Consts.classes.ACTIVE);t._$div.find(t._selectors.VIEWBTN).removeClass(TC.Consts.classes.ACTIVE).parent().removeClass(TC.Consts.classes.ACTIVE);var n=$btn.parent().find("a").html();if(n){var s=t.findStoredMap({name:n});if(s){var r=i(s.extent);t.layer.clearFeatures(),a&&(t.layer.addPolygon([[[r[0],r[1]],[r[0],r[3]],[r[2],r[3]],[r[2],r[1]]]],{showsPopup:!1}).then(function(){t.layer.map.zoomToFeatures(t.layer.features)}),$btn.addClass(TC.Consts.classes.ACTIVE),$btn.parent().addClass(TC.Consts.classes.ACTIVE),$btn.attr("title",t.getLocaleString("removeMapExtent")))}}});var a=function(e){e=e.toLowerCase();var a=t._$div.find(t._selectors.LISTITEM).hide(),n=a.filter("li:not([class]),li."+TC.Consts.classes.ACTIVE);if(0===e.length)n.show(),t._$div.find(t._classSelector+"-map-search-icon").css("visibility","visible");else{t._$div.find(t._classSelector+"-map-search-icon").css("visibility","hidden");var s=new RegExp(e,"i");n.each(function(){var e=$(this);e.toggle(s.test(e.find("a").text()))}),0===n.filter(":visible").length&&a.filter('[class^="tc-ctl-cbuild-map-not"]').show()}},n=t._$div.find(t._selectors.SEARCH);n.on("keyup search",function(){a($(this).val().toLowerCase().trim())});try{if(n.has($("::-ms-clear"))){var r;n.on("mouseup",function(e){r=n.val(),""!==r&&setTimeout(function(){var e=n.val();""===e&&a(e)},1)})}}catch(v){}t._$dialogDiv.find(t._selectors.BLLIST).on("change","input[type=checkbox]",function(e){t.baseLayers.length=0,t._$dialogDiv.find(t._selectors.BLLIST+" input[type=checkbox]").each(function(e,a){var n=$(a);if(n.prop("checked"))for(var s=n.val(),r=0,i=t.map.baseLayers.length;i>r;r++){var o=t.map.baseLayers[r];if(o.id===s&&o.type===TC.Consts.layerType.WMTS){t.baseLayers[t.baseLayers.length]=o;break}}}),t.updateRequestSchemas(),p(t),T(t),A(t),g(t)}),t._$dialogDiv.find(t._selectors.RNGMAXRES).on("input change",function(e){p(t,{rangeValue:$(e.target).val()}),T(t),g(t)});TC.Util.getQueryStringParams();_(t,location.href).addClass(TC.Consts.classes.ACTIVE),$.isFunction(e)&&e()})}),window.addEventListener("beforeunload",function(e){if(t.isDownloading){var a=t.getLocaleString("cb.mapDownloading.warning");return e.returnValue=a,a}},!0)},r.register=function(a){var n=this;if(TC.control.SWCacheClient.prototype.register.call(n,a),navigator.serviceWorker){navigator.serviceWorker.addEventListener("message",function(e){switch(e.data.event){case"progress":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEPROGRESS,{url:e.data.name,loaded:e.data.count,total:e.data.total}));break;case"cached":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEDOWNLOAD,{url:e.data.name}));break;case"deleted":n.$events.trigger($.Event(TC.Consts.event.MAPCACHEDELETE,{url:e.data.name}));break;case"error":e.data.action===n._actions.CREATE&&TC.error(n.getLocaleString("cb.resourceDownload.error",{url:e.data.url}))}});var r=function(){s().then(function(e){n.cacheUrlList(e,{silent:!0})})},l=function(){n.deleteCache(n.LOCAL_STORAGE_KEY_PREFIX,{silent:!0})};t.status===t.CACHED||t.status===t.UPDATEREADY||t.status===t.UNCACHED?r():(t.addEventListener("cached",r,!1),t.addEventListener("updateready",r,!1),t.addEventListener("downloading",l,!1),t.addEventListener("obsolete",l,!1))}n.mapIsOffline&&(a._$div.addClass(TC.Consts.classes.OFFLINE),n._$offlinePanelDiv=$(TC.Util.getDiv(n.options.offlinePanelDiv)),n.options.offlinePanelDiv||n._$offlinePanelDiv.appendTo(a._$div),n.getRenderedHtml(n.CLASS+"-off-panel",null,function(e){n._$offlinePanelDiv.html(e),navigator.onLine||n._$offlinePanelDiv.find(n._selectors.OFFPANEL).addClass(TC.Consts.classes.CONNECTION_OFFLINE).removeClass(TC.Consts.classes.CONNECTION_MOBILE).removeClass(TC.Consts.classes.CONNECTION_WIFI),n._$offlinePanelDiv.find(n._selectors.EXIT).on(TC.Consts.event.CLICK,function(e){TC.confirm(n.getLocaleString("offlineMapExit.confirm"),null,function(){e.preventDefault()})})})),n.layer=null,a.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0}).then(function(e){n.layer=e,TC.loadJS(!TC.control.Draw,TC.apiLocation+"TC/control/Draw",function(){n.boxDraw=new TC.control.Draw({div:n._$div.find(n._selectors.DRAW),mode:TC.Consts.geom.RECTANGLE,layer:n.layer}),n.boxDraw.$events.on(TC.Consts.event.DRAWSTART,function(e){n.map.toast(n.getLocaleString("clickOnDownloadAreaOppositeCorner"),{type:TC.Consts.msgType.INFO})}).on(TC.Consts.event.DRAWEND,function(e){var t=e.geometry.geometry[0],a=t[0],s=t[2],r=Math.min(a[0],s[0]),i=Math.max(a[0],s[0]),o=Math.min(a[1],s[1]),l=Math.max(a[1],s[1]);n.setExtent([r,o,i,l]);var c=n._$dialogDiv.find("input[type=checkbox]");c.each(function(e,t){for(var a=0,s=n.map.baseLayers.length;s>a;a++){var r=n.map.baseLayers[a];if(t.value===r.id){var i=$(t),o=i.parents("li").first(),l=r.getResolutions(),c=n.wrap.getRequestSchemas({extent:n.extent,layers:[r]})[0].tileMatrixLimits;c.length&&l[l.length-1]==c[c.length-1].res?o.removeClass(TC.Consts.classes.HIDDEN):(i.prop("checked",!1),o.addClass(TC.Consts.classes.HIDDEN));break}}});var d;d=n._$dialogDiv.find(n._selectors.BLLISTITEM).filter(":not(."+TC.Consts.classes.HIDDEN+")").length?"selectAtLeastOne":"cb.noMapsAtSelectedExtent",n._$dialogDiv.find(n._selectors.BLLISTTEXT).html(n.getLocaleString(d)),T(n),g(n),TC.Util.showModal(n._$dialogDiv.find(n._classSelector+"-dialog"),{openCallback:function(){c.prop("disabled",!1);var e;if(Date.prototype.toLocaleString){var t={};t.year=t.month=t.day=t.hour=t.minute=t.second="numeric",e=(new Date).toLocaleString(n.map.options.locale.replace("_","-"),t)}else e=(new Date).toString();n._$dialogDiv.find(n._selectors.NAMETB).val(e)[0];A(n)},closeCallback:function(){c.prop("disabled",!0),n.layer.clearFeatures()}})}),a.on(TC.Consts.event.CONTROLDEACTIVATE,function(e){n.boxDraw===e.control&&n._state===n._states.EDITING&&o(n)}),a.addControl(n.boxDraw)})});var c=function(e){var t=!1,a=n._$dialogDiv.find(n._selectors.BLLIST),s=function(){return a.find('li[data-tc-layer-uid="'+e.id+'"]').length>0},r=e.type===TC.Consts.layerType.WMTS;return TC.Util.detectSafari()&&TC.Util.detectIOS()&&(r=r&&TC.Util.isSameOrigin(e.url)),r&&!s()&&(t=!0,n.getRenderedHtml(n.CLASS+"-bl-node",e,function(e){s()||a.append(e)})),t};a.on(TC.Consts.event.LAYERADD,function(e){c(e.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){e.layer.type===TC.Consts.layerType.WMTS&&n._$dialogDiv.find(n._selectors.BLLIST).find('li[data-tc-layer-uid="'+e.layer.id+'"]').remove()});var d=TC.Util.getQueryStringParams(),C=d[n.MAP_DEFINITION_PARAM_NAME],u=d[n.MAP_EXTENT_PARAM_NAME];a.ready(function(){if(n.mapIsOffline){for(var e=[],t=0,s=n.offlineControls.length;s>t;t++){var r=n.offlineControls[t];r=r.substr(0,1).toUpperCase()+r.substr(1),e=e.concat(a.getControlsByClass("TC.control."+r))}for(var t=0,s=a.controls.length;s>t;t++){var i=a.controls[t];e.indexOf(i)<0&&i.disable()}$(n._selectors.OFFLINEHIDDEN).addClass(TC.Consts.classes.HIDDEN)}}),a.loaded(function(){if(a.putLayerOnTop(n.layer),n._firstRender.then(function(){n._$div.find(n._selectors.NEWBTN).prop("disabled",!1);for(var e=0,t=a.baseLayers.length;t>e;e++)c(a.baseLayers[e])}),n.mapIsOffline){var e=JSON.parse(window.atob(decodeURIComponent(C))),t=[],s=$.grep(a.baseLayers,function(a){var n=!1;if(a.type===TC.Consts.layerType.WMTS)for(var s=0,r=e.layers.length;r>s;s++){var i=e.layers[s],o=0===a.url.indexOf("//")?location.protocol+a.url:a.url;if(o===e.url[i.urlIdx]&&a.layerNames===i.id&&a.matrixSet===e.tms[i.tmsIdx]){n=!0;break}}return n||a.type!==TC.Consts.layerType.VECTOR&&(t[t.length]=a),n})[0];s&&a.setBaseLayer(s);for(var r=0,o=t.length;o>r;r++)a.removeLayer(t[r]);a.setExtent(i(u))}}),n.$events.on(TC.Consts.event.MAPCACHEDOWNLOAD,function(e){n.isDownloading=!1;var t=function(e){var t=e.indexOf("#");return t>=0?e.substr(0,t):e},s=t(e.url),r=_(n,s);r.length&&!n.serviceWorkerEnabled?(r.removeClass(TC.Consts.classes.DISABLED),r.find(n._selectors.DELBTN).prop("disabled",!1),TC.alert(n.getLocaleString("cb.delete.error"))):n.currentMap&&s===n.currentMap.url&&(S(n),a.toast(n.getLocaleString("mapDownloaded",{mapName:n.currentMap.name}))),n.currentMap=null,N(n,e.url),o(n)}).on(TC.Consts.event.MAPCACHEDELETE,function(e){n.isDownloading=!1;var t=D(n,e.url)||n.currentMap&&n.currentMap.name;N(n,e.url),n.currentMap=null,t&&(document.cookie=n.COOKIE_KEY_PREFIX+"delete=; expires=Thu, 01 Jan 1970 00:00:01 GMT;",a.toast(n.getLocaleString("mapDeleted",{mapName:t}))),o(n)}).on(TC.Consts.event.MAPCACHEPROGRESS,function(e){var t=e.total;!t&&n.requestSchemas&&(t=n.requestSchemas[0].tileCount);var a=e.loaded;a?n._loadedCount=a:(n._loadedCount+=1,a=n._loadedCount),n.showDownloadProgress(a,t)}).on(TC.Consts.event.MAPCACHEERROR,function(t){n.isDownloading=!1,N(n,t.url),o(n);var a=n.getLocaleString("cb.mapCreation.error"),s=!0;switch(t.reason){case"quota":a+=". "+n.getLocaleString("cb.mapCreation.error.reasonQuota");break;case"resource":a+=". "+n.getLocaleString("cb.mapCreation.error.reasonResource");break;case"manifest":"410"==t.status&&D(n,t.url),s=!1;break;case e:a+=". "+n.getLocaleString("cb.mapCreation.error.reasonAlreadyExists")}s&&(TC.Util.detectIE()?(TC.error(a),TC.alert(n.getLocaleString("cb.mapCreation.error.reasonIE"))):TC.alert(a)),n.currentMap=null})},r.setExtent=function(e){var t=this;$.isArray(e)&&e.length>=4&&(t.extent=e,t.updateRequestSchemas())},r.cacheUrlList=function(e,t){var a=this,n=t||{};a.createCache(n.name||a.LOCAL_STORAGE_KEY_PREFIX+"common",{urlList:e,silent:n.silent})},r.requestCache=function(e){var t=this,a=e||{};if(t.map){var n=a.extent||t.extent||t.map.getExtent();if(t.updateRequestSchemas({extent:n}),t.requestSchemas){for(var s=function(e,a,n){var s=e.res>=t.minResolution;return!s&&a>0&&(s=n[a-1].res>t.minResolution),s},r=function(e){return{mId:e.mId,cl:e.cl,cr:e.cr,rt:e.rt,rb:e.rb}},i=t.requestSchemas.map(function(e){return{layerId:e.layerId,tileMatrixLimits:e.tileMatrixLimits.filter(s)
}}),o=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],l=0,c=i.length;c>l;l++){var d=i[l],C=d.tileMatrixLimits[d.tileMatrixLimits.length-1],u=C.res*C.tSize;o[0]=Math.min(o[0],C.origin[0]+u*C.cl),o[1]=Math.min(o[1],C.origin[1]-u*(C.rb+1)),o[2]=Math.max(o[2],C.origin[0]+u*(C.cr+1)),o[3]=Math.max(o[3],C.origin[1]-u*C.rt),d.tileMatrixLimits=d.tileMatrixLimits.map(r)}var f=Math.pow(10,t.map.wrap.isGeo()?TC.Consts.DEGREE_PRECISION:TC.Consts.METER_PRECISION);o=o.map(function(e,t){var a=3>t?Math.ceil:Math.floor;return a(e*f)/f});for(var p={bBox:o,res:Math.floor(1e3*t.minResolution)/1e3,url:[],tms:[],format:[],layers:new Array(t.baseLayers.length)},l=0,c=t.baseLayers.length;c>l;l++){var v=t.baseLayers[l],T=0===v.url.indexOf("//")?location.protocol+v.url:v.url,E=$.inArray(T,p.url);0>E&&(E=p.url.push(T)-1);var g=$.inArray(v.matrixSet,p.tms);0>g&&(g=p.tms.push(v.matrixSet)-1);var h=v.format.substr(v.format.indexOf("/")+1),_=$.inArray(h,p.format);0>_&&(_=p.format.push(h)-1),p.layers[l]={urlIdx:E,id:v.layerNames,tmsIdx:g,formatIdx:_}}var N=TC.Util.getQueryStringParams(),I=N[t.MAP_EXTENT_PARAM_NAME]=o.toString();N[t.MAP_DEFINITION_PARAM_NAME]=btoa(JSON.stringify(p)),t.serviceWorkerEnabled&&(N[t.SERVICE_WORKER_FLAG]=1);var L=location.origin+location.pathname.substr(0,location.pathname.lastIndexOf("/")+1)+t.CACHE_REQUEST_PATH+"?"+$.param(N);if(t.currentMap={name:a.mapName,extent:I,url:L},t.isDownloading=!0,t.serviceWorkerEnabled)for(var l=0,c=i.length;c>l;l++){for(var S=i[l],D=null,A=0,y=t.baseLayers.length;y>A;A++){var M=t.baseLayers[A];if(M.id===S.layerId){D=t.wrap.getGetTilePattern(M);break}}if(D){urlList=[];var O=0;for(k=0,lenk=S.tileMatrixLimits.length;k<lenk;k++){var C=S.tileMatrixLimits[k];for(M=C.cl;M<=C.cr;M++)for(m=C.rt;m<=C.rb;m++)urlList[O++]=D.replace("{TileMatrix}",C.mId).replace("{TileCol}",M).replace("{TileRow}",m)}urlList.push(L),t.cacheUrlList(urlList,{name:L})}}else b(t,L)}}},r.cancelCacheRequest=function(){var e=this;e.currentMap&&(N(e,e.currentMap.url),e.deleteCache(e.currentMap.url).then(function(t){t||(e.currentMap=null)})),e.isDownloading=!1,o(e)},r.deleteMap=function(e){var t=this,a=t.findStoredMap({name:e});if(a){var n=TC.Util.getQueryStringParams(a.url);t.deleteCache(a.url).then(function(e){e||(document.cookie=t.COOKIE_KEY_PREFIX+"delete="+atob(decodeURIComponent(n[t.MAP_DEFINITION_PARAM_NAME])),b(t,a.url))})}},r.findStoredMap=function(e){var t=this;return $.grep(t.storedMaps,function(t){var a=!0;return e.name&&e.name!==t.name&&(a=!1),a&&e.url&&e.url!==t.url&&(a=!1),a})[0]},r.showDownloadProgress=function(e,t){var a=this,n=a._classSelector,s=a._$div.find(n+"-progress-count");if(t){var r=Math.min(Math.round(100*e/t),100),i=r+"%";a._$div.find(n+"-progress-ratio").css("width",i),s.html(i)}else a._$div.find(n+"-progress-bar").addClass(TC.Consts.classes.HIDDEN),s.html(a.getLocaleString("xFiles",{quantity:e}))},r.updateRequestSchemas=function(e){var t=this,a=e||{};return a.extent=a.extent||t.extent,a.layers=a.layers||t.baseLayers,t.requestSchemas=t.wrap.getRequestSchemas(a),t.requestSchemas},r.getResolutions=function(){for(var e=this,t=[],a=function(e){return e.res},n=e.requestSchemas.map(function(e){return e.tileMatrixLimits.map(a)}),s=Number.POSITIVE_INFINITY,r=0,i=0,o=n.length;o>i;i++){var l=n[i];s=Math.min(s,l[0]),r=Math.max(r,l[l.length-1])}for(var i=0,o=n.length;o>i;i++)t=t.concat(n[i].filter(function(e){return s>=e&&e>=r&&t.indexOf(e)<0}));return t.sort(function(e,t){return t-e}),t}}();