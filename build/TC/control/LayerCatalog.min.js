TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control"),TC.control.LayerCatalog=function(){var t=this;t.layers=[],t.searchInit=!1,TC.Control.apply(t,arguments),t._readyDeferred=$.Deferred(),TC.Consts.classes.SELECTABLE||(TC.Consts.classes.SELECTABLE="tc-selectable"),TC.Consts.classes.INCOMPATIBLE||(TC.Consts.classes.INCOMPATIBLE="tc-incompatible"),TC.Consts.classes.ACTIVE||(TC.Consts.classes.ACTIVE="tc-active"),t._$div.on("mouseup.tc","li",function(e){var s=$(e.target);s.hasClass(t.CLASS+"-leaf")||(s.toggleClass(TC.Consts.classes.COLLAPSED),s.find("ul").first().toggleClass(TC.Consts.classes.COLLAPSED),e.stopPropagation())})},TC.inherit(TC.control.LayerCatalog,TC.Control),function(){var t=TC.control.LayerCatalog.prototype;t.CLASS="tc-ctl-lcat",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/LayerCatalog.html",t.template[t.CLASS+"-branch"]=TC.apiLocation+"TC/templates/LayerCatalogBranch.html",t.template[t.CLASS+"-node"]=TC.apiLocation+"TC/templates/LayerCatalogNode.html",t.template[t.CLASS+"-info"]=TC.apiLocation+"TC/templates/LayerCatalogInfo.html",t.template[t.CLASS+"-results"]=TC.apiLocation+"TC/templates/LayerCatalogResults.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"availableLayers"}).x(e.get(["enableSearch"],!1),e,{block:s},{}).w('</h2><div class="tc-ctl-lcat-search tc-hidden tc-collapsed"><div class="tc-group"><input type="search" class="tc-ctl-lcat-input tc-textbox" placeholder="').h("i18n",e,{},{$key:"textToSearchInLayers"}).w('" /></div><ul></ul></div><div class="tc-ctl-lcat-tree">').x(e.get(["layerTrees"],!1),e,{"else":n,block:r},{}).w('</div><div class="tc-ctl-lcat-info tc-hidden">').p("tc-ctl-lcat-info",e,e.rebase(e.getPath(!0,[])),{}).w("</div>")}function s(t,e){return t.x(e.get(["layerTrees"],!1),e,{block:a},{})}function a(t,e){return t.w('<button class="tc-ctl-lcat-btn-search" title="').h("i18n",e,{},{$key:"searchlayersbytext"}).w('"></button>')}function n(t,e){return t.w('<div class="tc-ctl tc-ctl-lcat-loading"><span>').h("i18n",e,{},{$key:"loadingLayerTree"}).w("...</span></div>")}function r(t,e){return t.w('<ul class="tc-ctl-lcat-branch">').s(e.get(["layerTrees"],!1),e,{block:l},{}).w("</ul>")}function l(t,e){return t.p("tc-ctl-lcat-branch",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS,e),e.__dustBody=!0,s.__dustBody=!0,a.__dustBody=!0,n.__dustBody=!0,r.__dustBody=!0,l.__dustBody=!0,e},t.template[t.CLASS+"-branch"]=function(){function e(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{"else":s,block:a},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><span>').f(e.get(["title"],!1),e,"h").w('</span><ul class="tc-ctl-lcat-branch tc-collapsed">').s(e.get(["children"],!1),e,{block:n},{}).w("</ul></li>")}function s(t,e){return t.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}function a(t,e){return t.w('class="tc-ctl-lcat-node tc-collapsed"')}function n(t,e){return t.p("tc-ctl-lcat-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-branch",e),e.__dustBody=!0,s.__dustBody=!0,a.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-node"]=function(){function e(t,e){return t.x(e.get(["isVisible"],!1),e,{block:s},{})}function s(t,e){return t.w("<li ").x(e.get(["children"],!1),e,{"else":a,block:n},{}).w(' data-tc-layer-name="').f(e.get(["name"],!1),e,"h").w('" data-tc-layer-uid="').f(e.get(["uid"],!1),e,"h").w('"><span data-tooltip="').x(e.get(["name"],!1),e,{block:r},{}).w('">').f(e.get(["title"],!1),e,"h").w("</span>").x(e.get(["name"],!1),e,{block:l},{}).w('<ul class="tc-ctl-lcat-branch tc-collapsed">').s(e.get(["children"],!1),e,{block:o},{}).w("</ul></li>")}function a(t,e){return t.w('class="tc-ctl-lcat-node tc-ctl-lcat-leaf"')}function n(t,e){return t.w('class="tc-ctl-lcat-node tc-collapsed"')}function r(t,e){return t.h("i18n",e,{},{$key:"clickToAddToMap"})}function l(t,e){return t.w('<button class="tc-ctl-lcat-btn-info"/>')}function o(t,e){return t.p("tc-ctl-lcat-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-node",e),e.__dustBody=!0,s.__dustBody=!0,a.__dustBody=!0,n.__dustBody=!0,r.__dustBody=!0,l.__dustBody=!0,o.__dustBody=!0,e},t.template[t.CLASS+"-info"]=function(){function e(t,e){return t.w('<a class="tc-ctl-lcat-info-close"></a><h2>').h("i18n",e,{},{$key:"layerInfo"}).w('</h2><h3 class="tc-ctl-lcat-title">').f(e.get(["title"],!1),e,"h").w("</h3>").x(e.get(["abstract"],!1),e,{block:s},{}).x(e.get(["metadata"],!1),e,{block:a},{})}function s(t,e){return t.w('<div class="tc-ctl-lcat-abstract"><h4>').h("i18n",e,{},{$key:"abstract"}).w("</h4><div>").f(e.get(["abstract"],!1),e,"h").w("</div></div>")}function a(t,e){return t.w('<div class="tc-ctl-lcat-metadata"><h4>').h("i18n",e,{},{$key:"metadata"}).w("</h4><ul>").s(e.get(["metadata"],!1),e,{block:n},{}).w("</ul></div>")}function n(t,e){return t.w('<li><a href="').f(e.get(["url"],!1),e,"h",["s"]).w('" type="').f(e.get(["format"],!1),e,"h").w('" title="').f(e.get(["formatDescription"],!1),e,"h").w('" target="_blank">').f(e.get(["formatDescription"],!1),e,"h").w("</a></li>")}return dust.register(t.CLASS+"-info",e),e.__dustBody=!0,s.__dustBody=!0,a.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-results"]=function(){function e(t,e){return t.s(e.get(["servicesFound"],!1),e,{"else":s,block:a},{})}function s(t,e){return t.w('<li class="tc-ctl-lcat-no-results"><h5>').h("i18n",e,{},{$key:"noMatches"}).w("</h5></li>")}function a(t,e){return t.h("gt",e,{block:n},{key:e.get(["servicesLooked"],!1),value:1}).s(e.get(["founds"],!1),e,{block:l},{}).h("gt",e,{block:c},{key:e.get(["servicesLooked"],!1),value:1})}function n(t,e){return t.w('<li class="tc-ctl-lcat-search-group ').x(e.getPath(!1,["service","isCollapsed"]),e,{block:r},{}).w('" data-tc-service-index="').f(e.getPath(!1,["service","index"]),e,"h").w('"><h5>').f(e.getPath(!1,["service","title"]),e,"h").w("</h5><ul>")}function r(t,e){return t.w("tc-collapsed")}function l(t,e){return t.w('<li data-tc-layer-name="').f(e.get(["Name"],!1),e,"h").w('" ').x(e.get(["alreadyAdded"],!1),e,{"else":o,block:i},{}).w('><h5 class="tc-selectable">').f(e.get(["Title"],!1),e,"h").w('</h5><button class="tc-ctl-lcat-search-btn-info" /></li>')}function o(t,e){return t.w(' data-tooltip="').h("i18n",e,{},{$key:"clickToAddToMap"}).w('" ')}function i(t,e){return t.w(' data-tooltip="').h("i18n",e,{},{$key:"layerAlreadyAdded"}).w('" class="tc-checked" ')}function c(t,e){return t.w("</ul></li>")}return dust.register(t.CLASS+"-results",e),e.__dustBody=!0,s.__dustBody=!0,a.__dustBody=!0,n.__dustBody=!0,r.__dustBody=!0,l.__dustBody=!0,o.__dustBody=!0,i.__dustBody=!0,c.__dustBody=!0,e}),function(){var e={LAYER:"tcLayer",LAYERNAME:"tcLayerName",LAYERINFO:"tcLayerInfo",SERVICEINDEX:"tcServiceIndex"},s=3,a="data-tooltip";t.register=function(t){var s=this;TC.Control.prototype.register.call(s,t);var n=function(){if($.isArray(s.options.layers)){for(var t=0;t<s.options.layers.length;t++){var e=s.options.layers[t];e.type&&e.type!==TC.Consts.layerType.WMS||(e.id||(e.id=TC.getUID()),$.isPlainObject(e)&&(e=new TC.layer.Raster(e)),s.layers.push(e))}s.render(function(){s._readyDeferred.resolve()})}else s._readyDeferred.resolve()},r=function(e){e.layer===t.baseLayer&&(n(),t.off(TC.Consts.event.LAYERUPDATE,r))};t.loaded(function(){t.baseLayer.state&&t.baseLayer.state!==TC.Layer.state.IDLE?t.on(TC.Consts.event.LAYERUPDATE,r):n()});var l=function(t){var a=$();if(!t.isBase){var n=t.options.url;s._$roots&&s._$roots.each(function(s,r){var l=$(r),o=l.data(e.LAYER);o&&o.type===t.type&&o.options.url===n&&(a=a.add(l))})}return a},o=function(t,e){var s=$(),a=e||l(t);if(a.length)for(var n=0;n<t.names.length;n++){var r=a.find('li[data-tc-layer-name="'+t.names[n]+'"]');s=s.add(r),s=s.add(r.find("li"))}return s},i=function(t){var a=$();if(!t.isBase){var n=t.options.url;s.$list&&s.$list.find("li").each(function(s,r){var l=$(r),o=l.data(e.LAYER);if(o&&o.type===t.type&&o.options.url===n)for(var i=0;i<t.names.length;i++)l.is('li[data-tc-layer-name="'+t.names[i]+'"]')&&(a=a.add(l))})}return a},c=function(){if("createEvent"in document){var t=document.createEvent("HTMLEvents");t.initEvent("keyup",!1,!0),s.$text&&s.$text[0].dispatchEvent(t)}else s.$text&&s.$text[0].fireEvent("keyup")},d=function(t){var e=s.map.getControlsByClass(TC.control.ListTOC)[0];if(e)for(var n=e.layers,r=0;r<n.length;r++){var l=n[r];l!==t&&o(l).addClass(TC.Consts.classes.CHECKED).find("span").attr(a,C)}},C=s.getLocaleString("layerAlreadyAdded"),u=s.getLocaleString("clickToAddToMap");t.on(TC.Consts.event.BEFORELAYERADD+" "+TC.Consts.event.BEFOREUPDATEPARAMS,function(t){o(t.layer).hasClass(TC.Consts.classes.LOADING)||o(t.layer).addClass(TC.Consts.classes.LOADING).find("span").removeAttr(a)}).on(TC.Consts.event.LAYERADD+" "+TC.Consts.event.UPDATEPARAMS,function(t){var e=t.layer;e.isBase||e.type!==TC.Consts.layerType.WMS||s._readyDeferred.then(function(){var t=l(e),n=function(){o(e,t).removeClass(TC.Consts.classes.LOADING).addClass(TC.Consts.classes.CHECKED).find("span").attr(a,C),c()};if(t.length)n();else{for(var r=!1,i=0,d=s.layers.length;d>i;i++){var u=s.layers[i];if(u.type===e.type&&u.options.url===e.options.url){r=!0;break}}r||s.addLayer(new TC.layer.Raster({url:e.options.url,type:e.type,layerNames:[],title:e.title||e.wrap.getServiceTitle(),hideTitle:!0,hideTree:!1})).then(function(){t=l(e),n()})}})}).on(TC.Consts.event.LAYERERROR,function(t){t.reason&&TC.alert(s.getLocaleString(t.reason,{url:t.layer.url})),o(t.layer).removeClass(TC.Consts.classes.LOADING)}).on(TC.Consts.event.LAYERREMOVE,function(t){o(t.layer).removeClass(TC.Consts.classes.CHECKED).find("span").attr(a,u),i(t.layer).removeClass(TC.Consts.classes.CHECKED).attr(a,u),d(t.layer),c()}).on(TC.Consts.event.EXTERNALSERVICEADDED,function(t){t&&t.layer&&(s.addLayer(t.layer),s._$div.removeClass("tc-collapsed"))}),s._$div.on(TC.Consts.event.CLICK,"span",function(n){var r=$(n.target),l=r.parent();if(!l.hasClass(TC.Consts.classes.LOADING)&&!l.hasClass(TC.Consts.classes.CHECKED)){n.preventDefault;var o=l.data(e.LAYERNAME);o=void 0!==o?o.toString():"";var i=s._$roots.has(l).data(e.LAYER);if(i||(i=l.data(e.LAYER)),i&&o){var c=1;/iPad/i.test(navigator.userAgent)?c=10:TC.Util.detectFirefox()&&(c=250),i.title||(i.title=i.getTree().title),l.addClass(TC.Consts.classes.LOADING).find("span").attr(a,"");var d=function(t){var e=new $.Deferred;return setTimeout(function(){t[0].offsetHeight=t[0].offsetHeight,t[0].offsetWidth=t[0].offsetWidth,e.resolve()},c),e.promise()};d(l).then(function(){var e=$.extend({},i.options);e.id=TC.getUID(),e.layerNames=[o],t.addLayer(e).then(function(t){t.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(t){var e=this.parent;(401===t.error.code||403===t.error.code)&&e.map.toast(t.error.text,{type:TC.Consts.msgType.ERROR}),e.map.removeLayer(e)})}),n.stopPropagation()})}}})},t.render=function(t){var n=this,r=$.map(n.layers,function(t){return t.wrap.getLayer()});$.when.apply(n,r).then(function(){var r=$.map(n.layers,function(t){var e=t.getTree(),s=function a(e){for(var s=!1,n=0;n<e.children.length;n++)a(e.children[n])&&(s=!0);return e.hasOwnProperty("isVisible")&&(e.isVisible=!t.names||!t.names.length||s||e.isVisible),e.isVisible};return s(e),e});n.renderData({layerTrees:r,enableSearch:n.options.enableSearch},function(){var r=n.getLocaleString("layerAlreadyAdded");n._$roots=n._$div.find("div."+n.CLASS+"-tree > ul."+n.CLASS+"-branch > li."+n.CLASS+"-node"),n._$roots.each(function(t,s){var l=n.layers[t],o=$(s).data(e.LAYER,l),i=o.find("."+n.CLASS+"-btn-info"),c={};i.each(function(t,s){var o=$(s),i=o.parent().find("span").first(),d=o.parent().data(e.LAYERNAME).toString();if(d){i.addClass(TC.Consts.classes.SELECTABLE);var C=l.wrap.getInfo(d);if(C.hasOwnProperty("abstract")||C.hasOwnProperty("legend")||C.hasOwnProperty("metadata")){if(C.metadata)for(var u=0,f=C.metadata.length;f>u;u++){var h=C.metadata[u];h.formatDescription=c[h.format]=c[h.format]||n.getLocaleString(TC.Util.getSimpleMimeType(h.format))||n.getLocaleString("viewMetadata")}o.data(e.LAYERINFO,C),o.on(TC.Consts.event.CLICK,function(){$(this).hasClass(TC.Consts.classes.CHECKED)?($(this).removeClass(TC.Consts.classes.CHECKED),n.hideLayerInfo()):(n.showLayerInfo(l,d),$(this).addClass(TC.Consts.classes.CHECKED))})}else o.remove();if(l.compatibleLayers&&l.compatibleLayers.indexOf(d)<0&&i.parent().append('<span class="'+TC.Consts.classes.INCOMPATIBLE+'" title="'+n.getLocaleString("srsNotCompatible")+'"></span>'),n.map)for(var u=0,f=n.map.workLayers.length;f>u;u++){var y=n.map.workLayers[u];y.type===TC.Consts.layerType.WMS&&y.url===l.url&&1===y.names.length&&y.names[0]===d&&(i.parent().addClass(TC.Consts.classes.CHECKED),i.attr(a,r))}}else i.attr(a,""),o.remove()})}),n.$text=n._$div.find("."+n.CLASS+"-input"),n.$list=n._$div.find("."+n.CLASS+"-search ul"),n.$text.on("mouseup",function(t){var e=n.$text.val();""!==e&&setTimeout(function(){var t=n.$text.val();""===t&&n.$list.empty()},1)});var l=[];TC._search=TC._search||{},TC._search.retryTimeout=null,TC.loadJS(!n.$text.autocomplete,[TC.apiLocation+"lib/jQuery/autocomplete.js"],function(){n.$text.autocomplete({link:"#",target:n.$list,minLength:0,source:function(t,a){l=[],n._$roots.find("li."+TC.Consts.classes.CHECKED).each(function(t,s){l.push($(s).data(e.LAYERNAME).toString())}),t=t.trim(),t.length<s?n.$list.html(""):t.length>=s&&(TC._search.retryTimeout&&clearTimeout(TC._search.retryTimeout),TC._search.retryTimeout=setTimeout(function(){for(var e=[],s=0;s<n.layers.length;s++){var r=n.layers[s].searchSubLayers(t);r.length&&e.push({service:{index:s,title:n.layers[s].title||n.layers[s].id},founds:r})}a({servicesFound:e,servicesLooked:n.layers.length})},TC._search.interval))},callback:function(t){n.$text.val(t.target.text||t.target.innerText),TC._search.lastPattern=n.$text.val(),n.goToResult(unescape(t.target.hash).substring(1)),n.$text.autocomplete("clear")},buildHTML:function(t){if(t.results&&t.results.servicesFound.length>0)for(var e=n.map.getLayerTree().workLayers,s=0;s<t.results.servicesFound.length;s++){for(var a=t.results.servicesFound[s].founds,r=0;r<a.length;r++){delete a[r].alreadyAdded;for(var o=0;o<e.length;o++)if(l.indexOf(a[r].Name)>=0){a[r].alreadyAdded=!0;break}a[r].Name||(a.splice(r,1),r--)}t.results.servicesFound[s].founds.length?t.results.servicesFound[s].service.isCollapsed=$(n._$div.find(".tc-ctl-lcat-search-group")[s]).hasClass(TC.Consts.classes.COLLAPSED):t.results.servicesFound.splice(s,1)}var i="";return dust.render(n.CLASS+"-results",t.results,function(t,e){i=e}),i}})}),n.searchInit||(n._$div.on("click","h2 button",function(){var t=n._$div.hasClass("tc-collapsed");n._$div.removeClass("tc-collapsed");var e=n._$div.find("."+n.CLASS+"-search"),s=n._$div.find("."+n.CLASS+"-tree"),a=n._$div.find("."+n.CLASS+"-info");if(e.hasClass(TC.Consts.classes.HIDDEN)||t){e.removeClass(TC.Consts.classes.HIDDEN),s.addClass(TC.Consts.classes.HIDDEN),n.$text[0].focus(),$(this).addClass(n.CLASS+"-btn-tree"),$(this).attr("title",n.getLocaleString("viewAvailableLayersTree")),$(this).removeClass(n.CLASS+"-btn-search");var r=$(".tc-ctl-lcat-search li button.tc-checked").length;0===r&&a.addClass(TC.Consts.classes.HIDDEN)}else{e.addClass(TC.Consts.classes.HIDDEN),s.removeClass(TC.Consts.classes.HIDDEN),$(this).addClass(n.CLASS+"-btn-search"),$(this).attr("title",n.getLocaleString("searchLayersByText")),$(this).removeClass(n.CLASS+"-btn-tree");var r=$(".tc-ctl-lcat-tree li button.tc-checked").length;r>0&&a.removeClass(TC.Consts.classes.HIDDEN)}}),n._$div.on("click","."+n.CLASS+"-search button."+n.CLASS+"-search-btn-info",function(t){if(t.stopPropagation(),$(this).hasClass(TC.Consts.classes.CHECKED))$(this).removeClass(TC.Consts.classes.CHECKED),n.hideLayerInfo();else{var s=$(this).parent();n.showLayerInfo(n.layers[s.parents("li").data(e.SERVICEINDEX)],s.data(e.LAYERNAME)),$(this).addClass(TC.Consts.classes.CHECKED)}}),n._$div.on("click",".tc-ctl-lcat-search li",function(t){t.stopPropagation();var s=$(this);if(!s.hasClass("tc-ctl-lcat-no-results")){if(s.hasClass("tc-ctl-lcat-search-group"))return void s.toggleClass(TC.Consts.classes.COLLAPSED);var l=s.data(e.LAYERNAME);if(l=void 0!==l?l.toString():"",!$(this).hasClass(TC.Consts.classes.CHECKED)){var o=s.parents("li.tc-ctl-lcat-search-group"),i=n.layers[0==o.length?0:o.data(e.SERVICEINDEX)].options.url,c=n.layers[0==o.length?0:o.data(e.SERVICEINDEX)].title;n.map.addLayer({id:TC.getUID(),url:i,title:c,hideTitle:!0,layerNames:[l]},function(t){s.data(e.LAYER,t),t.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(t){var e=this.parent;(401===t.error.code||403===t.error.code)&&e.map.toast(t.error.text,{type:TC.Consts.msgType.ERROR}),e.map.removeLayer(e)})}),$(this).addClass(TC.Consts.classes.CHECKED),$(this).attr(a,r)}}}),n.searchInit=!0),$.isFunction(t)&&t()})})},t.showLayerInfo=function(t,s){var a=this,n=null,r=a._$div.find("."+a.CLASS+"-info"),l=function(t,s){{var n=!1;r.data(e.LAYERNAME)}return s&&(n=!0,r.data(e.LAYERNAME,t),r.removeClass(TC.Consts.classes.HIDDEN),dust.render(a.CLASS+"-info",s,function(t,e){r.html(e),t&&TC.error(t),r.find("."+a.CLASS+"-info-close").on(TC.Consts.event.CLICK,function(){a.hideLayerInfo()})})),n};return a._$div.find("."+a.CLASS+"-btn-info, ."+a.CLASS+"-search-btn-info").removeClass(TC.Consts.classes.CHECKED),a._$roots.each(function(r,o){var i=$(o);if(i.data(e.LAYER)===t){var c=i.find("."+a.CLASS+"-btn-info");return c.each(function(t,r){var o=$(r),i=o.parent().data(e.LAYERNAME).toString();if(i===s){var c=o.data(e.LAYERINFO);return a._$div.find('li [data-tc-layer-name="'+i+'"] > button').toggleClass(TC.Consts.classes.CHECKED,l(i,c)),n=c,!1}}),!1}}),n}}(),t.hideLayerInfo=function(){var t=this;t._$div.find("."+t.CLASS+"-btn-info, ."+t.CLASS+"-search-btn-info").removeClass(TC.Consts.classes.CHECKED),t._$div.find("."+t.CLASS+"-info").addClass(TC.Consts.classes.HIDDEN)},t.addLayer=function(t){var e=$.Deferred(),s=this,a=[];return s.options.layers&&s.options.layers.length&&(a=$.grep(s.options.layers,function(e){var s=TC.Util.reqGetMapOnCapabilities(e.url);return s&&s.replace(TC.Util.regex.PROTOCOL)==t.url.replace(TC.Util.regex.PROTOCOL)})),0==a.length&&(a=$.grep(s.layers,function(e){return e.url.replace(TC.Util.regex.PROTOCOL)==t.url.replace(TC.Util.regex.PROTOCOL)})),0==a.length?(s.layers.push(t),t.getCapabilitiesPromise().then(function(){t.compatibleLayers=t.wrap.getCompatibleLayers(s.map.crs),t.title=t.title||t.wrap.getServiceTitle(),s.render(function(){e.resolve()})})):e.resolve(),e},t.loaded=function(){return this._readyDeferred.promise()}}();