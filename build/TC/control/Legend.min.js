TC.control=TC.control||{},TC.control.MapContents||TC.syncLoadJS(TC.apiLocation+"TC/control/MapContents"),TC.control.Legend=function(){TC.control.MapContents.apply(this,arguments)},TC.inherit(TC.control.Legend,TC.control.MapContents),function(){var e=TC.control.Legend.prototype;e.CLASS="tc-ctl-legend",e.template={},TC.isDebug?(e.template[e.CLASS]=TC.apiLocation+"TC/templates/Legend.html",e.template[e.CLASS+"-node"]=TC.apiLocation+"TC/templates/LegendNode.html"):(e.template[e.CLASS]=function(){function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"legend"}).w('</h2><div class="tc-ctl-legend-tree"><ul class="tc-ctl-legend-branch">').s(t.get(["workLayers"],!1),t,{"else":n,block:i},{}).w("</ul></div>")}function n(e,t){return e.w('<li class="tc-ctl-legend-empty">').h("i18n",t,{},{$key:"noData"}).w("</li>")}function i(e,t){return e.p("tc-ctl-legend-node",t,t.rebase(t.getPath(!0,[])),{})}return dust.register(e.CLASS,t),t.__dustBody=!0,n.__dustBody=!0,i.__dustBody=!0,t},e.template[e.CLASS+"-node"]=function(){function t(e,t){return e.w("<li ").x(t.get(["children"],!1),t,{"else":n,block:i},{}).w(' data-tc-layer-name="').f(t.get(["name"],!1),t,"h").w('" data-tc-layer-uid="').f(t.get(["uid"],!1),t,"h").w('"><div class="tc-ctl-legend-title">').f(t.get(["title"],!1),t,"h").w("</div>").x(t.get(["legend"],!1),t,{block:a},{}).w('<ul class="tc-ctl-legend-branch">').s(t.get(["children"],!1),t,{block:o},{}).w("</ul></li>")}function n(e,t){return e.w('class="tc-ctl-legend-node tc-ctl-legend-leaf" ')}function i(e,t){return e.w('class="tc-ctl-legend-node" ')}function a(e,t){return e.w('<div class="tc-ctl-legend-watch">').x(t.getPath(!1,["legend","src"]),t,{"else":l,block:r},{}).w('</div><div class="tc-ctl-legend-nvr">').h("i18n",t,{},{$key:"notVisibleAtCurrentResolution"}).w("</div>")}function l(e,t){return e.w('<div class="tc-ctl-legend-img" style="border:solid ').f(t.getPath(!1,["legend","strokeWidth"]),t,"h").w("px ").f(t.getPath(!1,["legend","strokeColor"]),t,"h").w(";background-color:").f(t.getPath(!1,["legend","fillColor"]),t,"h").x(t.getPath(!1,["legend","width"]),t,{block:d},{}).w('"></div>')}function d(e,t){return e.w(";width:").f(t.getPath(!1,["legend","width"]),t,"h").w("px;height:").f(t.getPath(!1,["legend","height"]),t,"h").w("px;border-radius:50%")}function r(e,t){return e.w('<img src="" data-tc-img="').f(t.getPath(!1,["legend","src"]),t,"h").w('" ').x(t.getPath(!1,["legend","width"]),t,{block:s},{}).w(" />")}function s(e,t){return e.w('style="width:').f(t.getPath(!1,["legend","width"]),t,"h").w("px;height:").f(t.getPath(!1,["legend","height"]),t,"h").w('px;"')}function o(e,t){return e.p("tc-ctl-legend-node",t,t.rebase(t.getPath(!0,[])),{})}return dust.register(e.CLASS+"-node",t),t.__dustBody=!0,n.__dustBody=!0,i.__dustBody=!0,a.__dustBody=!0,l.__dustBody=!0,d.__dustBody=!0,r.__dustBody=!0,s.__dustBody=!0,o.__dustBody=!0,t});var t={layer:"tcLayer",layerUid:"tcLayerUid"};e.register=function(e){var t=this;TC.control.MapContents.prototype.register.call(t,e)},e.loadGraphics=function(){var e=this;e._$div.find("ul."+e.CLASS+"-branch").first().children("li").not("."+e.CLASS+"-empty").each(function(n,i){var a=$(i),l=a.data(t.layer);a.find("li").each(function(t,n){var i=$(n),a=i.find("img").first();a&&void 0!=a.attr("src")&&0==a.attr("src").length&&e.styleLegendImage(a,l)})})},e.updateScale=function(){var e=this,n=e.CLASS+"-node-inscale",i=e.CLASS+"-node-outofscale";e._$div.find("ul."+e.CLASS+"-branch").first().children("li").not("."+e.CLASS+"-empty").each(function(a,l){var d=$(l),r=d.data(t.layer);if(r){var s=!1;d.find("li").each(function(a,l){var d=$(l);if(d.hasClass(e.CLASS+"-node-visible")){var o=d.data(t.layerUid);if(r.isVisibleByScale(o)){s=!0,d.removeClass(i).addClass(n);var c=d.find("img").first();c.length>0&&e.styleLegendImage(c,r)}else d.addClass(i).removeClass(n)}}),d.toggleClass(n,s),d.toggleClass(i,!s)}})},e.update=function(){var e=this;e._$div.find("ul."+e.CLASS+"-branch").first().children("li").each(function(n,i){var a=$(i),l=a.data(t.layer);l&&(l.getTree(),a.find("li").each(function(n,i){var a=$(i),d=a.data(t.layerUid),r=e.CLASS+"-node-visible",s=e.CLASS+"-node-notvisible",o=e.CLASS+"-node-hasvisible";switch(l._cache.visibilityStates[d]){case TC.Consts.visibility.NOT_VISIBLE:a.removeClass(r+" "+o).addClass(s);break;case TC.Consts.visibility.HAS_VISIBLE:a.removeClass(r+" "+s).addClass(o);break;default:a.removeClass(s+" "+o).addClass(r)}}),e.updateLayerVisibility(l))}),e.updateScale()},e.updateLayerTree=function(e){var n=this;e.isBase||e.options.stealth||(TC.control.MapContents.prototype.updateLayerTree.call(n,e),n._$div.find("."+n.CLASS+"-empty").addClass(TC.Consts.classes.HIDDEN),TC.loadJSInOrder(!window.dust,TC.url.templating,function(){dust.render(n.CLASS+"-node",n.layerTrees[e.id],function(i,a){var l=$(a),d=l.data(t.layerUid),r=n._$div.find("ul."+n.CLASS+"-branch").first(),s=r.find('li[data-tc-layer-uid="'+d+'"]');1===s.length?s.html(l.html()):(l.data(t.layer,e),r.prepend(l)),i&&TC.error(i)}),n.update()}))},e.removeLayer=function(e){var n=this,i=function(){return n._$div.find("."+n.CLASS+"-branch").first().children("li").not("."+n.CLASS+"-empty")};if(!e.isBase){var a=i();a.each(function(n,l){var d=$(l);return d.data(t.layer)===e?(d.remove(),a=i(),!1):void 0}),0===a.length&&n._$div.find("."+n.CLASS+"-empty").removeClass(TC.Consts.classes.HIDDEN)}},e.updateLayerVisibility=function(e){var n=this;n._$div.find("."+n.CLASS+"-branch").first().children("li").each(function(i,a){var l=$(a);return l.data(t.layer)===e?(l.toggleClass(n.CLASS+"-node-notvisible",!e.getVisibility()),!1):void 0})},e.getLayerUIElements=function(){var e=this;return e._$div.find("ul."+e.CLASS+"-branch").first().children("li."+e.CLASS+"-node")}}();