TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control"),TC.control.MapContents=function(){var e=this;TC.Control.apply(e,arguments),e.layerTrees={}},TC.inherit(TC.control.MapContents,TC.Control),function(){var e=TC.control.MapContents.prototype;e.CLASS="tc-ctl-mc";var t={layer:"tcLayer",img:"tcImg"};e.render=function(e){var t=this;t.map&&t.renderData(t.map.getLayerTree(),e)},e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t.render(function(){for(var r=0,n=e.layers.length;n>r;r++)t.updateLayerTree(e.layers[r]);e.on(TC.Consts.event.ZOOM,function(){t.updateScale()}).on(TC.Consts.event.UPDATEPARAMS,function(e){var r=e.layer.names,n=function a(e){var t=!1;if(e)if($.inArray(e.name,r)>=0)t=!0;else for(var n=0;n<e.children.length;n++)if(a(e.children[n])){t=!0;break}return t};n(t.layerTrees[e.layer.id])||0===r.length?t.update():t.updateLayerTree(e.layer)}).on(TC.Consts.event.LAYERVISIBILITY,function(e){t.updateLayerVisibility(e.layer)}).on(TC.Consts.event.LAYERADD,function(e){t.updateLayerTree(e.layer)}).on(TC.Consts.event.VECTORUPDATE+" "+TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATURESADD,function(e){t._updateLayerTreeTimeout&&clearTimeout(t._updateLayerTreeTimeout),t._updateLayerTreeTimeout=setTimeout(function(){t.map.workLayers.indexOf(e.layer)>-1&&(t.updateLayerTree(e.layer),delete t._updateLayerTreeTimeout)},100)}).on(TC.Consts.event.LAYERREMOVE,function(e){t.removeLayer(e.layer)}).on(TC.Consts.event.LAYERORDER,function(e){t.updateLayerOrder(e.layer,e.oldIndex,e.newIndex)})})},e.updateScale=function(){},e.updateLayerVisibility=function(e){},e.updateLayerTree=function(e){this.layerTrees[e.id]=e.getTree()},e.updateLayerOrder=function(e,r,n){var a=this;if(r>=0&&r!==n)for(var o,i,s=a.getLayerUIElements(),l=a.map.workLayers.length-1;l>=0;l--){var c=a.map.workLayers[l];if(i=o,s.each(function(e,r){var n=$(r);return n.data(t.layer)===c?(o=n,!1):void 0}),c===e){i?i.after(o):s.parent().prepend(o);break}}},e.removeLayer=function(e){this.update()},e.getLayerUIElements=function(){var e=this;return e._$div.find("ul").first().children()};var r=function(e){return/[&?]REQUEST=getLegendGraphic/i.test(e)},n=function(e,t,r){var n="error.tc";TC.Cfg.proxy&&e.off(n).on(n,function(){e.attr("src",TC.proxify(t))});var a=/^(https?:)?\/\//i;if(TC.Util.isSecureURL(document.location.href)&&!TC.Util.isSecureURL(t)){var o="";o=1==r?t.replace(a,"https://"):TC.isUsingServiceWorker()?TC.proxify(t):t,e.attr("src",o)}else e.attr("src",a.test(t)?t.substr(t.indexOf("//")):t)};e.styleLegendImage=function(e,a){if(!e.attr("src")){var o=e.data(t.img);if(a&&a.options.method&&"POST"===a.options.method)a.getLegendGraphicImage().done(function(t){n(e,t)}).fail(function(e){TC.error(e)});else{if(r(o)){var i=e.parent(),s=i.css("color"),l=s.indexOf("("),c=s.indexOf(")");if(l>=0&&c>l){color=s.substr(0,c).substr(l+1).split(","),s="0x";for(var u=0;3>u;u++){var f=parseInt(color[u]).toString(16);s+=1===f.length?"0"+f:f}}else s.replace("#","0x");o+="&LEGEND_OPTIONS=fontName:"+i.css("font-family")+";fontSize:"+parseInt(i.css("font-size"))+";fontColor:"+s+";fontAntiAliasing:true",a.params&&a.params.sld_body&&(o=TC.Util.addURLParameters(o,{sld_body:a.params.sld_body})),e.data(t.img,o)}n(e,o,a.usesSSL)}}}}();