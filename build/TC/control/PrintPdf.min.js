TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control"),TC.control.PrintPdf=function(){var e=this;TC.Control.apply(e,arguments)},TC.inherit(TC.control.PrintPdf,TC.Control),function(){var e=TC.control.PrintPdf.prototype;e.CLASS="tc-ctl-print-pdf";var t={marginTop:20,marginLeft:55,a4:{width:596,height:842},a3:{width:842,height:1191},qrCode:{sideLength:85},headerHeight:20},n={PORTRAIT:"portrait",LANDSCAPE:"landscape"},r={A4:"a4",A3:"a3"},i=TC.Util.getParameterByName("orientation"),a=TC.Util.getParameterByName("size"),o=function(e,r){return e===n.PORTRAIT?t[r].width:t[r].height},s=function(e,r){return e===n.PORTRAIT?t[r].height:t[r].width};e.template=TC.isDebug?TC.apiLocation+"TC/templates/PrintPdf.html":function(){function t(e,t){return e.w('<button disabled class="disabled tc-button tc-ctl-print-pdf-btn" title="').h("i18n",t,{},{$key:"printpdf"}).w('"></button>')}return dust.register(e.CLASS,t),t.__dustBody=!0,t};var l=function(){var e=window.location.href,t=e.indexOf("?"),n=e.indexOf("#");return t>0&&(e=n>t?e.replace(e.substring(t,n),""):e.replace(e.substring(t,e.length-1),"")),e},d=function(e){var n=$.Deferred(),r=150;return e?TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){e.length>r&&(e=TC.Util.shortenUrl(e));var i=$("#qrcode");i.empty();new QRCode(i.get(0),{text:e,width:t.qrCode.sideLength,height:t.qrCode.sideLength});setTimeout(function(){var e=i.find("img").attr("src");n.resolve(e)},100)}):n.resolve(imgBase64),n.promise()};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t.pdfLibPromise=function(){var e=$.Deferred();return window.pdfMake?e.resolve():TC.loadJS(!window.pdfMake,[TC.Consts.url.PDFMAKE],function(){e.resolve()}),e.promise()}();var n=!0;e._$div.on("mouseover",function(){n&&(e.toast(t.getLocaleString("print.advice.title")+": "+t.getLocaleString("print.advice.desc"),{type:TC.Consts.msgType.INFO,duration:7e3}),n=!1)});var r="."+t.CLASS+"-btn";t.map.$events.on(TC.Consts.event.STARTLOADING,function(){var e=t._$div.find(r);e.addClass("disabled"),e.attr("disabled","disabled")}),t.map.$events.on(TC.Consts.event.STOPLOADING,function(){var e=t._$div.find(r);e.removeClass("disabled"),e.removeAttr("disabled")}),t.getLayersFromOpener(),t.options.qrCode&&d(l()),t._$div.on("click","."+t.CLASS+"-btn",function(){t.createPdf()})};var c=function(){var e=$.Deferred(),o={pageOrientation:i||n.LANDSCAPE,pageSize:a||r.A4,pageMargins:[t.marginLeft,t.marginTop]};return e.resolve(o),e.promise()};e.createPdf=function(){var e=this,n=o(i,a),r=s(i,a);e.canvas=$(".tc-map .ol-viewport canvas")[0],e.mapSize=TC.Util.calculateAspectRatioFit(e.canvas.width,e.canvas.height,n-2*t.marginLeft,r-2*t.marginTop-t.headerHeight);var p=function(t){TC.error(e.getLocaleString("print.error")),TC.error("No se ha podido generar el base64 correspondiente a la imagen: "+t,TC.Consts.msgErrorMode.EMAIL,"Error en la impresi√≥n")},g=function(n){n.content=n.content||[];var r=$.Deferred(),i=e.map.getControlsByClass(TC.control.ScaleBar)[0];if(i)var a=$(".tc-ctl-sb .ol-scale-line-inner"),o=e.canvas.width/e.mapSize.width,s=a.width()/o;var l=function(e){var t;e&&(t=[[e]]),t[0].push({text:TC.Util.getParameterByName("title"),alignment:"center",fontSize:11}),i&&t[0].push({table:{widths:[s],body:[[{text:i.getText(),fontSize:10,alignment:"center"}]]},layout:{hLineWidth:function(e,t){return 0===e?0:1},paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return 0},paddingBottom:function(e,t){return 0}}}),n.content.push({table:{widths:[s,"*",s]},layout:"noBorders"}),n.content[0].table.body=t,r.resolve(n)};return e.options.logo?$.when(TC.Util.imgToDataUrl(e.options.logo,"image/png")).then(function(e,n){var r=(t.headerHeight,n.width*t.headerHeight/n.height,TC.Util.calculateAspectRatioFit(n.width,n.height,s,t.headerHeight));l({image:e,height:r.height,width:r.width})},function(){p(e.options.logo),r.reject()}):l(),r.promise()},u=function(n){var r=$.Deferred();n.content=n.content||[];var i=function(t){n.content.push({table:{widths:["*"],body:[[{image:TC.Util.toDataUrl(t),width:e.mapSize.width}]]},layout:{paddingLeft:function(e,t){return 0},paddingRight:function(e,t){return 0},paddingTop:function(e,t){return.1},paddingBottom:function(e,t){return 0}}}),r.resolve(n)};return e.options.qrCode?$.when(d(l())).then(function(n){n?$.when(TC.Util.addToCanvas(e.canvas,n,{x:e.canvas.width-t.qrCode.sideLength,y:e.canvas.height-t.qrCode.sideLength})).then(function(e){i(e)}):(TC.error(e.getLocaleString("print.qr.error")),i(e.canvas))}):i(e.canvas),r.promise()},h=function(t){var n=$.Deferred(),r=function(e,t,n){if(t.isVisibleByScale(e.name)){var r,i;t.options&&t.options.params&&t.options.params.base64LegendSrc?i=t.options.params.base64LegendSrc:e.legend&&(r=e.legend.src),result.push({src:r,title:e.title,level:n,srcBase64:i})}},a=function(e,t,n,r){if(Array.isArray(e))for(var i=0;i<e.length;i++)a(e[i],t,n,r);else e&&e.hasOwnProperty("children")&&e.children.length>0&&(e.title&&e.name&&result.push({header:e.title,level:r}),a(e.children,t,n,++r));e&&e.hasOwnProperty("children")&&0==e.children.length&&(t.apply(this,[e,n,r]),r--)},o=function(){for(var t=[],n=0;n<d.length;n++)for(var r=d[n].layers,i=0;i<r.length;i++)!function(n,r){var i=d[n].layers[r],a=i.src||i.srcBase64;if(a){e.map.options.crossOrigin&&TC.Util.detectIE()&&(a=TC.proxify(a));var o=TC.Util.imgToDataUrl(a,"image/png");t.push(o),o.then(function(e,t){i.image={base64:e,canvas:t}},function(){p(a)})}}(n,i);return t};if(e.options.legend&&e.options.legend.visible){var s=e.options.legend.orientation||i,l=e.map.workLayers,d=[],c=7;if(t.content=t.content||{},l.length>0){for(var g=l.length-1;g>=0;g--){var u=l[g];u.type===TC.Consts.layerType.WMS&&u.getVisibility()&&(result=[],a(u.getTree(),r,u,0),result.length>0&&d.push({title:u.title,layers:result}))}$.when.apply($,o()).then(function(){d.length>0&&t.content.push({text:" ",pageBreak:"before",pageOrientation:s});for(var e=0;e<d.length;e++){var r=d[e],i=10;t.content.push({text:r.title,fontSize:11,margin:[0,0,0,5]});for(var a=0;a<r.layers.length;a++){var o=r.layers[a];if(i=c*o.level,o.header)t.content.push({text:o.header,fontSize:10,margin:[i,0,0,3]});else if(t.content.push({text:o.title,fontSize:9,margin:[i,0,0,2]}),o.image){var l=o.image.canvas.width/2,p=l*o.image.canvas.height/o.image.canvas.width;t.content.push({image:o.image.base64,width:l,height:p,margin:[i,0,0,2]})}}}n.resolve(t)},function(){n.reject()})}else n.resolve(t)}else n.resolve(t);return n.promise()},f=function(e){var t=window.location.host+"_",n=TC.Util.getParameterByName("title");if(n)t+=n;else{var r=TC.Util.getFormattedDate((new Date).toString(),!0);t+=r}pdfMake.createPdf(e).download(t.replace(/[\\\/:*?"<>\|]/g,"")+".pdf")},m=e.map.getControlsByClass(TC.control.LoadingIndicator)[0],C=m.addWait(),v=function(){m.removeWait(C)};$.when(e.pdfLibPromise).then(c).then(g).fail(v).then(u).then(h).fail(v).then(f).then(v)},e.getLayersFromOpener=function(e){var t=this,n=window.opener;if(n){var r=n.TC,i=r.printPreview?r.printPreview.refererMap:null;i&&t.map.loaded(function(){0===n.location.hash.length&&t.map.setExtent(i.options.initialExtent);for(var e=0;e<t.map.baseLayers.length;e++)t.map.removeLayer(t.map.baseLayers[e]);var a=i.getBaseLayer();t.map.addLayer({id:a.id,title:a.title,type:a.type,url:a.url,encoding:a.encoding,layerNames:a.layerNames,matrixSet:a.matrixSet,format:a.format,minResolution:a.minResolution,maxZoom:a.maxZoom,isBase:!0});for(var o,s=i.workLayers,e=0;e<s.length;e++)o=s[e],o.type===r.Consts.layerType.WMS&&o.options.stateless&&t.map.addLayer({id:o.id,title:o.title,type:o.type,method:o.method,url:o.url,format:o.format,stateless:o.stateless,params:o.params,layerNames:o.layerNames},function(e){e.setVisibility(o.getVisibility()),e.setOpacity(o.getOpacity())});var l=r.printPreview.mapFeatures;l&&t.map.addLayer({id:r.getUID(),type:r.Consts.layerType.VECTOR},function(e){r.loadJS(!r.feature,[r.apiLocation+"TC/Feature",r.apiLocation+"TC/feature/Point",r.apiLocation+"TC/feature/Polyline",r.apiLocation+"TC/feature/Polygon",r.apiLocation+"TC/feature/MultiPolygon",r.apiLocation+"TC/feature/MultiPolyline",r.apiLocation+"TC/feature/Circle",r.apiLocation+"TC/feature/Marker"],function(){for(var t=0;t<l.length;t++){var n=l[t];switch(n.CLASSNAME){case"TC.feature.Point":e.addPoint(n.geometry,n.options);break;case"TC.feature.Polyline":e.addPolyline(n.geometry,n.options);break;case"TC.feature.Polygon":e.addPolygon(n.geometry,n.options);break;case"TC.feature.MultiPolygon":e.addMultiPolygon(n.geometry,n.options);break;case"TC.feature.MultiPolyline":e.addMultiPolyline(n.geometry,n.options);break;case"TC.feature.Circle":e.addCircle(n.geometry,n.options);break;case"TC.feature.Marker":e.addMarker(n.geometry,n.options)}}})})})}}}();