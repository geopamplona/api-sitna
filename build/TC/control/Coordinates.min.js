TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control"),TC.control.Coordinates=function(){var o=this;o.crs="",o.xy=[0,0],o.latLon=[0,0],o.units="m",o.isGeo=!1,TC.Control.apply(o,arguments),o.geoCrs=o.options.geoCrs||TC.Cfg.geoCrs},TC.inherit(TC.control.Coordinates,TC.Control),function(){var o=TC.control.Coordinates.prototype;o.CLASS="tc-ctl-coords",o.template=TC.isDebug?TC.apiLocation+"TC/templates/Coordinates.html":function(){function t(o,t){return o.w('<div>CRS: <span class="tc-ctl-coords-crs">').f(t.get(["crs"],!1),t,"h").w('</span></div><div class="tc-ctl-coords-xy">').x(t.get(["isGeo"],!1),t,{"else":e,block:s},{}).w("</div>").x(t.get(["showGeo"],!1),t,{block:r},{})}function e(o,t){return o.w('X: <span class="tc-ctl-coords-x">').f(t.get(["x"],!1),t,"h").w('</span> Y: <span class="tc-ctl-coords-y">').f(t.get(["y"],!1),t,"h").w("</span>")}function s(o,t){return o.h("i18n",t,{},{$key:"lat"}).w(': <span class="tc-ctl-coords-lat">').f(t.get(["lat"],!1),t,"h").w("</span> ").h("i18n",t,{},{$key:"lon"}).w(': <span class="tc-ctl-coords-lon">').f(t.get(["lon"],!1),t,"h").w("</span>")}function r(o,t){return o.w('<div class="tc-ctl-coords-alt">CRS: <span class="tc-ctl-coords-geocrs">').f(t.get(["geoCrs"],!1),t,"h").w('</span></div><div class="tc-ctl-coords-xy">').h("i18n",t,{},{$key:"lat"}).w(': <span class="tc-ctl-coords-lat">').f(t.get(["lat"],!1),t,"h").w("</span> ").h("i18n",t,{},{$key:"lon"}).w(': <span class="tc-ctl-coords-lon">').f(t.get(["lon"],!1),t,"h").w("</span></div>")}return dust.register(o.CLASS,t),t.__dustBody=!0,e.__dustBody=!0,s.__dustBody=!0,r.__dustBody=!0,t},o.register=function(o){var t=this;TC.Control.prototype.register.call(t,o),t.crs=t.map.crs,t.wrap||(t.wrap=new TC.wrap.control.Coordinates(t)),t.clear(),o.loaded(function(){t.wrap.register(o).then(function(){t.render(function(){t.update(),t.clear()})}),TC.Util.detectMobile()&&($.when(o.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0,title:"Coordenadas"})).then(function(o){t.layer=o}),t.activateCoords())})},o.render=function(o){var t=this;t.renderData({x:t.xy[0],y:t.xy[1],lat:t.latLon[0],lon:t.latLon[1],crs:t.crs,geoCrs:t.geoCrs,isGeo:t.isGeo,showGeo:t.options.showGeo},function(){t.$crs=t._$div.find("."+t.CLASS+"-crs"),t.$geoCrs=t._$div.find("."+t.CLASS+"-geocrs"),t.$x=t._$div.find("."+t.CLASS+"-x"),t.$y=t._$div.find("."+t.CLASS+"-y"),t.$lat=t._$div.find("."+t.CLASS+"-lat"),t.$lon=t._$div.find("."+t.CLASS+"-lon"),$.isFunction(o)&&o()})},o.formatCoord=function(o,t){var e;return e=o.toFixed(t),3>=t&&(e=e.replace(/\B(?=(\d{3})+(?!\d))/g,"|")),e=e.replace(".",",").replace(/\|/g,".")},o.update=function(){var o=this;o.renderPromise().then(function(){o.$crs&&(!o.isGeo&&o.options.showGeo&&(o.latLon=TC.Util.reproject(o.xy,o.crs,o.geoCrs).reverse()),o.$crs.text(o.crs),o.$geoCrs.text(o.geoCrs),o.isGeo||(o.$x.text(o.formatCoord(o.xy[0],TC.Consts.METER_PRECISION)),o.$y.text(o.formatCoord(o.xy[1],TC.Consts.METER_PRECISION))),(o.isGeo||o.options.showGeo)&&(o.$lat.text(o.formatCoord(o.latLon[0],TC.Consts.DEGREE_PRECISION)),o.$lon.text(o.formatCoord(o.latLon[1],TC.Consts.DEGREE_PRECISION))),TC.Util.detectMobile()||o._$div.removeClass(TC.Consts.classes.HIDDEN))})},o.clear=function(){var o=this;TC.Util.detectMobile()||o._$div.addClass(TC.Consts.classes.HIDDEN)},o.deactivateCoords=function(){var o=this;o._$div.toggleClass(TC.Consts.classes.HIDDEN,!0),o.clear(),o.wrap.coordsDeactivate(),o.cleanCoordsPointer()},o.cleanCoordsPointer=function(){var o=this;delete o.currentCoordsMarker,$.when(o.getLayer()).then(function(o){o&&o.clearFeatures()})},o.activateCoords=function(){var o=this;o.wrap.coordsActivate()},o.getCoords=function(){var o=this,t=o.map.getControlsByClass(TC.control.Popup);t&&t.length>0&&t[0].isVisible()?o.coordsToPopup(t[0]):(o.updateCoordsCtrl([(o.map.getExtent()[0]+o.map.getExtent()[2])/2,(o.map.getExtent()[1]+o.map.getExtent()[3])/2]),o.coordsToClick.call(o,{coordinate:o.xy}))},o.coordsToPopup=function(o){var t=this;o&&t.updateCoordsCtrl(o.wrap.popup.getPosition())},o.updateCoordsCtrl=function(o){var t=this;o&&(t.x=o[0],t.y=o[1],t.xy=[t.x,t.y],t.update())};var t,e;o.coordsToClick=function(o){var s=this;$(s.map._$div).hasClass("tc-ctl-sv-active tc-collapsed")||($(s._$div).stop(!0,!0),t&&clearTimeout(t),0==s._$div.find("span.close").length&&(e=s._$div.append('<span class="close"></span>'),$(e).click(function(){s._$div.toggleClass(TC.Consts.classes.HIDDEN,!0),s.clear(),s.cleanCoordsPointer()})),s.updateCoordsCtrl(o.coordinate),s.coordsMarkerAdd(o.coordinate),s._$div.removeClass(TC.Consts.classes.HIDDEN),t=setTimeout(function(){$(s._$div).animate({opacity:0},3e3,"linear",function(){$(s._$div).css({opacity:.7}),s._$div.toggleClass(TC.Consts.classes.HIDDEN,!0),s.clear(),s.cleanCoordsPointer()})},5e3))},o.coordsMarkerAdd=function(o){var t=this;t.currentCoordsMarker?t.currentCoordsMarker.setCoords(o):$.when(t.getLayer()).then(function(e){e&&$.when(e.addMarker(o,{title:"Coord",showsPopup:!1,cssClass:TC.Consts.classes.POINT,anchor:[.5,.5]})).then(function(o){t.currentCoordsMarker=o})})},o.getLayer=function(){var o=this,t=new $.Deferred;return void 0==o.layer?$.when(o.map.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR,stealth:!0,title:"Coordenadas"})).then(function(e){o.layer=e,o.layer.map.putLayerOnTop(o.layer),t.resolve(o.layer)}):t.resolve(o.layer),t}}();