TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control"),TC.control.Search=function(){var e=this;if(TC.Control.apply(e,arguments),TC.Consts.event.TOOLSCLOSE=TC.Consts.event.TOOLSCLOSE||"toolsclose.tc",e.url="//idena.navarra.es/ogc/wfs",e.version="1.1.0",e.featurePrefix="IDENA",e._LIKE_PATTERN="*",e.UTMX="X",e.UTMY="Y",e.LON="Lon",e.LAT="Lat",e.UTMX_LABEL="X: ",e.UTMY_LABEL="Y: ",e.LON_LABEL="Lon: ",e.LAT_LABEL="Lat: ",e.MUN="M",e.POL="P",e.PAR="Par",e.MUN_LABEL="Mun: ",e.POL_LABEL="Pol: ",e.PAR_LABEL="Par: ",e.availableSearchTypes={},e.availableSearchTypes[TC.Consts.searchType.CADASTRAL]={suggestionRoot:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["CATAST_Pol_ParcelaRusti","CATAST_Pol_ParcelaUrba","CATAST_Pol_ParcelaMixta"],municipality:{featureType:"CATAST_Pol_Municipio",outputProperties:["CMUNICIPIO","MUNICIPIO"]},queryProperties:{municipality:"CMUNICIPIO",polygon:"POLIGONO",parcel:"PARCELA"},suggestionListHead:function(){return{label:e.getLocaleString("search.list.cadastral"),color:{"#e5475f":e.getLocaleString("search.list.cadastral.mixed"),"#0c8b3d":e.getLocaleString("search.list.cadastral.rustic"),"#136278":e.getLocaleString("search.list.cadastral.urban")}}},styles:{CATAST_Pol_ParcelaUrba:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#136278",strokeWidth:2,strokeOpacity:1}},CATAST_Pol_ParcelaRusti:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#0c8b3d",strokeWidth:2,strokeOpacity:1}},CATAST_Pol_ParcelaMixta:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#e5475f",strokeWidth:2,strokeOpacity:1}}},parser:e.getCadastralRef,goTo:e.goToCadastralRef,goToIdFormat:"M{0}P{1}Par{2}",idPropertiesIdentifier:"#"},e.availableSearchTypes[TC.Consts.searchType.COORDINATES]={parser:e.getCoordinates,goTo:e.goToCoordinates,label:null,suggestionListHead:function(t){return{label:e.availableSearchTypes[TC.Consts.searchType.COORDINATES].label||e.getLocaleString("search.list.coordinates")}}},e.availableSearchTypes[TC.Consts.searchType.MUNICIPALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Municipio",dataIdProperty:["CMUNICIPIO"],queryProperties:{tProperty:["MUNINOAC","MUNICIPIO"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.municipality"),color:{"#fe06a5":e.getLocaleString("search.list.municipality")}}},outputProperties:["MUNICIPIO"],outputFormatLabel:"{0}",searchWeight:2,styles:{CATAST_Pol_Municipio:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#fe06a5",strokeWidth:2,strokeOpacity:1}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.LOCALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["CATAST_Pol_Municipio","ESTADI_Pol_EntidadPob"],renderFeatureType:["CATAST_Pol_Municipio"],dataIdProperty:{CATAST_Pol_Municipio:["CMUNICIPIO"],ESTADI_Pol_EntidadPob:["CMUNICIPIO","CENTIDAD"]},queryProperties:{tProperty:{CATAST_Pol_Municipio:["MUNINOAC","MUNICIPIO"],ESTADI_Pol_EntidadPob:["ENTINOAC","ENTIDAD"]}},suggestionListHead:function(){return{label:e.getLocaleString("search.list.locality"),color:{"#feba1e":e.getLocaleString("search.list.locality")}}},outputProperties:{CATAST_Pol_Municipio:["MUNICIPIO"],ESTADI_Pol_EntidadPob:["MUNICIPIO","ENTIDAD"]},outputFormatLabel:{CATAST_Pol_Municipio:"{0}",ESTADI_Pol_EntidadPob:"{1} ({0})"},searchWeight:2,styles:{CATAST_Pol_Municipio:{polygon:{fillColor:"#000000",fillOpacity:0,strokeColor:"#ffffff",strokeWidth:5,strokeOpacity:1}},ESTADI_Pol_EntidadPob:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#feba1e",strokeWidth:2,strokeOpacity:1}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.COUNCIL]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Concejo",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CCONCEJO"],queryProperties:{tProperty:["CONCEJO"]},outputProperties:["MUNICIPIO","CONCEJO"],outputFormatLabel:"{1} ({0})",searchWeight:2,parser:e.getAddress,goTo:e.goToAddress,idPropertiesIdentifier:"#",suggestionListHead:function(){return{label:e.getLocaleString("search.list.council"),color:{"#49006a":e.getLocaleString("search.list.council")}}},styles:{CATAST_Pol_Concejo:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#49006a",strokeWidth:2,strokeOpacity:1}}}},e.availableSearchTypes[TC.Consts.searchType.STREET]={root:null,limit:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Lin_CalleEje",renderFeatureType:"CATAST_Txt_Calle",dataIdProperty:["CVIA"],queryProperties:{tProperty:["ENTINOAC","ENTIDADC"],sProperty:["VIA","VIANOAC"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.street"),color:{"#CB0000":e.getLocaleString("search.list.street")}}},outputProperties:["ENTIDADC","VIA","CENTIDADC","CMUNICIPIO"],outputFormatLabel:"{1}, {0}",styles:{CATAST_Lin_CalleEje:{line:{strokeColor:"#CB0000",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid"}},CATAST_Txt_Calle:{point:{label:"VIA",angle:"CADANGLE",fontColor:"#000000",fontSize:7,fontWeight:"bold",labelOutlineColor:"#ffffff",labelOutlineWidth:2}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.NUMBER]={root:null,limit:null,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Txt_Portal",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDADC","CVIA","PORTAL"],queryProperties:{tProperty:["ENTIDADC","ENTINOAC"],sProperty:["VIA","VIANOAC"],pProperty:["PORTAL"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.number"),color:{"#CB0000":e.getLocaleString("search.list.number")}}},outputProperties:["ENTIDADC","VIA","PORTAL","CENTIDADC","CMUNICIPIO"],outputFormatLabel:"{1} {2}, {0}",styles:{CATAST_Txt_Portal:{point:{radius:0,label:"PORTAL",angle:"CADANGLE",fontColor:"#CB0000",fontSize:14,fontWeight:"bold",labelOutlineColor:"#FFFFFF",labelOutlineWidth:4}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.URBAN]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"ESTADI_Pol_EntidadPob",renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDAD"],idPropertiesIdentifier:"#",queryProperties:{tProperty:["ENTINOAC","ENTIDAD"]},suggestionListHead:function(){return{label:e.getLocaleString("search.list.urban"),color:{"#feba1e":e.getLocaleString("search.list.urban")}}},outputProperties:["MUNICIPIO","ENTIDAD"],outputFormatLabel:"{1} ({0})",searchWeight:2,styles:{ESTADI_Pol_EntidadPob:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#feba1e",strokeWidth:2,strokeOpacity:1}}},parser:e.getAddress,goTo:e.goToAddress},e.availableSearchTypes[TC.Consts.searchType.COMMONWEALTH]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["POLUCI_Pol_MancoRSUg"],renderFeatureType:"",dataIdProperty:["CMANCOMUNI"],queryProperties:{tProperty:["MANCOMUNID"]},outputProperties:["MANCOMUNID"],outputFormatLabel:"{0}",searchWeight:1,styles:{POLUCI_Pol_MancoRSUg:{polygon:{fillColor:"#000000",fillOpacity:.1,strokeColor:"#fc4e2a",strokeWidth:2,strokeOpacity:1}}}},e.rootCfg={},e.rootCfg[TC.Consts.searchType.MUNICIPALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"CATAST_Pol_Municipio",dataIdProperty:["CMUNICIPIO"],queryProperties:{tProperty:["MUNICIPIO"]},outputProperties:["MUNICIPIO"],outputFormatLabel:"{0}",getRootLabel:function(){var t=new $.Deferred;if(e.rootCfg.active&&!e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel){var r={};r.SERVICE="WFS",r.VERSION=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].version,r.REQUEST="GetFeature",r.TYPENAME=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].featurePrefix+":"+e.rootCfg[TC.Consts.searchType.MUNICIPALITY].featureType,r.OUTPUTFORMAT=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputFormat,r.PROPERTYNAME=["CMUNICIPIO"].concat(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties).join(","),r.CQL_FILTER=e.rootCfg[TC.Consts.searchType.MUNICIPALITY].root.map(function(e){return["CMUNICIPIO"].map(function(t,r){return t+"="+e[r]}).join(" AND ")}),r.CQL_FILTER=r.CQL_FILTER.join(" OR "),$.ajax({url:e.rootCfg[TC.Consts.searchType.MUNICIPALITY].url+"?"+$.param(r),type:"GET"}).done(function(r){r.totalFeatures>0?(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel=r.features.map(function(t){return{id:["CMUNICIPIO"].map(function(e){return t.properties[e]}).join("#"),label:t.properties[e.rootCfg[TC.Consts.searchType.MUNICIPALITY].outputProperties[0]].toLowerCase()}}),t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel)):(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel=[],t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel))}).fail(function(){t.resolve([])})}else t.resolve(e.rootCfg[TC.Consts.searchType.MUNICIPALITY].rootLabel);return t}},e.rootCfg[TC.Consts.searchType.LOCALITY]={root:null,limit:!1,url:e.url||"//idena.navarra.es/ogc/wfs",version:e.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:e.featurePrefix||"IDENA",geometryName:"the_geom",featureType:["ESTADI_Pol_EntidadPob"],renderFeatureType:"",dataIdProperty:["CMUNICIPIO","CENTIDADC"],queryProperties:{tProperty:["ENTINOAC"]},outputProperties:["ENTINOAC"],getRootLabel:function(){var t=new $.Deferred;if(e.rootCfg.active&&!e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel){var r={};r.SERVICE="WFS",r.VERSION=e.rootCfg[TC.Consts.searchType.LOCALITY].version,r.REQUEST="GetFeature",r.TYPENAME=e.rootCfg[TC.Consts.searchType.LOCALITY].featurePrefix+":"+e.rootCfg[TC.Consts.searchType.LOCALITY].featureType,r.OUTPUTFORMAT=e.rootCfg[TC.Consts.searchType.LOCALITY].outputFormat,r.PROPERTYNAME=["CMUNICIPIO","CENTIDAD"].concat(e.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties).join(","),r.CQL_FILTER=e.rootCfg[TC.Consts.searchType.LOCALITY].root.map(function(e){return["CMUNICIPIO","CENTIDAD"].map(function(t,r){return t+"="+e[r]}).join(" AND ")}),r.CQL_FILTER=r.CQL_FILTER.join(" OR "),$.ajax({url:e.rootCfg[TC.Consts.searchType.LOCALITY].url+"?"+$.param(r),type:"GET"}).done(function(r){r.totalFeatures>0?(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel=r.features.map(function(t){return{id:["CMUNICIPIO","CENTIDAD"].map(function(e){return t.properties[e]}).join("#"),label:t.properties[e.rootCfg[TC.Consts.searchType.LOCALITY].outputProperties[0]].toLowerCase()}}),t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel)):(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel=[],t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel))}).fail(function(){t.resolve([])})}else t.resolve(e.rootCfg[TC.Consts.searchType.LOCALITY].rootLabel);return t}},e.allowedSearchTypes=e.options.allowedSearchTypes||{},e.options.allowedSearchTypes)for(var t in e.options.allowedSearchTypes)e.availableSearchTypes[t]&&!$.isEmptyObject(e.options.allowedSearchTypes[t])&&($.extend(e.availableSearchTypes[t],e.options.allowedSearchTypes[t]),(e.options.allowedSearchTypes[t].root&&t!=TC.Consts.searchType.MUNICIPALITY&&e.options.allowedSearchTypes[t].rootType==TC.Consts.searchType.MUNICIPALITY||t!=TC.Consts.searchType.LOCALITY&&e.options.allowedSearchTypes[t].rootType==TC.Consts.searchType.LOCALITY)&&(e.rootCfg.active=e.rootCfg[e.options.allowedSearchTypes[t].rootType],e.rootCfg.active.root=e.options.allowedSearchTypes[t].root,e.rootCfg.active.limit=e.options.allowedSearchTypes[t].limit,e.availableSearchTypes[TC.Consts.searchType.STREET].queryProperties.tProperty=e.availableSearchTypes[TC.Consts.searchType.NUMBER].queryProperties.tProperty=e.rootCfg.active.dataIdProperty));e.rootCfg.active&&e.rootCfg.active.getRootLabel(),e.queryableFeatures=e.options.queryableFeatures||!1,e.UTMX_LEN=6,e.UTMY_LEN=7,e.CADASTRAL=TC.Consts.searchType.CADASTRAL,e.COORDINATES=TC.Consts.searchType.COORDINATES,e.MUNICIPALITY=TC.Consts.searchType.MUNICIPALITY,e.LOCALITY=TC.Consts.searchType.LOCALITY,e.COUNCIL=TC.Consts.searchType.COUNCIL,e.STREET=TC.Consts.searchType.STREET,e.NUMBER=TC.Consts.searchType.NUMBER,e.COMMONWEALTH=TC.Consts.searchType.COMMONWEALTH,e.URBAN=TC.Consts.searchType.URBAN,e.ROAD=TC.Consts.searchType.ROAD,e.ROADPK=TC.Consts.searchType.ROADPK,e.wrap=new TC.wrap.control.Search(e),e.interval=500,e.searchTypes={CADASTRAL_SEARCH:{parser:e.getCadastralRef,goTo:e.goToCadastralRef},COORDINATES_SEARCH:{parser:e.getCoordinates,goTo:e.goToCoordinates},ADDRESS_SEARCH:{types:[TC.Consts.searchType.MUNICIPALITY,TC.Consts.searchType.LOCALITY,TC.Consts.searchType.COUNCIL,TC.Consts.searchType.URBAN,TC.Consts.searchType.STREET,TC.Consts.searchType.NUMBER],parser:e.getAddress,goTo:e.goToAddress}},e.NORMAL_PATTERNS={ROMAN_NUMBER:/M{0,4}(CM|CD|D?C{0,3})(XC|XL|L?X{0,3})(IX|IV|V?I{0,3}){1,}?\S?\./i,ABSOLUTE_NOT_DOT:/[`~!@#$%^&*_|+\=?;:'"\{\}\[\]\\]/gi,ABSOLUTE:/[`~!@#$%^&*_|+\=?;:'.\{\}\[\]\\]/gi},e.filter=function(e){var t=function(t,r){for(var a=0;a<e._search.data.length;a++)if(e._search.data[a].id==t&&(!r||r&&e._search.data[a].dataRole===r))return e._search.data[a]},r=function(t){var r=e.availableSearchTypes[t.dataRole],a=t.dataLayer;return r.renderFeatureType&&(t.dataLayer instanceof Array||(a=[t.dataLayer]),a=a.concat(r.renderFeatureType instanceof Array?r.renderFeatureType:[r.renderFeatureType])),a};return{getPropertyName:function(t,r){return e.availableSearchTypes[t].queryProperties[r+"Property"]},getPropertyValue:function(t,r){return e.availableSearchTypes[t][r]},getIsLikeNode:function(t,r){var a=/([\-\"\.\º\(\)\/])/g;return a.test(r)&&(r=r.replace(a,"\\$1")),r.toString().indexOf(e._LIKE_PATTERN)>-1?'<Or><PropertyIsLike escape="\\" singleChar="_" wildCard="*" matchCase="false"><PropertyName>'+t+"</PropertyName><Literal>"+r.toLowerCase().replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+'</Literal></PropertyIsLike><PropertyIsLike escape="\\" singleChar="_" wildCard="*" matchCase="false"><PropertyName>'+t+"</PropertyName><Literal>"+r.toUpperCase().replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsLike></Or>":"<PropertyIsEqualTo><PropertyName>"+t+"</PropertyName><Literal>"+r.replace(/\</gi,"&lt;").replace(/\>/gi,"&gt;")+"</Literal></PropertyIsEqualTo>"},getFilterNode:function(t,r){var a;if(t instanceof Array||"string"==typeof t){if(t instanceof Array&&t.length>1){a="<ogc:Or>";for(var o=0;o<t.length;o++)a+=e.filter.getIsLikeNode($.trim(t[o]),r);return a+="</ogc:Or>"}return e.filter.getIsLikeNode($.trim(t instanceof Array&&1===t.length?t[0]:t),r)}var s=[];for(var i in t)if(t[i]instanceof Array&&t[i].length>1){a="<Or>";for(var o=0;o<t[i].length;o++)a+=e.filter.getIsLikeNode($.trim(t[i][o]),r);a+="</Or>",s.push('(<Filter xmlns="http://www.opengis.net/ogc">'+a+"</Filter>)")}else{var n=t[i];t[i]instanceof Array&&1==t[i].length&&(n=t[i][0]),s.push('(<Filter xmlns="http://www.opengis.net/ogc"><Or>'+e.filter.getIsLikeNode($.trim(n),r)+"</Or></Filter>)")}return s.join("")},getFilter:function(t,r){var a={};a.multiL=!1,a.f="";var o,s=function(t,r){var a=[];if(r!=e.rootCfg.active.root)for(var o=r.split("#"),s=0;s<e.rootCfg.active.dataIdProperty.length;s++)0==s&&e.rootCfg.active.dataIdProperty.length>1&&a.push("<ogc:And>"),a.push(e.filter.getFilterNode(e.rootCfg.active.dataIdProperty[s],o.length>s?o[s]:o[0])),s==e.rootCfg.active.dataIdProperty.length-1&&e.rootCfg.active.dataIdProperty.length>1&&a.push("</ogc:And>");else{for(var i=0;i<e.rootCfg.active.root.length;i++){var o=e.rootCfg.active.root[i];0==i&&e.rootCfg.active.root.length>1&&a.push("<ogc:Or>");for(var s=0;s<e.rootCfg.active.dataIdProperty.length;s++)0==s&&e.rootCfg.active.dataIdProperty.length>1&&a.push("<ogc:And>"),a.push(e.filter.getFilterNode(e.rootCfg.active.dataIdProperty[s],o.length>s?o[s]:o[0])),s==e.rootCfg.active.dataIdProperty.length-1&&e.rootCfg.active.dataIdProperty.length>1&&a.push("</ogc:And>")}e.rootCfg.active.root.length>1&&a.push("</ogc:Or>")}return t.concat(a)};switch(r){case e.NUMBER:if(o=[],e.rootCfg.active||!/(\<|\>|\<\>)/gi.exec(t.t)&&!/(\<|\>|\<\>)/gi.exec(t.s))e.rootCfg.active?o=s(o,t.t):o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)),o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN));else{var i=/(\<|\>|\<\>)/gi.exec(t.t);i?o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t.substring(0,t.t.indexOf(i[0])).trim()+e._LIKE_PATTERN)):e.rootCfg.active?o=s(o,t.t):o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)),i=/(\<|\>|\<\>)/gi.exec(t.s),o.push(i?e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s.substring(0,t.s.indexOf(i[0])).trim()+e._LIKE_PATTERN):e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN))}o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"p"),t.p+"*")),a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+o.join("")+"</ogc:And></ogc:Filter>";break;case e.STREET:if(o=[],e.rootCfg.active||!/(\<|\>|\<\>)/gi.exec(t.t)&&!/(\<|\>|\<\>)/gi.exec(t.s))e.rootCfg.active?o=s(o,t.t):o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)),o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN));else{var i=/(\<|\>|\<\>)/gi.exec(t.t);i?o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t.substring(0,t.t.indexOf(i[0])).trim()+e._LIKE_PATTERN)):e.rootCfg.active?o=s(o,t.t):o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)),i=/(\<|\>|\<\>)/gi.exec(t.s),o.push(i?e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s.substring(0,t.s.indexOf(i[0])).trim()+e._LIKE_PATTERN):e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN))}a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+o.join("")+"</ogc:And></ogc:Filter>";break;case e.COUNCIL:a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)+"</ogc:Filter>";break;case e.URBAN:a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)+"</ogc:Filter>";break;case e.LOCALITY:a.f=e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN),a.multiL=!0;break;case e.MUNICIPALITY:a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)+"</ogc:Filter>";break;case e.ROAD:a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc">'+e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)+"</ogc:Filter>";break;case e.ROADPK:var o=[];o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"t"),e._LIKE_PATTERN+t.t+e._LIKE_PATTERN)),o.push(e.filter.getFilterNode(e.filter.getPropertyName(r,"s"),e._LIKE_PATTERN+t.s+e._LIKE_PATTERN)),a.f='<ogc:Filter xmlns:ogc="http://www.opengis.net/ogc"><ogc:And>'+o.join("")+"</ogc:And></ogc:Filter>"}return a},getParams:function(t,r,a,o){var s=e.filter.getFilter(t,r),i={REQUEST:"GetFeature",SERVICE:"WFS",MAXFEATURES:500,VERSION:e.availableSearchTypes[r].version,OUTPUTFORMAT:e.availableSearchTypes[r].outputFormat},n=e.filter.getPropertyValue(r,"featureType");if(n instanceof Array){for(var l=[],c=0;c<n.length;c++)l.push(e.availableSearchTypes[r].featurePrefix?e.availableSearchTypes[r].featurePrefix+":"+$.trim(n[c]):$.trim(n[c]));i.TYPENAME=l.join(",")}else i.TYPENAME=e.availableSearchTypes[r].featurePrefix?e.availableSearchTypes[r].featurePrefix+":"+$.trim(n):$.trim(n);var p=function(e){if(""!==(e||"")){if(e instanceof Array)return e.join(",");var t=[];if(e instanceof Object)for(var r in e){var a=e[r][0];e[r].length>1&&(a=e[r].join(",")),t.push(a)}return t}},T=p(a),u=p(o);if(T instanceof Array&&u instanceof Array){i.PROPERTYNAME="";for(var c=0;c<T.length;c++)i.PROPERTYNAME+="("+T[c]+","+u[c]+")"}else i.PROPERTYNAME=T+","+u;return i.FILTER=s.f,$.param(i)},getGoToFilterLayer:function(e,a){var o=t(e,a);return r(o)},getGoToFilter:function(a,o){var s=[],i=a.split("#"),n=t(a,o);if(n&&n.dataRole){var l=e.availableSearchTypes[n.dataRole],c=l.dataIdProperty,p=r(n);if(a.indexOf("#")>-1&&p instanceof Array)for(var T=0;T<p.length;T++)for(var u=0;u<c[p[T]].length;u++)s.push({name:c[p[T]][u],value:i[u]});else if(-1==a.indexOf("#")&&p instanceof Array){for(var f=c,T=0;T<p.length;T++)if(!s.hasOwnProperty(p[T])){f instanceof Object&&c.hasOwnProperty(p[T])&&(f=c[p[T]]);for(var u=0;u<f.length;u++)u<i.length&&s.push({name:f[u],value:i[u]})}}else{c instanceof Object&&c.hasOwnProperty(p)&&(c=c[p]);for(var T=0;T<c.length;T++)s.push({name:c[T],value:i[T]})}}return e.transformFilter(s)},getGoToElement:function(e){return t(e)}}}(e)},TC.inherit(TC.control.Search,TC.Control),function(){var e=TC.control.Search.prototype;e.CLASS="tc-ctl-search",TC.Consts.event.SEARCHQUERYEMPTY=TC.Consts.event.SEARCHQUERYEMPTY||"searchqueryempty.tc",e.template=TC.isDebug?TC.apiLocation+"TC/templates/Search.html":function(){function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"search.1"}).w('</h2><div class="tc-ctl-search-content"><input type="search" class="tc-ctl-search-txt" placeholder="').h("i18n",t,{},{$key:"search.placeholder"}).w('" title="').h("i18n",t,{},{$key:"search.instructions"}).w('" /><a title="').h("i18n",t,{},{$key:"search.instructions"}).w('" class="tc-ctl-btn tc-ctl-search-btn">').h("i18n",t,{},{$key:"search.2"}).w('</a><ul class="tc-ctl-search-list"></ul></div>')}return dust.register(e.CLASS,t),t.__dustBody=!0,t},e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t._search={data:[]},t.layerStyleFN=function(){function e(e){return e.indexOf(".")>-1?e.split(".")[0]:e}function r(e,r,a){for(var o in t.allowedSearchTypes){var s=t.availableSearchTypes[o]||t.allowedSearchTypes[o];if(s&&s.hasOwnProperty("featureType")&&(s.featureType.indexOf(a)>-1||s.renderFeatureType&&s.renderFeatureType.indexOf(a)>-1)&&s.styles[a].hasOwnProperty(r))return s.styles[a][r][e]}return TC.Cfg.styles[r][e]}return function(t,a,o,s){var i=this;s instanceof TC.Feature||i.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:i.layer,geom:s.geom}));var n=r(a,t,e(s.id));if(o){if(n instanceof Array){var l=n.map(function(e){return s.getData().hasOwnProperty(e)?s.getData()[e]:""}),c=this.getSearchTypeByFeature(e(s.id));return c?c.outputFormatLabel.tcFormat(l):l.join(" ")}return s.getData().hasOwnProperty(n)?s.getData()[n]:""}return n}}(),e.loaded(function(){var r=t.layerStyleFN;t.layerPromise=e.addLayer({id:TC.getUID(),title:"Búsquedas",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{polygon:{fillColor:r.bind(t,"polygon","fillColor",!1),fillOpacity:r.bind(t,"polygon","fillOpacity",!1),strokeColor:r.bind(t,"polygon","strokeColor",!1),strokeOpacity:r.bind(t,"polygon","strokeOpacity",!1),strokeWidth:r.bind(t,"polygon","strokeWidth",!1)},line:{strokeColor:r.bind(t,"line","strokeColor",!1),strokeOpacity:r.bind(t,"line","strokeOpacity",!1),strokeWidth:r.bind(t,"line","strokeWidth",!1)},marker:{anchor:TC.Defaults.styles.marker.anchor,height:TC.Defaults.styles.marker.height,width:TC.Defaults.styles.marker.width},point:{radius:r.bind(t,"point","radius",!1),height:r.bind(t,"point","height",!1),width:r.bind(t,"point","width",!1),fillColor:r.bind(t,"point","fillColor",!1),fillOpacity:r.bind(t,"point","fillOpacity",!1),strokeColor:r.bind(t,"point","strokeColor",!1),strokeWidth:r.bind(t,"point","strokeWidth",!1),fontSize:r.bind(t,"point","fontSize",!1),fontColor:r.bind(t,"point","fontColor",!1),labelOutlineColor:r.bind(t,"point","labelOutlineColor",!1),labelOutlineWidth:r.bind(t,"point","labelOutlineWidth",!1),label:r.bind(t,"point","label",!0),angle:r.bind(t,"point","angle",!0)}}}),$.when(t.layerPromise).then(function(e){t.layer=e})}),t.EMPTY_RESULTS_LABEL=t.getLocaleString("noResults"),t.EMPTY_RESULTS_TITLE=t.getLocaleString("checkCriterion"),t.OUTBBX_LABEL=t.getLocaleString("outsideOfLimits"),t.WFS_TYPE_ATTRS=["url","version","geometryName","featurePrefix","featureType","properties","outputFormat"],t.availableSearchTypes[TC.Consts.searchType.ROAD]={root:null,limit:!1,url:t.url||"//idena.navarra.es/ogc/wfs",version:t.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:t.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"INFRAE_Lin_CtraEje",dataIdProperty:["DCARRETERA"],queryProperties:{tProperty:["DCARRETERA"]},suggestionListHead:function(){return{label:t.getLocaleString("search.list.road"),color:{"#00b2fc":t.getLocaleString("search.list.road")}}},outputProperties:["DCARRETERA"],outputFormatLabel:t.getLocaleString("search.list.road.shorter")+": {0}",searchWeight:2,styles:{INFRAE_Lin_CtraEje:{polygon:{strokeColor:"#00b2fc",strokeOpacity:1,strokeWidth:5},line:{strokeColor:"#00b2fc",strokeOpacity:1,strokeWidth:5,strokeLinecap:"round",strokeDashstyle:"solid"}}},parser:t.getRoad,goTo:t.goToRoad,pattern:new RegExp("^(?:(?:"+t.getLocaleString("search.list.road")+"|"+t.getLocaleString("search.list.road.shorter")+")\\:?)?\\s*((A?|AP?|N?|NA?|PA?)\\s*\\-?\\s*(\\d{1,4})\\s*\\-?\\s*(A?|B?|C?|R?))$","i")},t.availableSearchTypes[TC.Consts.searchType.ROADPK]={root:null,limit:!1,url:t.url||"//idena.navarra.es/ogc/wfs",version:t.version||"1.1.0",outputFormat:TC.Consts.format.JSON,featurePrefix:t.featurePrefix||"IDENA",geometryName:"the_geom",featureType:"INFRAE_Sym_CtraPK",dataIdProperty:["DCARRETERA","CPK"],queryProperties:{tProperty:["DCARRETERA"],sProperty:["PK"]},suggestionListHead:function(){return{label:t.getLocaleString("search.list.pk.larger"),color:{"#00b2fc":t.getLocaleString("search.list.road")+" "+t.getLocaleString("search.list.pk")}}},outputProperties:["DCARRETERA","PK"],outputFormatLabel:t.getLocaleString("search.list.road.shorter")+": {0} "+t.getLocaleString("search.list.pk")+": {1}",searchWeight:2,styles:{INFRAE_Sym_CtraPK:{point:{label:["DCARRETERA","PK"],fontColor:"#00b2fc",fontSize:14,fontWeight:"bold",labelOutlineColor:"#ffffff",labelOutlineWidth:2}}},parser:t.getPK,goTo:t.goToPK,pattern:new RegExp("^(?:(?:"+t.getLocaleString("search.list.road")+"|"+t.getLocaleString("search.list.road.shorter")+")\\:?)?\\s*((A?|AP?|N?|NA?|PA?)\\s*\\-?\\s*(\\d{1,4})\\s*\\-?\\s*(A?|B?|C?|R?))\\s*\\,*\\s*(?:(?:"+t.getLocaleString("search.list.pk")+"\\:?)|(?:P\\:?)|(?:K\\:?)|(?:KM\\:?)|(?:\\s+|\\,+))\\s*(\\d{1,4})$","i")}},e.renderData=function(e,t){var r=this;r._search=r._search||{};var a=function(){r.search(r.$text.val(),function(e){1===e.length?(r.$text.val(e[0].label),r.goToResult(e[0].id),r.$list.hide("fast")):0===e.length&&r.$list.hide("fast")})};TC.Control.prototype.renderData.call(r,e,function(){var e=function(){r.$text.val(r.$list[0].label||r.$list.find("li:not([header]) > a > span").text()),r.lastPattern=r.$text.val(),r.goToResult(r.$list[0].id||unescape(r.$list.find("li:not([header]) > a").attr("href")).substring(1)),r.$list.hide("fast")};r.$text=r._$div.find("input.tc-ctl-search-txt"),r.$list=r._$div.find(".tc-ctl-search-list"),r.$button=r._$div.find(".tc-ctl-search-btn"),r.$button.on(TC.Consts.event.CLICK,function(){r.getLayer().then(function(t){r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length>1||(t.features.length>0?t.map.zoomToFeatures(t.features):1===r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length?e():r.$text.trigger("keyup.autocomplete"))})}),r.$list.on(TC.Consts.event.CLICK,"a.tc-ctl-search-li-empty",function(){r.$list.hide("fast"),r.$text.focus()});try{if(r.$text.has($("::-ms-clear"))){var t;r.$text.on("mouseup",function(e){t=r.$text.val(),""!==t&&setTimeout(function(){var e=r.$text.val();""===e&&(r.$list.hide("fast"),a())},1)})}}catch(o){}r.$text.on("keypress",function(t){return 13==t.which?(t.preventDefault(),t.stopPropagation(),r.lastPattern="",1===r.$list.find("li > a:not(.tc-ctl-search-li-loading,.tc-ctl-search-li-empty)").length?e():a(),!1):void 0}).on("search",function(){0===r.$text.val().length&&(r.$list.hide("fast"),a())}).on("input",function(){0===r.$text.val().length&&(r.$list.hide("fast"),a())}).on("targetCleared.autocomplete",function(){r.$list.hide("fast")}).on("targetUpdated.autocomplete",function(){r.$list.find("li").length>0&&r.$list.show("fast")}),r.lastPattern="",r.retryTimeout=null,TC.loadJS(!r.$text.autocomplete,[TC.apiLocation+"lib/jQuery/autocomplete.js"],function(){var e;r.$text=r._$div.find("input.tc-ctl-search-txt"),r.$text.autocomplete({link:"#",target:r.$list,minLength:2,ctx:r,source:function(t,a){function o(){var t=r.$text.val().trim();t.length>0&&(!r.lastPattern||t!=r.lastPattern)&&performance.now()-r.lastpress>r.interval?(window.cancelAnimationFrame(e),e=void 0,r.$list.hide("fast"),r.lastPattern=t,r.search(t,a)):e=requestAnimationFrame(o)}r.lastpress=performance.now(),e||(e=requestAnimationFrame(o))},callback:function(e){var t=$(e.target);$(e.target).is("a")||(t=$(e.target).closest("a")),r.$text.val($(t).find("span[hidden]").text()),r.lastPattern=r.$text.val(),r.goToResult(unescape($(t).attr("href")).substring(1),$(t).parent().attr("dataRole")),r.$text.autocomplete("clear")},buildHTML:function(e){function t(e,t){var r=parseInt(e,10),a=parseInt(t,10);if(isNaN(r)&&isNaN(a)){var o=e.replace(s,""),n=t.replace(s,"");if(o===n){var l=parseInt(e.replace(i,""),10),c=parseInt(t.replace(i,""),10);return l===c?0:l>c?1:-1}return o>n?1:-1}return isNaN(r)?1:isNaN(a)?-1:r>a?1:-1}var a=[],o=[],s=/[^a-zA-Z]/g,i=/[^0-9]/g,n=e.results.sort(function(e,r){return e.dataRole>r.dataRole?1:e.dataRole<r.dataRole?-1:t(e.label,r.label)});r.rootCfg.active&&(n=n.sort(function(e,r){var a=this.rootCfg.active.root[0].join("-"),o=this.rootCfg.active.dataIdProperty.map(function(t){return e.properties[t].toString()}).join("-"),s=this.rootCfg.active.dataIdProperty.map(function(e){return r.properties[e].toString()}).join("-");return o!==a&&s===a?1:o===a&&s!==a?-1:t(e.label,r.label)}.bind(r)));for(var l=0;l<n.length;l++){var c=n[l];if(-1==o.indexOf(c.dataRole)){var p=this.ctx.availableSearchTypes[c.dataRole]||this.ctx.allowedSearchTypes[c.dataRole],T=p.suggestionListHead(),u='<li header><span class="header">'+T.label+"</span>";for(var f in T.color)u+='<span class="header-color" title="'+T.color[f]+'" style="color: '+f+';"></span>';a[a.length]=u+"</li>",o.push(c.dataRole)}var C=c.label,h=[],g=this.ctx.lastPattern;g=r.NORMAL_PATTERNS.ROMAN_NUMBER.test(g)?g.replace(r.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT,""):g.replace(r.NORMAL_PATTERNS.ABSOLUTE,"");var y=[],d=",";if(-1==g.indexOf(d)&&(d=" "),y=g.trim().split(d),c.label.indexOf(this.ctx.LAT_LABEL)>-1&&c.label.indexOf(this.ctx.LON_LABEL)>-1||c.label.indexOf(this.ctx.UTMX_LABEL)>-1&&c.label.indexOf(this.ctx.UTMY_LABEL)>-1){y=this.ctx.lastPattern.split(" ");for(var A=0;A<y.length;A++)","==y[A].trim().slice(-1)&&(y[A]=y[A].slice(0,-1))}for(var m=0;m<y.length;m++)if(y[m].trim().length>0){h.push("("+y[m].trim().replace(/\(/gi,"\\(").replace(/\)/gi,"\\)")+")");

var L=/((\<)|(\>)|(\<\>))/gi.exec(y[m].trim());if(L)for(var v=y[m].trim().replace(/((\<)|(\>)|(\<\>))/gi,"").split(" "),P=0;P<v.length;P++)v[P].trim().length>0&&h.push("("+v[P].trim().replace(/\(/gi,"\\(").replace(/\)/gi,"\\)")+")")}if(c.dataRole==TC.Consts.searchType.ROAD||c.dataRole==TC.Consts.searchType.ROADPK){var E=r.availableSearchTypes[c.dataRole].pattern,L=E.exec(this.ctx.lastPattern);L&&(h=[],L[2]&&L[3]&&(h.push(L[2]+"-"+L[3]),L[4]&&(h[h.length-1]=h[h.length-1]+"-"+L[4]),h[h.length-1]="("+h[h.length-1]+")"),L[5]&&h.push("(?:"+r.getLocaleString("search.list.pk")+"\\:\\s\\d*)("+L[5]+")\\d*"))}var S="("+h.join("|")+")";S=S.replace(/a/gi,"[a|á]"),S=S.replace(/e/gi,"[e|é]"),S=S.replace(/i/gi,"[i|í]"),S=S.replace(/o/gi,"[o|ó]"),S=S.replace(/u/gi,"[u|ú|ü]");var N=new RegExp(S,"gi"),I=c.label;C=c.dataRole==TC.Consts.searchType.ROAD||c.dataRole==TC.Consts.searchType.ROADPK?I.replace(N,function(){var e=Array.prototype.slice.call(arguments,0);return e[e.length-3]?e[0].replace(e[e.length-3],"<b>"+e[e.length-3]+"</b>"):"<b>"+e[0]+"</b>"}):I.replace(N,"<b>$1</b>"),a[a.length]='<li dataRole="'+c.dataRole+'"><a href="#'+encodeURIComponent(c.id)+'"><span hidden>'+c.label+"</span>"+C+"</a></li>"}return a.join("")}}),r.$text.add(r.$list).keydown(function(e){e.ctrlKey||e.altKey||e.shiftKey||(40===e.keyCode?(r.$text[0]==document.activeElement?r.$list.find("li:not([header]):first a").focus():r.$list.find("li:not([header]):last a").is(":focus")?r.$text.focus():r.$list.find("li:not([header])").find("a:focus").parent("li:not([header])").nextAll("li:not([header]):first").find("a").focus(),e.preventDefault(),e.stopPropagation()):38===e.keyCode&&(r.$text[0]==document.activeElement?r.$list.find("li:not([header]):last a").focus():document.activeElement==r.$list.find("li:not([header]):first a").get(0)?r.$list.find("li:not([header]):last a").focus():r.$list.find("li:not([header])").find("a:focus").parent("li:not([header])").prevAll("li:not([header]):first").find("a").focus(),e.preventDefault(),e.stopPropagation())),e.stopPropagation()})})}),$.isFunction(t)&&t()},e.getLayer=function(){var e=this;if(e.layerPromise=e.layerPromise||new $.Deferred,e.layer){var t=new $.Deferred;return t.resolve(e.layer),t}return e.layerPromise},e.getFeatures=function(){var e=this;return e.layer.features},e.getSearchTypeByFeature=function(e){var t=this;for(var r in t.allowedSearchTypes){var a=t.availableSearchTypes[r]||t.allowedSearchTypes[r];if(a&&a.hasOwnProperty("featureType")&&(a.featureType.indexOf(e)>-1||a.renderFeatureType&&a.renderFeatureType.indexOf(e)>-1))return a}return null},e.cleanMap=function(){var e=this;e.getLayer().then(function(t){var r=t.features;t.clearFeatures(),e.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:t,feature:r}));for(var a=0;a<e.WFS_TYPE_ATTRS.length;a++)t.hasOwnProperty(e.WFS_TYPE_ATTRS[a])&&delete t[e.WFS_TYPE_ATTRS[a]]})},e.getMunicipalities=function(){var e=this;if(TC.cache.search=TC.cache.search||{},!TC.cache.search.municipalities){e._municipalitiesDeferred=new $.Deferred;var t={REQUEST:"GetFeature",SERVICE:"WFS",TYPENAME:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featureType,VERSION:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].version,PROPERTYNAME:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties.join(","),OUTPUTFORMAT:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat};e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix&&(t.TYPENAME=e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix+":"+t.TYPENAME);var r=e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].url+"?"+$.param(t);$.ajax({url:r,type:"GET",dataType:"text"}).done(function(t){var r;r=e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat===TC.Consts.format.JSON?new TC.wrap.parser.JSON:new TC.wrap.parser.WFS({featureNS:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featurePrefix,featureType:e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.featureType});var a=r.read(t);TC.cache.search.municipalities=[];for(var o=0;o<a.length;o++){var s=a[o];TC.cache.search.municipalities.push({label:s.data[e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties[1]],id:s.data[e.availableSearchTypes[TC.Consts.searchType.CADASTRAL].municipality.outputProperties[0]]})}TC.cache.search.municipalities.sort(function(e,t){var r;return r=e.label<t.label?-1:e.label>t.label?1:0}),e._municipalitiesDeferred.resolve(TC.cache.search.municipalities)}).fail(function(){e._municipalitiesDeferred.resolve()})}return TC.cache.search.municipalities||e._municipalitiesDeferred.promise()},e.getCoordinates=function(e){var t=this,r=new $.Deferred,a=e.match(new RegExp("^"+$.trim(t.UTMX_LABEL.toLowerCase())+"*\\s*([0-9]{"+t.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*"+$.trim(t.UTMY_LABEL.toLowerCase())+"*\\s*([0-9]{"+t.UTMY_LEN+"}(?:[.,]\\d+)?)$"));if(a&&(e=a[1]+" "+a[2]),a=e.match(new RegExp("^"+$.trim(t.LAT_LABEL.toLowerCase())+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(t.LON_LABEL.toLowerCase())+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$")),a&&(e=a[1]+" "+a[3]),/\d/.test(e)&&(new RegExp("^([0-9]{"+t.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*([0-9]{"+t.UTMY_LEN+"}(?:[.,]\\d+)?)$").test(e)||/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.test(e)))if(a=/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.exec(e),a&&(a[1].indexOf(",")>-1||a[3].indexOf(",")>-1)&&(a[1]=a[1].replace(",","."),a[3]=a[3].replace(",","."),e=a[1]+" "+a[3]),!a||a&&(a[1].indexOf(",")>-1?a[1].replace(",","."):a[1])<=180&&(a[3].indexOf(",")>-1?a[3].replace(",","."):a[3])<=90){a=new RegExp("^([0-9]{"+t.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*([0-9]{"+t.UTMY_LEN+"}(?:[.,]\\d+)?)$").exec(e),a&&(a[1].indexOf(",")>-1||a[2].indexOf(",")>-1)&&(a[1]=a[1].replace(",","."),a[2]=a[2].replace(",","."),e=a[1]+" "+a[2]),e=e.replace(t.UTMX_LABEL,"").replace(t.UTMY_LABEL,"").replace(t.LON_LABEL,"").replace(t.LAT_LABEL,"");var o=TC.Util.parseCoords(e);if(o){var s=o[0].value,i=o[1].value,n=o[0].type===TC.Consts.UTM?t.UTMX:t.LAT,l=o[1].type===TC.Consts.UTM?t.UTMY:t.LON,c=n+s+l+i,p=t.getPoint(c);p&&!t.insideLimit(p)&&(s=o[1].value,i=o[0].value,n=o[1].type===TC.Consts.UTM?t.UTMX:t.LAT,l=o[0].type===TC.Consts.UTM?t.UTMY:t.LON,c=n+s+l+i,p=t.getPoint(c)),p?(t.availableSearchTypes[TC.Consts.searchType.COORDINATES].label=/^X(\d+(?:\.\d+)?)Y(\d+(?:\.\d+)?)$/.test(c)?t.getLocaleString("search.list.coordinates.utm")+t.map.crs:t.getLocaleString("search.list.coordinates.geo"),r.resolve([{id:c,label:t.getLabel(c),dataRole:TC.Consts.searchType.COORDINATES}])):r.resolve([])}else r.resolve([])}else r.resolve([]);else r.resolve([]);return r.promise()},e.getCadastralRef=function(e){var t=this,r=new $.Deferred,a=e.match(new RegExp($.trim(t.MUN_LABEL.toLowerCase())+"?\\s(.*)\\,\\s?"+$.trim(t.POL_LABEL.toLowerCase())+"?\\s(\\d{1,2})\\,\\s?"+$.trim(t.PAR_LABEL.toLowerCase())+"?\\s(\\d{1,4})"));a&&(e=a[1]+", "+a[2]+", "+a[3]);var o=e;return!/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.test(e)&&t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].suggestionRoot&&(o=t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].suggestionRoot+", "+e),/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.test(o)&&!new RegExp("^([0-9]{"+t.UTMX_LEN+"})\\s*\\,\\s*([0-9]{"+t.UTMY_LEN+"})$").test(e)?$.when(t.getMunicipalities()).then(function(e){var a=/^(.*)\,(\s*\d{1,2}\s*)\,(\s*\d{1,4}\s*)$/.exec(o);if(a){var s=new RegExp($.trim(a[1]).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i"),i=$.grep(e,function(e){return e=e.label||e.id||e,s.test(e)||s.test(t.removePunctuation(e))}),n=function(e,r,a,o){var s=[];return s.push[t.MUN]=e,s.push[t.POL]=a,s.push[t.PAR]=o,{id:t.MUN+e+t.POL+a+t.PAR+o,label:t.getLabel(t.MUN+r+t.POL+a+t.PAR+o),dataRole:TC.Consts.searchType.CADASTRAL,properties:s}};if(i.length>0)for(var l=0;l<i.length;l++)i[l]=n(i[l].id,i[l].label,$.trim(a[2]),$.trim(a[3]));/^[0-9]*$/g.test(a[1])&&i.push(n($.trim(a[1]),$.trim(a[1]),$.trim(a[2]),$.trim(a[3]))),r.resolve(i)}}):r.resolve([]),r.promise()},e.getAddress=function(e){var t=this,r=new $.Deferred,a=[],o=function(e){var r=[];for(var a in t.allowedSearchTypes)switch(!0){case a==TC.Consts.searchType.MUNICIPALITY:case a==TC.Consts.searchType.LOCALITY:case a==TC.Consts.searchType.COUNCIL:case a==TC.Consts.searchType.URBAN:case a==TC.Consts.searchType.STREET:case a==TC.Consts.searchType.NUMBER:t.availableSearchTypes[a]&&t.availableSearchTypes[a].hasOwnProperty("queryProperties")&&Object.keys(t.availableSearchTypes[a].queryProperties).length===Object.keys(e).length&&r.push(a)}return r=r.sort(function(e,r){return(t.availableSearchTypes[e].searchWeight||0)>=(t.availableSearchTypes[r].searchWeight||0)?1:0}).filter(function(e){for(var a=0;a<r.length;a++)if((t.availableSearchTypes[r[a]].searchWeight||0)>(t.availableSearchTypes[e].searchWeight||0))return!1;return!0})},s=function(e,r){var a;return a=t.availableSearchTypes[r].outputFormat===TC.Consts.format.JSON?new TC.wrap.parser.JSON:new TC.wrap.parser.WFS({featureNS:t.availableSearchTypes[r].featurePrefix,featureType:t.availableSearchTypes[r].featureType}),a.read(e)},i=function(e){var r="";e=t.removePunctuation(e);var a,o=/(.*)\s<>\s.*/;return(e.indexOf("(")>-1||e.indexOf(")")>-1)&&(o=/(.*)(\s<>\s.*\(.*\))/,e.indexOf("<>")>-1&&o.test(e)?(a=e.match(o),null!==a&&(r=e.replace(a[2],""),r=r.splitRemoveWhiteSpaces(",").join(","))):(o=/\(.*\)/,o.test(e)||(o=/\(.*/,o.test(e)||(o=/.*\)/,o.test(e)||(o=/\(.*\)/))),r=e.replace(o,""),r=r.splitRemoveWhiteSpaces(",").join(",")),e=r),e=t.NORMAL_PATTERNS.ROMAN_NUMBER.test(e)?e.replace(t.NORMAL_PATTERNS.ABSOLUTE_NOT_DOT,""):e.replace(t.NORMAL_PATTERNS.ABSOLUTE,""),e.toLowerCase()},n=function(e){for(var r=function(e){return/^(\d{1,3})\s?\-?\s?([a-z]{0,4})\s?\-?\s?([a-z]{0,4})$/i.test(e)},a=function(e){var r=[],a=/^(\d{1,3})\s?\-?\s?([a-z]{0,4})\s?\-?\s?([a-z]{0,4})$/i.exec(e);if(a){for(var o=1;o<a.length;o++)a[o].trim().length>0&&r.push(a[o].trim());return r.join(t._LIKE_PATTERN)}return e},o=function(e){return/^([a-z]{1,4})\s?\-?\s?(\d{1,3})$/i.test(e)},s=function(e){var r=[],a=/^([a-z]{1,4})\s?\-?\s?(\d{1,3})$/i.exec(e);if(a){for(var o=1;o<a.length;o++)a[o].trim().length>0&&r.push(a[o].trim());return r.join(t._LIKE_PATTERN)}return e},i=function(e){return/^(sn|S\/N|s\/n|s\-n)$/i.test(e)},n=function(e){var t=/^(sn|S\/N|s\/n|s\-n)$/i.exec(e);return t?"s*n":e},l=function(e){return/^([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.test(e)},c=function(e){var t=/^([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);return t?e:e},p=[r,o,i,l],T=[a,s,n,c],u=0;u<T.length&&!p[u].call(t,e);)u++;return u<T.length?T[u].call(t,e):e},l=function(e,r,a){var o=new $.Deferred;e=e.trim(),","==e.charAt(e.length-1)&&(e=e.substring(0,e.length-1));var s=[],i=function(e){if(r)for(var t=e.length;t--;)if(a){if(e[t].t){var o=this.rootCfg.active.rootLabel.filter(function(r){return r.label.indexOf(this.removePunctuation(e[t].t).toLowerCase())>-1}.bind(this));1==o.length?e[t].t=o[0].id:o.length>1?o.map(function(r){var a=$.extend({},e[t]);a.t=r.id,e.push(a)}):0==o.length&&e.splice(t,1)}}else e.push($.extend({},e[t],{t:r}))}.bind(t),l=function(e,t){var r=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);if(r&&r[1]&&r[2]){var a=function(){return n((r[3]||r[4]||r[5]||r[6]).trim())};return/^([^0-9]+)$/i.test(r[1].trim())&&/^([^0-9]+)$/i.test(r[2].trim())?(t.push({t:r[1].trim(),s:r[2].trim(),p:a()}),t.push({t:r[2].trim(),s:r[1].trim(),p:a()})):t.push(/^([^0-9]+)$/i.test(r[1].trim())?{t:r[1].trim(),s:r[2].trim(),p:a()}:{s:r[1].trim(),t:r[2].trim(),p:a()}),i(t),!0}return!1},c=function(e,t){var r=/^(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))(?:\s*\,\s*)([^0-9\,]+)$/i.exec(e);if(r&&r[6]&&r[1]){var a=function(){return n((r[2]||r[3]||r[4]||r[5]).trim())};return/^([^0-9]+)$/i.test(r[6].trim())&&/^([^0-9]+)$/i.test(r[1].trim())?(t.push({t:r[6].trim(),s:r[1].trim(),p:a()}),t.push({t:r[1].trim(),s:r[6].trim(),p:a()})):t.push(/^([^0-9]+)$/i.test(r[6].trim())?{t:r[6].trim(),s:r[1].trim(),p:a()}:{s:r[6].trim(),t:r[1].trim(),p:a()}),i(t),!0}return!1},p=function(e,t){var r=/^(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)([^0-9\,]+)(?:\s*\,\s*)(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);return r&&r[1]&&r[2]?(t.push({t:r[2].trim(),s:r[1].trim(),p:n((r[3]||r[4]||r[5]||r[6]).trim())}),i(t),!0):!1},T=function(e,r){var a=/^([^0-9\,]+)(?:\s*\,\s*)(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))$/i.exec(e);if(a&&a[1]&&a[2]){if(/^([^0-9]+)$/i.test(a[1].trim())&&/^([^0-9]+)$/i.test(a[2].trim()))r.push({t:a[1].trim(),s:a[2].trim()}),r.push({s:a[1].trim(),t:a[2].trim()});else{var o=function(e){for(var r=e.split(" ").reverse(),a=[],o=0;o<r.length;o++)1==r[o].length&&(a.push(r[o]),r[o]="");return a.length>0?r.reverse().join(" ").trim()+t._LIKE_PATTERN+a.reverse().join(t._LIKE_PATTERN):r.reverse().join(" ").trim()};r.push(/^([^0-9]+)$/i.test(a[1].trim())?{t:a[1].trim(),s:o(a[2].trim())}:{s:o(a[1].trim()),t:a[2].trim()})}return i(r),!0}return!1},u=function(e,r){var a=/^(?:([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+))(?:\s*\,\s*)([^0-9\,]+)$/i.exec(e);if(a){for(var o={},s=e.split(",").reverse(),l=0;l<s.length;l++)if(/^([^0-9\,]+)$/i.test(s[l].trim()))o.t=s[l].trim();else if(/(\s*\d+)/i.test(s[l].trim()))if(-1==s[l].trim().indexOf(" "))o.s=s[l].trim();else{for(var c=s[l].trim().split(" ").reverse(),p=function(e){var t=/^(?:(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e.trim());return t?(o.p=n(e.trim()),!0):!1},T=0,u=c[T].trim();T<c.length&&!p(u);)T++,T<c.length&&(u+=c[T]);if(o.p){for(var f=c,C=0;C<f.length;C++){for(var h=!1,g=0;g<f[C].split("").length;g++)o.p.indexOf(f[C][g])>-1&&(h=!0);if(h){{f[C]}if(f[C]="",o.p==n(u))break}}if(/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9]+)$/i.test(c.reverse().join(" ").trim())){for(var y=[],d=c.reverse(),A=0;A<d.length;A++)1==d[A].trim().length&&(y.push(d[A].trim()),d[A]="");o.s=y.length>0?d.reverse().join(" ").trim()+t._LIKE_PATTERN+y.reverse().join(t._LIKE_PATTERN):d.reverse().join(" ").trim()}r.push({t:o.t,s:o.s+" "+o.p})}else o.s=s[l].trim()}return r.push(o),i(r),!0}return!1},f=function(e,t){var a=/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/0-9\<\>]+)$/i.exec(e);return a&&a[1]?(t.push(r?{t:r,s:a[1].trim()}:{t:a[1].trim()}),!0):!1},C=function(e,t){var a=/^([^\,][a-z\u00f1\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\s*\-\.\(\)\/]+)\s*\,?\s*((\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4}))$/i.exec(e);return a&&a[1]&&a[2]?(t.push(r?{t:r,s:a[1].trim(),p:n(a[2].trim())}:{t:a[1].trim(),s:a[2].trim()}),!0):!1},h=function(e,t){var a=/^([^\,][0-9\s*\-\.\(\)\/]+)\s*\,?\s*(\d{1,3}\s?\-?\s?[a-z]{0,4}\s?\-?\s?[a-z]{0,4})|([a-z]{1,4}\s?\-?\s?\d{1,3})|(sn|S\/N|s\/n|s\-n)|([a-z]{1,4}\s?\+\s?[a-z]{1,4})$/i.exec(e);return a&&a[1]&&a[2]&&r?(t.push({t:r,s:a[1].trim(),p:n(a[2].trim())}),!0):!1},g=function(){for(var r=[function(e){return e.length>=3},function(e){return/^\d+$/.test(e)?!1:/^\d+\,\s*\d+$/.test(e)?!1:!0}],a=0;a<r.length;a++)if(!r[a].call(t,e))return!1;return!0};if(g(e)){var y=[l,c,p,T,u];y=r&&e.split(",").length<3?[C,h,f].concat(y):y.concat([C,h,f]);var d=0;try{for(;d<y.length&&!y[d].call(t,e,s);)d++}catch(A){TC.error("Error según el patrón: "+e,TC.Consts.msgErrorMode.EMAIL,"Error en la búsqueda del callejero")}}return s.length>0&&r?$.when(t.rootCfg.active.getRootLabel()).then(function(e){if(e)for(var a=s.length;a--;){var i=s[a];if(s.length>1&&i.t==r&&e.filter(function(e){return e.indexOf(t.removePunctuation(i.s).toLowerCase())>-1}).length>0){s.splice(a,1);break}}o.resolve(s)}):o.resolve(s),o.promise()},c=function(e,r,o,s){for(var i=0;i<e.length;i++){var n=[],l=[],c="",p=o,T=s,u=t.filter.getPropertyValue(r,"outputFormatLabel"),f=e[i].id.split(".").slice(0,1).shift();o instanceof Array||(p=o[f],T=s[f],u=u[f]);for(var C=0;C<p.length;C++)n.push(e[i].data[p[C]]);for(var C=0;C<T.length;C++)l.push(e[i].data[T[C]]);var h=function(e){for(var t=[],r=0;r<e.length;r++)-1==jQuery.inArray(e[r],t)&&t.push(e[r]);return t};n instanceof Array&&u&&h(n).length>1?c=u.tcFormat(n):n instanceof Array&&1==h(n).length&&(c=n[0]);var g=c.toCamelCase(),y=function(e,t){for(var r=0;r<a.length;r++)if(a[r].dataRole==e&&a[r].text.toLowerCase().trim()==t.toLowerCase().trim())return!0;return!1};if(!y(r,g)){for(var d=[],A=0;A<o.length;A++)d[o[A]]=n[A];a.push({text:g,label:g,id:l.join("#"),dataRole:r,dataLayer:f,properties:d})}}}.bind(t);return e=i(e),$.when(l(e,t.rootCfg.active&&t.rootCfg.active.root||"",t.rootCfg.active&&t.rootCfg.active.limit||!1)).then(function(e){function i(e,o){var i=t.filter.getPropertyValue(o,"outputProperties"),n=t.filter.getPropertyValue(o,"dataIdProperty");return $.ajax({url:t.availableSearchTypes[o].url,type:"POST",contentType:"application/x-www-form-urlencoded;charset=UTF-8",dataType:"text",data:t.filter.getParams(e,o,i,n),beforeSend:function(){t.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+t.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>'),t.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var t=s(e,o);c(t,o,i,n)}).fail(function(e){"abort"!==e.statusText&&alert("error"),r.resolve(a)})}if(e){if(t._search.data=a,t.request){for(var n=0;n<t.request.length;n++)t.request[n].abort();t.request=[]}else t.request=[];$.map(e,function(e,r){for(var a=o(e),r=0;r<a.length;r++){var s=a[r];s&&t.allowedSearchTypes[s]&&t.request.push(i(e,s))}}),$.when.apply($,t.request).then(function(){t.request=null,r.resolve(a)})}else r.resolve(a)}),r.promise()},e.getRoad=function(e){var t=this,r=new $.Deferred;if(e=e.trim(),e.length<2)r.resolve([]);else{var a=TC.Consts.searchType.ROAD,o=t.availableSearchTypes[a].pattern,s=o.exec(e);if(s&&s[3]){var i=t.filter.getPropertyValue(a,"outputProperties"),n=t.filter.getPropertyValue(a,"dataIdProperty"),l=t.filter.getPropertyValue(a,"outputFormatLabel"),c=s[2]?s[2].trim()+"-"+s[3].trim():s[3].trim();s[4]&&s[4].length>0&&(c=c+"-"+s[4].trim()),$.ajax({url:t.availableSearchTypes[a].url+"?"+t.filter.getParams({t:c},a,i,n),type:"GET",contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){if(t.request){for(var e=0;e<t.request.length;e++)t.request[e].abort();t.request=[]}else t.request=[];t.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+t.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>'),t.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var t=[];e.totalFeatures>0?(e.features.map(function(e){if(!t.some(function(t){return t.text==e.properties[i[0]]})){var r=l.tcFormat(i.map(function(t){return e.properties[t]})),o=i.map(function(t){return e.properties[t]}).join("-");t.push({id:n.map(function(t){return e.properties[t]}).join("#"),label:r,text:o,dataLayer:e.id.split(".")[0],dataRole:a})}}),r.resolve(t)):r.resolve([])}).fail(function(e){r.resolve([])})}else r.resolve([])}return r.promise()},e.getPK=function(e){var t=this,r=new $.Deferred;if(e=e.trim(),e.length<3)r.resolve([]);else{var a=TC.Consts.searchType.ROADPK,o=t.availableSearchTypes[a].pattern,s=o.exec(e);if(s&&s[3]&&s[5]){var i=t.filter.getPropertyValue(a,"outputProperties"),n=t.filter.getPropertyValue(a,"dataIdProperty"),l=t.filter.getPropertyValue(a,"outputFormatLabel"),c=s[2]?s[2].trim()+"-"+s[3].trim():s[3].trim();s[4]&&s[4].length>0&&(c=c+"-"+s[4].trim()),$.ajax({url:t.availableSearchTypes[a].url+"?"+t.filter.getParams({t:c,s:s[5].trim()},a,i,n),type:"GET",contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){if(t.request){for(var e=0;e<t.request.length;e++)t.request[e].abort();t.request=[]}else t.request=[];t.$list.html('<li><a class="tc-ctl-search-li-loading" href="#">'+t.getLocaleString("searching")+'<span class="tc-ctl-search-loading-spinner tc-ctl-search-loading"></span></a></li>'),t.$text.trigger("targetUpdated.autocomplete")}}).done(function(e){var t=[];e.totalFeatures>0?(e.features.map(function(e){if(!t.some(function(t){return t.label==e.properties[i[0]]})){var r=l.tcFormat(i.map(function(t){return e.properties[t]}));t.push({id:n.map(function(t){return e.properties[t]}).join("#"),label:r,text:r,dataLayer:e.id.split(".")[0],dataRole:a})}}),r.resolve(t)):r.resolve([])}).fail(function(e){r.resolve([])})}else r.resolve([])}return r.promise()},e.search=function(e,t){var r=this,a=[];if(e=$.trim(e),e.length>0){e=e.toLowerCase();var o=[],s=function(t){var s=new $.Deferred;o.push(s),$.when(t.call(r,e)).then(function(e){a=a.concat(e),s.resolve(a)})},i=!1;for(var n in r.allowedSearchTypes)switch(n){case TC.Consts.searchType.CADASTRAL:s(r.availableSearchTypes[TC.Consts.searchType.CADASTRAL].parser);break;case TC.Consts.searchType.COORDINATES:s(r.availableSearchTypes[TC.Consts.searchType.COORDINATES].parser);break;case TC.Consts.searchType.ROAD:s(r.availableSearchTypes[TC.Consts.searchType.ROAD].parser);break;case TC.Consts.searchType.ROADPK:s(r.availableSearchTypes[TC.Consts.searchType.ROADPK].parser);break;case TC.Consts.searchType.MUNICIPALITY:case TC.Consts.searchType.LOCALITY:case TC.Consts.searchType.COUNCIL:case TC.Consts.searchType.URBAN:case TC.Consts.searchType.STREET:case TC.Consts.searchType.NUMBER:i||(s(r.availableSearchTypes[n].parser),i=!0);break;default:r.allowedSearchTypes[n].parser?s(r.allowedSearchTypes[n].parser):console.log("Falta implementación del método parser")}$.when.apply(r,o).then(function(){a&&(r._search.data=a=a.sort(function(e,t){var r,a=/(\d+)/,o="";return a.test(e.label)&&a.test(t.label)?(r=e.label.match(a)[1],o=t.label.match(a)[1]):(r=e.label,o=t.label),r>o?1:o>r?-1:0}.bind(r))),t&&t(a),0===a.length&&(r.cleanMap(),(!r.layer||r.layer&&0===r.layer.features.length)&&(r.$list.html('<li><a title="'+r.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+r.EMPTY_RESULTS_LABEL+"</a></li>"),r.$text.trigger("targetUpdated.autocomplete")))})}else r.cleanMap()};var t=function(e){var t=this;if(e&&e.length>0)for(var r=0;r<e.length;r++)e[r].showsPopup!=t.queryableFeatures&&(e[r].showsPopup=t.queryableFeatures)};e.goToResult=function(e,r){var a=this,o=null;a.loading||(a.loading=a.map.getControlsByClass("TC.control.LoadingIndicator")[0]);var s;s=a.loading.addWait(),Modernizr.mq("(max-width: 30em)")&&(a.$text.blur(),a.map.$events.trigger($.Event(TC.Consts.event.TOOLSCLOSE),{})),a.cleanMap();var i=!1,n=!0;for(var l in a.allowedSearchTypes)if(n)switch(l){case TC.Consts.searchType.CADASTRAL:o=a.availableSearchTypes[TC.Consts.searchType.CADASTRAL].goTo.call(a,e),null!==o&&(n=!1);break;case TC.Consts.searchType.COORDINATES:o=a.availableSearchTypes[TC.Consts.searchType.COORDINATES].goTo.call(a,e),null!==o&&(n=!1);break;case TC.Consts.searchType.ROAD:r===TC.Consts.searchType.ROAD&&(o=a.availableSearchTypes[TC.Consts.searchType.ROAD].goTo.call(a,e)),null!==o&&(n=!1);break;case TC.Consts.searchType.ROADPK:o=a.availableSearchTypes[TC.Consts.searchType.ROADPK].goTo.call(a,e),null!==o&&(n=!1);break;case TC.Consts.searchType.MUNICIPALITY:case TC.Consts.searchType.LOCALITY:case TC.Consts.searchType.COUNCIL:case TC.Consts.searchType.URBAN:case TC.Consts.searchType.STREET:case TC.Consts.searchType.NUMBER:var c=r||a.filter.getGoToElement(e).dataRole;c&&c===l&&(o=a.availableSearchTypes[c].goTo.call(a,e,c),null!==o&&(n=!1));break;default:a.allowedSearchTypes[l].goTo?(i=!0,o=a.allowedSearchTypes[l].goTo.call(a,e),null!==o&&(n=!1)):console.log("Falta implementación del método goTo")}a.loading.removeWait(s),o?(s=a.loading.addWait(),a.getLayer().then(function(r){switch(!0){case o.params.type==TC.Consts.layerType.VECTOR:for(var i=0;i<a.WFS_TYPE_ATTRS.length;i++)r.hasOwnProperty(a.WFS_TYPE_ATTRS[i])&&delete r[a.WFS_TYPE_ATTRS[i]];break;case o.params.type==TC.Consts.layerType.WFS:for(var i=0;i<a.WFS_TYPE_ATTRS.length;i++)r[a.WFS_TYPE_ATTRS[i]]=o.params[a.WFS_TYPE_ATTRS[i]]}r.type=o.params.type,r.refresh().then(function(){a.map.one(TC.Consts.event.LAYERUPDATE,function(e){e.layer==r&&(a.map.one(TC.Consts.event.FEATURESADD,function(e){e.layer==r&&(!e.layer.features||0==e.layer.features.length&&e.layer.wrap.layer.getSource().getFeatures()?(a.$list.hide("fast"),e.layer.map.setExtent(e.layer.wrap.layer.getSource().getExtent())):e.layer.features&&e.layer.features.length>0?(a.$list.hide("fast"),t.call(a,e.layer.features),a.layer.map.zoomToFeatures(e.layer.features),a.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:a.layer,features:a.layer.features}))):e.layer.features&&0==e.layer.features.length&&o.params.type==TC.Consts.layerType.WFS&&(a.$list.html(o.emptyResultHTML),a.$text.trigger("targetUpdated.autocomplete"),a.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY))),a.loading.removeWait(s))}),o.params.type!=TC.Consts.layerType.WFS&&a.map.one(TC.Consts.event.FEATURESADD,function(e){e.layer.features&&0==e.layer.features.length&&(a.$list.html(o.emptyResultHTML),a.$text.trigger("targetUpdated.autocomplete"),a.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY)))}),e.layer.features&&e.layer.features.length>0?(a.$list.hide("fast"),t.call(a,e.layer.features),a.layer.map.zoomToFeatures(a.layer.features),a.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:a.layer,features:a.layer.features})),a.loading.removeWait(s)):e.layer.features&&0==e.layer.features.length&&o.params.type==TC.Consts.layerType.WFS&&(a.$list.html(o.emptyResultHTML),a.$text.trigger("targetUpdated.autocomplete"),a.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY)),a.loading.removeWait(s)))}),0==r.features.length&&a.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:r,id:e}))})})):i||a.map.$events.trigger($.Event(TC.Consts.event.SEARCHQUERYEMPTY))};var r=function(e){var t=this;if(e&&e.layer==t.layer){var r,a,o,s=e.id,i=t.getPoint(s);if(i&&t.insideLimit(i))a=t.getLabel(s),o=t.layer.addMarker(i,$.extend({},t.map.options.styles.point,{title:a,group:a})),r=t.map.options.pointBoundsRadius,t.map.setExtent([i[0]-r,i[1]-r,i[0]+r,i[1]+r]);else{var n=/^Lat((?:[+-]?)\d+(?:\.\d+)?)Lon((?:[+-]?)\d+(?:\.\d+)?)$/.exec(s);s=t.LAT+n[2]+t.LON+n[1],i=t.getPoint(s),i&&t.insideLimit(i)&&(a=t.getLabel(s),o=t.layer.addMarker(i,$.extend({},t.map.options.styles.point,{title:a,group:a})),r=t.map.options.pointBoundsRadius,t.map.setExtent([i[0]-r,i[1]-r,i[0]+r,i[1]+r]),t.$text.val(a))}$.when(o).then(function(e){t.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:t.layer,features:[e]}))})}};e.goToCoordinates=function(e){var t=this,a={};if(/^X(\d+(?:[\.\,]\d+)?)Y(\d+(?:[\.\,]\d+)?)$/.test(e)||/^Lat((?:[+-]?)\d+(?:[.,]\d+)?)Lon((?:[+-]?)\d+(?:[.,]\d+)?)$/.test(e)){a.params={type:TC.Consts.layerType.VECTOR,styles:{marker:{url:t.layerStyleFN.bind(t,"marker","url",!0)}}},a.emptyResultHTML='<li><a class="tc-ctl-search-li-empty">'+t.OUTBBX_LABEL+"</a></li>";var o=r.bind(t);return t.map.one(TC.Consts.event.LAYERUPDATE,o),a}return null},e.goToCadastralRef=function(e){var t=this,r={};if(/^\M(\d+)\P(\d{1,2})Par{1}(\d{1,4})/g.test(e)){var a=/^\M(\d+)\P(\d{1,2})Par{1}(\d{1,4})/g.exec(e);return TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter"),r.params={type:TC.Consts.layerType.WFS,url:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].url,version:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].version,geometryName:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].geometryName,featurePrefix:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featurePrefix,featureType:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].featureType,properties:new TC.filter.and(new TC.filter.equalTo(t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.municipality,$.trim(a[1])),new TC.filter.equalTo(t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.polygon,$.trim(a[2])),new TC.filter.equalTo(t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].queryProperties.parcel,$.trim(a[3]))),outputFormat:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].outputFormat,styles:t.availableSearchTypes[TC.Consts.searchType.CADASTRAL].styles},r.emptyResultHTML='<li><a title="'+t.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+t.EMPTY_RESULTS_LABEL+"</a></li>",r}return null},e.goToRoad=function(e){var t=this,r={},a=TC.Consts.searchType.ROAD;return r.params={type:TC.Consts.layerType.WFS,url:t.availableSearchTypes[a].url,version:t.availableSearchTypes[a].version,geometryName:t.availableSearchTypes[a].geometryName,featurePrefix:t.availableSearchTypes[a].featurePrefix,featureType:t.filter.getGoToFilterLayer(e),maxFeatures:3e3,properties:t.filter.getGoToFilter(e,a),outputFormat:t.availableSearchTypes[a].outputFormat,styles:t.availableSearchTypes[a].styles},r.emptyResultHTML='<li><a title="'+t.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+t.EMPTY_RESULTS_LABEL+"</a></li>",r},e.goToPK=function(e){var t=this,r={},a=TC.Consts.searchType.ROADPK;return r.params={type:TC.Consts.layerType.WFS,url:t.availableSearchTypes[a].url,version:t.availableSearchTypes[a].version,geometryName:t.availableSearchTypes[a].geometryName,featurePrefix:t.availableSearchTypes[a].featurePrefix,featureType:t.filter.getGoToFilterLayer(e),maxFeatures:3e3,properties:t.filter.getGoToFilter(e,a),outputFormat:t.availableSearchTypes[a].outputFormat,styles:t.availableSearchTypes[a].styles},r.emptyResultHTML='<li><a title="'+t.EMPTY_RESULTS_TITLE+'" class="tc-ctl-search-li-empty">'+t.EMPTY_RESULTS_LABEL+"</a></li>",r},e.goToAddress=function(e,t){var r=this,a={},o=r.availableSearchTypes[t];return a.params={type:TC.Consts.layerType.WFS,url:o.url,version:o.version,geometryName:o.geometryName,featurePrefix:o.featurePrefix,featureType:r.filter.getGoToFilterLayer(e),maxFeatures:3e3,properties:r.filter.getGoToFilter(e,t),outputFormat:o.outputFormat,styles:o.styles},a},e.getPoint=function(e){var t,r=this,a=r.map.wrap.isGeo(),o=/^X(\d+(?:\.\d+)?)Y(\d+(?:\.\d+)?)$/.exec(e);if(o&&3===o.length)t=[parseFloat(o[1]),parseFloat(o[2])],a&&(t=TC.Util.reproject(t,r.map.options.utmCrs,r.map.crs));else{if(o=/^Lat((?:[+-]?)\d+(?:[.,]\d+)?)Lon((?:[+-]?)\d+(?:[.,]\d+)?)$/.exec(e),o&&3===o.length&&(t=[parseFloat(o[2]),parseFloat(o[1])],!a))return TC.Util.reproject(t,r.map.options.geoCrs,r.map.crs);if(o=/^Lon((?:[+-]?)\d+(?:[.,]\d+)?)Lat((?:[+-]?)\d+(?:[.,]\d+)?)$/.exec(e),o&&3===o.length&&(t=[parseFloat(o[2]),parseFloat(o[1])],!a))return TC.Util.reproject(t,r.map.options.geoCrs,r.map.crs)}return t},e.insideLimit=function(e){var t=this,r=function(e,t){return e instanceof Array?t[0]>=e[0]&&t[0]<=e[2]&&t[1]>=e[1]&&t[1]<=e[3]:!0};return r(t.map.options.maxExtent,e)?!0:!1},e.getPattern=function(){var e=this;return e.$text.val()},e.getLabel=function(e){var t=this,r=e,a=TC.Util.getMapLocale(t.map);if(e.match(new RegExp("^(?:"+t.LAT+"[-\\d])|(?:"+t.UTMX+"[\\d])"))){r=r.replace(t.LAT,t.LAT_LABEL).replace(t.LON," "+t.LON_LABEL).replace(t.UTMX,t.UTMX_LABEL).replace(t.UTMY," "+t.UTMY_LABEL);var o=r.match(new RegExp("^"+$.trim(t.LAT_LABEL)+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(t.LON_LABEL)+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$"));o&&(r=r.replace(o[1],parseFloat(o[1]).toLocaleString(a)),r=r.replace(o[3],parseFloat(o[3]).toLocaleString(a)));var s=1.1.toLocaleString(a).substring(1,2),o=r.match(new RegExp("^"+$.trim(t.UTMX_LABEL)+"*\\s*([0-9]{"+t.UTMX_LEN+"}(?:[.,]\\d+)?)\\s*\\,?\\s*"+$.trim(t.UTMY_LABEL)+"*\\s*([0-9]{"+t.UTMY_LEN+"}(?:[.,]\\d+)?)$"));o&&(Number.isInteger(parseFloat(o[1]))||(r=r.replace(o[1],o[1].replace(".",s))),
Number.isInteger(parseFloat(o[2]))||(r=r.replace(o[2],o[2].replace(".",s))))}else if(e.match(new RegExp("^(?:"+t.LON+"[-\\d])"))){r=r.replace(t.LON,t.LON_LABEL).replace(t.LAT," "+t.LAT_LABEL);var o=r.match(new RegExp("^"+$.trim(t.LON_LABEL)+"*\\s*([-+]?\\d{1,3}([.,]\\d+)?)\\,?\\s*"+$.trim(t.LAT_LABEL)+"*\\s*([-+]?\\d{1,2}([.,]\\d+)?)$"));o&&(r=r.replace(o[1],parseFloat(o[1]).toLocaleString(a)),r=r.replace(o[3],parseFloat(o[3]).toLocaleString(a)))}else if(e.match(new RegExp("^(?:(\\"+t.MUN+"{1})(.*)(\\"+t.POL+"{1})(\\d{1,2})(\\"+t.PAR+"{1})(\\d{1,4}))"))){var o=e.match(new RegExp("^(?:(\\"+t.MUN+"{1})(.*)(\\"+t.POL+"{1})(\\d{1,2})(\\"+t.PAR+"{1})(\\d{1,4}))"));r=t.MUN_LABEL+o[2]+", "+t.POL_LABEL+o[4]+", "+t.PAR_LABEL+o[6]}return r},e.removePunctuation=function(e){e=e||"";for(var t=new Array(e.length),r={"á":"a","Á":"A","é":"e","É":"E","í":"i","Í":"I","ó":"o","Ó":"O","ú":"u","ü":"u","Ú":"U","Ü":"U"},a=0,o=e.length;o>a;a++)t[a]=r[e.charAt(a)]||e.charAt(a);return t.join("")},e.decodeEntities=function(e){return $("<div/>").html(e).text()},e.transformFilter=function(e){if(TC.filter||TC.syncLoadJS(TC.apiLocation+"TC/Filter"),e&&e instanceof Array){var t=e.map(function(e){if(!e.hasOwnProperty("type"))return new TC.filter.equalTo(e.name,e.value);switch(!0){case e.type==TC.Consts.comparison.EQUAL_TO:return new TC.filter.equalTo(e.name,e.value)}});return t.length>1?TC.filter.and.apply(null,t):t[0]}}}(),String.prototype.tcFormat||(String.prototype.tcFormat=function(){var e=(arguments||[""])[0];return this.replace(/{(\d+)}/g,function(t,r){return"undefined"!=typeof e[r]?e[r]:t})}),String.prototype.splitRemoveWhiteSpaces||(String.prototype.splitRemoveWhiteSpaces=function(e){for(var t=[],r=this.split(e),a=0;a<r.length;a++)$.trim(r[a]).length>0&&t.push($.trim(r[a]));return t}),String.prototype.toCamelCase||(String.prototype.toCamelCase=function(){var e=this.toLowerCase(),t=this.toLowerCase().match(/\W+(.)/g);if(t)for(var r=0;r<t.length;r++)/[;:.<>\{\}\[\]\/\s()]/g.test(t[r])&&(e=e.replace(t[r],t[r].toUpperCase()));return e.charAt(0).toUpperCase()+e.substring(1)}),Array.prototype.hasOwnProperty("findByProperty")||Object.defineProperty(Array.prototype,"findByProperty",{enumerable:!1,writable:!0,value:function(e,t){for(var r=0;r<this.length;r++)if(this[r][e]==t)return this[r]}}),String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var r=this.toString();("number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t>r.length)&&(t=r.length),t-=e.length;var a=r.indexOf(e,t);return-1!==a&&a===t});