TC.control=TC.control||{},TC.control.FeatureInfoCommons||TC.syncLoadJS(TC.apiLocation+"TC/control/FeatureInfoCommons"),function(){TC.control.FeatureInfo=function(){var e=this;TC.control.FeatureInfoCommons.apply(this,arguments),e.wrap=new TC.wrap.control.FeatureInfo(e),TC.Consts.classes.FROMLEFT="tc-fromleft",TC.Consts.classes.FROMRIGHT="tc-fromright",e.callback=function(t,r){for(var a=!1,o=0;o<e.map.workLayers.length;o++){var n=e.map.workLayers[o];if(n.type===TC.Consts.layerType.WMS&&n.getVisibility()&&n.names.length>0){a=!0;break}}a?e.wrap.getFeatureInfo(r):e.map.$events.trigger($.Event(TC.Consts.event.NOFEATUREINFO,{xy:r,control:e}))}},TC.inherit(TC.control.FeatureInfo,TC.control.FeatureInfoCommons);var e=TC.control.FeatureInfo.prototype;e.FEATURE_PARAM="showfeature";var t=TC.apiLocation+"lib/jshash/md5-min.js",r=function(e,r){return 0===jQuery.grep(e.map.workLayers,function(e,t){return e.type===TC.Consts.layerType.WMS&&e.url===r.s&&e.getDisgregatedLayerNames().indexOf(r.l)>=0}).length?void TC.error(TC.Util.getLocaleString(e.map.options.locale,"sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST):(e.sharedFeatureInfo=r,void TC.loadJS(!window.hex_md5,[t],function(){var t=e.map.options.pixelTolerance||TC.Cfg.pixelTolerance,a=2*t+1,o=[t,t],n=a*r.r/2,i=[r.xy[0]-n,r.xy[1]-n,r.xy[0]+n,r.xy[1]+n];e.beforeGetFeatureInfo({xy:o,control:e}),e.wrap.getFeatureInfo(o,{serviceUrl:r.s,layerName:r.l,featureId:r.f,mapSize:[a,a],boundingBox:i})}))},a=function o(e,t){var r;if($.isArray(e)){r=e.slice();for(var a=0,n=r.length;n>a;a++)r[a]=o(r[a])}else r="number"==typeof e?Math.round(e.toFixed(t)):e;return r};e.register=function(e){var t=this;TC.control.FeatureInfoCommons.prototype.register.call(t,e),t._$div.appendTo("<div>"),e.loaded(function(){t._layersDeferred.then(function(){var e=TC.Util.getParameterByName(t.FEATURE_PARAM);if(e){var a;try{a=JSON.parse(decodeURIComponent(escape(window.atob(e))))}catch(o){TC.error(TC.Util.getLocaleString(t.map.options.locale,"sharedFeatureNotValid"),TC.Consts.msgErrorMode.TOAST)}a&&r(t,a)}})})},e.beforeGetFeatureInfo=function(e){var t=this;if(TC.control.FeatureInfoCommons.prototype.beforeGetFeatureInfo.call(t,e),e.control===t&&t.map&&t.filterLayer){for(var r=null;!r;)r=t.map.getCoordinateFromPixel(e.xy);var a=t.getLocaleString("featureInfo"),o=$.extend({},t.map.options.styles.marker,t.markerStyle,{title:a,set:a});t.displayMode!==TC.control.FeatureInfoCommons.POPUP&&(o.showsPopup=!1),t.filterLayer.clearFeatures(),$.when(t.filterLayer.addMarker(r,o)).then(function(e){null===t.lastFeatureCount?(t.map.putLayerOnTop(t.filterLayer),t.filterFeature=e):t.filterLayer.clearFeatures()})}},e.onShowModal=function(){var e=this,r=e.getDisplayTarget().find("ul."+e.CLASS+"-features li."+TC.Consts.classes.CHECKED),o=e._shareCtl;o.extraParams=null;var n=r.parents("li").first(),i=n.parents("li").first(),s=e.info.services[i.index()];if(s){var l=s.layers[n.index()];if(l){var f=l.features[r.index()];TC.loadJS(!window.hex_md5,[t],function(){var t=hex_md5(JSON.stringify({data:f.getData(),geometry:a(f.geometry,TC.Consts.DEGREE_PRECISION)}));o.extraParams={},o.extraParams[e.FEATURE_PARAM]=window.btoa(unescape(encodeURIComponent(JSON.stringify({xy:f.wrap.getInnerPoint(),r:e.map.getResolution(),s:s.mapLayer.url,l:l.name,f:f.id,h:t}))));var r=o._$div;r.find(".tc-url input[type=text]").val(o.generateLink()),r.find(".tc-iframe input[type=text]").val(o.generateIframe())})}}},e.responseCallback=function(e){var t=this;if(t.filterFeature){var r=e.services;t.info={services:r,defaultFeature:e.defaultFeature};for(var o=0;o<r.length;o++){for(var n=r[o],i=0;i<n.layers.length;i++)n.layers[i].features.length||(n.layers.splice(i,1),i-=1);n.layers.length||(r.splice(o,1),o-=1)}r.length?t.renderData(e,function(){if(t._$div.find("td."+t.CLASS+"-val").each(function(e,r){var a=$(r),o=a.text();TC.Util.isURL(o)&&a.html('<a href="'+o+'" target="_blank" title="'+t.getLocaleString("linkInNewWindow")+'">'+o+"</a>")}),t.sharedFeatureInfo){t._$div.find("ul."+t.CLASS+"-services li").addClass(TC.Consts.classes.CHECKED);for(var e,r=t.sharedFeatureInfo,o=0,n=t.info.services.length;n>o;o++){var i=t.info.services[o];if(i.mapLayer.url===r.s){for(var s=0,l=i.layers.length;l>s;s++){var f=i.layers[s];if(f.name===r.l){for(var u=0,d=f.features.length;d>u;u++){var C=f.features[u];if(C.id===r.f){e=C;var c=hex_md5(JSON.stringify({data:C.getData(),geometry:a(C.geometry,TC.Consts.DEGREE_PRECISION)}));r.h!==c&&TC.alert(t.getLocaleString("finfo.featureChanged.warning"));break}}break}}break}}e&&t.map.addControl(new TC.control.Popup({div:TC.Util.getDiv(),closeButton:!0})).then(function(r){e.data=t._$div.html(),r.$popupDiv.addClass(t.CLASS+"-lite");t.getLocaleString("deleteFeature");t.getRenderedHtml(t.CLASS+"-del-btn",null,function(e){r.$popupDiv.append(e),r.$popupDiv.find("."+t.CLASS+"-del-btn").on(TC.Consts.event.CLICK,function(e){TC.confirm(t.getLocaleString("deleteFeature.confirm"),function(){t.map.removeLayer(t.sharedFeatureLayer),delete t.sharedFeatureLayer})})}),e.showsPopup=!0,e.popup=r,t.map.addLayer({id:TC.getUID(),type:TC.Consts.layerType.VECTOR,title:t.getLocaleString("foi")}).then(function(r){t.sharedFeatureLayer=r,t.filterLayer.clearFeatures(),r.addFeature(e),t.map.zoomToFeatures([e])}),t.map.on(TC.Consts.event.POPUP,function(a){a.control===r&&r.$popupDiv.find("table").on(TC.Consts.event.CLICK,function(r){t.map.zoomToFeatures([e])})})}),delete t.sharedFeatureInfo}else t.displayResults()}):(t.resultsLayer.clearFeatures(),t.filterLayer.clearFeatures())}}}();