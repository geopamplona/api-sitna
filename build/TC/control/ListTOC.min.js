TC.control=TC.control||{},TC.control.TOC||TC.syncLoadJS(TC.apiLocation+"TC/control/TOC"),TC.control.ListTOC=function(){var t=this;TC.control.TOC.apply(t,arguments),t.layers=[]},TC.inherit(TC.control.ListTOC,TC.control.TOC),function(){var t=TC.control.ListTOC.prototype;t.CLASS="tc-ctl-ltoc",t.CLICKEVENT="click.tc",TC.Consts.classes.DRAG=TC.Consts.classes.DRAG||"tc-drag",TC.Consts.classes.DRAGEND=TC.Consts.classes.DRAGEND||"tc-dragend",TC.Consts.event.TOOLSOPEN=TC.Consts.event.TOOLSOPEN||"toolsopen.tc",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/ListTOC.html",t.template[t.CLASS+"-elm"]=TC.apiLocation+"TC/templates/ListTOCElement.html",t.template[t.CLASS+"-type-sgl"]=TC.apiLocation+"TC/templates/ListTOCTooltipSingle.html",t.template[t.CLASS+"-type-grp"]=TC.apiLocation+"TC/templates/ListTOCTooltipGroup.html",t.template[t.CLASS+"-type-grp-node"]=TC.apiLocation+"TC/templates/ListTOCTooltipGroupNode.html"):(t.template[t.CLASS]=function(){function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"loadedLayers"}).w('<span class="tc-ctl-ltoc-n"></span><button class="tc-ctl-ltoc-del-all tc-hidden" title="').h("i18n",e,{},{$key:"removeAllLayersFromMap"}).w('"></button></h2><div class="tc-ctl-ltoc-empty">').h("i18n",e,{},{$key:"noData"}).w('</div><div class="tc-ctl-ltoc-content"><form><ul>').s(e.get(["workLayers"],!1),e,{block:n},{}).w("</ul></form></div>")}function n(t,e){return t.p("tc-ctl-ltoc-elm",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS,e),e.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-elm"]=function(){function e(t,e){return t.w('<li class="tc-ctl-ltoc-elm" tabindex="-1"><div class="tc-ctl-ltoc-lyr">').x(e.get(["path"],!1),e,{block:n},{}).w('</div><div class="tc-ctl-ltoc-type"></div><div class="tc-ctl-ltoc-path" title="').s(e.get(["path"],!1),e,{"else":a,block:s},{}).w('">').s(e.get(["path"],!1),e,{"else":o,block:i},{}).w('</div><div><div class="tc-ctl-ltoc-btn-info" title="').h("i18n",e,{},{$key:"infoFromThisLayer"}).w('"></div><input type="range" value="').f(e.get(["opacity"],!1),e,"h").w('" title="').h("i18n",e,{},{$key:"transparencyOfThisLayer"}).w('" /><input type="checkbox" ').nx(e.get(["hide"],!1),e,{block:c},{}).w(' title="').h("i18n",e,{},{$key:"visibilityOfThisLayer"}).w('" /></div><div class="tc-ctl-ltoc-info tc-hidden">').x(e.get(["abstract"],!1),e,{block:d},{}).x(e.get(["legend"],!1),e,{block:p},{}).x(e.get(["metadata"],!1),e,{block:u},{}).w('</div><div class="tc-ctl-ltoc-dd ').x(e.get(["hide"],!1),e,{block:g},{}).w('" title="').h("i18n",e,{},{$key:"dragToReorder"}).w('"></div><div class="tc-ctl-ltoc-del ').nx(e.get(["hide"],!1),e,{block:h},{}).w('" title="').h("i18n",e,{},{$key:"removeLayerFromMap"}).w('"></div></li>')}function n(t,e){return t.f(e.get(["title"],!1),e,"h")}function a(t,e){return t.f(e.get(["title"],!1),e,"h")}function s(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:r},{})}function r(t,e){return t.w(" &bull; ")}function o(t,e){return t.f(e.get(["title"],!1),e,"h")}function i(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:l},{})}function l(t,e){return t.w(" &bull; ")}function c(t,e){return t.w('checked="checked"')}function d(t,e){return t.w('<div class="tc-ctl-ltoc-abstract"><h4>').h("i18n",e,{},{$key:"abstract"}).w("</h4><div>").f(e.get(["abstract"],!1),e,"h").w("</div></div>")}function p(t,e){return t.w('<div class="tc-ctl-ltoc-legend" data-tc-layer-name="').f(e.get(["layerNames"],!1),e,"h").w('"><h4>').h("i18n",e,{},{$key:"content"}).w("</h4>").s(e.get(["legend"],!1),e,{block:C},{}).w(" </div>")}function C(t,e){return t.w("<div><p>").f(e.get(["title"],!1),e,"h").w('</p><img data-tc-img="').f(e.get(["src"],!1),e,"h").w('" /></div>')}function u(t,e){return t.w('<div class="tc-ctl-ltoc-metadata"><h4>').h("i18n",e,{},{$key:"metadata"}).w("</h4><ul>").s(e.get(["metadata"],!1),e,{block:f},{}).w("</ul></div>")}function f(t,e){return t.w('<li><a href="').f(e.get(["url"],!1),e,"h",["s"]).w('" type="').f(e.get(["format"],!1),e,"h").w('" title="').f(e.get(["formatDescription"],!1),e,"h").w('" target="_blank">').f(e.get(["formatDescription"],!1),e,"h").w("</a></li>")}function g(t,e){return t.w("tc-hidden")}function h(t,e){return t.w("tc-hidden")}return dust.register(t.CLASS+"-elm",e),e.__dustBody=!0,n.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,r.__dustBody=!0,o.__dustBody=!0,i.__dustBody=!0,l.__dustBody=!0,c.__dustBody=!0,d.__dustBody=!0,p.__dustBody=!0,C.__dustBody=!0,u.__dustBody=!0,f.__dustBody=!0,g.__dustBody=!0,h.__dustBody=!0,e},t.template[t.CLASS+"-type-sgl"]=function(){function e(t,e){return t.h("i18n",e,{},{$key:"singleLayer"})}return dust.register(t.CLASS+"-type-sgl",e),e.__dustBody=!0,e},t.template[t.CLASS+"-type-grp"]=function(){function e(t,e){return t.w("<div>").h("i18n",e,{},{$key:"groupLayerThatContains"}).w(":</div><ul>").s(e.get(["Layer"],!1),e,{block:n},{}).w("</ul>")}function n(t,e){return t.p("tc-ctl-ltoc-type-grp-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-type-grp",e),e.__dustBody=!0,n.__dustBody=!0,e},t.template[t.CLASS+"-type-grp-node"]=function(){function e(t,e){return t.w('<li class="tc-ctl-ltoc-tip-grp-elm"><span>').f(e.get(["Title"],!1),e,"h").w("</span><ul>").s(e.get(["Layer"],!1),e,{block:n},{}).w("</ul></li>")}function n(t,e){return t.p("tc-ctl-ltoc-type-grp-node",e,e.rebase(e.getPath(!0,[])),{})}return dust.register(t.CLASS+"-type-grp-node",e),e.__dustBody=!0,n.__dustBody=!0,e});var e={layer:"tcLayer"},n=function(t,n){var a;return t._$div.find("li."+t.CLASS+"-elm").each(function(t,s){var r=$(s);return r.data(e.layer)===n?(a=r,!1):void 0}),a},a=function(t){return $.grep(t.map.workLayers,function(t){return!t.stealth}).length};t.register=function(t){var e=this;TC.control.TOC.prototype.register.call(e,t),t.off(TC.Consts.event.EXTERNALSERVICEADDED),t.on(TC.Consts.event.LAYEROPACITY,function(t){var a=n(e,t.layer);a&&a.find("input[type=range]").val(Math.round(100*t.opacity))}).on(TC.Consts.event.FEATURESIMPORT,function(n){var a=n.fileName;if(n.features&&n.features.length>0){var s="."+TC.Consts.format.GPX.toLowerCase();if(n.fileName.toLowerCase().indexOf(s)===n.fileName.length-s.length)return;t.one(TC.Consts.event.LAYERADD,function(t){if(t&&t.layer&&t.layer.title==a){if(e.map&&e.map.layout&&e.map.layout.accordion&&e._$div.hasClass(TC.Consts.classes.COLLAPSED))for(var n=0;n<e.map.controls.length;n++)e.map.controls[n]!==e&&e.map.controls[n]._$div.addClass(TC.Consts.classes.COLLAPSED);e.map.$events.trigger($.Event(TC.Consts.event.TOOLSOPEN),{}),e._$div.removeClass(TC.Consts.classes.COLLAPSED)}})}})},t._addBrowserEventHandlers=function(){var t=this;t._$div.on(t.CLICKEVENT,"input[type=checkbox]",function(n){var a=$(n.target),s=a.parents("li."+t.CLASS+"-elm").first(),r=s.data(e.layer),o=a.prop("checked");r.setVisibility(o),n.stopPropagation()}).on("change input","input[type=range]",function(t){var n=$(t.target),a=n.parents("li").first().data(e.layer);a.setOpacity(n.val()/100)}).on(t.CLICKEVENT,"."+t.CLASS+"-del",function(n){var a=$(n.target).parents("li").first(),s=a.data(e.layer);t.map.removeLayer(s)}).on(t.CLICKEVENT,"."+t.CLASS+"-del-all",function(n){TC.confirm(t.getLocaleString("layersRemove.confirm"),function(){var n=t._$div.find("li."+t.CLASS+"-elm"),a=new Array(n.length);n.each(function(t,n){a[t]=$(n).data(e.layer)});for(var s=0,r=a.length;r>s;s++)t.map.removeLayer(a[s])})}).on(t.CLICKEVENT,"."+t.CLASS+"-btn-info",function(n){var a=$(n.target),s=a.parents("li").first(),r=s.find("."+t.CLASS+"-info");r.find("."+t.CLASS+"-legend img").each(function(n,a){var r=s.data(e.layer);t.styleLegendImage($(a),r)}),r.toggleClass(TC.Consts.classes.HIDDEN),s.find('input[type="checkbox"]').is(":checked")&&s.find("."+t.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!r.hasClass(TC.Consts.classes.HIDDEN)),a.toggleClass(TC.Consts.classes.CHECKED)})},t.updateLayerVisibility=function(t){var e=this,a=n(e,t);if(a){var s=t.getVisibility();a.find("."+e.CLASS+"-del").toggleClass(TC.Consts.classes.HIDDEN,s),a.find("."+e.CLASS+"-info").hasClass(TC.Consts.classes.HIDDEN)&&a.find("."+e.CLASS+"-dd").toggleClass(TC.Consts.classes.HIDDEN,!s)}},t.updateLayerTree=function(t){var n=this,s=function(t,a,s){if(t!==a){for(var r=t.data(e.layer),o=a.data(e.layer),i=-1,l=0;l<n.map.layers.length;l++)if(o===n.map.layers[l]){i=l;break}i>=1&&i<n.map.layers.length&&n.map.insertLayer(r,i,s)}},r=function(t){var e=$.Deferred();return t&&t.options.method&&"POST"===t.options.method?t.getLegendGraphicImage().done(function(t){e.resolve(t)}).fail(function(t){TC.error(t)}):e.resolve(),e.promise()};if(!t.isBase&&!t.options.stealth){TC.control.MapContents.prototype.updateLayerTree.call(n,t);for(var o=!1,i=0,l=n.layers.length;l>i;i++)if(t===n.layers[i]){o=!0;break}if(!o){var c=n.CLASS+"-elm";n.layers.push(t),TC.loadJSInOrder(!window.dust,TC.url.templating,function(){TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js"],function(){var a=t.title?t.title:t.capabilities.Service.Title,o={title:t.options.hideTitle?"":a,hide:t.renderOptions&&t.renderOptions.hide?!0:!1,opacity:t.renderOptions&&t.renderOptions.opacity?100*t.renderOptions.opacity:100},i=t.isRaster();if(i){o.layerNames=t.layerNames;var l=t.getPath();l.shift(),o.path=l;var d=t.names[0],p=t.wrap.getInfo(d);o.legend=p.legend,o["abstract"]=p["abstract"];var C,u=p.hasOwnProperty("abstract")||p.hasOwnProperty("legend")||p.hasOwnProperty("metadata");if(t.tree&&t.tree.children&&t.tree.children.length&&t.tree.children[0].children&&t.tree.children[0].children.length)C=null;else if(C=p.metadata)for(var f=0,g=C.length;g>f;f++){var h=C[f];h.formatDescription=n.getLocaleString(TC.Util.getSimpleMimeType(h.format))||n.getLocaleString("viewMetadata")}o.metadata=C}r(t).done(function(a){a&&(legend.src=a),dust.render(c,o,function(a,r){var o,l=$(r),c=!1;if(i&&(c=t.names.length>1,!c))for(var p=t.wrap.getAllLayerNodes(),C=0;C<p.length;C++){var f=p[C];if(t.wrap.getName(f)===d){o=f,t.wrap.getLayerNodes(f).length>0&&(c=!0);break}}var g=l.find("."+n.CLASS+"-type"),h=c?n.CLASS+"-type-grp":n.CLASS+"-type-sgl";g.addClass(h),u||l.find("."+n.CLASS+"-btn-info").addClass(TC.Consts.classes.HIDDEN),o&&(t.wrap.normalizeLayerNode(o),dust.render(h,o,function(t,e){var a;g.on("mouseover",function(t){var s=g.offset(),r=$(n.map.div).offset();a=$("<div>").addClass(n.CLASS+"-tip").html(e).css({top:s.top-r.top+"px",right:$(n.map.div).width()-(s.left-r.left)+"px"}).appendTo(n.map.div)}).on("mouseout",function(t){a.remove()})}));var v=n._$div.find("ul").first();l.data(e.layer,t),l.drag("start",function(t,e){var n=$(this),a=v.children("li");a.not(n).addClass(TC.Consts.classes.DRAGEND);a.index(n);n.css("zIndex",100).addClass(TC.Consts.classes.DRAG);var s=a.last(),r=n.position();e.limit={top:a.first().position().top-r.top,bottom:s.height()+s.position().top-r.top-n.height()-1},e.dropTargetIndex=-1}).drag("end",function(t,e){var n=$(this);n.removeClass(TC.Consts.classes.DRAG).addClass(TC.Consts.classes.DRAGEND);var a,r,o=function(t){return parseInt(t.substr(t.lastIndexOf(",")+1))},i=o(n.css("transform")),l=this.getBoundingClientRect().top-i;if(e.dropTargetIndex>=0){a=v.children("li").get(e.dropTargetIndex),r=$(a);var c=o(r.css("transform")),d=a.getBoundingClientRect().top-c}n.css("transform",r?"translateY("+(d-l)+"px)":"");var p="transitionend.tc";n.on(p,function C(t){"transform"===t.originalEvent.propertyName&&(n.off(p,C).removeClass(TC.Consts.classes.DRAGEND).css("zIndex",""),r&&s(n,r,function(){v.children("li").css("transform","").removeClass(TC.Consts.classes.DRAGEND)}))})}).drag(function(t,e){var n,a=$(this),s=Math.min(Math.max(e.limit.top,Math.round(e.deltaY)),e.limit.bottom),r=this.getBoundingClientRect(),o=r.height-1,i=(r.top+r.bottom)/2,l=[],c=v.children("li");c.each(function(t,a){var s=a.getBoundingClientRect();l[t]={elm:a,top:s.top,bottom:s.bottom},a===e.drag&&(n=t)});for(var d,p=-1,C=0,u=l.length;u>C;C++){var f=l[C];n>C?(i<f.bottom?i>f.top&&e.deltaY>e.prevDeltaY?d="":(d="translateY("+o+"px)",0>p&&(p=C)):d="",$(f.elm).css("transform",d)):C>n&&(i>f.top?i<f.bottom&&e.deltaY<e.prevDeltaY?d="":(d="translateY(-"+o+"px)",p=C):d="",$(f.elm).css("transform",d))}e.dropTargetIndex=p,a.css("transform","translateY("+s+"px)"),e.prevDeltaY=e.deltaY},{handle:"."+n.CLASS+"-dd"}).on("keydown",function(t){var e=this,n=function(){e.focus()},a=$(this);switch(!0){case/Up$/.test(t.key):var r=a.prev();r.length&&s(a,r,n);break;case/Down$/.test(t.key):var o=a.next();o.length&&s(a,o,n)}}),v.prepend(l),n.updateScale()})})})});var d=a(n);$("."+n.CLASS+"-n").text(d).toggleClass(TC.Consts.classes.VISIBLE,d>0),n._$div.find("."+n.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,d>0),n._$div.find("."+n.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,!1)}}},t.updateScale=function(){var t=this;t._$div.find("ul").find("li."+t.CLASS+"-elm").each(function(n,a){var s=$(a),r=s.data(e.layer);if(r.names){for(var o=!1,i=0;i<r.names.length;i++)if(r.isVisibleByScale(r.names[i])){o=!0;break}s.toggleClass(t.CLASS+"-elm-notvisible",!o)}})},t.updateLayerOrder=function(t,e,n){TC.control.MapContents.prototype.updateLayerOrder.call(this,t,e,n)},t.removeLayer=function(t){var n=this,s=n.layers.indexOf(t);s>=0&&n.layers.splice(s,1);var r=n._$div.find("ul").first();r.find("li."+n.CLASS+"-elm").each(function(n,a){var s=$(a);return s.data(e.layer)===t?(s.remove(),!1):void 0});var o=a(n);n._$div.find("."+n.CLASS+"-del-all").toggleClass(TC.Consts.classes.HIDDEN,0===o),n._$div.find("."+n.CLASS+"-empty").toggleClass(TC.Consts.classes.HIDDEN,o>0),$("."+n.CLASS+"-n").text(o).toggleClass(TC.Consts.classes.VISIBLE,o>0)},t.getLayerUIElements=function(){var t=this;return t._$div.find("ul").first().children("li."+t.CLASS+"-elm")}}();