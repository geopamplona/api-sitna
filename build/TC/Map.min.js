var TC=TC||{};!function(){var e=[],t=[];TC.Map=TC.Map||function(e,t){var n=this;n.$events=$(n),n.isReady=!1,n.isLoaded=!1,n.controls=[],n.activeControl=null,n.layers=[],n.baseLayers=[],n.workLayers=[],n.baseLayer=null,n.vectors=null;var o=0;n.div=TC.Util.getDiv(e),n._$div=$(n.div),n._$div.addClass(TC.Consts.classes.LOADING),n._$div.data("map",n),n._$div.addClass(TC.Consts.classes.MAP),n._markerDeferreds=[],TC.ready||(TC.Cfg=$.extend({},TC.Defaults,TC.Cfg),TC.ready=!0),n.options=a(t),n._remainingLayers=0;var i=function(){if(n.options.stateful&&(l(),n.state=n.checkLocation()),n.options.layout&&n.$events.trigger($.Event(TC.Consts.event.LAYOUTLOAD,{map:n})),t&&void 0!==t.workLayers&&(n.options.workLayers=t.workLayers),t&&void 0!==t.baseLayers&&(n.options.baseLayers=t.baseLayers),n._remainingLayers=n.options.baseLayers.length+n.options.workLayers.length,n.options.zoomToFeatures){var e=function a(e){clearTimeout(n._zoomToFeaturesTimeout),n._zoomToFeaturesTimeout=setTimeout(function(){n.zoomToFeatures(e.layer.features,{animate:!1}),n.off(TC.Consts.event.FEATURESADD,a)},100)};n.on(TC.Consts.event.FEATURESADD,e)}else{var r=function s(e){e.layer.isBase&&e.layer===n.baseLayer&&("undefined"!=typeof n.state&&n.setExtent(n.state.ext),n.off(TC.Consts.event.LAYERADD,s))};n.on(TC.Consts.event.LAYERADD,r)}n.crs=n.options.crs,n.wrap=new TC.wrap.Map(n),TC.loadJS(!(TC.isLegacy?window[TC.Consts.PROJ4JSOBJ_LEGACY]:window[TC.Consts.PROJ4JSOBJ]),[TC.url.proj4js],function(){TC.loadJSInOrder(!(TC.isLegacy?window[TC.Consts.OLNS_LEGACY]:window[TC.Consts.OLNS]),[TC.url.ol,TC.url.olConnector],function(){TC.loadProjDef(n.options.crs,function(){n.wrap.setMap();for(var e in n.options.controls)if(n.options.controls[e])if("boolean"==typeof n.options.controls[e])n.addControl(e);else{var t=n.options.controls[e];e=e.substr(0,1).toUpperCase()+e.substr(1),n.addControl(e,t)}n.on(TC.Consts.event.BEFORELAYERUPDATE,v),n.on(TC.Consts.event.LAYERUPDATE,T);var r,a,s;for(r=0;r<n.options.baseLayers.length;r++){if(s=n.options.baseLayers[r],"string"==typeof s)for(a=0;a<TC.Cfg.availableBaseLayers.length;a++)if(TC.Cfg.availableBaseLayers[a].id===s){s=TC.Cfg.availableBaseLayers[a];break}n.addLayer($.extend({},s,{isBase:!0,map:n}))}var o=function(e){e.isRaster()&&!e.names&&e.setVisibility(!1)};for(r=0;r<n.options.workLayers.length;r++){var i=!1;if(s=$.extend({},n.options.workLayers[r],{map:n}),n.state&&s.type!==TC.Consts.layerType.VECTOR)for(var r=0;r<n.state.layers.length;r++){var l=n.state.layers[r];if(l.u===s.url&&s.layerNames.indexOf(l.n)>=0){s.hideTitle=l.hideTitle,s.renderOptions={opacity:l.o,hide:!l.v},l.Added=!0;break}i=!0,n._remainingLayers--}i||$.when(n.addLayer(s)).then(o)}n.state&&n.state.layers&&n.state.layers.forEach(function(e){if(!e.Added){var t=e.o,r=e.v;n.addLayer({id:TC.getUID(),url:TC.Util.isOnCapabilities(e.u,e.u.indexOf(window.location.protocol)<0)||e.u,hideTitle:e.h,layerNames:e.n?e.n.split(","):"",renderOptions:{opacity:e.o,hide:!e.v}}).then(function(e){e.wrap.$events.on(TC.Consts.event.TILELOADERROR,function(e){var t=this.parent;(401===e.error.code||403===e.error.code)&&t.map.toast(e.error.text,{type:TC.Consts.msgType.ERROR}),t.map.removeLayer(t)});var n=e.wrap.getRootLayerNode();e.title=n.Title||n.title,e.setOpacity(t),e.setVisibility(r)})}}),n.isReady=!0,n.$events.trigger($.Event(TC.Consts.event.MAPREADY))})})}),n.on(TC.Consts.event.FEATURECLICK,function(e){n.activeControl&&n.activeControl.isExclusive()||e.feature.showPopup()}),n.on(TC.Consts.event.NOFEATURECLICK,function(e){e.layer._noFeatureClicked=!0;var t,r,a=!0;for(t=0;t<n.workLayers.length;t++)if(r=n.workLayers[t],r instanceof TC.layer.Vector&&!r._noFeatureClicked){a=!1;break}if(a){for(t=0;t<n.workLayers.length;t++)r=n.workLayers[t],r instanceof TC.layer.Vector&&delete r._noFeatureClicked;for(var s=n.getControlsByClass(TC.control.Popup),t=0,o=s.length;o>t;t++)s[t].hide()}})};n.one(TC.Consts.event.MAPREADY,function(){p(n._$div)}),n.one(TC.Consts.event.MAPLOAD,function(){n._$div.removeClass(TC.Consts.classes.LOADING)});var l=function(){var e=4;window.jsonpack||TC.syncLoadJS(TC.apiLocation+TC.Consts.url.JSONPACK);var t=[TC.Consts.event.LAYERADD,TC.Consts.event.LAYERORDER,TC.Consts.event.LAYERREMOVE,TC.Consts.event.LAYERVISIBILITY,TC.Consts.event.ZOOM,TC.Consts.event.BASELAYERCHANGE].join(" ");n.on(TC.Consts.event.MAPLOAD,function(){n.loaded(function(){n.replaceCurrent=!0,C(),n.on(t,$.proxy(C,n));var r;n.on(TC.Consts.event.LAYEROPACITY,function(e){clearTimeout(r),r=setTimeout(function(){C(e)},500)}),window.addEventListener("popstate",function(r){var a;a=n.loadingCtrl&&n.loadingCtrl.addWait(),setTimeout(function(){r&&null!=r.state&&(n.off(t,$.proxy(C,n)),$.when(d(r.state)).then(function(){setTimeout(function(){n.on(t,$.proxy(C,n))},200),n.loadingCtrl&&n.loadingCtrl.removeWait(a)}))},e)})})})},y=null,u=null,C=function(e){var t=".tc",r=c();if(n.replaceCurrent)return window.history.replaceState(r,null,null),void delete n.replaceCurrent;n.lastEventType=e.type;var a=function(){u=y,y=TC.Util.utf8ToBase64(r),window.history.pushState(r,null,window.location.href.split("#").shift()+"#"+y)};if(e)switch(!0){case e.type==TC.Consts.event.BASELAYERCHANGE.replace(t,""):case e.type==TC.Consts.event.ZOOM.replace(t,""):case e.type==TC.Consts.event.LAYERORDER.replace(t,""):a();break;case e.type.toLowerCase().indexOf("LAYER".toLowerCase())>-1:e.layer.type==TC.Consts.layerType.WMS&&a()}},c=function(){for(var e={},t=n.getExtent(),r=0;r<t.length;r++)Math.abs(t[r])>180&&(t[r]=Math.floor(1e3*t[r])/1e3);e.ext=t,e.base=n.getBaseLayer().id,e.layers=[];for(var a,s,r=0;r<n.workLayers.length;r++)a=n.workLayers[r],"WMS"!=a.type||a.options.stateless||a.layerNames&&a.layerNames.length&&(s={u:TC.Util.isOnCapabilities(a.url),n:$.isArray(a.names)?a.names.join(","):a.names,o:a.getOpacity(),v:a.getVisibility(),h:a.options.hideTitle},e.layers.push(s));return window.jsonpack||TC.syncLoadJS(TC.apiLocation+TC.Consts.url.JSONPACK),jsonpack.pack(e)},f=function(){var e=[];n.workLayers.forEach(function(t){"vector"!=t.type&&e.push(t)});for(var t=0;t<e.length;t++)n.removeLayer(e[t])},d=function(e){var t=new $.Deferred,r=[];n.loadingctrl||(n.loadingCtrl=n.getControlsByClass("TC.control.LoadingIndicator")[0]),n.hasWait||(n.hasWait=n.loadingCtrl&&n.loadingCtrl.addWait());var a,s=function(){n.loadingCtrl&&n.loadingCtrl.removeWait(n.hasWait),delete n.hasWait,t.resolve()};if("string"==typeof e)try{a=jsonpack.unpack(e)}catch(o){try{a=JSON.parse(e)}catch(i){TC.error(TC.Util.getLocaleString(n.options.locale,"mapStateNotValid"))}}else a=e;if(a){if(a.base!=n.getBaseLayer().id&&n.setBaseLayer(a.base),a.ext&&r.push(n.setExtent(a.ext)),f(),a.layers=a.layers||a.capas||[],a.layers.length>0)for(var l=0;l<a.layers.length;l++){var y=a.layers[l],u=y.o,C=y.v,p=!1;for(j=0;j<n.options.workLayers.length;j++){var c=$.extend({},n.options.workLayers[j],{map:n});if(c.type!==TC.Consts.layerType.VECTOR&&y.u===c.url&&c.layerNames.indexOf(y.n)){p=!0,c.renderOptions.opacity=y.o,c.renderOptions.hide=!y.v,r.push(n.addLayer(c).then(setVisibility));break}}p||r.push(n.addLayer({id:TC.getUID(),url:TC.Util.isOnCapabilities(y.u,y.u.indexOf(window.location.protocol)<0)||y.u,hideTitle:y.h,layerNames:y.n?y.n.split(","):"",renderOptions:{opacity:y.o,hide:!y.v}}).then(function(e){var t=e.wrap.getRootLayerNode();e.title=t.Title||t.title,e.setOpacity(u,!0),e.setVisibility(C)}))}$.when.apply($,r).done(function(){s()})}return t};s.getMapState=function(){var e=c();return TC.Util.utf8ToBase64(e)},s.getPreviousMapState=function(){return u},s.checkLocation=function(){var e=window.location.hash;if(e&&e.length>1){e=e.substr(1);var t;try{t=jsonpack.unpack(TC.Util.base64ToUtf8(e))}catch(r){try{t=JSON.parse(TC.Util.base64ToUtf8(e))}catch(a){return void TC.error(TC.Util.getLocaleString(n.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST)}}if(t){var s=!1;if(t.hasOwnProperty("ext")||(s=!0,t.ext=n.options.initialExtent),t.hasOwnProperty("base")||(s=!0,t.base=n.options.defaultBaseLayer),t.hasOwnProperty("layers"))for(var o=t.layers.length-1;o>=0;o--)t.layers[o]&&t.layers[o].hasOwnProperty("u")&&t.layers[o].hasOwnProperty("n")?t.layers[o].hasOwnProperty("o")&&t.layers[o].hasOwnProperty("v")&&t.layers[o].hasOwnProperty("h")||(s=!0,jQuery.extend(t.layers[o],{o:t.layers[o].o||1,v:t.layers[o].v||!0,h:t.layers[o].h||!1})):(s=!0,t.layers.length=t.layers.length-1);else s=!0,t.layers=[];return s&&TC.error(TC.Util.getLocaleString(n.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST),t}TC.error(TC.Util.getLocaleString(n.options.locale,"mapStateNotValid"),TC.Consts.msgErrorMode.TOAST)}};var v=function(e){0>=o&&(o=0,n.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATE))),o+=1},T=function(e){o-=1,0>=o&&(o=0,n.$events.trigger($.Event(TC.Consts.event.UPDATE)))},g=function(e){var t=$.Deferred();if("string"==typeof e){var r=e,n=function(e,t){var r=$.Deferred();return $.ajax({type:"HEAD",url:e,complete:function(n,a){r.resolve({resource:t,found:404!==n.status,url:e})}}),r.promise()},a=/^(https?:)?\/\//i.test(r),s=function(t,s){var y=$.Deferred(),u=[l+r+"/"+s,i+r+"/"+s,i+"responsive/"+s];a&&u.unshift(r+"/"+s);var C=0;return function p(r){n(u[r],t).done(function(t){t.found?y.resolve(o(e,t)):p(++r)})}(C),y.promise()},o=function(e,t){if(!(t.resource in e)){var n=($.extend(!0,{},e),t.found?t.url:i+r+"/"+y[t.resource]);e[t.resource]=n}return e},i=TC.apiLocation+"TC/layout/",l="layout/",e={},y={script:"script.js",style:"style.css",markup:"markup.html",config:"config.json",i18n:"resources"},u=Object.keys(y).length;for(var C in y)s(C,y[C]).done(function(e){Object.keys(e).length===u&&t.resolve(e)})}else t.resolve(e);return t.promise()};TC.i18n=TC.i18n||{},TC.i18n.loadResources=TC.i18n.loadResources||function(e,t,r){var n;return e?n=$.ajax({url:t+r+".json",type:"GET",dataType:"json",success:function(e){TC.i18n[r]=TC.i18n[r]||{},$.extend(TC.i18n[r],e),"undefined"!=typeof dust&&dust.i18n.add(r,TC.i18n[r])}}):dust.i18n.add(r,TC.i18n[r]),n};var h=[],L=n.options.locale,w=$.Deferred();h.push(w),TC.loadJSInOrder(!window.dust||!window.dust.i18n,TC.url.templating,function(){L&&(dust.i18n.setLanguages([L]),h.push(TC.i18n.loadResources(!TC.i18n[L],TC.apiLocation+"TC/resources/",L))),w.resolve()}),$.when.apply(this,h).always(function(){n.options.layout?g(n.options.layout).done(function(e){n.$events.trigger($.Event(TC.Consts.event.BEFORELAYOUTLOAD,{map:n}));var r;"string"==typeof e?r={href:$.trim(e)}:(e.hasOwnProperty("config")||e.hasOwnProperty("markup")||e.hasOwnProperty("style")||e.hasOwnProperty("ie8Style")||e.hasOwnProperty("script")||e.hasOwnProperty("href")||e.hasOwnProperty("i18n"))&&(r=$.extend({},e)),r.href&&(r.href+=r.href.match(/\/$/)?"":"/"),r.config=r.config||r.href+"config.json",r.markup=r.markup||r.href+"markup.html",r.style=r.style||r.href+"style.css",r.ie8Style=r.ie8Style||r.href+"ie8.css",r.script=r.script||r.href+"script.js",r.i18n=r.i18n||r.href+"resources",r.i18n&&(r.i18n+=r.i18n.match(/\/$/)?"":"/"),n.layout=r;var s=[],o=$.Deferred();if(s.push(o),r.config?s.push($.ajax({url:r.config,type:"GET",dataType:"json",success:function(e){o.resolve(e.i18n),n.options=a(e,t)},error:function(e,t,r){TC.error(t+": "+r),o.resolve(!1)}})):o.resolve(!1),r.markup){var l;L&&(l=$.Deferred(),s.push(l)),s.push($.ajax({url:r.markup,type:"GET",dataType:"html",success:function(e){o.then(function(t){t&&L?TC.i18n.loadResources(!0,r.i18n,L).always(function(){var t="tc-markup";dust.loadSource(dust.compile(e,t)),dust.render(t,null,function(e,t){e?(TC.error(e),l.reject()):(n._$div.append(t),l.resolve())})}):(n._$div.append(e),L&&l.resolve())})},error:function(){l.reject()}}))}$.when.apply(this,s).always(function(){TC.loadJS(r.script,r.script,function(){p(n._$div),r.style&&TC.loadCSS(r.style),!Modernizr.canvas&&r.ie8Style&&TC.loadCSS(r.ie8Style),i()})})}):i()}),n.$events.on(TC.Consts.event.UPDATEPARAMS,function(e){r(e.layer)}),n.$events.on(TC.Consts.event.ZOOM,function(){for(var e=0;e<n.workLayers.length;e++)r(n.workLayers[e])});var m=TC.error;TC.error=function(e,t,r){if(t){var a=function(e,t,r){switch(t){case TC.Consts.msgErrorMode.TOAST:if(!n.toast)return void console.warn("No existe el objeto Toast");n.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration});break;case TC.Consts.msgErrorMode.EMAIL:JL("onerrorLogger").fatalException(r?{msg:r,errorMsg:e}:e,null);break;case TC.Consts.msgErrorMode.CONSOLE:default:console.error(e)}};if($.isArray(t))for(var s=0;s<t.length;s++)a(e,t[s],r);else a(e,t,r)}else m(e),n.toast(e,{type:TC.Consts.msgType.ERROR,duration:2*TC.Cfg.toastDuration})}};var r=function(e){e.type===TC.Consts.layerType.WMS&&(e.tree=null)},n=function(e,t){var r=$.map(e,function(e){var r={};return e&&(r[t]=e[t]),r}),n={};if(n[t]=TC.Cfg[t],r.unshift(n),"baseLayers"===t&&r[1].baseLayers){n=r[1];for(var a=0;a<n.baseLayers.length;a++)"object"==typeof n.baseLayers[a]&&$.extend(n.baseLayers[a],$.grep(TC.Cfg.availableBaseLayers,function(e){return e.id===n.baseLayers[a].id})[0])}else r.unshift(!0),n=$.extend.apply(this,r);return n[t]},a=function(){var e=$.extend.apply(this,$.merge([!0,{},TC.Cfg],arguments));return e.baseLayers=n(arguments,"baseLayers"),e.workLayers=n(arguments,"workLayers"),e},s=TC.Map.prototype;s.addLayer=function(r,n){var a=this,s=c(r);if(s){var o;for(o=0,len=e.length;o<len&&c(e[o]);o++);e.splice(o,0,r),t.splice(o,0,n)}else e.push(r),t.push(n);for(var i=new $.Deferred,l=function(e){return"string"==typeof e?e:e.id},y=l(r),u=!1,C=0;C<a.options.baseLayers.length&&!u;C++)l(a.options.baseLayers[C])===y&&(u=!0);for(var C=0;C<a.options.workLayers.length&&!u;C++)l(a.options.workLayers[C])===y&&(u=!0);u||a.isLoaded||(a._remainingLayers=a._remainingLayers+1);var p,f,d;return s?(f=!TC.layer||!TC.layer.Raster,d=TC.apiLocation+"TC/layer/Raster.js"):(f=!TC.layer||!TC.layer.Vector,d=TC.apiLocation+"TC/layer/Vector.js"),TC.loadJS(f,[d],function(){if("string"==typeof r){for(var s=0;s<TC.Cfg.availableBaseLayers.length;s++)if(TC.Cfg.availableBaseLayers[s].id===r){p=new TC.layer.Raster($.extend({},TC.Cfg.availableBaseLayers[s],{map:a}));break}}else r instanceof TC.Layer?(p=r,p.map=a):(r.map=a,p=r.type===TC.Consts.layerType.VECTOR||r.type===TC.Consts.layerType.KML||r.type===TC.Consts.layerType.WFS?new TC.layer.Vector(r):new TC.layer.Raster(r));var o=$.inArray(r,e);0>o&&(o=0),e[o]=p,t[o]=n,a.$events.trigger($.Event(TC.Consts.event.BEFORELAYERADD,{layer:p})),$.when(a.wrap.getMap(),p.wrap.getLayer()).then(function(){var r=$.grep(e,function(e){return e.wrap&&e.wrap.isNative(e.wrap.getLayer())});if(r.length===e.length)for(var n=e.length,s=0;n>s;s++){var o=e.shift(),l=t.shift(),y=-1;if(c(o)&&(y=a.wrap.indexOfFirstVector()),-1===y&&(y=a.wrap.getLayerCount()),o)if(o.isCompatible(a.crs))a.layers[a.layers.length]=o,o.isBase?(a.state?o.isDefault=a.state.base===o.id:"string"==typeof a.options.defaultBaseLayer?o.isDefault=a.options.defaultBaseLayer===o.id:"number"==typeof a.options.defaultBaseLayer&&(o.isDefault=a.options.defaultBaseLayer===a.baseLayers.length),o.isDefault&&(a.wrap.setBaseLayer(o.wrap.getLayer()),a.baseLayer=o),a.baseLayers[a.baseLayers.length]=o,a.options.baseLayers.length!==a.baseLayers.length||a.baseLayer||a.wrap.setBaseLayer(a.baseLayers[0].wrap.getLayer())):(a.wrap.insertLayer(o.wrap.getLayer(),y),a.workLayers[a.workLayers.length]=o),a.$events.trigger($.Event(TC.Consts.event.LAYERADD,{layer:o})),$.isFunction(l)&&l(o);else{var u,C='Layer "'+o.title+'" ("'+o.names+'"): ';u=o.isValidFromNames()?"layerSrsNotCompatible":"layerNameNotValid",C+=TC.Util.getLocaleString(a.options.locale,u),TC.error(C),a.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:o,reason:u}))}a._remainingLayers=a._remainingLayers-1,0===a._remainingLayers&&(a.isLoaded||(a.isLoaded=!0,a.$events.trigger($.Event(TC.Consts.event.MAPLOAD))))}i.resolve(p)})}),i.promise()},s.removeLayer=function(e){var t=this,r=new $.Deferred;return $.when(e.wrap.getLayer()).then(function(n){for(var a=0;a<t.layers.length;a++)t.layers[a]===e&&t.layers.splice(a,1);if(e.isBase){for(var a=0;a<t.baseLayers.length;a++)if(t.baseLayers[a]===e){t.baseLayers.splice(a,1),t.baseLayer===e&&t.setBaseLayer(t.baseLayers[0]);break}}else{for(var a=0;a<t.workLayers.length;a++)if(t.workLayers[a]===e){t.workLayers.splice(a,1);break}e===t.vectors&&(t.vectors=null)}t.wrap.removeLayer(n),t.$events.trigger($.Event(TC.Consts.event.LAYERREMOVE,{layer:e})),r.resolve(e)}),r},s.insertLayer=function(e,t,r){for(var n=this,a=-1,s=0;s<n.layers.length;s++)if(e===n.layers[s]){a=s;break}var o=[];o.push(e.wrap.getLayer());var i=n.layers[t];i&&o.push(i.wrap.getLayer()),$.when.apply(this,o).then(function(s,o){var i=-1;i=o?n.wrap.getLayerIndex(o):n.wrap.getLayerCount(),i>=0&&(e.map=n,n.wrap.insertLayer(s,i),a>-1&&n.layers.splice(a,1),n.layers.splice(t,0,e),n.workLayers=$.grep(n.layers,function(e){return!e.isBase}),n.$events.trigger($.Event(TC.Consts.event.LAYERORDER,{layer:e,oldIndex:a,newIndex:t}))),$.isFunction(r)&&r()})},s.setLayerIndex=function(e,t){this.wrap.setLayerIndex(e.wrap.getLayer(),t)},s.putLayerOnTop=function(e){var t=this,r=t.wrap.getLayerCount();t.setLayerIndex(e,r-1)},s.setBaseLayer=function(e,t){var r=this,n=null,a=!1;if("string"==typeof e){var s;for(s=0;s<r.layers.length;s++)if(r.layers[s].id===e){e=r.layers[s],a=!0;break}if(!a)for(s=0;s<TC.Cfg.availableBaseLayers.length;s++)if(TC.Cfg.availableBaseLayers[s].id===e){e=r.addLayer($.extend(!0,{},TC.Cfg.availableBaseLayers[s],{isDefault:!0,map:r})),a=!0;break}}else a=$.inArray(e,r.layers)>=0;return a?(r.$events.trigger($.Event(TC.Consts.event.BEFOREBASELAYERCHANGE,{oldLayer:r.getBaseLayer(),newLayer:e})),n=e,$.when(r.wrap.getMap(),e).then(function(e,n){$.when(n.wrap.getLayer()).then(function(e){r.wrap.setBaseLayer(e).then(function(){r.baseLayer=n,r.$events.trigger($.Event(TC.Consts.event.BASELAYERCHANGE,{layer:n})),$.isFunction(t)&&t()})})})):TC.error("Base layer is not in layers collection"),n},s.on=function(e,t){var r=this;return r.$events.on(e,t),r},s.one=function(e,t){var r=this;return r.$events.one(e,t),r},s.off=function(e,t){var r=this;return r.$events.off(e,t),r},s.ready=function(e){var t=this;$.isFunction(e)&&(t.isReady?e():t.one(TC.Consts.event.MAPREADY,e))},s.loaded=function(e){var t=this;$.isFunction(e)&&(t.isLoaded?e():t.one(TC.Consts.event.MAPLOAD,e))},s.getLayerTree=function(){var e=this,t={baseLayers:[],workLayers:[]};e.baseLayer&&(t.baseLayers[0]=e.baseLayer.getTree());for(var r=0;r<e.workLayers.length;r++){var n=e.workLayers[r].getTree();n&&t.workLayers.unshift(n)}return t},s.addControl=function(e,t){var r=this,n=new $.Deferred,a=function(e){r.controls.push(e),e.register(r),$dv=$(e.div),0===$dv.parent().length&&$dv.appendTo(r._$div),r.$events.trigger($.Event(TC.Consts.event.CONTROLADD,{control:e})),n.resolve(e)};return"string"==typeof e?(e=e.substr(0,1).toUpperCase()+e.substr(1),TC.loadJS(!TC.Control||!TC.control[e],[TC.apiLocation+"TC/control/"+e],function(){a(new TC.control[e](null,t))})):a(e),n.promise()},s.getControlsByClass=function(e){var t=this,r=[],n=e;if("string"==typeof e){n=window;for(var a=e.split("."),s=0;s<a.length&&(n=n[a[s]],n);s++);}if($.isFunction(n))for(var s=0;s<t.controls.length;s++){var o=t.controls[s];o instanceof n&&r.push(o)}return r},s.getDefaultControl=function(){var e=this.getControlsByClass("TC.control.FeatureInfo");return e&&e.length?e[0]:null},s.getLoadingIndicator=function(){var e=null,t=this.getControlsByClass("TC.control.LoadingIndicator");return t.length&&(e=t[0]),e},s.setExtent=function(e,t){return this.wrap.setExtent(e,t)},s.getExtent=function(){return this.wrap.getExtent()},s.setCenter=function(e,t){this.wrap.setCenter(e,t)},s.getCenter=function(){return this.wrap.getCenter()},s.setRotation=function(e){this.wrap.setRotation(e)},s.getRotation=function(){return this.wrap.getRotation()},s.getViewHTML=function(){return this.wrap.getViewport()},s.getCoordinateFromPixel=function(e){return this.wrap.getCoordinateFromPixel(e)},s.getPixelFromCoordinate=function(e){return this.wrap.getPixelFromCoordinate(e)},s.zoomToFeatures=function(e,t){var r=this;if(e.length>0){var n=[1/0,1/0,-(1/0),-(1/0)],a=t||{},s=a.pointBoundsRadius||r.options.pointBoundsRadius;s=r.wrap.isGeo()?s/TC.Util.getMetersPerDegree(r.getExtent()):s;var o=a.extentMargin;"number"!=typeof o&&(o=r.options.extentMargin);for(var i=0;i<e.length;i++){var l=e[i].getBounds();l&&(n[0]=Math.min(n[0],l[0]),n[1]=Math.min(n[1],l[1]),n[2]=Math.max(n[2],l[2]),n[3]=Math.max(n[3],l[3]))}if(n[2]-n[0]===0&&(n[0]=n[0]-s,n[2]=n[2]+s),n[3]-n[1]===0&&(n[1]=n[1]-s,n[3]=n[3]+s),r.options.extentMargin){var y=(n[2]-n[0])*o/2,u=(n[3]-n[1])*o/2;n[0]=n[0]-y,n[1]=n[1]-u,n[2]=n[2]+y,n[3]=n[3]+u}r.options.maxExtent&&(n[0]=Math.max(n[0],r.options.maxExtent[0]),n[1]=Math.max(n[1],r.options.maxExtent[1]),n[2]=Math.min(n[2],r.options.maxExtent[2]),n[3]=Math.min(n[3],r.options.maxExtent[3])),r.wrap.setExtent(n,a),r.$events.trigger($.Event(TC.Consts.event.ZOOMTO,{extent:n}))}},s.zoomToMarkers=function(e){var t=this;$.when.apply(this,t._markerDeferreds).then(function(){for(var r=[],n=0;n<t.workLayers.length;n++){var a=t.workLayers[n];if(a.type===TC.Consts.layerType.VECTOR)for(var s=0;s<a.features.length;s++){var o=a.features[s];o instanceof TC.feature.Marker&&(r[r.length]=o)}}for(var n=0;n<arguments.length;n++)r[r.length]=arguments[n];t.zoomToFeatures(r,e),t._markerDeferreds=[]})},s.getLayer=function(e){var t=this,r=null;if("string"==typeof e){for(var n=0;n<t.layers.length;n++)if(t.layers[n].id===e){r=t.layers[n];break}}else TC.Layer&&e instanceof TC.Layer&&(r=e);return r};var o=function(e){var t;return e.vectors?t=e.vectors:(t=e.addLayer({id:TC.getUID(),title:TC.i18n[e.options.locale].vectors,type:TC.Consts.layerType.VECTOR}),e.vectors=t,$.when(t).then(function(t){e.vectors=t})),t};s.addPoint=function(e,t){var r=this;if(t&&t.layer){var n=r.getLayer(t.layer);n&&n.addPoint(e,t)}else $.when(o(r)).then(function(r){r.addPoint(e,t)})},s.addMarker=function(e,t){var r=this;if(t&&t.layer){var n=r.getLayer(t.layer);n&&r._markerDeferreds.push(n.addMarker(e,t))}else{var a=new $.Deferred;r._markerDeferreds.push(a),$.when(o(r)).then(function(r){$.when(r.addMarker(e,t)).then(function(e){a.resolve(e)})})}},s.addPolyline=function(e,t){var r=this;if(t&&t.layer){var n=r.getLayer(t.layer);n&&t.layer.addPolyline(e,t)}else $.when(o(r)).then(function(r){r.addPolyline(e,t)})},s.addPolygon=function(e,t){var r=this;if(t&&t.layer){var n=r.getLayer(t.layer);n&&t.layer.addPolygon(e,t)}else $.when(o(r)).then(function(r){r.addPolygon(e,t)})},s.getBaseLayer=function(){return this.baseLayer||this.baseLayers[0]},s.getResolutions=function(){return this.getBaseLayer().getResolutions()},s.getResolution=function(){return this.wrap.getResolution()},s.setResolution=function(e){this.wrap.setResolution(e)},s.exportFeatures=function(e,t){var r=this,n=t||{},a=r.getLoadingIndicator(),s=a&&a.addWait(),o=r.wrap.exportFeatures(e,n),i=TC.Consts.mimeType[n.format],l=n.format||"";TC.Util.downloadFile((n.fileName||TC.getUID())+"."+l.toLowerCase(),i,o),a&&a.removeWait(s)};var i="tc-toast-container",l="tc-toast",y={},u=function(){var e=$(this),t=e.parent("."+i),r=e.html();e.addClass(TC.Consts.classes.HIDDEN),void 0!==y[r]&&(y[r]=void 0),setTimeout(function(){e.remove(),t.find("."+l).length||t.remove()},1e3)};s.toast=function(e,t){var r=this,n=t||{},a=n.duration||TC.Cfg.toastDuration,s=y[e];s&&(clearTimeout(s.timeout),s.$toast.remove());var o=r._$div.find("."+i);o.length||(o=$("<div>").addClass(i).appendTo(r._$div)),s=y[e]={$toast:$("<div>").addClass(l).html(e).appendTo(o).on(TC.Consts.event.CLICK,u)};var C="";switch(n.type){case TC.Consts.msgType.INFO:C=TC.Consts.classes.INFO;break;case TC.Consts.msgType.WARNING:C=TC.Consts.classes.WARNING;break;case TC.Consts.msgType.ERROR:C=TC.Consts.classes.ERROR}s.$toast.addClass(C),s.timeout=setTimeout(function(){u.call(s.$toast)},a)};var C=!1,p=function(e){if(/iPad/i.test(navigator.userAgent)){var t=window.innerHeight,r=e.height(),n=Modernizr.mq("only screen and (orientation : landscape)")?20:0;r===t+n&&(C=!0)}var a=function(){e.toggleClass(TC.Consts.classes.IPAD_IOS7_FIX,Modernizr.mq("only screen and (orientation : landscape)"))};C?(a(),$(window).on("resize",a)):$(window).off("resize",a)},c=function(e){return"string"==typeof e||e.type!==TC.Consts.layerType.VECTOR&&e.type!==TC.Consts.layerType.KML&&e.type!==TC.Consts.layerType.WFS};s.exportImage=function(){var e=this,t=null,r="El mapa actual no es compatible con la exportación de imágenes",n=e.wrap.getViewport({synchronous:!0}).getElementsByTagName("canvas")[0];if(n&&e.options.crossOrigin)try{t=n.toDataURL()}catch(a){TC.error(r+": "+a.message)}else TC.error(r);return t}}();