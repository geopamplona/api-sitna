!function(e,t){"function"==typeof define&&define.amd?define(["../../lib/ol/build/ol-debug"],t):"object"==typeof exports?module.exports=t(require("../../lib/ol/build/ol-debug")):e.ol=t(e.ol)}(this,function(e){Math.hypot=Math.hypot||function(){for(var e=0,t=arguments.length,r=0;t>r;r++){if(arguments[r]===1/0||arguments[r]===-(1/0))return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)};for(var t=0,r=["ms","moz","webkit","o"],a=0;a<r.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[r[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[a]+"CancelAnimationFrame"]||window[r[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,r){var a=(new Date).getTime(),n=Math.max(0,16-(a-t)),o=window.setTimeout(function(){e(a+n)},n);return t=a+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});var n="mousemove.tc",o="mouseout.tc",i="mouseover.tc",s=TC.url.ol.substr(0,TC.url.ol.lastIndexOf("/"));s=s.substr(0,s.lastIndexOf("/")+1)+"css/ol.css",e.proj.oldGet=e.proj.get,e.proj.get=function(t){if("string"==typeof t){for(var r=0,a=e.proj.EPSG4326.PROJECTIONS.length;a>r;r++){var n=e.proj.EPSG4326.PROJECTIONS[r];if(n.getCode()===t)return n}TC.loadProjDef(t,!0)}return e.proj.oldGet.call(this,t)},e.format.GMLBase.prototype.readGeometryElement=function(t,r){var a=r[0],n=a.srsName=t.firstElementChild.getAttribute("srsName");if((this instanceof e.format.GML2CRS84||this instanceof e.format.GML3CRS84)&&("EPSG:4326"!==n||!n))throw new Error("Conflicto de CRS");n&&(a.srsName=this.srsName||n,a.dataProjection=e.proj.get(a.srsName));var o=e.xml.pushParseAndPop(null,this.GEOMETRY_PARSERS_,t,r,this);return o?e.format.Feature.transformWithOptions(o,!1,a):void 0},e.format.GMLBase.prototype.readFeatureElement=function(t,r){var a,n,o=t.getAttribute("fid")||e.xml.getAttributeNS(t,e.format.GMLBase.GMLNS,"id"),i={};for(a=t.firstElementChild;a;a=a.nextElementSibling){var s=a.localName;if(0===a.childNodes.length||1===a.childNodes.length&&(3===a.firstChild.nodeType||4===a.firstChild.nodeType)){var l=e.xml.getAllTextContent(a,!1);e.format.GMLBase.ONLY_WHITESPACE_RE_.test(l)&&(l=void 0),i[s]=l}else(i[s]=this.readGeometryElement(a,r))&&"boundedBy"!==s&&"referencePoint"!==s&&(n=s)}var p=new e.Feature(i);return n&&p.setGeometryName(n),o&&p.setId(o),p};var l="http://www.opengis.net/gml",p="http://www.opengis.net/gml/3.2";e.format.GMLBase.prototype.MULTIPOINT_PARSERS_[p]=e.format.GMLBase.prototype.MULTIPOINT_PARSERS_[l],e.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[p]=e.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[l],e.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[p]=e.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[l],e.format.GMLBase.prototype.POINTMEMBER_PARSERS_[p]=e.format.GMLBase.prototype.POINTMEMBER_PARSERS_[l],e.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[p]=e.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[l],e.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[p]=e.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[l],e.format.GMLBase.prototype.RING_PARSERS[p]=e.format.GMLBase.prototype.RING_PARSERS[l],e.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[p]=e.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS_[l],e.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[p]=e.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS_[l],e.format.GML3.prototype.GEOMETRY_PARSERS_[p]=e.format.GML3.prototype.GEOMETRY_PARSERS_[l],e.format.GML3.prototype.MULTICURVE_PARSERS_[p]=e.format.GML3.prototype.MULTICURVE_PARSERS_[l],e.format.GML3.prototype.MULTISURFACE_PARSERS_[p]=e.format.GML3.prototype.MULTISURFACE_PARSERS_[l],e.format.GML3.prototype.CURVEMEMBER_PARSERS_[p]=e.format.GML3.prototype.CURVEMEMBER_PARSERS_[l],e.format.GML3.prototype.SURFACEMEMBER_PARSERS_[p]=e.format.GML3.prototype.SURFACEMEMBER_PARSERS_[l],e.format.GML3.prototype.SURFACE_PARSERS_[p]=e.format.GML3.prototype.SURFACE_PARSERS_[l],e.format.GML3.prototype.CURVE_PARSERS_[p]=e.format.GML3.prototype.CURVE_PARSERS_[l],e.format.GML3.prototype.ENVELOPE_PARSERS_[p]=e.format.GML3.prototype.ENVELOPE_PARSERS_[l],e.format.GML3.prototype.PATCHES_PARSERS_[p]=e.format.GML3.prototype.PATCHES_PARSERS_[l],e.format.GML3.prototype.SEGMENTS_PARSERS_[p]=e.format.GML3.prototype.SEGMENTS_PARSERS_[l],e.format.KML._createStyleDefaults_=e.format.KML.createStyleDefaults_,e.format.KML.createStyleDefaults_=function(){return e.format.KML._createStyleDefaults_(),e.format.KML.DEFAULT_FILL_STYLE_.color_=T(TC.Cfg.styles.polygon.fillColor,TC.Cfg.styles.polygon.fillOpacity),e.format.KML.DEFAULT_TEXT_STYLE_.fill_=new e.style.Fill({color:e.format.KML.DEFAULT_COLOR_}),e.format.KML.DEFAULT_STROKE_STYLE_.color_=T(TC.Cfg.styles.line.strokeColor,1),e.format.KML.DEFAULT_STROKE_STYLE_.width_=TC.Cfg.styles.line.strokeWidth,e.format.KML.DEFAULT_STYLE_ARRAY_},e.format.KML.prototype._readDocumentOrFolder_=e.format.KML.prototype.readDocumentOrFolder_,e.format.KML.prototype.readDocumentOrFolder_=function(t,r){var a=e.format.KML.prototype._readDocumentOrFolder_.apply(this,arguments);if("Folder"==t.localName)for(var n=0;n<a.length;n++){var o=a[n];$.isArray(o._folders)||(o._folders=[]);var i=t.getElementsByTagName("name")[0];i&&TC.Util.fastUnshift(o._folders,i.innerHTML||i.textContent)}return a},e.format.KML.readText_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE),e.asserts.assert("text"==t.localName);var a=e.xml.getAllTextContent(t,!1);return a.trim()},e.format.KML.BALLOON_STYLE_PARSERS_=e.xml.makeStructureNS(e.format.KML.NAMESPACE_URIS_,{text:e.xml.makeObjectPropertySetter(e.format.KML.readText_)}),e.format.KML.BalloonStyleParser_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE),e.asserts.assert("BalloonStyle"==t.localName);var a=e.xml.pushParseAndPop({},e.format.KML.BALLOON_STYLE_PARSERS_,t,r);if(goog.isDef(a)){var n=r[r.length-1];e.asserts.assert(goog.isObject(n));var o=new e.style.Text({text:a.text});n.balloonStyle=o}};for(var c in e.format.KML.STYLE_PARSERS_){var u=e.format.KML.STYLE_PARSERS_[c];u.BalloonStyle=e.format.KML.BalloonStyleParser_}e.format.KML.readStyle_=function(t,r){var a=e.xml.pushParseAndPop({},e.format.KML.STYLE_PARSERS_,t,r);if(!a)return null;var n="fillStyle"in a?a.fillStyle:e.format.KML.DEFAULT_FILL_STYLE_,o=a.fill;void 0===o||o||(n=null);var i="imageStyle"in a?a.imageStyle:e.format.KML.DEFAULT_IMAGE_STYLE_;i==e.format.KML.DEFAULT_NO_IMAGE_STYLE_&&(i=void 0);var s="textStyle"in a?a.textStyle:e.format.KML.DEFAULT_TEXT_STYLE_,l="strokeStyle"in a?a.strokeStyle:e.format.KML.DEFAULT_STROKE_STYLE_,p="balloonStyle"in a?a.balloonStyle:e.format.KML.DEFAULT_BALLOON_STYLE_,c=a.outline;void 0===c||c||(l=null);var u=new e.style.Style({fill:n,image:i,stroke:l,text:s,zIndex:void 0});return u._balloon=p,[u]},e.format.KML._readURI_=e.format.KML.readURI_,e.format.KML.readURI_=function(t){var r=e.format.KML._readURI_(t);return"https:"===location.protocol&&0===r.indexOf("http://")&&(r=r.substr(5)),r};for(var c in e.format.KML.ICON_PARSERS_)e.format.KML.ICON_PARSERS_[c].href=e.xml.makeObjectPropertySetter(e.format.KML.readURI_);e.format.KML.whenParser_=function(t,r){e.asserts.assert(t.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT"),e.asserts.assert("when"==t.localName,"localName should be when");var a=r[r.length-1];e.asserts.assert(goog.isObject(a),"gxTrackObject should be an Object");var a=a.whens,n=e.xml.getAllTextContent(t,!1);if(n=/^\s*(\d{4})($|-(\d{2})($|-(\d{2})($|T(\d{2}):(\d{2}):(\d{2})(?:.?\d{3})?(Z|(?:([+\-])(\d{2})(?::(\d{2}))?)))))\s*$/.exec(n)){var o=parseInt(n[1],10),i=n[3]?parseInt(n[3],10)-1:0,s=n[5]?parseInt(n[5],10):1,l=n[7]?parseInt(n[7],10):0,p=n[8]?parseInt(n[8],10):0,c=n[9]?parseInt(n[9],10):0,o=Date.UTC(o,i,s,l,p,c);n[10]&&"Z"!=n[10]&&(i="-"==n[11]?-1:1,o+=60*i*parseInt(n[12],10),n[13]&&(o+=3600*i*parseInt(n[13],10))),a.push(o)}else a.push(0)},e.format.KML.GX_TRACK_PARSERS_=e.xml.makeStructureNS(e.format.KML.NAMESPACE_URIS_,{when:e.format.KML.whenParser_},e.xml.makeStructureNS(e.format.KML.GX_NAMESPACE_URIS_,{coord:e.format.KML.gxCoordParser_}));var g=function(t,r){var a=e.xml.parse(t),n=a.getElementsByTagName(r.toLowerCase());if(n&&n.length>0){var o=n[0].getAttribute("xmlns");if(o&&o.indexOf(" ")>-1&&y.indexOf(o)>-1)for(var i=o.split(" "),s=[],l=0;l<i.length;l++)s.push("xmlns:"+r.toLowerCase()+l+'="'+i[l].trim()+'"')}return t};e.format.KML.prototype.readFeatures=function(t,r){if("string"==typeof t){var a="<kml",n=t.indexOf(a);if(n>=0){n+=a.length;{t.indexOf(">",n)}t.indexOf("xmlns:xsi=")<0&&(t=t.substr(0,n)+' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'+t.substr(n)),t=g(t,"KML")}}return e.format.XMLFeature.prototype.readFeatures.call(this,t,r)},e.format.XSD.readDateTime=function(t){if(t=e.xml.getAllTextContent(t,!1),t=/^\s*(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(Z|(?:([+\-])(\d{2})(?::(\d{2}))?))\s*$/.exec(t)){var r=parseInt(t[1],10),a=parseInt(t[2],10)-1,n=parseInt(t[3],10),o=parseInt(t[4],10),i=parseInt(t[5],10),s=parseInt(t[6],10),r=Date.UTC(r,a,n,o,i,s);return"Z"!=t[7]&&(a="-"==t[8]?-1:1,r+=60*a*parseInt(t[9],10),void 0!==t[10]&&(r+=3600*a*parseInt(t[10],10))),r}},e.format.GPX.RTEPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime)}),e.format.GPX.TRKPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime)}),e.format.GPX.WPT_PARSERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),time:e.xml.makeObjectPropertySetter(e.format.XSD.readDateTime),magvar:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),geoidheight:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),name:e.xml.makeObjectPropertySetter(e.format.XSD.readString),cmt:e.xml.makeObjectPropertySetter(e.format.XSD.readString),desc:e.xml.makeObjectPropertySetter(e.format.XSD.readString),src:e.xml.makeObjectPropertySetter(e.format.XSD.readString),link:e.format.GPX.parseLink_,sym:e.xml.makeObjectPropertySetter(e.format.XSD.readString),type:e.xml.makeObjectPropertySetter(e.format.XSD.readString),fix:e.xml.makeObjectPropertySetter(e.format.XSD.readString),sat:e.xml.makeObjectPropertySetter(e.format.XSD.readNonNegativeInteger),hdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),vdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),pdop:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),ageofdgpsdata:e.xml.makeObjectPropertySetter(e.format.XSD.readDecimal),dgpsid:e.xml.makeObjectPropertySetter(e.format.XSD.readNonNegativeInteger),extensions:e.format.GPX.parseExtensions_}),e.format.XSD.writeDateTimeTextNode=function(t,r){var a=new Date(r),n=a.getUTCFullYear()+"-"+e.string.padNumber(a.getUTCMonth()+1,2)+"-"+e.string.padNumber(a.getUTCDate(),2)+"T"+e.string.padNumber(a.getUTCHours(),2)+":"+e.string.padNumber(a.getUTCMinutes(),2)+":"+e.string.padNumber(a.getUTCSeconds(),2)+"Z";t.appendChild(e.xml.DOCUMENT.createTextNode(n))},e.format.GPX.WPT_TYPE_SERIALIZERS_=e.xml.makeStructureNS(e.format.GPX.NAMESPACE_URIS_,{ele:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),time:e.xml.makeChildAppender(e.format.XSD.writeDateTimeTextNode),magvar:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),geoidheight:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),name:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),cmt:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),desc:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),src:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),link:e.xml.makeChildAppender(e.format.GPX.writeLink_),sym:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),type:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),fix:e.xml.makeChildAppender(e.format.XSD.writeStringTextNode),sat:e.xml.makeChildAppender(e.format.XSD.writeNonNegativeIntegerTextNode),hdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),vdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),pdop:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),ageofdgpsdata:e.xml.makeChildAppender(e.format.XSD.writeDecimalTextNode),dgpsid:e.xml.makeChildAppender(e.format.XSD.writeNonNegativeIntegerTextNode)});var f=function(e){for(var t=[],r=[],a=Math.pow(2,e.length),n=0;a>n;n++){r=[];for(var o=0;o<e.length;o++)n&Math.pow(2,o)&&-1==r.indexOf(e[o])&&r.push(e[o]);r.length>0&&-1==t.indexOf(r.join(" "))&&t.push(r.join(" "))}return t},m=function(e,t){if(e&&e.length>0)for(var r=0;r<t.length;r++){var a=e.indexOf(t[r]);a>-1&&e.splice(a,1)}},d=function(e,t){for(var r=0;r<e.length;r++)for(var a=e[r],n=0;n<t.length;n++){var o=t[n].split(" ")[0];a[t[n]]=a[o]}},v=[e.format.KML.DATA_PARSERS_,e.format.KML.EXTENDED_DATA_PARSERS_,e.format.KML.REGION_PARSERS_,e.format.KML.LAT_LON_ALT_BOX_PARSERS_,e.format.KML.LOD_PARSERS_,e.format.KML.EXTRUDE_AND_ALTITUDE_MODE_PARSERS_,e.format.KML.FLAT_LINEAR_RING_PARSERS_,e.format.KML.FLAT_LINEAR_RINGS_PARSERS_,e.format.KML.GX_TRACK_PARSERS_,e.format.KML.GEOMETRY_FLAT_COORDINATES_PARSERS_,e.format.KML.ICON_PARSERS_,e.format.KML.ICON_STYLE_PARSERS_,e.format.KML.INNER_BOUNDARY_IS_PARSERS_,e.format.KML.LABEL_STYLE_PARSERS_,e.format.KML.LINE_STYLE_PARSERS_,e.format.KML.MULTI_GEOMETRY_PARSERS_,e.format.KML.GX_MULTITRACK_GEOMETRY_PARSERS_,e.format.KML.NETWORK_LINK_PARSERS_,e.format.KML.LINK_PARSERS_,e.format.KML.OUTER_BOUNDARY_IS_PARSERS_,e.format.KML.PAIR_PARSERS_,e.format.KML.PLACEMARK_PARSERS_,e.format.KML.POLY_STYLE_PARSERS_,e.format.KML.SCHEMA_DATA_PARSERS_,e.format.KML.STYLE_PARSERS_,e.format.KML.STYLE_MAP_PARSERS_],y=f(e.format.KML.NAMESPACE_URIS_.slice().slice(1));m(y,e.format.KML.NAMESPACE_URIS_),e.format.KML.NAMESPACE_URIS_=e.format.KML.NAMESPACE_URIS_.concat(y),d(v,y);var C=[e.format.GPX.GPX_PARSERS_,e.format.GPX.LINK_PARSERS_,e.format.GPX.RTE_PARSERS_,e.format.GPX.RTEPT_PARSERS_,e.format.GPX.TRK_PARSERS_,e.format.GPX.TRKSEG_PARSERS_,e.format.GPX.TRKPT_PARSERS_,e.format.GPX.WPT_PARSERS_,e.format.GPX.LINK_SERIALIZERS_,e.format.GPX.RTE_SEQUENCE_,e.format.GPX.RTE_SERIALIZERS_,e.format.GPX.RTEPT_TYPE_SEQUENCE_,e.format.GPX.TRK_SEQUENCE_,e.format.GPX.TRK_SERIALIZERS_,e.format.GPX.TRKSEG_SERIALIZERS_,e.format.GPX.WPT_TYPE_SEQUENCE_,e.format.GPX.WPT_TYPE_SERIALIZERS_,e.format.GPX.GPX_SERIALIZERS_],h=f(e.format.GPX.NAMESPACE_URIS_.slice().slice(1));m(h,e.format.GPX.NAMESPACE_URIS_),e.format.GPX.NAMESPACE_URIS_=e.format.GPX.NAMESPACE_URIS_.concat(h),d(C,h),e.format.GML3Patched=function(t){var r=new e.format.GML(t);return r.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS].featureMember=e.xml.makeArrayPusher(e.format.GMLBase.prototype.readFeaturesInternal),r},e.format.GMLBase.prototype.readFeaturesInternal=function(t,r){e.DEBUG&&console.assert(t.nodeType==Node.ELEMENT_NODE,"node.nodeType should be ELEMENT");var a=t.localName,n=null;if("FeatureCollection"==a){var o=this.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS];o.member||(o.member=e.xml.makeArrayPusher(e.format.GMLBase.prototype.readFeaturesInternal)),"http://www.opengis.net/wfs"===t.namespaceURI?n=e.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,r,this):(this.FEATURE_COLLECTION_PARSERS[t.namespaceURI]=this.FEATURE_COLLECTION_PARSERS[t.namespaceURI]||this.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.GMLNS],n=e.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,r,this))}else if("featureMembers"==a||"featureMember"==a||"member"==a){var i,s,l=r[0],p=l.featureType,c=l.featureNS,u="p",g="p0";if(t.childNodes){for(p=[],c={},i=0,s=t.childNodes.length;s>i;++i){var f=t.childNodes[i];if(1===f.nodeType){var m=f.nodeName.split(":").pop();if(-1===p.indexOf(m)){var d="",v=0,y=f.namespaceURI;for(var C in c){if(c[C]===y){d=C;break}++v}d||(d=u+v,c[d]=y),p.push(d+":"+m)}}}"featureMember"!=a&&"member"!=a&&(l.featureType=p,l.featureNS=c)}if("string"==typeof c){var h=c;c={},c[g]=h}var T={},S=Array.isArray(p)?p:[p];for(var w in c){var E={};for(i=0,s=S.length;s>i;++i){var L=-1===S[i].indexOf(":")?g:S[i].split(":")[0];L===w&&(E[S[i].split(":").pop()]="featureMembers"==a?e.xml.makeArrayPusher(this.readFeatureElement,this):e.xml.makeReplacer(this.readFeatureElement,this))}T[c[w]]=E}n="featureMember"==a||"member"==a?e.xml.pushParseAndPop(void 0,T,t,r):e.xml.pushParseAndPop([],T,t,r)}null===n&&(n=[]);var R=function(e){var t=e.getGeometry();if(e.getProperties()[e.getGeometryName()]&&(!t||!t.flatCoordinates.length))throw"Geometría no válida. ¿Posible versión incorrecta de GML?"};if(n instanceof e.Feature)R(n);else for(var i=0,M=n.length;M>i;i++)R(n[i]);return n},e.format.GML3CRS84=function(){e.format.GML3.call(this,{srsName:"CRS:84"})},e.inherits(e.format.GML3CRS84,e.format.GML3),e.format.GML2CRS84=function(){e.format.GML2.call(this,{srsName:"CRS:84"})},e.inherits(e.format.GML2CRS84,e.format.GML2),e.View.prototype.getValueForResolutionFunction=function(e){var t=e||2,r=this.maxResolution_,a=this.minResolution_,n=Math.log(r/a)/Math.log(t);return function(e){var a=Math.log(r/e)/Math.log(t)/n;return a=Math.max(Math.min(1,a),0)}},e.control.OverviewMap.prototype._validateExtent_=e.control.OverviewMap.prototype.validateExtent_,e.control.OverviewMap.prototype.validateExtent_=function(){var e=this;e._validateExtent_(),e._wrap&&e._wrap.parent.options.alwaysCentered&&e.recenter_()},e.control.OverviewMap.prototype._resetExtent_=e.control.OverviewMap.prototype.resetExtent_,e.control.OverviewMap.prototype.resetExtent_=function(){var t=this;t._resetExtent_.call(t);var r=t._wrap;if(r.is3D){var a=t.ovmap_,n=a.getView(),o=n.calculateExtent(),i=r.get3DCameraLayer().getSource().getFeatures()[0];if(i){coordinates=i.getGeometry().getCoordinates();var s=coordinates[0][0],l=coordinates[0][1];if(!e.extent.containsCoordinate(o,s)||!e.extent.containsCoordinate(o,l)){var p=Math.max(o[0]-s[0],o[1]-s[1],s[0]-o[2],s[1]-o[3],o[0]-l[0],o[1]-l[1],l[0]-o[2],l[1]-o[3]);n.fit(e.extent.buffer(o,p))}}}};var T=function(t,r){var a;return t?(a=e.color.asArray(t),a=a.slice(),void 0!==r&&(a[3]=r)):a=[0,0,0,1],a},S=function(e,t){var r=e.map.getView(),a=r.getResolution(),n={projection:r.getProjection(),center:r.getCenter(),resolution:a,enableRotation:!1};if(e.parent.options.maxExtent&&(n.extent=e.parent.options.initialExtent),t instanceof TC.layer.Raster){var o,i,s=t.getResolutions();if(s&&s.length){o=t.maxResolution||s[0],i=t.minResolution||s[s.length-1];var l=s.indexOf(i),p=s.indexOf(o);n.resolutions=s.slice(p,l+1)}else o=t.maxResolution,i=t.minResolution;i&&(n.minResolution=i,i>a&&(n.resolution=i)),o&&(n.maxResolution=o,a>o&&(n.resolution=o))}return n};TC.wrap.Map.prototype.setMap=function(){var t=this,r=[(t.parent.options.initialExtent[0]+t.parent.options.initialExtent[2])/2,(t.parent.options.initialExtent[1]+t.parent.options.initialExtent[3])/2],a=proj4(t.parent.crs),n=function(){var r=t.parent.crs.substr(t.parent.crs.lastIndexOf(":")+1),n={units:a.oProj.units,extent:t.parent.options.baselayerExtent,global:!0,worldExtent:t.parent.options.baselayerExtent},o=[];n.code="EPSG:"+r,o.push(new e.proj.Projection(n)),n.code="urn:ogc:def:crs:EPSG::"+r,o.push(new e.proj.Projection(n)),e.proj.addEquivalentProjections(o);var i=function(e,t,r,a){for(var n=[],o=a||2,i=0;i<t.length;i+=o)n=n.concat(e(t.slice(i,i+o)));if($.isArray(r)){r.length=0;for(var i=0;i<n.length;i++)r[i]=n[i];n=r}return n},s=function(e,t,r){return i(a.forward,e,t,r)},l=function(e,t,r){return i(a.inverse,e,t,r)};e.proj.addEquivalentTransforms(e.proj.EPSG4326.PROJECTIONS,o,s,l)};n();var o={code:t.parent.crs,units:a.oProj.units,extent:t.parent.options.baselayerExtent};"EPSG:4326"===t.parent.crs&&(o.axisOrientation="neu");var i=new e.proj.Projection(o),s=e.interaction.defaults(),l={projection:i,center:r,enableRotation:!1};if(t.parent.options.maxExtent){var p=t.parent.options.maxExtent;l.extent=p;var c=t.parent.div.getBoundingClientRect(),u=(c.width/c.height,p[2]-p[0]),g=p[3]-p[1];l.resolution=c.width/c.height>u/g?u/c.width:g/c.height}else l.zoom=2;t.map=new e.Map({target:t.parent.div,renderer:e.renderer.Type.CANVAS,view:new e.View(l),controls:[],interactions:s}),t.map.getView().fit(t.parent.options.initialExtent),t.map._wrap=t;var f=function(){t.map.updateSize()};$(t.parent.div).on(e.events.EventType.RESIZE,f),t.parent.$events.one(TC.Consts.event.MAPLOAD,f),t.map.on(e.MapBrowserEventType.SINGLECLICK,function(e){var r=$.map(t.parent.workLayers,function(){return!1});t.map.forEachFeatureAtPixel(e.pixel,function(e,a){if(e._wrap&&e._wrap.parent.showsPopup){for(var n=0;n<t.parent.workLayers.length;n++){var o=t.parent.workLayers[n];if(o.wrap.layer===a){r[n]=!0;break}}return t.parent.$events.trigger($.Event(TC.Consts.event.FEATURECLICK,{feature:e._wrap.parent})),e}});for(var a=0;a<r.length;a++)r[a]||t.parent.$events.trigger($.Event(TC.Consts.event.NOFEATURECLICK,{layer:t.parent.workLayers[a]}))});var m=t.map.getView();m.on("change:resolution",function(){t.parent.$events.trigger($.Event(TC.Consts.event.BEFOREZOOM))},t.parent),t.map.on(e.MapEventType.MOVEEND,function(){t.parent.$events.trigger($.Event(TC.Consts.event.ZOOM))}),t.mapDeferred.resolve(t.map);var d=function(r,a){var n=(t.map.getView().getResolution(),t.map.getView().getZoom(),a||S(t,r)),o=new e.View(n);t.map.setView(o),t.map.render()};t.parent.$events.on(TC.Consts.event.BASELAYERCHANGE,function(e){d(e.layer)}),t.parent.$events.on(TC.Consts.event.MAPLOAD,function(e){d(t.parent.getBaseLayer())})},TC.wrap.Map.prototype.insertLayer=function(t,r){for(var a=this,n=a.map.getLayers(),o=!1,i=0;i<n.getLength();i++)if(n.item(i)===t){o=!0;break}if(o)n.remove(t),n.insertAt(r,t);else{if(n.insertAt(r,t),t instanceof e.layer.Tile){var s=t.getSource().getResolutions(),l=a.map.getView();l.maxResolution_=s[0],l.minResolution_=s[s.length-1]}var p=t._wrap,c=0,u=function(e){p.parent.state=TC.Layer.state.LOADING,0>=c&&(c=0,a.parent.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:p.parent}))),t._loadingTileCount=t._loadingTileCount+1};p.parent.state===TC.Layer.state.LOADING&&p.parent.isRaster()&&u(),p.$events.on(TC.Consts.event.BEFORETILELOAD,u),p.$events.on(TC.Consts.event.TILELOAD,function(e){c-=1,0>=c&&(c=0,p.parent.state=TC.Layer.state.IDLE,a.parent.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:p.parent})))})}},TC.wrap.Map.prototype.removeLayer=function(e){this.map.removeLayer(e)},TC.wrap.Map.prototype.getLayerCount=function(){return this.map.getLayerGroup().getLayers().getLength()},TC.wrap.Map.prototype.indexOfFirstVector=function(){var t=-1;return this.map.getLayerGroup().getLayers().forEach(function(r,a){r instanceof e.layer.Vector&&-1===t&&(t=a)}),t},TC.wrap.Map.prototype.getLayerIndex=function(e){var t=-1;return this.map.getLayerGroup().getLayers().forEach(function(r,a){r===e&&(t=a)}),t},TC.wrap.Map.prototype.setLayerIndex=function(e,t){var r=this.map.getLayers(),a=r.getArray(),n=a.indexOf(e);n>-1&&n!=t&&(this.map.removeLayer(e),this.insertLayer(e,t))},TC.wrap.Map.prototype.setBaseLayer=function(e){var t=this,r=new $.Deferred,a=S(t,e._wrap.parent),n=t.map.getView(),o=function(){var a=t.parent.getBaseLayer();a&&t.map.removeLayer(a.wrap.getLayer()),t.insertLayer(e,0),r.resolve()},i=n.getResolution();return a.resolutions&&a.resolutions.indexOf(i)<0?(a.resolution=$.grep(a.resolutions.sort(function(e,t){return e-t}),function(e){return e>a.resolution})[0],n.animate({resolution:a.resolution,duration:TC.Consts.ZOOM_ANIMATION_DURATION},function(){o()})):o(),r.promise()},TC.wrap.Map.prototype.setExtent=function(t,r){var a=this;a.done&&a.done.resolve(),a.done=new $.Deferred;var n=r||{};return clearTimeout(a._timeout),a._timeout=setTimeout(function(){var r=a.map.getSize(),o=a.map.getView(),i=function(){a.done.resolve()},s=function(){var e=o.getResolutionForExtent(t,r);if(o.constrainResolution){var a=o.constrainResolution(e,0,0);e>a&&(a=a/e<TC.Consts.EXTENT_TOLERANCE?o.constrainResolution(a,-1,0):o.constrainResolution(e,0,0)),e=a}o.animate({resolution:e,center:[(t[0]+t[2])/2,(t[1]+t[3])/2],duration:void 0===n.animate||n.animate?TC.Consts.ZOOM_ANIMATION_DURATION:0},i)};a.parent.baseLayer?$.when(a.parent.baseLayer.wrap.getLayer()).then(function(n){var i=n.getSource();if(i.getResolutions!=goog.abstractMethod){var l=o.getResolutionForExtent(t,r),p=a.parent.baseLayer.getResolutions();if(p&&p.length>0){var c=Math.min.apply(a,p);if(c>l){var u=.5*(c/l-1),g=e.extent.getWidth(t)*u,f=e.extent.getHeight(t)*u;t=t.slice(0),t[0]=t[0]-g,t[1]=t[1]-f,t[2]=t[2]+g,t[3]=t[3]+f}}}s()}):s()},50),a.done},TC.wrap.Map.prototype.getExtent=function(){return this.map.getView().calculateExtent(this.map.getSize())},TC.wrap.Map.prototype.setCenter=function(e,t){var r=this,a=t||{},n=r.map.getView();a.animate?n.animate({center:e,duration:TC.Consts.ZOOM_ANIMATION_DURATION}):n.setCenter(e)},TC.wrap.Map.prototype.getCenter=function(){return this.map.getView().getCenter()},TC.wrap.Map.prototype.getResolution=function(){return this.map.getView().getResolution()},TC.wrap.Map.prototype.setResolution=function(e){$.when(this.getMap()).then(function(t){t.getView().setResolution(e)})},TC.wrap.Map.prototype.setRotation=function(e){$.when(this.getMap()).then(function(t){t.getView().setRotation(e)})},TC.wrap.Map.prototype.getRotation=function(){return this.map.getView().getRotation()},TC.wrap.Map.prototype.getCoordinateFromPixel=function(e){return this.map.getCoordinateFromPixel(e)},TC.wrap.Map.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)},TC.wrap.Map.prototype.getViewport=function(e){var t=this,r=e||{};if(r.synchronous)a=t.map.getViewport();else{var a=new $.Deferred;$.when(this.getMap()).then(function(e){a.resolve(e.getViewport())})}return a},TC.wrap.Map.prototype.isNative=function(t){return t instanceof e.Map},TC.wrap.Map.prototype.isGeo=function(){return this.map.getView().getProjection().getUnits()===e.proj.Units.DEGREES},TC.wrap.Map.prototype.addPopup=function(t){var r=$.Deferred(),a=this,o=void 0===t.options.draggable||t.options.draggable;TC.loadJS(o&&!$.fn.drag,[TC.apiLocation+"lib/jQuery/jquery.event.drag.js"],function(){$.when(a.getMap()).then(function(r){if(!t.$popupDiv){var i=TC.Util.getDiv();t.$popupDiv=$(i),t.$popupDiv.addClass(TC.control.Popup.prototype.CLASS).appendTo(a.parent.div),t.$contentDiv=$(TC.Util.getDiv()).addClass(TC.control.Popup.prototype.CLASS+"-content").appendTo(t.$popupDiv);var s=new e.Overlay({element:i,positioning:e.OverlayPositioning.BOTTOM_LEFT});r.addOverlay(s),t.wrap.popup=s;var l=$(r.getViewport());if(o){var p=t.$popupDiv.parent();t.$popupDiv.addClass(TC.Consts.classes.DRAGGABLE),p.on("touchmove",function(e){$(e.target).parents(".tc-ctl-finfo-layer-content").length&&e.stopPropagation()}).drag("start",function(e,a){var n=e.target.getBoundingClientRect();if(n.left+e.target.clientWidth<e.clientX||n.top+e.target.clientHeight<e.clientY)return!1;if(t.setDragging(!0),t._currentOffset=s.getOffset(),t._previousContainerPosition){var o=r.getSize();s.setPosition(r.getCoordinateFromPixel([t._previousContainerPosition[0],o[1]-t._previousContainerPosition[1]])),t._currentOffset=[0,0],s.setOffset(t._currentOffset),delete t._previousContainerPosition}else t._currentOffset=s.getOffset()}).drag("end",function(e,a){t.setDragging(!1);var n=r.getCoordinateFromPixel([0,0]),o=r.getCoordinateFromPixel(s.getOffset()),i=[o[0]-n[0],o[1]-n[1]],l=s.getPosition();s.setPosition([l[0]+i[0],l[1]+i[1]]),s.setOffset([0,0]),t._currentOffset=[0,0],t._previousContainerPosition=[parseInt(p.css("left")),parseInt(p.css("bottom"))]}).drag(function(e,r){return e.buttons||Modernizr.touch?void s.setOffset([t._currentOffset[0]+r.deltaX,t._currentOffset[1]+r.deltaY]):!1},{not:"th,td, td *,input,select"}).on("mouseenter",function(e){l.off(n+".popup")}).on("mouseleave",function(e){l.on(n+".popup",c)})}var c=function(e){var t=r.getTarget(),n=!1;if(!a.parent.activeControl||!a.parent.activeControl.isExclusive()){var o=r.getEventPixel(e.originalEvent);n=r.forEachFeatureAtPixel(o,function(e,t){var r=!0;return e=e,e._wrap&&!e._wrap.parent.showsPopup&&(r=!1),r&&e._wrap&&a.parent.$events.trigger($.Event(TC.Consts.event.FEATUREOVER,{feature:e._wrap.parent})),r})}n?t.style.cursor="pointer":(t.style.cursor="",a.parent.$events.trigger($.Event(TC.Consts.event.FEATUREOUT)))};l.off(n+".popup").on(n+".popup",c)}}),r.resolve()}),r.promise()},TC.wrap.Map.prototype.hidePopup=function(e){var t=this;t.parent.currentFeature=null,e.$popupDiv&&e.$popupDiv.removeClass(TC.Consts.classes.VISIBLE)};var w=function(t){switch(t){case TC.Consts.layerType.KML:case TC.Consts.mimeType.KML:return new e.format.KML({showPointNames:!1});case TC.Consts.layerType.GPX:return new e.format.GPX;case TC.Consts.layerType.GEOJSON:case TC.Consts.mimeType.JSON:case TC.Consts.format.JSON:return new e.format.GeoJSON;case TC.Consts.format.GML2:return new e.format.GML2;case TC.Consts.format.GML3:return new e.format.GML3Patched;case TC.Consts.mimeType.GML:case TC.Consts.format.GML:return new e.format.GML;case TC.Consts.format.TOPOJSON:return new e.format.TopoJSON;case TC.Consts.format.WKT:return new e.format.WKT}};TC.wrap.Map.prototype.exportFeatures=function(t,r){var a=this,n=I({styles:a.parent.options.styles}),o=t.map(function(e){var t=e.wrap.feature;return t.getStyle()||t.setStyle(n),t}),i=w(r.format);if(i instanceof e.format.GMLBase){i.featureNS="sitna",i.featureType="getFeatureInfoResult";var s=i.writeFeaturesNode(o,{featureProjection:a.parent.crs}),l=e.xml.createElementNS("http://www.opengis.net/gml","FeatureCollection");return e.xml.setAttributeNS(l,"http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation",i.schemaLocation),s.removeAttribute("xmlns:xsi"),s.removeAttribute("xsi:schemaLocation"),l.appendChild(s),l.outerHTML}return i.writeFeatures(o,{featureProjection:a.parent.crs})};var E=function(e){for(var t=0,r=e.dataTransfer.types.length;r>t;t++)if("Files"===e.dataTransfer.types[t])return!0;return!1},L=function(e){var t=this;E(e)&&(t.getMap()._wrap.parent._$div.addClass(TC.Consts.classes.DROP),e.preventDefault(),e.stopPropagation())},R=function(e){var t=this;if(E(e)){var r=t.getMap()._wrap.parent;e.target===t.target&&r._$div.removeClass(TC.Consts.classes.DROP)}};TC.wrap.Map.prototype.enableDragAndDrop=function(t){var r=this,a=t||{},n={formatConstructors:[e.format.KML,e.format.GPX,e.format.GML3CRS84,e.format.GML2CRS84,e.format.GML3Patched,e.format.GML2,e.format.GeoJSON,function(){return new e.format.WKT({splitCollection:!0})},e.format.TopoJSON]};n.target=a.dropTarget?TC.getDiv(a.dropTarget):r.parent.div;var o=new e.interaction.DragAndDrop(n);if(o.on(e.interaction.DragAndDrop.EventType_.ADD_FEATURES,function(e){var t=e.features?e.features.map(function(e){return TC.wrap.Feature.createFeature(e)}):[];$.when.apply(this,t).then(function(){var t=r.parent.getLoadingIndicator();if(t&&t.removeWait(r._featureImportWaitId),arguments.length){for(var a=new Array(arguments.length),n=0,o=a.length;o>n;n++)a[n]=arguments[n];r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESIMPORT,{features:a,fileName:e.file.name}))}else r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESIMPORTERROR,{file:e.file}))})}),a.once)o.map_=r.map;else{r.map.addInteraction(o);var i=o.target?o.target:r.map.getViewport(),s=function(e){if(E(e)){var t=r.parent;if(o.target===e.target){var a=t.getLoadingIndicator();a&&(r._featureImportWaitId=a.addWait()),e.stopPropagation()}else e.preventDefault();t._$div.removeClass(TC.Consts.classes.DROP)}};o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DRAGENTER,L,o)),o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DRAGENTER,L,o)),o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DRAGOVER,L,o)),o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DRAGOVER,L,o)),o.dropListenKeys_.push(e.events.listen(i,e.events.EventType.DROP,s,o)),o.dropListenKeys_.push(e.events.listen(document.body,e.events.EventType.DROP,s,o)),o.dropListenKeys_.push(e.events.listen(document.body,"dragleave",R,o)),o.dropListenKeys_.push(e.events.listen(document.body,"dragend",R,o)),
o.dropListenKeys_.push(e.events.listen(document.body,"dragexit",R,o)),document.addEventListener("mouseenter",function(e){e.buttons||r.parent._$div.removeClass(TC.Consts.classes.DROP)},!1),r.ddEnabled=!0}return o},TC.wrap.Map.prototype.loadFiles=function(t){var r,a=this;a.ddEnabled?a.map.getInteractions().forEach(function(t){t instanceof e.interaction.DragAndDrop&&(r=t)}):r=a.enableDragAndDrop({once:!0});var n=a.parent.getLoadingIndicator();n&&(a._featureImportWaitId=n.addWait()),e.interaction.DragAndDrop.handleDrop_.call(r,{dataTransfer:{files:t}})},TC.wrap.Layer.prototype.getVisibility=function(e){var t=this,r=!1;return t.layer&&(r=t.layer.getVisible()),r},TC.wrap.Layer.prototype.setVisibility=function(e){var t=this;$.when(t.getLayer()).then(function(t){t.setVisible(e)})},TC.wrap.Layer.prototype.isNative=function(t){return t instanceof e.layer.Layer},TC.wrap.layer.Raster.prototype.WmsParser=e.format.WMSCapabilities,TC.wrap.layer.Raster.prototype.WmtsParser=e.format.WMTSCapabilities,TC.wrap.Layer.prototype.addCommonEvents=function(e){var t=this;e.on("change:visible",function(){t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERVISIBILITY,{layer:t.parent}))},t.parent.map)},TC.wrap.layer.Raster.prototype.getGetMapUrl=function(){var e=null,t=this;switch(t.getServiceType()){case TC.Consts.layerType.WMS:for(var r=t.parent.capabilities.Capability.Request.GetMap.DCPType,a=0;a<r.length;a++)if(r[a].HTTP&&r[a].HTTP.Get){e=r[a].HTTP.Get.OnlineResource;break}break;case TC.Consts.layerType.WMTS:e=t.parent.capabilities.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href}return e=$("<textarea />").html(e).text()},TC.wrap.layer.Raster.prototype.getInfoFormats=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Capability.Request.GetFeatureInfo&&(e=t.Capability.Request.GetFeatureInfo.Format),e},TC.wrap.layer.Raster.infoFormatPreference=["application/json","application/vnd.ogc.gml/3.1.1","application/vnd.ogc.gml","application/vnd.esri.wms_featureinfo_xml","text/html","text/plain","text/xml"],TC.wrap.layer.Raster.prototype.getWMTSLayer=function(){var e=null,t=this,r=t.parent.capabilities;if(r&&r.Contents)for(var a=0;a<r.Contents.Layer.length;a++)for(var n=r.Contents.Layer[a],o=0;o<n.TileMatrixSetLink.length;o++)if(t.parent.options.matrixSet===n.TileMatrixSetLink[o].TileMatrixSet){e=n;break}return e},TC.wrap.layer.Raster.prototype.getTileMatrix=function(e){var t=null,r=this,a=r.parent.capabilities;if(a&&a.Contents&&a.Contents.TileMatrixSet)for(var n=0;n<a.Contents.TileMatrixSet.length;n++){var o=a.Contents.TileMatrixSet[n];if(o.Identifier===e){t=o.TileMatrix;break}}return t},TC.wrap.layer.Raster.prototype.getScaleDenominators=function(e){var t=[],r=this;if(e.ScaleDenominator?t=[e.ScaleDenominator,e.ScaleDenominator]:(e.MinScaleDenominator||e.MaxScaleDenominator)&&(t=[e.MaxScaleDenominator,e.MinScaleDenominator]),!t.length&&!r.getName(e)){for(var a=r.getLayerNodes(e),n=-(1/0),o=1/0,i=0,s=a.length;s>i;i++){var l=r.getScaleDenominators(a[i]);l[0]>n&&(n=l[0]),l[1]<o&&(o=l[1])}n>-(1/0)&&1/0>o&&(t=[n,o])}return t},TC.wrap.layer.Raster.prototype.getAttribution=function(e){var t=null;return e&&(t=e.ServiceIdentification?e.ServiceIdentification.Title:e.Service.Title),t},TC.wrap.layer.Raster.prototype.getInfo=function(e){var t=this,r={},a=t.parent.capabilities;if(a&&a.Capability)for(var n=t.getAllLayerNodes(),o=0;o<n.length;o++){var i=n[o];if(t.parent.compareNames(t.getName(i),e)){i.Title&&(r.title=i.Title),i.Abstract&&(r["abstract"]=i.Abstract),r.legend=[];var s=function(e){var t=this.getLegend(e);t.src&&r.legend.push({src:t.src,title:e.Title})},l=function(e,r){if(e.Layer&&e.Layer.length>0)for(var a in e.Layer)l(e.Layer[a],r);else r.apply(t,[e])};if(l(i,s),i.MetadataURL&&i.MetadataURL.length){r.metadata=[];for(var p=0;p<i.MetadataURL.length;p++){var c=i.MetadataURL[p];r.metadata.push({format:c.Format,type:c.type,url:c.OnlineResource})}}r.queryable=i.queryable;break}}return r},TC.wrap.layer.Raster.prototype.getServiceType=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Capability.Request&&t.Capability.Request.GetMap?e=TC.Consts.layerType.WMS:t.OperationsMetadata&&t.OperationsMetadata.GetTile&&(e=TC.Consts.layerType.WMTS),e},TC.wrap.layer.Raster.prototype.getServiceTitle=function(){var e=null,t=this.parent.capabilities;return t.Capability&&t.Service?e=t.Service.Title:t.ServiceIdentification&&(e=t.ServiceIdentification.Title),e},TC.wrap.layer.Raster.prototype.getRootLayerNode=function(){var e,t=this;return t.getServiceType()===TC.Consts.layerType.WMS&&(e=t.parent.capabilities.Capability.Layer),e},TC.wrap.layer.Raster.prototype.getName=function(e,t){var r=e.Name;if(r&&t){var a=r.indexOf(":");a>=0&&(r=r.substr(a+1))}return r},TC.wrap.layer.Raster.prototype.getIdentifier=function(e){return e.Identifier},TC.wrap.layer.Raster.prototype.getLayerNodes=function(e){var t=e.Layer;return $.isArray(t)||(t=t?[t]:[]),t},TC.wrap.layer.Raster.prototype.getAllLayerNodes=function(){var e=this;if(!e._layerList)switch(e.getServiceType()){case TC.Consts.layerType.WMS:var t=function a(t){for(var r=[t],n=e.getLayerNodes(t),o=0;o<n.length;o++)r=r.concat(a(n[o]));return r},r=e.getRootLayerNode();e._layerList=r?t(r):[];break;case TC.Consts.layerType.WMTS:e._layerList=e.parent.capabilities.Contents.Layer.slice();break;default:e._layerList=[]}return e._layerList},TC.wrap.layer.Raster.prototype.normalizeLayerNode=function(e){return e},TC.wrap.layer.Raster.prototype.normalizeCapabilities=function(e){return e},TC.wrap.layer.Raster.prototype.getLegend=function(e){var t={},r=e.Style;if(r&&r.length&&r.length&&r[0].LegendURL&&r[0].LegendURL.length){var a=r[0].LegendURL[0];t.src=$("<textarea />").html(a.OnlineResource).text()}return t},TC.wrap.layer.Raster.prototype.isCompatible=function(e){var t=this,r=!0,a=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(a.capabilities&&a.capabilities.Capability&&a.capabilities.Capability.Layer&&a.names.length>0)for(var n=a.names.slice(0),o=function p(r,n,o){var i=!1;if(r)for(var s=0;s<r.length;s++){var l=r[s],c=o||$.inArray(e,l.CRS||l.SRS)>=0;if(a.compareNames(t.getName(l),n)){c&&(i=!0);break}if(p(l.Layer,n,c)){i=!0;break}}return i};n.length>0;)if(!o([a.capabilities.Capability.Layer],n.pop())){r=!1;break}break;case TC.Consts.layerType.WMTS:var i=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$|^"+e+"$","g");if(r=!1,a.capabilities&&a.capabilities.Contents&&a.capabilities.Contents.TileMatrixSet)for(var s=a.capabilities.Contents.TileMatrixSet,l=0;l<s.length;l++)if(s[l].Identifier===a.options.matrixSet){r=i.test(s[l].SupportedCRS);break}}return r},TC.wrap.layer.Raster.prototype.getCompatibleLayers=function(e){var t=this,r=[],a=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(a.capabilities&&a.capabilities.Capability&&a.capabilities.Capability.Layer){var n=function(e,t,a){var o=a||$.inArray(t,e.CRS||e.SRS)>=0;if(o&&e.Name&&(r[r.length]=e.Name),e.Layer)for(var i=0;i<e.Layer.length;i++)n(e.Layer[i],t,o)};n(a.capabilities.Capability.Layer,e)}break;case TC.Consts.layerType.WMTS:var o=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$","g");if(a.capabilities&&a.capabilities.Contents&&a.capabilities.Contents.TileMatrixSet)for(var i=a.capabilities.Contents.TileMatrixSet,s=0;s<i.length;s++)o.test(i[s].SupportedCRS)&&(r[r.length]=i[s].Identifier)}return r},TC.wrap.layer.Raster.prototype.setWMTSUrl=function(){var e=this;$.when(e.getLayer()).then(function(t){e.parent.options=e.parent.options||{};var r=t.getSource().getUrls();e.parent.options.urlPattern=r[r.length-1]})};var M=function(e,t){function r(t){if(200===this.status){var r=URL.createObjectURL(this.response),a=function(t){URL.revokeObjectURL(t.target.src),n.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e}))};o.addEventListener("load",a),o.addEventListener("error",a),o.src=r}else this.status>=400&&this.status<500&&(o.src=TC.Consts.BLANK_IMAGE,n.$events.trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:this.status,text:this.statusText}})))}function a(a){n._proxify=!0;var i=new XMLHttpRequest;i.open("GET",TC.proxify(t)),i.responseType="blob",i.onload=r,i.onerror=function(){o.src=TC.Consts.BLANK_IMAGE,n.$events.trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:this.status,text:this.statusText}}))};try{i.send()}catch(a){o.src=TC.Consts.BLANK_IMAGE,n.$events.trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:this.status,text:this.statusText}}))}}var n=this,o=e.getImage();n.parent.usesSSL?t=t.replace(/^(f|ht)tp?:\/\//i,"https://"):n.parent.usesProxy&&TC.Util.isSecureURL(document.location.href)&&!TC.Util.isSecureURL(t)&&(t=TC.proxify(t)),n.parent.map&&n.parent.map.options.crossOrigin&&TC.Util.detectIE()&&(t=TC.proxify(t));var i=new XMLHttpRequest;i.open("GET",n._proxify?TC.proxify(t):t),i.responseType="blob",i.onload=r,i.onerror=a;try{i.send()}catch(s){a.call(s)}},_=function(e,t){var r=this;r.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e}));for(var a=e.getImage(),n=new XMLHttpRequest,o=t.split("?"),i=o[1].split("&"),s="",l=0;l<i.length;l++){var p=i[l].split("=");p&&p.length>1&&p[1]&&"LAYERS"!==p[0]&&(s+="&"+i[l])}n.open("POST",r._proxify?TC.proxify(o[0]):o[0],!0),n.responseType="blob";var c=function(t){if(200===this.status){var n=URL.createObjectURL(this.response),o=function(t){URL.revokeObjectURL(t.target.src),r.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e}))};a.addEventListener("load",o),a.addEventListener("error",o),a.src=n}else this.status>=400&&this.status<500&&(a.src=TC.Consts.BLANK_IMAGE,r.$events.trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:this.status,text:this.statusText}})))};n.onload=c,n.onerror=function(){r._proxify=!0;var n=new XMLHttpRequest;n.open("POST",TC.proxify(t)),n.responseType="blob",n.onload=c,n.onerror=function(){a.src=TC.Consts.BLANK_IMAGE,r.$events.trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:this.status,text:this.statusText}}))};try{n.send()}catch(o){a.src=TC.Consts.BLANK_IMAGE,r.$events.trigger($.Event(TC.Consts.event.TILELOADERROR,{tile:e,error:{code:this.status,text:this.statusText}}))}},n.send(s)};TC.wrap.layer.Raster.prototype.createWmsLayer=function(t,r,a){var n=this,o=null,i=null,s=a&&a.method&&"POST"===a.method;n.$events=$(n),i=s?$.proxy(_,n):$.proxy(M,n);var l=new e.source.ImageWMS({url:t,crossOrigin:a.map?a.map.options.crossOrigin:void 0,params:r,extent:TC.Cfg.initialExtent,ratio:TC.Cfg.imageRatio,imageLoadFunction:i});l.on(e.source.Image.EventType_.IMAGELOADSTART,function(e){n.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e.image.getImage()}))}),l.on(e.source.Image.EventType_.IMAGELOADEND,function(e){n.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.image.getImage()}))}),l.on(e.source.Image.EventType_.IMAGELOADERROR,function(e){n.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.image.getImage()}))});var p={visible:!!r.LAYERS.length||s,source:l};return a.minResolution&&(p.minResolution=a.minResolution),a.maxResolution&&(p.maxResolution=a.maxResolution),o=new e.layer.Image(p),o._wrap=n,n.addCommonEvents(o),o},TC.wrap.layer.Raster.prototype.createWmtsLayer=function(t,r,a){var n=this,o=null;n.$events=$(n);var i=e.source.WMTS.optionsFromCapabilities(n.parent.capabilities,{layer:r,matrixSet:a.matrixSet,crossOrigin:a.map?a.map.options.crossOrigin:void 0,requestEncoding:a.encoding,format:a.format}),s="https:";location.protocol===s&&(i.urls=i.urls.map(function(e){return e.replace("http:",s)})),i.crossOrigin=a.map?a.map.options.crossOrigin:void 0;var l=new e.source.WMTS(i);l.setTileLoadFunction($.proxy(M,n)),l.on(e.source.TileEventType.TILELOADSTART,function(e){n.$events.trigger($.Event(TC.Consts.event.BEFORETILELOAD,{tile:e.tile.getImage()}))}),l.on(e.source.TileEventType.TILELOADEND,function(e){n.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()}))}),l.on(e.source.TileEventType.TILELOADERROR,function(e){n.$events.trigger($.Event(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()}))});var p={source:l};a.minResolution&&(p.minResolution=a.minResolution),a.maxResolution&&(p.maxResolution=a.maxResolution),o=new e.layer.Tile(p),o._wrap=n;var c=$.proxy(l.getResolutions,l);l.getResolutions=function(){var e=c(),t=o._wrap.parent.getLimitedMatrixSet();if(t&&t.length){var r=t[0].matrixIndex;e=e.slice(r,t.length+r)}return e},n.addCommonEvents(o);var u=l.getResolutions();return o.setMaxResolution(u[0]+1),o.setMinResolution(u[u.length-1]),o},TC.wrap.layer.Raster.prototype.getParams=function(){return this.layer.getSource().getParams()},TC.wrap.layer.Raster.prototype.setParams=function(e){this.layer.getSource().updateParams(e)},TC.wrap.layer.Raster.prototype.getResolutions=function(){if(this.layer.getSource){var e=this.layer.getSource();return e.getResolutions&&e.getResolutions!=goog.abstractMethod?e.getResolutions():[]}return[]},TC.wrap.Geometry={getNearest:function(t,r){var a=new e.geom.LineString(r);return a.getClosestPoint(t)}};var P=function(e,t,r){if(e){var a=function(a){var n=(r&&r._wrap?r._wrap.parent.options.width:null)||t;if(a>n){var o=n/a;e.setScale(o)}},n=e.getSize();if(n)a(n[0]);else{var o=e.getImage();o.naturalWidth?a(o.naturalWidth):$('<img src="'+e.getSrc()+'">').on("load",function(){a(this.naturalWidth)})}}},A=function(e,t){var r=e,a=t&&t.wrap&&t.wrap.feature;if("string"==typeof e){var n=e.match(/^\$\{(.+)\}$/);if(n&&a){for(var o=n[1].split("."),i=a.getProperties(),s=0;s<o.length&&void 0!==i;s++)i=i[o[s]];if(void 0===i){i=t.data;for(var s=0;s<o.length&&void 0!==i;s++)i=i[o[s]]}r=i}}else $.isFunction(e)&&(r=e(t));return r},x=function(e){var t=e.getStyle();return $.isFunction(t)&&(t=t.call(e)),$.isArray(t)&&(t=t[0]),t},I=function(t,r){var a,n={};r&&(a=r._wrap?r._wrap.parent:{id:TC.wrap.Feature.prototype.getId.call({feature:r}),features:r.get("features"),getData:function(){return TC.wrap.Feature.prototype.getData.call({feature:r})}});var o,i=a&&$.isArray(a.features)&&a.features.length>1&&t.cluster;o=i?t.cluster.styles||TC.Cfg.styles.cluster:t.styles||TC.Cfg.styles,o.line&&(n.stroke=new e.style.Stroke({color:A(o.line.strokeColor,a),width:A(o.line.strokeWidth,a),lineDash:o.line.lineDash})),o.polygon&&(n.fill=new e.style.Fill({color:T(A(o.polygon.fillColor,a),A(o.polygon.fillOpacity,a))}),n.stroke=new e.style.Stroke({color:A(o.polygon.strokeColor,a),width:A(o.polygon.strokeWidth,a),lineDash:o.polygon.lineDash}));var s=function(t){var r={text:""+A(t.label,a)};return t.fontSize&&(r.font=A(t.fontSize,a)+"pt sans-serif"),t.angle&&(r.rotation=-Math.PI*A(t.angle,a)/180),t.fontColor&&(r.fill=new e.style.Fill({color:T(A(t.fontColor,a),1)})),t.labelOutlineColor&&(r.stroke=new e.style.Stroke({color:T(A(t.labelOutlineColor,a),1),width:A(t.labelOutlineWidth,a)})),t.labelOffset&&(r.offsetX=t.labelOffset[0],r.offsetY=t.labelOffset[1]),new e.style.Text(r)};if(o.point){var l=o.point,p={radius:A(l.radius,a)||(A(l.height,a)+A(l.width,a))/4};l.fillColor&&(p.fill=new e.style.Fill({color:T(A(l.fillColor,a),A(l.fillOpacity,a))})),l.strokeColor&&(p.stroke=new e.style.Stroke({color:A(l.strokeColor,a),width:A(l.strokeWidth,a),lineDash:l.lineDash})),isNaN(p.radius)||(n.image=new e.style.Circle(p)),l.label&&(n.text=s(l))}if(o.marker){var c=o.marker;c.url&&(n.image=new e.style.Icon({crossOrigin:"anonymous",anchor:c.anchor,src:c.url})),c.label&&(n.text=s(c))}return[new e.style.Style(n)]},O=function(e){var t=e.toString(16);return 1===t.length&&(t="0"+t),t},F=function(e){return"#"+O(e[0])+O(e[1])+O(e[2])},D=function(t){var r={};if($.isArray(t)&&(t=t[0]),!$.isFunction(t)){var a=t.getStroke(),n=e.color.asArray(a.getColor());r.strokeColor=F(n),r.strokeWidth=a.getWidth();var o=t.getFill();n=e.color.asArray(o.getColor()),r.fillColor=F(n),r.fillOpacity=n[3]}return r};TC.wrap.layer.Vector.prototype.getStyle=function(){return D(this.layer.getStyle())},TC.wrap.layer.Vector.prototype.reloadSource=function(){var t=this,r=new $.Deferred,a=t.createVectorSource(t.parent,t.createStyles(t.parent));if(t.parent.type===TC.Consts.layerType.WFS)var n=a.source.on("change",function(t){"ready"==a.source.getState()&&(e.Observable.unByKey(n),r.resolve())});var o=t.layer.getSource().getFeatures();return t.layer.setSource(a.source),a.style&&t.layer.setStyle(a.style),t.parent.type!=TC.Consts.layerType.WFS&&(a.source.addFeatures(o),r.resolve()),r},TC.wrap.layer.Vector.prototype["import"]=function(e){var t=this,r=$.extend({},e);r.type=e.format;var a=t.layer.getSource().getFeatures(),n=t.createVectorSource(r,t.createStyles(t.parent));t.layer.setSource(n.source),n.style&&t.layer.setStyle(n.style),n.source.addFeatures(a)},TC.wrap.layer.Vector.prototype.createVectorSource=function(t,r){var a,n,o=this,i=function(e){var t=e.indexOf("?");switch(t>=0?e=e.substr(0,t):(t=e.indexOf("#"),t>=0&&(e=e.substr(0,t))),e.substr(e.lastIndexOf(".")+1).toLowerCase()){case"kml":return TC.Consts.layerType.KML;case"gpx":return TC.Consts.layerType.GPX;case"json":case"geojson":return TC.Consts.layerType.GEOJSON;default:return TC.Consts.layerType.VECTOR}};if($.isArray(t.url)||t.urls){var s=t.urls||t.url;s=$.map(s,function(e,t){return TC.proxify(e)}),n={url:s,format:new e.format.KML({showPointNames:!1}),projection:t.crs}}else if(t.url&&t.type!==TC.Consts.layerType.WFS)n={url:TC.proxify(t.url),projection:t.crs},n.format=w(i(t.url))||w(t.type);else if(t.data)n={projection:t.crs,loader:function(e,r,a){var n=this.getFormat();try{var i=n.readFeatures(t.data,{featureProjection:a});this.addFeatures(i)}catch(s){o.parent.map&&o.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:o.parent,reason:s.message}))}}},n.format=w(t.format)||w(t.type);else if(t.type==TC.Consts.layerType.WFS){var l,p;switch(t.outputFormat){case TC.Consts.format.JSON:l=new e.format.GeoJSON({geometryName:t.geometryName}),p="json";break;case TC.Consts.format.GML3:l=new e.format.GML3Patched,p=TC.Consts.mimeType.GML;break;default:l=new e.format.GML2,p=TC.Consts.mimeType.GML}n={format:l,loader:function(e,r,a){var n=this,i=t.url;if(i){o.parent.state=TC.Layer.state.LOADING,o.parent.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:o.parent}));var s={},c=a.getCode(),u=t.version||"1.1.0",g=i,f=$.isArray(t.featureType)?t.featureType:[t.featureType];if(!t.properties||t.properties instanceof Array&&!t.properties.length||!Object.keys(t.properties).length)g=g+"?service=WFS&version="+u+"&request=GetFeature&typename="+f.join(",")+"&outputFormat="+p+"&srsname="+c,e[0]!==-(1/0)&&e[1]!==-(1/0)&&e[2]!==1/0&&e[3]!==1/0&&(g=g+"&bbox="+e.join(",")+","+c),t.maxFeatures&&(g=g+"maxFeatures="+t.maxFeatures);else{s.type="POST",s.contentType=TC.Consts.mimeType.XML,s.processData=!1;var m=[];m[m.length]='<wfs:GetFeature xmlns:wfs="http://www.opengis.net/wfs" service="WFS" version="',m[m.length]=u,m[m.length]='" outputFormat="',m[m.length]=t.outputFormat,t.maxFeatures&&(m[m.length]='" maxFeatures="',m[m.length]=t.maxFeatures),m[m.length]='" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/',m[m.length]=u,m[m.length]='/wfs.xsd">';for(var d=0;d<f.length;d++)m[m.length]='<wfs:Query typeName="feature:',m[m.length]=f[d],m[m.length]='" srsName="',m[m.length]=c,m[m.length]='">',m[m.length]=t.properties.getText(),m[m.length]="</wfs:Query>";m[m.length]="</wfs:GetFeature>",s.data=m.join("")}s.url=g,o._requestUrl=g,$.ajax(s).done(function(e){n.addFeatures(l.readFeatures(e)),o.parent.state=TC.Layer.state.IDLE,o.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:o.parent,newData:e}))})}},projection:t.crs}}a=new e.source.Vector(n),a._tcLayer=o.parent;var c=t.style&&t.style.marker?t.style.marker:TC.Cfg.styles.marker;if(t.style&&t.style.marker||(c=$.extend({},c,{anchor:TC.Cfg.styles.point.anchor})),t.cluster&&(a=new e.source.Cluster({projection:t.crs,distance:t.cluster.distance,source:a}),t.cluster.animation)){var u=function(e,t,r,a){var n=Math.min((Date.now()-a)/r,1),o=(t[0]-e[0])*n,i=(t[1]-e[1])*n;return[e[0]+o,e[1]+i]},g=function(t,r){var a=Date.now(),n=t.getGeometry().getCoordinates(),o=r.getGeometry().getCoordinates();r.setGeometry(new e.geom.Point(n));var i=function s(){var i=u(n,o,TC.Consts.CLUSTER_ANIMATION_DURATION,a);r.setGeometry(new e.geom.Point(i)),i[0]!==o[0]&&i[1]!==o[1]?requestAnimationFrame(s):f.splice($.inArray(t,f),1)};requestAnimationFrame(i)},f=[];a.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(e){var t=e.feature.get("features");t&&t.length>1&&f.push(e.feature)}),a.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){var t=e.feature.get("features");if(t){var r=t[0].getGeometry().getCoordinates();if(t.length>1){var a=$.grep(f,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});a.length&&f.splice($.inArray(a[0],f),1)}var n=$.grep(f,function(e){var t=e.get("features");if(t&&t.length>0){var a=$.grep(t,function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});return a.length>0}});n.length&&g(n[n.length-1],e.feature)}})}var m=a;do m.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){var t=e.feature,r=x(t);r&&P(r.getImage(),c.width,t)}),m=$.isFunction(m.getSource)?m.getSource():null;while(m);var d=function(t){var r=null,a=x(t);if(a){var n=a.getImage();n instanceof e.style.Icon&&(r=n.getSrc())}return r};a.addEventListener(e.source.VectorEventType.ADDFEATURE,function(t){var r=t.feature;if(!r._wrap){r._wrapDeferred=$.Deferred();var a,n=r.getGeometry();n instanceof e.geom.Point?a=d(r)?o.parent.addMarker(r):o.parent.addPoint(r):n instanceof e.geom.LineString?a=o.parent.addPolyline(r):n instanceof e.geom.Polygon?a=o.parent.addPolygon(r):n instanceof e.geom.MultiLineString?a=o.parent.addMultiPolyline(r):n instanceof e.geom.MultiPolygon&&(a=o.parent.addMultiPolygon(r));var i;$.when(a).then(function(e){r._wrapDeferred.resolve(r._wrap);var t=r.get("features");$.isArray(t)&&(e.features=$.map(t,function(t){return new e.constructor(t)})),clearTimeout(i),i=setTimeout(function(){o.parent.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:o.parent,features:[e]}))},50)})}}),a.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(e){var t=e.feature;if(t._wrap){var r=$.inArray(t._wrap.parent,o.parent.features);r>-1&&(o.parent.features.splice(r,1),o.parent.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:o.parent,feature:t._wrap.parent})))}}),a.addEventListener(e.source.VectorEventType.ADDFEATURE,function(e){o.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:o.parent}))}),a.addEventListener(e.source.VectorEventType.REMOVEFEATURE,function(){o.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:o.parent}))}),a.addEventListener(e.source.VectorEventType.CLEAR,function(){o.parent.map.$events.trigger($.Event(TC.Consts.event.FEATURESCLEAR,{layer:o.parent}))});var v={source:a};return n&&n.format instanceof e.format.KML||(v.style=r||t.styles),v},TC.wrap.layer.Vector.prototype.createStyles=function(e){var t=this,r=!1;if($.isFunction(e))r=!0,t.styleFunction=function(t){return I(e(t))};else{e=$.extend({},e),e.crs=e.crs||TC.Cfg.crs,e.styles=e.styles||TC.Cfg.styles;var a=function o(e){for(var t in e){var r=e[t];switch(typeof r){case"string":if(/^\$\{(.+)\}$/.test(r))return!0;break;case"object":if(o(r))return!0;break;case"function":return!0}}return!1};r=!(!e.cluster||!e.cluster.styles)||a(e.styles),t.styleFunction=function(e){return I(t.parent.options,e)}}var n=r?t.styleFunction:t.styleFunction();return n},TC.wrap.layer.Vector.prototype.createVectorLayer=function(){var t=this,r=null;t.$events=$(t);var a=t.parent.options,n=t.createVectorSource(a,t.createStyles(a));return r=new e.layer.Vector(n),r._wrap=t,t.addCommonEvents(r),r},TC.wrap.layer.Vector.prototype.addFeatures=function(e){$.when(this.getLayer()).then(function(t){for(var r=t;$.isFunction(r.getSource);)r=r.getSource();r.addFeatures(e)})},TC.wrap.layer.Vector.prototype.getFeatures=function(){var t=this.getLayer();return t instanceof e.layer.Layer?t.getSource().getFeatures():[]},TC.wrap.layer.Vector.prototype.getFeatureById=function(t){var r=this.getLayer();return r instanceof e.layer.Layer?r.getSource().getFeatureById(t):null},TC.wrap.layer.Vector.prototype.removeFeature=function(e){$.when(this.getLayer()).then(function(t){var r=t.getSource();r.removeFeature(e.wrap.feature)})},TC.wrap.layer.Vector.prototype.clearFeatures=function(){$.when(this.getLayer()).then(function(e){var t=e.getSource();t.clearFeatures?t.clearFeatures():t.clear()})},TC.wrap.layer.Vector.prototype.setFeatureVisibility=function(t,r){var a=this,n={color:"rgba(0, 0, 0, 0)"},o={color:"rgba(0, 0, 0, 0)"},i=new e.style.Style({image:new e.style.Circle({radius:0,fill:new e.style.Fill(n),stroke:new e.style.Stroke(o)}),fill:new e.style.Fill(n),stroke:new e.style.Stroke(o)}),s=$.inArray(t,a.parent.features);if(s>=0){var l=t.wrap.feature;r&&l._originalStyle?l.setStyle(l._originalStyle):(l._originalStyle=l.getStyle(),l.setStyle(i)),$.when(a.getLayer()).then(function(e){a.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:a.parent}))})}},TC.wrap.layer.Vector.prototype.getRGBA=function(e,t){return T(e,t)},TC.wrap.layer.Vector.prototype.findFeature=function(e){},TC.wrap.layer.Vector.prototype.getGetFeatureUrl=function(){return this._requestUrl},TC.wrap.layer.Vector.prototype.getDescribeFeatureTypeUrl=function(){var e=this,t=e.parent,r=t.options.version||"1.1.0",a=t.url,n=$.isArray(t.options.featureType)?t.options.featureType:[t.options.featureType];return a=a+"?service=WFS&version="+r+"&request=DescribeFeatureType&typename="+n.join(",")+"&outputFormat=XMLSCHEMA"},TC.wrap.layer.Vector.prototype.sendTransaction=function(t,r,a){var n=this,o=$.Deferred(),i=function(e){return e.wrap.feature},s=$.map(t,i),l=$.map(r,i),p=$.map(a,i);return t.length||r.length||a.length?$.when(n.getLayer()).then(function(t){var r=(t.getSource(),new e.format.WFS),a=n.parent.options,i=r.writeTransaction(s,l,p,{featurePrefix:a.featurePrefix,featureNS:a.featureNS,featureType:a.featureType[0]}),c={url:n.parent.url,type:"POST",contentType:TC.Consts.mimeType.XML,processData:!1,data:i.outerHTML};$.ajax(c).done(function(e){var t=e.getElementsByTagName("ExceptionReport")[0],a={reason:""};if(t){var n=t.getElementsByTagName("Exception")[0];if(n){a.code=n.getAttribute("exceptionCode");for(var i=n.getElementsByTagName("ExceptionText"),s=0,l=i.length;l>s;s++)a.reason+="\n"+i[s].innerHTML}o.reject(a)}else{var p=r.readTransactionResponse(e);o.resolve(p)}}).fail(function(){o.reject({code:"",reason:"unknown"})})}):o.resolve(n.parent),o},TC.wrap.layer.Vector.prototype.setDraggable=function(t,r,a){var n=this;$.when(n.parent.map.wrap.getMap(),n.getLayer()).then(function(o,i){if(t){var s={layers:[i],features:new e.Collection(i.getSource().getFeatures())};n.interaction=new e.interaction.Translate(s),$.isFunction(r)&&n.interaction.on(e.interaction.TranslateEventType.TRANSLATEEND,function(e){e.features.getLength()&&r(e.features.item(0)._wrap.parent)}),$.isFunction(a)&&n.interaction.on(e.interaction.TranslateEventType.TRANSLATESTART,function(e){e.features.getLength()&&a(e.features.item(0)._wrap.parent)}),o.addInteraction(n.interaction)}else n.interaction&&o.removeInteraction(n.interaction)})},TC.wrap.control.Click.prototype.register=function(e){var t=this;t._trigger=function(r){var a=0;return e.wrap.map.forEachFeatureAtPixel(r.pixel,function(e,t){e._wrap&&e._wrap.parent.showsPopup&&a++}),a||(t.parent.map.$events.trigger($.Event(TC.Consts.event.CLICK,{coordinate:r.coordinate,pixel:r.pixel})),t.parent.callback(r.coordinate,r.pixel)),0===a}},TC.wrap.control.Click.prototype.activate=function(){var t=this;$.when(t.parent.map.wrap.getMap()).then(function(r){r.on(e.MapBrowserEventType.SINGLECLICK,t._trigger)})},TC.wrap.control.Click.prototype.deactivate=function(){var t=this;$.when(t.parent.map.wrap.getMap()).then(function(r){r.un(e.MapBrowserEventType.SINGLECLICK,t._trigger)})},TC.wrap.control.ScaleBar.prototype.render=function(){var t=this;t.ctl?t.ctl.updateElement_():t.ctl=new e.control.ScaleLine({target:t.parent.div})},TC.wrap.control.ScaleBar.prototype.getText=function(){var e=this;return e.ctl?e.ctl.renderedHTML_:void 0},TC.wrap.control.NavBar.prototype.register=function(t){var r=this;$.when(t.wrap.getMap()).then(function(a){var n=r.parent.div;r.zCtl=new e.control.Zoom({target:n}),r.zsCtl=new e.control.ZoomSlider({target:n,render:function(t){if(!t.frameState||!t.frameState.viewState||a.getView().getMinResolution()<=t.frameState.viewState.resolution){var n=function(){this.element.offsetWidth>this.element.offsetHeight?(r.requestSliderSize||(r.requestSliderSize=window.requestAnimationFrame(n.bind(this))),window.requestAnimationFrame(n.bind(this))):this.element.offsetWidth<this.element.offsetHeight&&(r.requestSliderSize&&(window.cancelAnimationFrame(r.requestSliderSize),delete r.requestSliderSize),e.control.ZoomSlider.render.call(this,t))};n.call(this)}}}),r.z2eCtl=new e.control.ZoomToExtent({target:n,extent:t.options.initialExtent,tipLabel:""}),a.addControl(r.zCtl),a.addControl(r.zsCtl),a.addControl(r.z2eCtl);var o=r.parent._$div;$buttons=o.find("button").addClass("tc-ctl-btn "+r.parent.CLASS+"-btn").css("display","block").html(""),$buttons.filter(".ol-zoom-in").addClass(r.parent.CLASS+"-btn-zoomin").attr("title",r.parent.getLocaleString("zoomIn")),$buttons.filter(".ol-zoom-out").addClass(r.parent.CLASS+"-btn-zoomout").attr("title",r.parent.getLocaleString("zoomOut")),o.find(".ol-zoom-extent button").addClass(r.parent.CLASS+"-btn-home").attr("title",r.parent.getLocaleString("zoomToInitialExtent")),$(t.div).find(".ol-zoomslider").addClass(r.parent.CLASS+"-bar").find(".ol-zoomslider-thumb").addClass(r.parent.CLASS+"-slider"),t.on(TC.Consts.event.BASELAYERCHANGE,$.proxy(r.refresh,r))})},TC.wrap.control.NavBar.prototype.refresh=function(){var t=this,r=t.parent.map.wrap.map;if(t.zsCtl.sliderInitialized_){var a=r.getView().getResolution();t.zsCtl.setThumbPosition_(a)}else r.once(e.MapEventType.POSTRENDER,function(e){t.zsCtl.render(e)})},TC.wrap.control.Coordinates.prototype.register=function(t){var r=this,a=new $.Deferred;return r.map=t,r._cleanCoordsTrigger=function(e){var t=r.map.getControlsByClass(TC.control.Popup)[0];e.toElement&&$(e.toElement).attr("class")&&t&&$(e.toElement).attr("class").indexOf(t.CLASS)>-1?r.parent.coordsToClick({coordinate:[(r.map.getExtent()[0]+r.map.getExtent()[2])/2,(r.map.getExtent()[1]+r.map.getExtent()[3])/2]}):r.parent.cleanCoordsPointer(e)},r._coordsTrigger=function(e){r.parent.coordsToClick(e)},$.when(t.wrap.getMap()).then(function(t){r.olMap=t;var i=t.getView().getProjection();r.parent.crs=i.getCode(),r.parent.units=i.getUnits(),r.parent.isGeo=r.parent.units===e.proj.Units.DEGREES;var s=t.getViewport();$(s).add(r.parent.div).on(n+".coords",function(e){var a=t.getEventCoordinate(e);a&&(r.parent.isGeo?r.parent.latLon=a.reverse():r.parent.xy=a,r.parent.update.apply(r.parent,arguments))}).on(o,function(e){r.parent.clear.apply(r.parent,arguments)}),a.resolve()}),a},TC.wrap.control.Geolocation.prototype.register=function(e){var t=this;t.map=e,t._snapTrigger=function(e){e.dragging||t.initSnap(t.olMap.getEventCoordinate(e.originalEvent))},t._postcomposeTrigger=function(e){t.duringTrackSnap(e)},$.when(e.wrap.getMap()).then(function(e){t.olMap=e})},TC.wrap.control.Geolocation.prototype.hasCoordinates=function(){var e=this;return e.trackData&&e.trackData.trackFeature&&e.trackData.trackFeature.getGeometry().getCoordinates().length>=1};var N=function(e,t){var r=t-e,a={s:Math.floor(r/1e3%60),m:Math.floor(r/6e4%60),h:Math.floor(r/36e5%24)};return $.extend({},a,{toString:("00000"+a.h).slice(-2)+":"+("00000"+a.m).slice(-2)+":"+("00000"+a.s).slice(-2)})};TC.wrap.control.Geolocation.prototype.getTooltip=function(t){var r=this;r.parent.elevationMarker||(r.parent.elevationMarker=new e.Overlay({element:r.parent.track.htmlElevationMarker,offset:[0,-11],positioning:e.OverlayPositioning.CENTER_CENTER,stopEvent:!1})),r.parent.layerTrack.getVisibility()&&r.parent.layerTrack.getOpacity()>0&&($(r.parent.track.htmlElevationMarker).show(),
r.olMap.addOverlay(r.parent.elevationMarker),r.parent.elevationMarker.setPosition(r.parent.chart.coordinates[t[0].index]));var a=r.map.getExtent(),n=r.parent.chart.coordinates[t[0].index];a[0]<=n[0]&&n[0]<=a[2]&&a[1]<=n[1]&&n[1]<=a[3]||TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Point,[TC.apiLocation+"TC/feature/Point"],function(){r.map.setCenter(n.slice(0,2),{animate:!0})});var o=t[0].x;o/=1e3;var i;4==r.parent.chart.coordinates[0].length&&r.parent.chart.coordinates[0][3]>0&&(i=N(r.parent.chart.coordinates[0][3],n[3]));var s,l,p=r.parent.map.options.locale&&r.parent.map.options.locale.replace("_","-")||void 0,c=parseInt(t[0].value.toFixed(0)).toLocaleString(p);return 1>o?(s=Math.round(1e3*o),l=" m"):(s=Math.round(100*o)/100,l=" km"),s=s.toLocaleString(p),'<div class="track-elevation-tooltip"><div><span>'+c+" m </span><br><span>"+s+l+" </span></div>"+(i?"<span>"+i.toString+"</span><div/>":"")},TC.wrap.control.Geolocation.prototype.addWaypoint=function(t,r){var a=this,n=new e.Feature({geometry:new e.geom.Point([t[0],t[1],r.ele,r.time],"XYZM")});n.setProperties(r),a.parent.layerTracking.wrap.layer.getSource().addFeature(n)};var G=!0,b=function(t,r){var a=t.getGeometry(),n=a.getType().toLowerCase(),o=!G,i=[];return i.push(new e.style.Style({stroke:new e.style.Stroke({width:2,color:"rgba(0,206,209, "+(o&&t.get("tracking")?0:1)+")",lineDash:[.1,6]})})),"point"!=n||o||i.push(new e.style.Style({image:new e.style.Circle({radius:3,fill:new e.style.Fill({color:"rgba(0,206,209, "+(o&&t.get("tracking")?0:.5)+")"}),stroke:new e.style.Stroke({color:"rgba(255, 255, 255, "+(o&&t.get("tracking")?0:1)+")",width:1})}),text:new e.style.Text({textAlign:"center",textBaseline:"middle",font:"bold 14px Arial",text:o&&t.get("tracking")?"":t.get("name"),fill:new e.style.Fill({color:"rgba(0,206,209, "+(o&&t.get("tracking")?0:1)+")"}),stroke:new e.style.Stroke({color:"rgba(255, 255, 255, "+(o&&t.get("tracking")?0:1)+")",width:parseInt(3,10)}),offsetX:parseInt(0,10),offsetY:parseInt(0,10)})})),i};TC.wrap.control.Geolocation.prototype.setTrackOnMapVisibility=function(e){var t=this;G=e,t.parent.layerTracking.wrap.layer.setStyle(b)},TC.wrap.control.Geolocation.prototype.addPosition=function(e,t,r,a,n,o,i){var s=this,l=Math.round(e[0]),p=Math.round(e[1]);if(s.trackData&&s.trackData.trackFeature){var c=s.trackData.trackFeature.getGeometry().getLastCoordinate();if(c&&0==c.length)s.trackData.trackFeature.getGeometry().appendCoordinate([l,p,t,r]);else{var u=Math.round(c[0]),g=Math.round(c[1]);(l!=u||p!=g)&&s.trackData.trackFeature.getGeometry().appendCoordinate([l,p,t,r])}}s.parent.$events.trigger($.Event(s.parent.Const.Event.STATEUPDATED,{moving:void 0!=t&&void 0!=a&&a>0&&t>0}))},TC.wrap.control.Geolocation.prototype.positionChangehandler=function(e){var t,r,a,n,o,i=this,s=$.Deferred();if(e&&e.coords)if(i.parent.layerGPS.clearFeatures(),t=e.coords.accuracy||0,r=e.coords.heading||e[2]||0,a=e.coords.speed?3.6*e.coords.speed:0,n=e.coords.altitude||0,o=e.coords.altitudeAccuracy||0,i.trackData&&i.trackData.trackFeature){var l=[e.coords&&e.coords.longitude||e[0],e.coords&&e.coords.latitude||e[1]],p=TC.Util.reproject(l,"EPSG:4326",i.parent.map.crs);i.addPosition(p,r,(new Date).getTime(),a,t,o,n);var c=i.trackData.trackFeature.getGeometry().getCoordinates(),u=c.length;u>=2&&(i.parent.deltaMean=(c[u-1][3]-c[0][3])/(u-1)),i.parent.$events.trigger($.Event(i.parent.Const.Event.POSITIONCHANGE,{pd:{position:[p[0],p[1]],altitude:n,accuracy:t,heading:TC.Util.radToDeg(r),speed:a}})),$.when(i.parent.layerGPS.addPoint(p,{radius:4,fillColor:"#00CED1",fillOpacity:1,strokeColor:"#ffffff",strokeWidth:2,showsPopup:!1}),i.parent.layerGPS.addCircle([p,t],{strokeColor:"#00CED1",strokeWidth:.4,fillColor:"#ffffff",fillOpacity:.2,showsPopup:!1})).done(function(e,t){i.parent.geopositionTracking=!0,0==i.parent.firstPosition&&(i.parent.firstPosition=!0,i.parent.$centerDiv?i.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!1):(i.parent.$centerDiv=i.parent._$div.find("."+i.parent.CLASS+"-track-center"),i.parent.$button=i.parent._$div.find("."+i.parent.CLASS+"-track-center button"),i.parent.$button.on("click",function(){i.parent.layerGPS.map.zoomToFeatures(i.parent.layerGPS.features),i.parent.track.$info.find(".prsidebar-body").fadeIn("slide"),i.parent.track.$info.find(".prcollapsed").hide()}),i.parent.$centerDiv.appendTo(i.parent.map._$div),i.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!1)),i.parent.layerGPS.map.zoomToFeatures(i.parent.layerGPS.features)),s.resolve({marker:e,accuracy:t})})}else s.resolve(null);else s.resolve(null);return s.promise()},TC.wrap.control.Geolocation.prototype.setTracking=function(t){function r(){var e=p++;navigator.geolocation.getCurrentPosition(function(e){clearInterval(l),a.parent.getLoadingIndicator().removeWait(a.parent.currentPositionWaiting),a.positionChangehandler(e).then(function(e){1==a.parent.geopositionTracking&&e&&e.marker&&e.accuracy&&(a.currentPositionTrk=navigator.geolocation.watchPosition(a.positionChangehandler.bind(a),a.parent.onGeolocateError.bind(a.parent),c))})},function(e){switch(e.code){case e.TIMEOUT:r();break;default:clearInterval(l),a.parent.onGeolocateError.call(a.parent,e)}},{timeout:5e3+e,maximumAge:10,enableHighAccuracy:!0})}var a=this;if(t){a.parent.firstPosition=!1,a.trackData={};var n=[];if(a.parent.sessionTracking)for(var o=(new e.format.GeoJSON).readFeatures(a.parent.sessionTracking),i=0;i<o.length;i++){var s=o[i].getGeometry().getType().toLowerCase();"point"==s?n.push(o[i]):"linestring"==s&&(a.trackData.trackFeature=o[i],a.trackData.trackFeature.setProperties({tracking:!0}))}else a.trackData.trackFeature=new e.Feature({geometry:new e.geom.LineString([],"XYZM"),tracking:!0});a.parent.layerTracking.wrap.layer.setSource(new e.source.Vector({features:[a.trackData.trackFeature]})),n.length>0&&a.parent.layerTracking.wrap.addFeatures(n),a.parent.layerTracking.wrap.layer.setStyle(b),a.trackData.trackFeature.getGeometry().getCoordinates().length>1&&a.parent.map.setExtent(a.parent.layerTracking.wrap.layer.getSource().getExtent()),a.parent.currentPositionWaiting=a.parent.getLoadingIndicator().addWait();var l,p=0,c={enableHighAccuracy:!0,timeout:6e5};l=setInterval(r,1e3),setTimeout(function(){a.trackData&&0==a.trackData.trackFeature.getGeometry().getLastCoordinate().length&&(clearInterval(l),a.parent.getLoadingIndicator().removeWait(a.parent.currentPositionWaiting),a.map.toast(a.parent.getLocaleString("geo.error.permission_denied"),{type:TC.Consts.msgType.WARNING}),a.parent.track.$activateButton.toggleClass(TC.Consts.classes.HIDDEN,!1),a.parent.track.$deactivateButton.toggleClass(TC.Consts.classes.HIDDEN,!0))},c.timeout+1e3)}else G=!0,a.parent.firstPosition=!1,window.navigator.geolocation.clearWatch(a.currentPositionTrk),delete a.trackData,a.parent.$centerDiv&&a.parent.$centerDiv.toggleClass(TC.Consts.classes.HIDDEN,!0)},TC.wrap.control.Geolocation.prototype.activateSnapping=function(){var t=this;G=!0,TC.Util.detectMobile()||(t.olMap.on([e.MapBrowserEventType.POINTERMOVE,e.MapBrowserEventType.SINGLECLICK],t._snapTrigger),t.olMap.on(e.render.EventType.POSTCOMPOSE,t._postcomposeTrigger))},TC.wrap.control.Geolocation.prototype.deactivateSnapping=function(){var t=this;$.when(t.parent.map.wrap.getMap()).then(function(r){TC.Util.detectMobile()||(r.un([e.MapBrowserEventType.POINTERMOVE,e.MapBrowserEventType.SINGLECLICK],t._snapTrigger),r.un(e.render.EventType.POSTCOMPOSE,t._postcomposeTrigger)),t.snapInfo&&r.removeOverlay(t.snapInfo),t.snapInfoElement&&(t.snapInfoElement.style.display="none"),t.snapLine&&(delete t.snapLine,r.render())})},TC.wrap.control.Geolocation.prototype.clear=function(t){var r=this;t&&t.wrap.layer&&(t.wrap.layer.getSource().clear(),t.wrap.layer.setSource(new e.source.Vector)),attachedDTD=!1,r.deactivateSnapping.call(r)};var k;TC.wrap.control.Geolocation.prototype.duringTrackSnap=function(t){var r=this,a=k=t.vectorContext;a&&r.snapLine&&("function"==typeof a.setFillStrokeStyle&&a.setFillStrokeStyle(null,new e.style.Stroke({color:"rgba(197, 39, 55, 1)",width:1})),"function"==typeof a.drawGeometry&&a.drawGeometry(r.snapLine.wrap.feature.getGeometry()))},TC.wrap.control.Geolocation.prototype.initSnap=function(t){var r=this;if(r.parent.layerTrack){var a=r.parent.layerTrack.wrap.layer.getSource(),n=a.getClosestFeatureToCoordinate(t);if(null!==n){var o=n.getGeometry(),i=o.getClosestPoint(t),s=[t,[i[0],i[1]]];r.snapLine?r.snapLine.wrap.feature.getGeometry().setCoordinates(s):r.snapLine=new TC.feature.Polyline(s),r.snapInfoElement||(r.snapInfoElement=document.getElementsByClassName("tc-ctl-geolocation-track-snap-info")[0]),r.snapInfoElement.style.display="block",r.snapInfo||(r.snapInfo=new e.Overlay({element:r.snapInfoElement,offset:[5,18]}),r.olMap.addOverlay(r.snapInfo)),void 0==r.snapInfo.getMap()&&r.snapInfo.setMap(r.olMap),r.snapInfo.setPosition(t);var l={};"LineString"!=n.getGeometry().getType()&&n.getKeys().indexOf("name")>-1&&(l.n=n.get("name"));var p=r.parent.map.options.locale&&r.parent.map.options.locale.replace("_","-")||void 0;l.x=Math.round(i[0]).toLocaleString(p),l.y=Math.round(i[1]).toLocaleString(p),l.z=i.length>=3?(Math.round(100*i[2])/100).toLocaleString(p):void 0,l.m=4==i.length&&i[3]>0?new Date(i[3]).toLocaleString(p):void 0,l&&r.parent.getRenderedHtml(r.parent.CLASS+"-track-snapping-node",l,function(e){r.snapInfoElement.innerHTML=e})}r.olMap.render()}},TC.wrap.control.Geolocation.prototype.drawTrackingData=function(e){var t=this,r=$.Deferred(),a=[],n=new TC.wrap.parser.JSON,o=n.parser.readFeatures(e);t.activateSnapping.call(t);for(var i=0,s=o.length;s>i;i++)a.push(TC.wrap.Feature.createFeature(o[i]));return $.when.apply($,a).then(function(){for(var e=0;e<arguments.length;e++){var a=arguments[e];a&&t.parent.layerTrack.addFeature(a)}t.parent.map.zoomToFeatures(t.parent.layerTrack.features),r.resolve()}),r.promise()},TC.wrap.control.Geolocation.prototype.formattedToStorage=function(e,t){var r=new TC.wrap.parser.JSON;r=r.parser;var a=e.wrap.layer.getSource().getFeatures();if(t)for(var n=0;n<a.length;n++)a[n].get("tracking")&&a[n].set("tracking",!1);return r.writeFeatures(a)},TC.wrap.control.Geolocation.prototype["export"]=function(t,r){var a=this,n=new $.Deferred,o=[];return a.parent.getTrackingData(r).then(function(i){if(i){var s=new e.source.Vector({features:(new e.format.GeoJSON).readFeatures(i)});if(s.getFeatures().length>0)s.forEachFeature(function(t){var r=t.clone();if(r.getGeometry().transform(a.parent.map.crs,"EPSG:4326"),"linestring"==r.getGeometry().getType().toLowerCase()){var n=new e.geom.MultiLineString([],r.getGeometry().getLayout());n.appendLineString(r.getGeometry()),o.push(new e.Feature({geometry:n}))}else o.push(r)});else{var l=a.parent.getTrackingData(r),p=new e.source.Vector({features:(new e.format.GeoJSON).readFeatures(l)});p.forEachFeature(function(t){var r=t.clone();if(r.getGeometry().transform(a.parent.map.crs,"EPSG:4326"),"linestring"==r.getGeometry().getType().toLowerCase()){var n=new e.geom.MultiLineString([],r.getGeometry().getLayout());n.appendLineString(r.getGeometry()),o.push(new e.Feature({geometry:n}))}else o.push(r)})}}switch(t){case"GPX":n.resolve(o?(new e.format.GPX).writeFeatures(o):null);break;case"KML":n.resolve(o?(new e.format.KML).writeFeatures(o):null)}}),n};var U=function(e){var t=[],r=[];if(e.length>1){4==e[0].length&&(e=e.sort(function(e,t){return e[0][3]==t[0][3]?0:e[0][3]<t[0][3]?-1:1}));for(var a=0;a<e.length;a++){for(var n=e[a],o=-1,i=1/0,s=n.getLastCoordinate(),l=a+1;l<e.length;l++){var p=e[l].getFirstCoordinate(),c=Math.hypot(s[0]-p[0],s[1]-p[1]);i>c&&(o=l,i=c)}t.length<e.length&&(-1==t.indexOf(a)&&(t.push(a),r=r.concat(n.getCoordinates())),-1==t.indexOf(o)&&(t.push(o),r=r.concat(e[o].getCoordinates())))}return r}return e[0].getCoordinates()};TC.wrap.control.Geolocation.prototype.processImportedFeatures=function(t){for(var r=this,a=r.parent.layerTrack.wrap.layer.getSource(),n=r.parent.importedFileName,o=[],i=[],s=[],l=[],p=a.getFeatures(),c=[],u=[],g=0;g<p.length;g++){var f=p[g];if(f instanceof TC.Feature&&(f=p[g].wrap.feature),f.getGeometry()instanceof e.geom.Point)u.push(f.getGeometry().getCoordinates()),l.push(f);else if(f.getGeometry()instanceof e.geom.LineString)c.push(f.getGeometry()),s.push(f);else if(f.getGeometry()instanceof e.geom.MultiLineString){var m=f.clone();o.push(m.getProperties().hasOwnProperty("name")?m.getProperties().name.trim().length>0?m.getProperties().name:n:n);var d=m.getGeometry().getLineStrings(),v=U(d);i.push(new e.Feature({geometry:new e.geom.LineString(v)})),s.push(f)}}if(c.length>0){var v=U(c);i.push(new e.Feature({geometry:new e.geom.LineString(v)}))}if(u.length>0&&l.length==p.length&&i.push(new e.Feature({geometry:new e.geom.LineString(u)})),s.length>0)for(var y=0;y<s.length;y++)a.removeFeature(s[y]);if(i.length>0){var C,h=function(e,t){for(var r=[],a=e.indexOf(t);-1!=a;)if(r.push(a),a=e.indexOf(t,a+1),r.length>1)return!0;return r.length>1?!0:!1},T=(new $.Deferred,0),S=function(){var e=[];return $.each(i,function(t){var s=new $.Deferred;C&&a.removeFeature(C);var l;if(o.length>t){var l=o[t];h(o,l)&&(l="["+(t+1)+"] "+l)}r.parent.importedFileName=l?l:n,C=i[t],a.addFeature(C),r.parent.saveTrack(r.parent.getLocaleString("geo.trk.upload.ok",{trackName:r.parent.importedFileName})).then(function(e){0==t&&(T=e),s.resolve()}),e.push(s)}),$.when.apply(void 0,e).promise()};S().then(function(){r.parent.$events.trigger(r.parent.Const.Event.IMPORTEDTRACK,T),delete r.parent.importedFileName;var e=r.parent.layerTrack.features;if(e&&e.length>0)for(var n=0;n<e.length;n++)e[n].showsPopup=!1;r.parent.map.setExtent(a.getExtent()),r.parent.getLoadingIndicator().removeWait(t)})}else r.parent.layerTrack&&(r.parent.map.removeLayer(r.parent.layerTrack),r.parent.layerTrack=void 0),delete r.parent.importedFileName,r.parent.getLoadingIndicator().removeWait(t),TC.alert(r.parent.getLocaleString("geo.trk.upload.error4"))},TC.wrap.control.Geolocation.prototype["import"]=function(t,r,a){var n,o,i=this;if(r&&r.text){var s=i.parent.layerTrack.wrap.createVectorSource({data:r.text,type:a});n=s.source,o=n.on("change",function(r){"ready"==n.getState()&&(e.Observable.unByKey(o),i.processImportedFeatures(t))});var l=i.parent.layerTrack.wrap.layer;l.setSource(n)}else i.parent.layerTrack&&(i.parent.map.removeLayer(i.parent.layerTrack),i.parent.layerTrack=void 0),delete i.parent.importedFileName,i.parent.getLoadingIndicator().removeWait(t),TC.alert(i.parent.getLocaleString("geo.trk.upload.error4"))};var K;TC.wrap.control.Geolocation.prototype.simulateTrackEnd=function(){var e=this;$(e.miProgressTextDiv).remove(),$(e.miProgressDiv).remove(),$(e.miDiv).remove(),e.simulateMarker&&(window.cancelAnimationFrame(K),e.simulateMarker.layer.wrap.layer.getSource().getFeatures().length>0&&e.simulateMarker.layer.removeFeature(e.simulateMarker),delete e.simulateMarker)},TC.wrap.control.Geolocation.prototype.simulateTrack=function(){for(var t,r=this,a=r.parent.layerTrack.wrap.layer.getSource().getFeatures(),n=0;n<a.length;n++)if(a[n].getGeometry()instanceof e.geom.LineString){t=a[n].getGeometry().getCoordinates();break}if(t&&t.length>0){var o=t[0],i=function(){var e=new $.Deferred;return r.simulateMarker?(r.simulateMarker.setCoords(o.slice(0,2)),e.resolve(r.simulateMarker)):r.parent.layerTrack.addPoint(o.slice(0,2),{radius:7,fillColor:"#ff0000",strokeColor:"#ffffff",strokeWidth:2}).then(function(t){e.resolve(t)}),e};i().then(function(a){r.simulateMarker=a;var n=function(){var a,n,o,i=(t.length,!1);if(r.parent.hasElevation){var s=d3.select(".c3-event-rects,.c3-event-rects-single").node().getBoundingClientRect();$("body").append('<div class="miDiv">'),r.miDiv=$("div.miDiv"),r.miDiv.width(s.width),r.miDiv.height(s.height),r.miDiv.append('<div class="miProgressDiv">'),r.miProgressDiv=$("div.miProgressDiv"),r.miProgressDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress"),r.miProgressDiv.width("0%"),r.miProgressDiv.height(s.height),r.miProgressDiv.append('<div class="miProgressTextDiv">'),r.miProgressTextDiv=$("div.miProgressTextDiv"),r.miProgressTextDiv.addClass("tc-ctl-geolocation-track-elevation-chart-progress text"),r.miProgressTextDiv.width(s.width),r.miProgressTextDiv.height(s.height),r.miDiv.css({top:s.top,left:s.left,bottom:s.bottom,right:s.right,position:"absolute","z-index":1e4})}var l=t;if(4==l[0].length&&l[0][3]>0)a=l[0][3],n=l[l.length-1][3],i=!0;else{l[0][3]=Date.now();for(var p=1;p<l.length;p++){var c;l[p][3]=0,c=p+1<l.length?new e.geom.LineString(l.slice(p-1,p+1)).getLength():new e.geom.LineString(l.slice(p-1)).getLength(),l[p][3]=l[p-1][3]+36e5*c/r.parent.walkingSpeed}a=l[0][3],n=l[l.length-1][3]}var u=new e.geom.LineString(l),g=a,f=u.getLength(),c=0,m=function(t){for(var r=0;r<l.length;r++)if(l[r][3]>t)return{d:new e.geom.LineString(l.slice(0,r)).getLength(),p:l[r-1].slice(0,2)}},d=function(){if(!r.parent.simulate_paused){var e=u.getCoordinateAtM(g),t=m(g);if(o>=1||!e||!t){r.simulateTrackEnd();var a=r.parent.getSelectedTrack();return a&&r.parent.uiSimulate(!1,a),$(r.miProgressTextDiv).remove(),$(r.miProgressDiv).remove(),void $(r.miDiv).remove()}if(r.parent.hasElevation){c=t.d;var n=(c+Math.hypot(t.p[0]-e[0],t.p[1]-e[1]))/f*100;r.miProgressDiv.width(n+"%");var s;i&&(s=N(l[0][3],e[3]));var p,v,y=r.parent.map.options.locale&&r.parent.map.options.locale.replace("_","-")||void 0,C=parseInt(e[2].toFixed(0)).toLocaleString(y);1>c/1e3?(p=Math.round(c/1e3*1e3),v=" m"):(p=Math.round(c/1e3*100)/100,v=" km"),p=p.toLocaleString(y),r.miProgressTextDiv.html("<div><span>"+C+" m</span><br><span>"+p+v+"</span></div>"+(i?"<br><span>"+s.toString+"</span>":""))}if(r.simulateMarker){{var h=r.simulateMarker.getCoords(),T=e;180*Math.atan2(T[1]-h[1],T[0]-h[0])/Math.PI}r.simulateMarker.setCoords(e)}g+=1!==r.parent.simulate_speed?r.parent.delta*r.parent.simulate_speed:r.parent.delta}K=requestAnimationFrame(d)};K=requestAnimationFrame(d)},o=new $.Deferred;window.d3?o.resolve():TC.loadJS(!window.d3,[TC.Consts.url.D3C3],function(){o.resolve()}),o.then(function(){K=requestAnimationFrame(n)})})}},TC.wrap.control.Geolocation.prototype.headingChangehandler=function(e){var t=this;t.parent.track.$infoOnMap||(t.parent.track.$infoOnMap=$('<div style="overflow-y: scroll; height: 200px; width: 200px; top: 0; left: 100px; background-color: fuchsia; position: absolute;"></div>').appendTo(t.parent.map._$div)),t.parent.track.$infoOnMap.show(),t.parent.track.$infoOnMap.html(t.parent.track.$infoOnMap.html()+"<br> <p> salta headingChangehandler </p>"),t.parent.track.$infoOnMap.html(t.parent.track.$infoOnMap.html()+"<br> <p> evt.target.getHeading(): "+e.target.getHeading()+" </p>"),t.heading=e.target.getHeading(),$.when(t.map.wrap.getMap()).then(function(e){e.getView().setRotation(-t.heading)}),t.parent.$events.trigger($.Event(t.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0}))},TC.wrap.control.Geolocation.prototype.orientationChangehandler=function(e){var t=this,r=t.map.wrap.map.getView(),a=r.getCenter(),n=r.getResolution(),o=e.target.getBeta()||0,i=e.target.getGamma()||0;a[0]-=n*i*25,a[1]+=n*o*25,r.setCenter(r.constrainCenter(a)),t.parent.$events.trigger($.Event(t.parent.Const.Event.STATEUPDATED,{moving:void 0!=heading&&heading>0}))},TC.wrap.control.Geolocation.prototype.pulsate=function(t){var r=this;r.pulsated=!0;var a,n=t.wrap.feature.getGeometry().getRadius(),o=(new Date).getTime(),i=500,s=function(e){switch(!0){case 50>=e:return n;case e>50&&100>=e:return 1.02*n;case e>100&&150>=e:return 1.05*n;case e>150&&200>=e:return 1.02*n;case e>200&&300>=e:return n;case e>300&&350>=e:return 1.02*n;case e>350&&400>=e:return 1.05*n;case e>400&&450>=e:return 1.02*n;case e>450&&500>=e:return 1*n;default:return n}};a=r.olMap.on(e.render.EventType.POSTCOMPOSE,function(r){var n=r.vectorContext,l=r.frameState,p=l.time-o,c=t.wrap.feature.getGeometry().clone(),u=s(p);return c.setRadius(u),n.setFillStrokeStyle(new e.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),new e.style.Stroke({color:"rgba(255, 0, 0, .8)",width:1})),n.drawCircleGeometry(c),p>i?void e.Observable.unByKey(a):void(l.animate=!0)})},TC.wrap.control.Coordinates.prototype.coordsActivate=function(){var t=this;t.olMap.on(e.MapBrowserEventType.SINGLECLICK,t._coordsTrigger);var r=t.olMap.getViewport();$(r).on(o,t._cleanCoordsTrigger)},TC.wrap.control.Coordinates.prototype.coordsDeactivate=function(){var t=this;t.olMap.un(e.MapBrowserEventType.SINGLECLICK,t._coordsTrigger);var r=t.olMap.getViewport();$(r).off(o,t._cleanCoordsTrigger)},TC.wrap.Parser=function(){},TC.wrap.Parser.prototype.read=function(e){var t=[],r=this;return r.parser&&(TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature"),t=$.map(r.parser.readFeatures(e),function(e){return new TC.Feature(null,{id:e.getId(),data:e.getProperties()})})),t},TC.wrap.parser={WFS:function(t){this.parser=new e.format.WFS(t)},JSON:function(t){this.parser=new e.format.GeoJSON(t)}},TC.inherit(TC.wrap.parser.WFS,TC.wrap.Parser),TC.inherit(TC.wrap.parser.JSON,TC.wrap.Parser),TC.wrap.control.OverviewMap.prototype.register=function(t){var r=this;$.when(r.parent.layer.wrap.getLayer()).then(function(a){r.ovMap=new e.control.OverviewMap({target:r.parent.div,collapsed:!1,collapsible:!1,className:r.parent.CLASS+" ol-overviewmap",layers:[a]}),r.ovMap._wrap=r,r.ovMap.ovmap_.removeOverlay(r.ovMap.boxOverlay_);var n=document.createElement("DIV");n.className="ol-overviewmap-box",n.style.boxSizing="border-box",r.ovMap.boxOverlay_=new e.Overlay({position:[0,0],positioning:e.OverlayPositioning.BOTTOM_LEFT,element:n}),r.ovMap.ovmap_.addOverlay(r.ovMap.boxOverlay_),r._$boxElm=$(r.ovMap.boxOverlay_.getElement()).parents(".ol-overlay-container").first(),TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jquery/jquery.event.drag.js",TC.apiLocation+"lib/jquery/jquery.event.drop.js"],function(){var e,a,n=r.ovMap.ovmap_;r._$boxElm.drag("start",function(r,o){var i=$(this);o.$dragged=i.clone().addClass(TC.Consts.classes.ACTIVE),i.after(o.$dragged),e=parseInt(i.css("bottom")),a=parseInt(i.css("left"));var s=n.getPixelFromCoordinate([t.options.maxExtent[0],t.options.maxExtent[1]]),l=n.getPixelFromCoordinate([t.options.maxExtent[2],t.options.maxExtent[3]]),p=n.getSize();o.limit={bottom:p[1]-s[1],left:s[0],top:p[1]-l[1]-i.height(),right:l[0]-i.width()}}).drag("end",function(e,a){a.$dragged.remove();var o=r.ovMap.getMap(),i=o.getView(),s=n.getPixelFromCoordinate(i.getCenter()),l=n.getCoordinateFromPixel([s[0]+a.deltaX,s[1]+a.deltaY]),p=t.getExtent(),c=(p[2]-p[0])/2,u=(p[3]-p[1])/2;l[0]+c>t.options.maxExtent[2]?l[0]=t.options.maxExtent[2]-c:l[0]-c<t.options.maxExtent[0]&&(l[0]=t.options.maxExtent[0]+c),l[1]+u>t.options.maxExtent[3]?l[1]=t.options.maxExtent[3]-u:l[1]-u<t.options.maxExtent[1]&&(l[1]=t.options.maxExtent[1]+u),t.setCenter(l,{animate:!0})}).drag(function(t,r){parseInt(r.$dragged.css("bottom")),parseInt(r.$dragged.css("left"));r.limit.top?(r.$dragged.css("bottom",Math.min(Math.max(e-r.deltaY,r.limit.bottom),r.limit.top)+"px"),r.$dragged.css("left",Math.min(Math.max(a+r.deltaX,r.limit.left),r.limit.right)+"px")):(r.$dragged.css("bottom",e-r.deltaY+"px"),r.$dragged.css("left",a+r.deltaX+"px"))})}),$.when(t.wrap.getMap()).then(function(n){r.ovMap.ovmap_.setView(new e.View(S(t.wrap,a._wrap.parent)));var o=$(r.parent.div).find("."+r.parent.CLASS+"-load");a._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){o.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)}),a._wrap.$events.on(TC.Consts.event.TILELOAD,function(){o.removeClass(TC.Consts.classes.VISIBLE).addClass(TC.Consts.classes.HIDDEN)}),n.addControl(r.ovMap),r.parent.isLoaded=!0,r.parent.$events.trigger($.Event(TC.Consts.event.MAPLOAD))})})},TC.wrap.control.OverviewMap.prototype.get3DCameraLayer=function(){var t=this,r=null,a="3DCamera",n=t.ovMap.getOverviewMap();if(n.getLayers().forEach(function(e){e.get("id")===a&&(r=e)}),!r){var n=t.ovMap.getOverviewMap(),o=I({});o[0].getFill().setColor([0,0,0,0]),r=new e.layer.Vector({id:a,source:new e.source.Vector,style:o}),n.addLayer(r)}return r},TC.wrap.control.OverviewMap.prototype.draw3DCamera=function(t){var r=this;r.is3D=!!t;var a=r.get3DCameraLayer();if(a){var n;t=t||{};var o=t.fov,i=a.getSource();if(o&&o.length){var s=i.getFeatures();s.length?n=s[0]:(n=new e.Feature,i.addFeature(n)),n.setGeometry(new e.geom.Polygon([o]))}else i.clear();var l="number"==typeof t.heading?t.heading:0;r._$boxElm.css("transform","rotate("+l+"rad)")}},TC.wrap.control.OverviewMap.prototype.enable=function(){var e=this;e.parent.layer&&e.parent.layer.setVisibility&&(e.parent.layer.setVisibility(!0),$(e.parent.map.div).trigger("resize"))},TC.wrap.control.OverviewMap.prototype.disable=function(){var e=this;e.parent.layer&&e.parent.layer.setVisibility&&e.parent.layer.setVisibility(!1)},TC.wrap.control.FeatureInfo.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var a=t._trigger;t._trigger=function(r){t.hasElegibleLayers().then(function(n){n&&a.call(t,r)&&e.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:r.pixel,control:t.parent}))})}})},TC.wrap.control.FeatureInfo.prototype.hasElegibleLayers=function(){var e=$.Deferred(),t=this.parent.map,r=!1;return $.when(t.wrap.getMap()).then(function(a){a.getLayers().forEach(function(e){var a=e._wrap.parent,n=e.getSource();return n.getGetFeatureInfoUrl&&$.inArray(a,t.workLayers)>=0?(r=!0,!1):void 0}),e.resolve(r)}),e};var B,V=function(e){var t=e.innerHTML||e.textContent;return B=B||document.createElement("textarea"),B.innerHTML=t,B.value},j={readFeatures:function(t){var r=[],a=(new DOMParser).parseFromString(t,"text/xml");if("FeatureInfoResponse"===a.documentElement.tagName)for(var n=a.documentElement.getElementsByTagName("FeatureInfoCollection"),o=0,i=n.length;i>o;o++)for(var s=n[o],l=s.getAttribute("layername"),p=s.getElementsByTagName("FeatureInfo"),c=0,u=p.length;u>c;c++){for(var g=p[c].getElementsByTagName("Field"),f={},m=0,d=g.length;d>m;m++){var v=g[m];f[V(v.getElementsByTagName("FieldName")[0])]=V(v.getElementsByTagName("FieldValue")[0])}var y=new e.Feature(f);y.setId(l+"."+TC.getUID()),r[r.length]=y}return r}},X=function(e,t,r){var a=t.getPath(r);e.layers.push({name:r,title:a[a.length-1],path:a.slice(1),features:[]})};TC.wrap.control.FeatureInfo.prototype.getFeatureInfo=function(t,r){var a=this,n=r||{},o=a.parent.map;$.when(o.wrap.getMap()).then(function(r){for(var i={},s={},l=[],p=[],c=r.getLayers().getArray(),u=0;u<c.length;u++){var g=c[u];if(g.getVisible()){var f=g._wrap.parent,m=g.getSource();if(m.getGetFeatureInfoUrl&&$.inArray(f,o.workLayers)>=0&&f.names.length>0&&(!n.serviceUrl||n.serviceUrl===f.url)){var d={};i[f.title]?d=i[f.title]:(d={layers:[],mapLayer:f,request:null},i[f.title]=d,s[f.title]={source:jQuery.extend(!0,{},m),layers:[]});var v=f.getDisgregatedLayerNames();if(n.layerName)v.indexOf(n.layerName)>=0&&g._wrap.getInfo(n.layerName).queryable&&(X(d,f,n.layerName),s[f.title].layers.push(n.layerName));else{for(var y=0;y<v.length;y++){var C=v[y];g._wrap.getInfo(C).queryable?X(d,f,C):(v.splice(y,1),y-=1)}s[f.title].layers=s[f.title].layers.concat(v)}}}}var h=n.mapSize||r.getSize(),T=Math.round(t[0]),S=Math.round(t[1]),w=n.boundingBox||o.getExtent(),E=r.getView().getResolution();for(var L in i){var d=i[L],m=s[L].source,c=s[L].layers,R=m.getParams();m.params_.LAYERS=c.join(",");var M=m.getGetFeatureInfoUrl(t,E,o.crs,{QUERY_LAYERS:c.join(","),INFO_FORMAT:R.INFO_FORMAT,FEATURE_COUNT:1e3,radius:o.options.pixelTolerance,buffer:o.options.pixelTolerance});M=M.replace(/I=\d+(\.\d+)?/,"I="+T).replace(/J=\d+(\.\d+)?/,"J="+S).replace(/WIDTH=\d+/,"WIDTH="+h[0]).replace(/HEIGHT=\d+/,"HEIGHT="+h[1]).replace(/BBOX=-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?\%2C-?\d+(\.\d+)?/,"BBOX="+w.join("%2C")).replace(/sld_body=[a-zA-Z%0-9._]*/);var _=M;d.mapLayer.usesProxy?M=TC.proxify(M):d.mapLayer.usesSSL&&(M=M.replace(/^(f|ht)tp?:\/\//i,"https://"));var P=$.ajax({url:M});P.originalUrl=M,P.title=L,P.requestedFormat=R.INFO_FORMAT,P.expandUrl=_,l.push(P)}l.length>0?$.when.apply(a,l).then(function(){for(var r=l.length>1?arguments:[arguments],s=!1,c=0,u=[],g=0;g<r.length;g++){var f=r[g],m=i[l[g].title],d=f[2];if("success"===f[1]){s=!0,m.text=d.responseText;var v,y=d.getResponseHeader("Content-type");if(y&&y.indexOf(";")>-1&&(y=y.substr(0,y.indexOf(";")).trim()),y||(y=d.requestedFormat),y===d.requestedFormat){switch(y){case"application/json":v=new e.format.GeoJSON;break;case"application/vnd.ogc.gml":v=d.responseText.indexOf("FeatureCollection")>-1?new e.format.WFS({gmlFormat:new e.format.GML2({srsName:o.crs})}):new e.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":v=new e.format.GML3Patched({srsName:o.crs});break;case"application/vnd.esri.wms_featureinfo_xml":v=j;break;default:v=null}if(v){var C=v.readFeatures(d.responseText,{featureProjection:e.proj.get(o.crs)});c+=C.length;for(var h=function(e,t,r){var a=!1;if(t===r)a=!0;else{var n=e.getNodePath(t),o=e.getNodePath(r);if(n.length>0&&o.length>=n.length){a=!0;for(var i=0;i<n.length;i++)if(e.wrap.getName(n[i])!==e.wrap.getName(o[i])){a=!1;break}}}return a},T={},S=0;S<C.length;S++){var w=C[S];if(w instanceof e.Feature){for(var E=w.getId()||TC.getUID(),L=!1,R=E.substr(0,E.lastIndexOf(".")),M=0;M<m.layers.length;M++){var _=m.layers[M],P=_.name.substr(_.name.indexOf(":")+1);if(h(m.mapLayer,P,R)){L=!0,n.featureId&&w.getId()!==n.featureId||(p.push(TC.wrap.Feature.createFeature(w)),u.push(_.features));break}}if(!L){var A;T[R]?A=T[R]:(A={name:R,title:R,path:[R],features:[]},T[R]=A,m.layers.push(A)),n.featureId&&w.getId()!==n.featureId||(p.push(TC.wrap.Feature.createFeature(w)),u.push(A.features))}}}}else{var x={name:"layer"+TC.getUID(),title:"Datos en el punto",features:[]};m.layers[m.layers.length]=x,x.features[0]={rawUrl:d.originalUrl,expandUrl:d.expandUrl,rawContent:d.responseText,rawFormat:y},c+=1}}else o.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:t,control:a.parent,layer:m.mapLayer,message:d.responseText}))}else o.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:t,control:a.parent,layer:m.mapLayer,message:d.responseText}))}if(s){var I=p;if(p.length){var O=$.Deferred();I=I.concat(O),TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry",function(){O.resolve()})}$.when.apply(this,I).then(function(){var e;if(arguments.length)for(var r=o.wrap.getCoordinateFromPixel(t),n=0;n<arguments.length;n++){var s=arguments[n];if(s){s.attributes=[];for(var l in s.data){var p=s.data[l];"object"!=typeof p&&s.attributes.push({name:l,value:"number"==typeof p?p.toLocaleString(TC.Util.getMapLocale(a.parent.map)):p})}s.showsPopup=!1,!e&&TC.Geometry.isInside(r,s.geometry)&&(e=s),u[n].push(s)}}var g=[];for(var f in i)i.hasOwnProperty(f)&&g.push(i[f]);o.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,{xy:t||null,services:g,featureCount:c,defaultFeature:e,control:a.parent}))})}},function(e,t,r){o.$events.trigger(TC.Consts.event.NOFEATUREINFO),o.toast(a.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})}):o.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,{xy:t,services:i,featureCount:0,control:a.parent}))})},TC.wrap.control.GeometryFeatureInfo.prototype.register=function(t){var r=this;$.when(t.wrap.getMap()).then(function(a){TC.wrap.control.Click.prototype.register.call(r,t);var n=r._trigger;r._trigger=function(t){r.hasElegibleLayers().then(function(a){a&&(r.parent._isSearching||t.type!=e.MapBrowserEventType.SINGLECLICK||r.parent._isDrawing||r.parent._isSearching||n.call(r,t))})}})},TC.wrap.control.GeometryFeatureInfo.prototype.hasElegibleLayers=function(){var e=$.Deferred(),t=this.parent.map,r=!1;return $.when(t.wrap.getMap()).then(function(a){a.getLayers().forEach(function(e){var a=e._wrap.parent,n=e.getSource();return n.getGetFeatureInfoUrl&&$.inArray(a,t.workLayers)>=0?(r=!0,!1):void 0}),e.resolve(r)}),e},TC.wrap.control.GeometryFeatureInfo.prototype.beginDraw=function(t){var r=this;t=t||{};var a=t.xy,n=t.layer,o=t.callback,i=t.geometryType,s=!1;r.drawCtrl?(r.drawCtrl.setActive(!0),r.drawCtrl.startDrawing_({coordinate:a})):$.when(n.wrap.getLayer()).then(function(t){
var n;switch(i){case TC.Consts.geom.POLYLINE:n=e.geom.GeometryType.LINE_STRING;break;default:n=e.geom.GeometryType.POLYGON}r.drawCtrl=new e.interaction.Draw({source:t.getSource(),type:n,style:t.getStyle()});var l=function(e){e.parent.showsPopup=!1};t.getSource().on(e.source.VectorEventType.ADDFEATURE,function(e){e.feature._wrap?l(e.feature._wrap):e.feature._wrapDeferred.then(l)}),r.drawCtrl.handleEvent=function(t){if(t.type==e.MapBrowserEventType.SINGLECLICK){var r=n===e.geom.GeometryType.POLYGON?this.sketchCoords_[0]:this.sketchCoords_;s&&2==r.length&&null!==this.sketchFeature_?this.addToDrawing_(t):s=!0}return e.interaction.Draw.handleEvent.call(this,t)},r.parent.map.wrap.getMap().addInteraction(r.drawCtrl),r.drawCtrl.on("drawstart",function(t){r.parent._isDrawing=!0;var a=r.parent.map;$.when(a.wrap.getMap()).then(function(t){t.getInteractions().forEach(function(t,r){t instanceof e.interaction.DoubleClickZoom&&t.setActive(!1)})})}),r.drawCtrl.startDrawing_({coordinate:a}),r.drawCtrl.on("drawend",function(a){r.parent._isDrawing=!1;var n=r.parent.map;$.when(n.wrap.getMap()).then(function(t){t.getInteractions().forEach(function(t,r){t instanceof e.interaction.DoubleClickZoom&&t.setActive(!1)})}),o&&TC.wrap.Feature.createFeature(a.feature).then(function(e){o(e)}),this.setActive(!1),r.parent.map.wrap.getMap().removeInteraction(r.drawCtrl),r.drawCtrl=null,t.getSource().clear(),r.parent._drawToken=!0,setTimeout(function(){r.parent._drawToken=!1},500)})})},TC.wrap.control.GeometryFeatureInfo.prototype.cancelDraw=function(e,t,r){var a=this;a.drawCtrl&&a.parent._isDrawing&&(a.parent._isDrawing=!1,a.drawCtrl.setActive(!1),a.drawCtrl.source_.clear())};var W=function(e,t,r,a){var n=[],o={};return $.when(e.wrap.getMap()).then(function(i){i.getLayers().forEach(function(i){var s=i._wrap.parent;if(i.getVisible()&&!($.inArray(s,e.workLayers)<0)&&s.type===TC.Consts.layerType.WMS){var l=s.getDisgregatedLayerNames()||s.availableNames;o[s.url.toLowerCase()]||(o[s.url.toLowerCase()]={layers:[],mapLayer:s,layerNames:[]});for(var p=0;p<l.length;p++){var c=l[p];if((s.isVisibleByScale(c)||a)&&s.wrap.getInfo(c).queryable){o[s.url.toLowerCase()].layerNames.push(c);var u=s.getPath(c);o[s.url.toLowerCase()].layers.push({name:c,title:u[u.length-1],path:u.slice(1),features:[]})}}0!=o[s.url.toLowerCase()].layerNames.length&&"undefined"==typeof o[s.url.toLowerCase()].request&&(o[s.url.toLowerCase()].request=s.getWFSCapabilitiesPromise(),o[s.url.toLowerCase()].defer=$.Deferred(),n.push(o[s.url.toLowerCase()].defer),$.when(o[s.url.toLowerCase()].request).then(function(e){var n=null;for(var i in o)o[i].request&&o[i].request.promise()==this&&(n=o[i]);var s=null,l=n.layerNames,p=n.defer;if(l instanceof Array&&l.length){if("undefined"==typeof e.Operations.GetFeature)return void p.resolve("El servicio "+n.mapLayer.title+" no tiene habilitado el GetFeature de WFS");for(var c=[],u=0;u<l.length;u++){for(var g=l[u].substring(l[u].indexOf(":")+1);"_"===g[g.length-1];)g=g.substring(0,g.lastIndexOf("_"));e.FeatureTypes.hasOwnProperty(g)?c.indexOf(g)<0&&c.push(g):TC.error("El servicio "+n.mapLayer.title+" no dispone de la capa "+g)}if(0==c.length)return TC.error("No hay ninguna capa válida para el servicio "+n.mapLayer.title+" por lo que no se consultará dicho servicio"),void p.resolve(null);e.Operations.GetFeature.CountDefault&&(s=e.Operations.GetFeature.CountDefault.DefaultValue),(("1.0.0"===e.version||"1.1.0"===e.version)&&!e.Operations.GetFeature.Operations.hasOwnProperty("Query")||"2.0.0"===e.version&&e.Operations.QueryExpressions.AllowedValues.Value.indexOf("wfs:Query")<0)&&TC.error("El servicio "+n.mapLayer.title+" no tiene habilitado el Query de WFS");var i=e.Operations.GetFeature.DCPType?e.Operations.GetFeature.DCPType[1].HTTP.Post.onlineResource:e.Operations.GetFeature.DCP.HTTP.Post["xlink:href"],f=n.mapLayer.usesProxy?TC.proxify(i):n.mapLayer.usesSSL?i.replace(/^(f|ht)tp?:\/\//i,"https://"):i;s?jQuery.ajax({url:f,data:TC.Util.WFSQueryBuilder(c,t,e,r,!0),cache:!1,contentType:"application/xml",type:"POST"}).then(function(){var o=xml2json(arguments[0]);if(o.Exception)return void p.resolve({err:o.Exception.exceptionCode,errorThrown:o.Exception.ExceptionText,service:n});var l=parseInt(o.numberMatched||o.numberOfFeatures,10);return isNaN(l)||l>parseInt(s,10)?void p.resolve({err:"NumMaxFeatures",limit:s,service:n}):void(a&&p.resolve({url:i,data:TC.Util.WFSQueryBuilder(c,t,e,r,!1),service:n,numFeatures:l}))},function(e,t,r){p.resolve({err:t,errorThrown:r,service:n})}):a||p.resolve({url:f,data:TC.Util.WFSQueryBuilder(c,t,e,r,!1),service:n}),a&&!s&&p.resolve({url:i,data:TC.Util.WFSQueryBuilder(c,t,e,r,!1),service:n}),a||jQuery.ajax({url:f,data:TC.Util.WFSQueryBuilder(c,t,e,r,!1),cache:!1,contentType:"application/xml",type:"POST"}).then(function(){return"success"!=arguments[1]?void p.reject(arguments):void p.resolve({service:n,response:arguments})},function(e,t,r){p.resolve({err:t,errorThrown:r,service:n})})}},function(e,t,r){var a=null;for(var n in o)o[n].request&&o[n].request.promise()==this&&(a=o[n]);a.defer.resolve({err:r,service:a})}))}})}),n};TC.WFSGetFeatureBuilder=W;var Y=function(t,r,a){var n,o=a.getResponseHeader("Content-type");switch(o&&o.indexOf(";")>-1&&(o=o.substr(0,o.indexOf(";")).trim()),o||(o=r.requestedFormat),o){case"application/json":n=new e.format.GeoJSON;break;case"application/vnd.ogc.gml":n=r.responseText.indexOf("FeatureCollection")>-1?new e.format.WFS({gmlFormat:new e.format.GML2({srsName:t.crs})}):new e.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":n=new e.format.GML3Patched({srsName:t.crs});break;case"text/xml":case"application/xml":var a=xml2json(r);a.ServiceException&&TC.error(a.ServiceException),n=null;break;default:n=null}return n?n.readFeatures(a.responseText,{featureProjection:e.proj.get(t.crs)}):null},H=function(t,r){for(var a=[],n=[],o=$.Deferred(),i=function(e,t,r){var a=!1;if(t===r||0===t.indexOf(r))a=!0;else{var n=e.getPath(t),o=e.getPath(r);if(n.length>0&&o.length>=n.length){a=!0;for(var i=0;i<n.length;i++)if(n[i]!==o[i]){a=!1;break}}}return a},s=0;s<t.length;s++){var l=t[s];if(l instanceof e.Feature){for(var p=l.getId()||TC.getUID(),c=!1,u=p.substr(0,p.lastIndexOf(".")),g=0;g<r.layers.length;g++){var f=r.layers[g],m=f.name.substr(f.name.indexOf(":")+1);if(i(r.mapLayer,m,u)){c=!0,a.push(TC.wrap.Feature.createFeature(l)),n[l.id_]=f.features;break}}if(!c){var d;fakeLayers[u]?d=fakeLayers[u]:(d={name:u,title:u,features:[]},fakeLayers[u]=d,r.layers.push(d)),opts.featureId&&l.getId()!==opts.featureId||(a.push(TC.wrap.Feature.createFeature(l)),n.push(d.features))}}}return $.when.apply(this,a).done(function(){if(arguments.length)for(var e=0;e<arguments.length;e++){var t=arguments[e];t.attributes=[];for(var a in t.data){var i=t.data[a];"object"!=typeof i&&t.attributes.push({name:a,value:i})}n[t.id].push(t)}o.resolve({service:r})}),o};TC.wrap.control.GeometryFeatureInfo.prototype.getFeaturesByGeometry=function(t,r){var a=this,n=a.parent.map;a.parent.filterFeature=t,t.layer=a.parent.filterLayer,$.when(n.wrap.getMap()).then(function(o){var i=t.wrap.feature.getGeometry(),s=i.stride,l=i.getFlatCoordinates();if(!r){for(var p=null,c=1,u=l.length;u>c;c+=s)(!p||p[1]<l[c])&&(p=[l[c-1],l[c]]);r=o.getPixelFromCoordinate(new e.geom.Point(p).getCoordinates())}n.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:r,control:a.parent}));var g=W(n,t,"JSON"),f=[];$.when.apply($,g).then(function(){for(var e=[],t=0,o=!1,i=0;i<arguments.length;i++)if(arguments[i])if(arguments[i].err){o=!0;var s=new $.Deferred;switch(f[f.length]=s,e.push(arguments[i].service),arguments[i].err){case"NumMaxFeatures":n.toast(a.parent.getLocaleString("featureInfo.tooManyFeatures").format(arguments[i].limit,arguments[i].service.mapLayer.title),{type:TC.Consts.msgType.WARNING});break;case"NameResolutionFailure":n.toast(a.parent.getLocaleString("featureInfo.inValidService").format(arguments[i].service.mapLayer.title),{type:TC.Consts.msgType.WARNING})}e.push(arguments[i].service),s.resolve()}else{var l=Y(n,arguments[i].response[0],arguments[i].response[2]);f[f.length]=H(l,arguments[i].service),e.push(arguments[i].service);for(var p=0;p<arguments[i].service.layers.length;p++)t+=l.length}$.when.apply($,f).then(function(){n.$events.trigger(t||o?$.Event(TC.Consts.event.FEATUREINFO,{xy:r||null,services:e,featureCount:t,control:a.parent}):$.Event(TC.Consts.event.NOFEATUREINFO,{xy:r,control:a.parent}))})},function(e){n.$events.trigger($.Event(TC.Consts.event.NOFEATUREINFO,{xy:r,control:a.parent}))})})},TC.wrap.control.Popup.prototype=function(){this.popup=null},TC.Consts.event.PANANIMATIONSTART="pananimationstart.tc",TC.Consts.event.PANANIMATIONEND="pananimationend.tc",TC.wrap.control.Popup.prototype.fitToView=function(){var t=this,r=t.parent.map,a=t.parent.map.wrap.map,n=t.parent.$popupDiv[0].getBoundingClientRect(),o=r._$div[0].getBoundingClientRect(),i=a.getCoordinateFromPixel([n.left-o.left,n.top-o.top]),s=a.getCoordinateFromPixel([n.right-o.left,n.bottom-o.top]),l=i[0],p=i[1],c=s[0],u=s[1],g=[l,u,c,p],f=r.getExtent();if(!e.extent.containsExtent(f,g)){var m={left:Math.max(f[0]-g[0],0),bottom:Math.max(f[1]-g[1],0),right:Math.max(g[2]-f[2],0),top:Math.max(g[3]-f[3],0)};if(t.parent.dragged){var d=t.popup.getPosition();m.right?d[0]=d[0]-m.right:m.left&&(d[0]=d[0]+m.left),m.top?d[1]=d[1]-m.top:m.bottom&&(d[1]=d[1]+m.bottom);var v=a.getPixelFromCoordinate(d);v[1]=a.getSize()[1]-v[1],t.parent._previousContainerPosition=v,t.popup._oldUpdatePixelPosition(d)}else if(t.parent.isVisible()){var y=a.getView(),C=y.getCenter().slice();m.top?C[1]+=m.top:m.bottom&&(C[1]-=m.bottom),m.right?C[0]+=m.right:m.left&&(C[0]-=m.left),y.animate({center:C,easing:function(e){return 0===e&&t.parent.map.$events.trigger($.Event(TC.Consts.event.PANANIMATIONSTART)),1===e&&t.parent.map.$events.trigger($.Event(TC.Consts.event.PANANIMATIONEND)),e}})}}},TC.wrap.control.Popup.prototype.setDragged=function(t){var r=this.popup;t?(r._oldUpdatePixelPosition||(r._oldUpdatePixelPosition=r.updatePixelPosition,r.updatePixelPosition=function(){}),r._newHandleOffsetChanged||(r._newHandleOffsetChanged=function(){this._oldUpdatePixelPosition()},e.events.unlisten(r,e.Object.getChangeEventType(e.Overlay.Property_.OFFSET),r.handleOffsetChanged,r),e.events.listen(r,e.Object.getChangeEventType(e.Overlay.Property_.OFFSET),r._newHandleOffsetChanged,r))):(delete this.parent._previousContainerPosition,r._oldUpdatePixelPosition&&(r.updatePixelPosition=r._oldUpdatePixelPosition,delete r._oldUpdatePixelPosition),r._newHandleOffsetChanged&&(e.events.unlisten(r,e.Object.getChangeEventType(e.Overlay.Property_.OFFSET),r._newHandleOffsetChanged,r),e.events.listen(r,e.Object.getChangeEventType(e.Overlay.Property_.OFFSET),r.handleOffsetChanged,r),delete r._newHandleOffsetChanged))},TC.wrap.Feature.prototype.getLegend=function(){var t=this,r={},a=x(t.feature);if(a){var n=a.getImage();if(n){if(n instanceof e.style.Icon){r.src=n.getSrc();var o=n.getScale();if(o){r.scale=o;var i=n.getImage();i.width&&(r.width=i.width*o,r.height=i.height*o)}}else n instanceof e.style.Circle&&(r.src=n.canvas_.toDataURL());t.parent.options.radius?r.height=r.width=2*t.parent.options.radius:(r.width=r.width||t.parent.options.width,r.height=r.height||t.parent.options.height)}else{var s=a.getStroke(),l=a.getFill();if(s){var p=s.getColor();p&&(r.strokeColor=e.color.asString(p));var c=s.getWidth();c&&(r.strokeWidth=c)}if(l){var u=l.getColor();u&&(r.fillColor=e.color.asString(u))}}}return r};var q=function(t,r,a){var n,o={},i=a||"geometry";return o[i]=new r(t),n=new e.Feature(o),a&&n.setGeometryName(a),n};return TC.wrap.Feature.prototype.createPoint=function(t,r){var a=this;$.isArray(t)?a.feature=q(t,e.geom.Point,r.geometryName):a.isNative(t)&&(a.feature=t,a.parent.geometry=t.getGeometry().getCoordinates()),a.feature._wrap=a,a.feature.setStyle(I({styles:{point:r}},a.feature))},TC.wrap.Feature.prototype.createMarker=function(t,r){var a=this,n=TC.Util.getPointIconUrl(r);n?(r.url=n,$.isArray(t)?a.feature=q(t,e.geom.Point,r.geometryName):a.isNative(t)&&(a.feature=t,a.parent.geometry=t.getGeometry().getCoordinates()),a.feature._wrap=a,a.feature.setStyle(I({styles:{marker:r}},a.feature))):a.createPoint(t,r)},TC.wrap.Feature.prototype.createPolyline=function(t,r){var a=this;$.isArray(t)?a.feature=q(t,e.geom.LineString,r.geometryName):a.isNative(t)&&(a.feature=t,a.parent.geometry=t.getGeometry().getCoordinates()),a.feature._wrap=a,r&&a.feature.setStyle(I({styles:{line:r}},a.feature))},TC.wrap.Feature.prototype.createPolygon=function(t,r){var a=this;if($.isArray(t)){if(t.length){var n=t[0];if($.isArray(n)&&n.length){var o=n[0];$.isArray(o)||(t=[t]);for(var i=0;i<t.length;i++){n=t[i];var s=n[0],l=n[n.length-1];(s[0]!==l[0]||s[1]!==l[1])&&(n[n.length]=s),a.parent.geometry=t,a.feature=q(t,e.geom.MultiLineString,r.geometryName)}a.parent.geometry=t,a.feature=q(t,e.geom.Polygon,r.geometryName)}}}else a.isNative(t)&&(a.feature=t,a.parent.geometry=t.getGeometry().getCoordinates());a.feature._wrap=a;var p=r||{};(p.strokeColor||p.strokeWidth||p.fillColor||p.fillOpacity)&&a.feature.setStyle(I({styles:{polygon:p}},a.feature))},TC.wrap.Feature.prototype.createMultiPolyline=function(t,r){var a=this;if($.isArray(t)){if(t.length){var n=t[0];if($.isArray(n)&&n.length){var o=n[0];$.isArray(o)||(t=[t]),a.parent.geometry=t,a.feature=q(t,e.geom.MultiLineString,r.geometryName)}}}else a.isNative(t)&&(a.feature=t,a.parent.geometry=t.getGeometry().getCoordinates());a.feature._wrap=a,r&&a.feature.setStyle(I({styles:{line:r}},a.feature))},TC.wrap.Feature.prototype.createMultiPolygon=function(t,r){var a=this;if($.isArray(t)){if(t.length){var n=t[0];if($.isArray(n)&&n.length){var o=n[0];if($.isArray(o)&&o.length){var i=o[0];$.isArray(i)||(t=[t])}else t=[[t]];for(var s=0,l=t.length;l>s;s++){n=t[s];for(var p=0,c=n.length;c>p;p++){o=n[p];var u=o[0],g=o[o.length-1];(u[0]!==g[0]||u[1]!==g[1])&&(o[o.length]=u)}}a.parent.geometry=t,a.feature=q(t,e.geom.MultiPolygon,r.geometryName)}}}else a.isNative(t)&&(a.feature=t,a.parent.geometry=t.getGeometry().getCoordinates());a.feature._wrap=a;var f=r||{};(f.strokeColor||f.strokeWidth||f.fillColor||f.fillOpacity)&&a.feature.setStyle(I({styles:{polygon:f}},a.feature))},TC.wrap.Feature.prototype.createCircle=function(t,r){var a=this;if($.isArray(t)&&$.isArray(t[0])&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]&&"number"==typeof t[1]){var n={},o=r.geometryName||"geometry";n[o]=new e.geom.Circle(t[0],t[1]),a.feature=new e.Feature(n),r.geometryName&&a.feature.setGeometryName(r.geometryName)}else if(a.isNative(t)){a.feature=t;var i=t.getGeometry();a.parent.geometry=[i.getCenter(),i.getRadius()]}a.feature._wrap=a,r&&a.feature.setStyle(new e.style.Style({stroke:new e.style.Stroke({color:r.strokeColor,width:r.strokeWidth,lineDash:r.lineDash}),fill:new e.style.Fill({color:T(r.fillColor,r.fillOpacity)})}))},TC.wrap.Feature.createFeature=function(t){var r,a=new $.Deferred,n=t.getGeometry(),o={id:t.getId()};switch(!0){case n instanceof e.geom.Point:var i=t.getStyle();$.isFunction(i)&&(i=i.call(t));for(var s=i?$.isArray(i)?i:[i]:[],l=0,p=s.length;p>l;l++)if(i=s[l],i.getImage()instanceof e.style.Icon){r="Marker";break}r=r||"Point";break;case n instanceof e.geom.LineString:r="Polyline";break;case n instanceof e.geom.Polygon:r="Polygon";break;case n instanceof e.geom.MultiLineString:r="MultiPolyline";break;case n instanceof e.geom.MultiPolygon:r="MultiPolygon"}return r?TC.loadJS(!TC.feature||TC.feature&&!TC.feature[r],[TC.apiLocation+"TC/feature/"+r],function(){var e=new TC.feature[r](t,o);e.data=e.wrap.getData(),a.resolve(e)}):TC.loadJS(!TC.Feature,[TC.apiLocation+"TC/Feature"],function(){var e=new TC.Feature(t,o);e.data=e.wrap.getData(),a.resolve(e)}),a},TC.wrap.Feature.prototype.cloneFeature=function(){return this.feature.clone()},TC.wrap.Feature.prototype.getStyle=function(){var t=this,r={},a=t.feature.getStyle();$.isFunction(a)&&(a=a.call(t.feature));for(var n=a?$.isArray(a)?a:[a]:[],o=0,i=n.length;i>o;o++){a=n[o];var s=a.getFill();s&&(r.fillColor=s.getColor(),$.isArray(r.fillColor)&&(r.fillOpacity=r.fillColor[3]));var l=a.getStroke();l&&(r.strokeColor=l.getColor(),r.strokeWidth=l.getWidth());var p=a.getImage();if(p instanceof e.style.Icon){r.url=p.getSrc();var c=p.getSize(),u=p.getAnchor();u&&(r.anchor=[u[0],u[1]],p.anchorXUnits_===e.style.IconAnchorUnits.PIXELS&&(r.anchor[0]=r.anchor[0]/c[0]),p.anchorYUnits_===e.style.IconAnchorUnits.PIXELS&&(r.anchor[1]=r.anchor[1]/c[1]))}var g=a.getText();if(g){r.label=g.getText();var f=g.getFont();f&&(r.fontSize=parseInt(f.match(/\d+pt/))||.75*parseInt(f.match(/\d+px/)));var m=g.getRotation();m&&(r.angle=-180*m/Math.PI),r.labelOffset=[g.getOffsetX(),g.getOffsetY()],s=g.getFill(),s&&(r.fontColor=s.getColor()),l=g.getStroke(),l&&(r.labelOutlineColor=l.getColor(),r.labelOutlineWidth=l.getWidth())}}return $.extend(t.parent.options,r),r},TC.wrap.Feature.prototype.getGeometry=function(){var t,r=this;if(r.feature&&r.feature.getGeometry){var a=r.feature.getGeometry();a&&(a.getCoordinates?t=a.getCoordinates():a instanceof e.geom.Circle&&(t=[a.getCenter(),a.getRadius()]))}return t},TC.wrap.Feature.prototype.setGeometry=function(t){var r=!1,a=this;if(a.feature&&a.feature.getGeometry){var n,o,i,s,l,p,c,u=a.feature.getGeometry();switch(!0){case u instanceof e.geom.MultiPolygon:l=!0,s=t,$.isArray(s)&&(i=t[0]);case u instanceof e.geom.Polygon||u instanceof e.geom.MultiLineString:p=!0,i=l?i:t,$.isArray(i)&&(o=i[0]);case u instanceof e.geom.LineString:c=!0,o=p?o:t,$.isArray(o)&&(n=o[0]);case u instanceof e.geom.Point:n=c?n:t,$.isArray(n)&&"number"==typeof n[0]&&"number"==typeof n[1]&&(u.setCoordinates(t),r=!0);break;case u instanceof e.geom.Circle:$.isArray(t)&&$.isArray(t[0])&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]&&"number"==typeof t[1]&&(u.setCenterAndRadius(t[0],t[1]),r=!0)}}return r},TC.wrap.Feature.prototype.getId=function(){var e,t=this;return t.feature&&(e=t.feature.getId()),e},TC.wrap.Feature.prototype.setId=function(e){var t=this;t.feature&&t.feature.setId(e)},TC.wrap.Feature.prototype.setStyle=function(t){var r=this,a=r.feature,n=r.parent,o=a.getGeometry();if(o instanceof e.geom.Point){var i;if(t.anchor){var s={anchor:A(t.anchor,n),src:TC.Util.getPointIconUrl(t),size:[A(t.width,n),A(t.height,n)]};t.angle&&(s.angle=t.angle),i=new e.style.Icon(s)}else{var l={radius:A(t.radius,n)||(A(t.height,n)+A(t.width,n))/4};t.fillColor&&(l.fill=new e.style.Fill({color:T(A(t.fillColor,n),A(t.fillOpacity,n))})),t.strokeColor&&(l.stroke=new e.style.Stroke({color:A(t.strokeColor,n),width:A(t.strokeWidth,n),lineDash:t.lineDash})),isNaN(l.radius)||(i=new e.style.Circle(l))}a.setStyle(new e.style.Style({image:i}))}else o instanceof e.geom.LineString||o instanceof e.geom.MultiLineString?a.setStyle(new e.style.Style({stroke:new e.style.Stroke({color:A(t.strokeColor,n),width:A(t.strokeWidth,n),lineDash:t.lineDash})})):(o instanceof e.geom.Polygon||o instanceof e.geom.MultiPolygon)&&a.setStyle(new e.style.Style({stroke:new e.style.Stroke({color:A(t.strokeColor,n),width:A(t.strokeWidth,n),lineDash:t.lineDash}),fill:new e.style.Fill({color:T(A(t.fillColor,n),A(t.fillOpacity,n))})}))},TC.wrap.Feature.prototype.getInnerPoint=function(t){var r,a=t||{},n=this.feature,o=n.getGeometry(),i=function(e){var t=a.clipBox;e[0]=Math.min(Math.max(e[0],t[0]),t[2]),e[1]=Math.min(Math.max(e[1],t[1]),t[3])},s=function f(e){if(a.clipBox&&$.isArray(e))if($.isArray(e[0]))for(var t=0,r=e.length;r>t;t++)f(e[t]);else i(e)};switch(r=o.getFirstCoordinate(),o.getType()){case e.geom.GeometryType.MULTI_POLYGON:o=o.getPolygon(0);case e.geom.GeometryType.POLYGON:var l=function(e,t){for(var r=!1,a=0,n=t.length-1;a<t.length;n=a++){var o=t[a][0],i=t[a][1],s=t[n][0],l=t[n][1],p=i>e[1]!=l>e[1]&&e[0]<(s-o)*(e[1]-i)/(l-i)+o;p&&(r=!r)}return r},p=o.getCoordinates();s(p),o=new e.geom.Polygon(p),r=o.getInteriorPoint().getCoordinates();for(var c=o.getLinearRings(),u=1;u<c.length;u++)if(l(r,c[u].getCoordinates())){r=o.getClosestPoint(r);break}break;case e.geom.GeometryType.MULTI_LINE_STRING:o=o.getLineString(0);case e.geom.GeometryType.LINE_STRING:var g=[0,0],p=o.getCoordinates();s(p),o=new e.geom.LineString(p);for(var u=0;u<p.length;u++)g[0]+=p[u][0],g[1]+=p[u][1];g[0]/=p.length,g[1]/=p.length,r=o.getClosestPoint(g)}return r},TC.wrap.Feature.prototype.showPopup=function(t){var r=this,a=t.map;if(a){var n=r.feature;if(n){a.currentFeature=r.parent;var o=a.getExtent();if(r._innerCentroid=r.getInnerPoint({clipBox:o}),t.$contentDiv.html(r.parent.getInfo()),t.options.closeButton){var i=t.$popupDiv.find("."+t.CLASS+"-close").length;if(0==i){var s=$("<div>").addClass(t.CLASS+"-close").attr("title",t.getLocaleString("close")).appendTo(t.$popupDiv);s.on(TC.Consts.event.CLICK,function(){t.hide()}),t.$contentDiv.addClass(t.CLASS+"-has-btn"),t.$contentDiv.find(".tc-ctl-finfo").css("width","auto").css("height","auto")}}var l,p=r.parent.options;if(p.anchor)l=p.anchor;else{for(var c,u=n._wrap.parent,g=0;g<a.workLayers.length;g++){var f=a.workLayers[g];if(!f.isRaster()&&$.inArray(u,f.features)>=0){c=f.wrap.styleFunction(n);break}}if($.isArray(c)){var m=c[0].getImage();l=!m||m instanceof e.style.Icon?[.5,0]:[.5,.5]}}t.wrap.popup.setOffset(l&&p.height?[0,-p.height*l[1]]:[0,0]),t.wrap.popup.setPosition(r._innerCentroid),t.$popupDiv.addClass(TC.Consts.classes.VISIBLE)}else a.wrap.hidePopup(t)}},TC.wrap.Feature.prototype.isNative=function(t){return t instanceof e.Feature},TC.wrap.Feature.prototype.getPath=function(){var e=[],t=this;return t.feature&&t.feature._folders&&(e=t.feature._folders),e},TC.wrap.Feature.prototype.getBounds=function(){var e=null,t=this;return t.feature&&(e=t.feature.getGeometry().getExtent()),e},TC.wrap.Feature.prototype.getTemplate=function(){var e=null,t=this,r=t.feature.getStyle();if("function"==typeof r&&(r=r.call(t.feature)),$.isArray(r))for(var a=0;a<r.length;a++)if(r[a]._balloon){var n=r[a]._balloon.getText();if(n){r=r[a]._balloon;break}}return r&&!$.isArray(r)&&r.getText&&(e=r.getText()),e},TC.wrap.Feature.prototype.getData=function(){var e=this,t=e.feature.getProperties();$.isArray(t.features)&&(t=1===t.features.length?t.features[0].getProperties():t.features.length+" elementos");var r=e.feature.getGeometryName();return t[r]&&delete t[r],t},TC.wrap.Feature.prototype.setData=function(e){this.feature.setProperties(e)},TC.wrap.control.Draw.prototype.mouseMoveHandler=function(e){var t=e.data;t.sketch&&t.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,t.getMeasureData()))},TC.wrap.control.Draw.prototype.mouseOverHandler=function(e){var t=e.data;t.sketch&&t.hoverCoordinate&&(t.pushCoordinate(t.hoverCoordinate),t.hoverCoordinate=null)},TC.wrap.control.Draw.prototype.clickHandler=function(e){var t=e.data;if(t.sketch){var r=t.sketch.getGeometry().getCoordinates();t.parent.$events.trigger($.Event(TC.Consts.event.POINT,{point:r[r.length-1]}))}},TC.wrap.control.Draw.prototype.getGeometry=function(){var t={};if(this.sketch){var r=this.sketch.getGeometry();r instanceof e.geom.Polygon?t.geometry=new TC.feature.Polygon(r.getCoordinates()):r instanceof e.geom.LineString?t.geometry=new TC.feature.Polyline(r.getCoordinates()):r instanceof e.geom.Point&&(t.geometry=new TC.feature.Point(r.getCoordinates()))}return t},TC.wrap.control.Draw.prototype.getMeasureData=function(){var t=this,r=function(r,a){a.length=r.getLength(),a.units=t.units,a.length>100&&t.units===e.proj.Units.METERS&&(a.length=a.length/1e3,a.units="km")},a=function(r,a){a.area=r.getArea();var n=r.getLinearRing(0);a.perimeter=e.geom.flat.length.linearRing(n.flatCoordinates,0,n.flatCoordinates.length,n.stride),a.units=t.units,a.area>1e4&&t.units===e.proj.Units.METERS&&(a.area=a.area/1e6,a.perimeter=a.perimeter/1e3,a.units="km")},n={};if(this.sketch){var o=this.sketch.getGeometry();o instanceof e.geom.Polygon?a(o,n):o instanceof e.geom.LineString&&r(o,n)}return n},TC.wrap.control.Draw.prototype.activate=function(t){var r,a=this;switch(t){case TC.Consts.geom.POLYGON:r=e.geom.GeometryType.POLYGON;break;case TC.Consts.geom.POINT:r=e.geom.GeometryType.POINT;break;default:r=e.geom.GeometryType.LINE_STRING}a.parent.map&&$.when(a.parent.map.wrap.getMap(),a.parent.getLayer()).then(function(o,s){a.units=o.getView().getProjection().getUnits(),$.when(s&&s.wrap.getLayer()).then(function(s){if(a.$viewport||(a.$viewport=$(o.getViewport())),a.interaction&&(o.removeInteraction(a.interaction),a.$viewport.off(TC.Consts.event.CLICK,a.clickHandler),a.parent.measure&&a.$viewport.off(n+".draw",a.mouseMoveHandler).off(i,a.mouseOverHandler)),a.snapInteraction&&o.removeInteraction(a.snapInteraction),t){a.$viewport.on(TC.Consts.event.CLICK,a,a.clickHandler),a.parent.measure&&a.$viewport.on(n+".draw",a,a.mouseMoveHandler).on(i,a,a.mouseOverHandler);var l={type:r,snapTolerance:0,condition:function(){return e.events.condition.shiftKeyOnly(arguments[0])&&(hole=o.forEachFeatureAtPixel(o.getPixelFromCoordinate(arguments[0].coordinate),function(t){return e.geom.GeometryType.POLYGON==t.getGeometry().getType()||e.geom.GeometryType.MULTI_POLYGON==t.getGeometry().getType()?t:null})),!0}};if(s)l.source=s.getSource(),l.style=s.getStyle();else{var p=a.parent.map.options.styles.selection;l.style=I({styles:{point:$.extend({},p.point,{fillOpacity:0}),line:p.line,polygon:p.polygon}})}if(t===TC.Consts.geom.RECTANGLE&&(l.type=e.geom.GeometryType.LINE_STRING,l.maxPoints=2,l.geometryFunction=function(t,r){r||(r=new e.geom.Polygon(null));var a=t[0],n=t[1];return r.setCoordinates([[a,[a[0],n[1]],n,[n[0],a[1]],a]]),r}),a.interaction=new e.interaction.Draw(l),a.interaction.on("drawstart",function(e){a.sketch=e.feature,a.parent.$events.trigger($.Event(TC.Consts.event.DRAWSTART))},this),a.interaction.on("drawend",function(e){a.parent.$events.trigger(a.parent.measure?$.Event(TC.Consts.event.MEASURE,a.getMeasureData()):$.Event(TC.Consts.event.DRAWEND,a.getGeometry())),a.sketch=null},this),o.addInteraction(a.interaction),a.parent.snapping){var c={};s?c.source=s.getSource():a.parent.snapping instanceof TC.Layer&&(c.source=a.parent.snapping.wrap.layer.getSource()),a.snapInteraction=new e.interaction.Snap(c),o.addInteraction(a.snapInteraction)}}a.redoStack=[]})})},TC.wrap.control.Draw.prototype.deactivate=function(){var e=this;e.parent.map&&$.when(e.parent.map.wrap.getMap(),e.parent.getLayer()).then(function(t,r){e.$viewport&&e.$viewport.off(TC.Consts.event.CLICK,e.clickHandler),r&&r.clearFeatures(),e.interaction&&(t.removeInteraction(e.interaction),e.interaction=null)})},TC.wrap.control.Draw.prototype.popCoordinate=function(){var t=this,r=null;if(t.interaction){var a=t.interaction.sketchFeature_;if(a){var n,o=a.getGeometry();o instanceof e.geom.Polygon?n=o.getCoordinates()[0]:o instanceof e.geom.LineString&&(n=o.getCoordinates());if(n.length>1){var i;o instanceof e.geom.Polygon?i=t.interaction.sketchCoords_[0]:o instanceof e.geom.LineString&&(i=t.interaction.sketchCoords_);var s=!1;if(t.interaction.sketchPoint_)for(var l=t.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<n.length;p++)if(n[p][0]==l[0]&&n[p][1]==l[1]){s=!0;break}var c;c=s?i.length-2:i.length-1,r=i[c],i.splice(c,1),o instanceof e.geom.Polygon?(o.setCoordinates([i]),t.interaction.sketchLine_.getGeometry().setCoordinates(i)):o.setCoordinates(i),a.setGeometry(o)}}}return r},TC.wrap.control.Draw.prototype.pushCoordinate=function(t){var r=this,a=!1;if(r.interaction){var n=r.interaction.sketchFeature_;if(n){var o,i=n.getGeometry();i instanceof e.geom.Polygon?o=i.getCoordinates()[0]:i instanceof e.geom.LineString&&(o=i.getCoordinates());var s;i instanceof e.geom.Polygon?s=r.interaction.sketchCoords_[0]:i instanceof e.geom.LineString&&(s=r.interaction.sketchCoords_);var l=!1;if(r.interaction.sketchPoint_)for(var p=r.interaction.sketchPoint_.getGeometry().getCoordinates(),c=0;c<o.length;c++)if(o[c][0]==p[0]&&o[c][1]==p[1]){l=!0;break}index=l?s.length-1:s.length,s.splice(index,0,t),i instanceof e.geom.LineString?i.setCoordinates(s,e.geom.GeometryLayout.XY):(i.setCoordinates([s],e.geom.GeometryLayout.XY),r.interaction.sketchLine_.getGeometry().setCoordinates(s)),a=!0}}return a},TC.wrap.control.Draw.prototype.undo=function(){var e=this,t=!1,r=e.popCoordinate();return r&&(e.redoStack.push(r),t=!0),e.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,e.getMeasureData())),t},TC.wrap.control.Draw.prototype.redo=function(){var e=this,t=!1;return e.redoStack.length>0&&(e.pushCoordinate(e.redoStack.pop()),t=!0),e.parent.$events.trigger($.Event(TC.Consts.event.MEASUREPARTIAL,e.getMeasureData())),t},TC.wrap.control.Draw.prototype.end=function(){var e=this;e.interaction&&e.interaction.sketchFeature_&&e.interaction.finishDrawing()},TC.wrap.control.CacheBuilder.prototype.getRequestSchemas=function(e){for(var t=e.extent,r=e.layers,a=new Array(r.length),n=0,o=a.length;o>n;n++){var i=r[n],s={layerId:i.id},l=i.wrap.layer.getSource();if(l.getUrls&&(s.url=l.getUrls()[0]),l.getTileGrid){for(var p=l.getTileGrid(),c=p.getResolutions(),u=p.getMatrixIds(),g=i.getLayerNodeByName(i.layerNames),f=null,m=0,d=g.TileMatrixSetLink.length;d>m;m++){var v=g.TileMatrixSetLink[m];if(v.TileMatrixSet===i.matrixSet){f=v.TileMatrixSetLimits;break}}s.tileMatrixLimits=[];for(var m=0,y=c.length;y>m;m++){var C=p.getOrigin(m),h=p.getTileSize(m),T=c[m],S=h*T,w={mId:u[m],res:T,origin:C,tSize:h,cl:Math.floor((t[0]-C[0])/S),cr:Math.floor((t[2]-C[0])/S),rt:Math.floor((C[1]-t[3])/S),rb:Math.floor((C[1]-t[1])/S)};if(f){var E=f[m];E&&(w.cl=Math.max(w.cl,E.MinTileCol),w.cr=Math.min(w.cr,E.MaxTileCol),w.rt=Math.max(w.rt,E.MinTileRow),w.rb=Math.min(w.rb,E.MaxTileRow))}w.cl<=w.cr&&w.rt<=w.rb&&s.tileMatrixLimits.push(w)}}a[n]=s}return a},TC.wrap.control.CacheBuilder.prototype.getGetTilePattern=function(e){var t="",r=e.wrap.layer.getSource();return r.getUrls&&(t=r.getUrls()[0]),e.options.encoding!==TC.Consts.WMTSEncoding.RESTFUL&&(t.indexOf("?")<0&&(t+="?"),t.indexOf("?")===t.length-1&&(t=t+"layer="+e.layerNames+"&style=default&tilematrixset="+encodeURIComponent(e.matrixSet)+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+encodeURIComponent(e.format)+"&TileMatrix={TileMatrix}&TileCol={TileCol}&TileRow={TileRow}")),t},TC.wrap.control.Edit.prototype.activate=function(t){var r=this;r.cancel(!0),t===TC.Consts.editMode.SELECT&&r.parent.map&&$.when(r.parent.map.wrap.getMap(),r.parent.layer.wrap.getLayer()).then(function(t,a){var n=r.parent.map.options.styles.selection;r.selectInteraction&&t.removeInteraction(r.selectInteraction);var o=new e.interaction.Select({layers:[a],style:I({styles:{point:$.extend({},n.point,{fillOpacity:0}),line:n.line,polygon:n.polygon}})});r.selectInteraction=o,t.addInteraction(o);var i=function(e){return e._wrap.parent};o.on("select",function(e){e.selected.length>0&&r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESSELECT,{ctrl:r,features:e.selected.map(i)})),e.deselected.length>0&&0==e.selected.length&&r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{ctrl:r.parent,features:e.deselected.map(i)}))}),r.modifyInteraction&&t.removeInteraction(r.modifyInteraction);var s=new e.interaction.Modify({features:o.getFeatures(),style:I({styles:{point:$.extend({},n.point,{fillOpacity:0}),line:n.line,polygon:n.polygon}})});s.on(e.interaction.ModifyEventType.MODIFYEND,function(e){e.features.forEach(function(e){e._wrap.parent.geometry=e._wrap.getGeometry(),r.parent.$events.trigger($.Event(TC.Consts.event.FEATUREMODIFY,{feature:e._wrap.parent,layer:r.parent.layer}))})}),r.modifyInteraction=s,t.addInteraction(s),r.snapInteraction&&t.removeInteraction(r.snapInteraction),r.parent.snapping&&(r.snapInteraction=new e.interaction.Snap({source:a.getSource()}),t.addInteraction(r.snapInteraction))})},TC.wrap.control.Edit.prototype.deactivate=function(){var e=this;e.modifyInteraction&&(e.modifyInteraction.setActive(!1),e.selectInteraction.setActive(!1),$.when(e.parent.map.wrap.getMap()).then(function(t){t.removeInteraction(e.modifyInteraction),e.modifyInteraction=null,e.selectInteraction=null})),e.drawInteraction&&(e.drawInteraction.abortDrawing_(),e.drawInteraction.setActive(!1),$.when(e.parent.map.wrap.getMap()).then(function(t){
t.removeInteraction(e.drawInteraction),e.drawInteraction=null})),e.parent.$events.trigger($.Event(TC.Consts.event.CONTROLDEACTIVATE,{ctrl:e}))},TC.wrap.control.Edit.prototype.cancel=function(e,t){var r=this;r.points=[],r.histPoints=[];r.control&&r.control.layer||r.modifyInteraction&&r.modifyInteraction.layer;if(r.selectInteraction){var a=r.selectInteraction.getFeatures();r.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{ctrl:r.parent,feature:a.get(0)})),a.clear(),r.selectInteraction.setActive(!1)}},TC.wrap.control.Edit.prototype.getSelectedFeatures=function(){var e=this,t=[];return e.selectInteraction&&e.selectInteraction.getFeatures().forEach(function(e){t[t.length]=e._wrap.parent}),t},TC.wrap.control.Edit.prototype.setSelectedFeatures=function(e){var t=this;if(t.selectInteraction){var r=t.selectInteraction.featureOverlay_.getSource();r.clear(),r.addFeatures(e.map(function(e){return e.wrap.feature}))}},TC.wrap.control.Edit.prototype.deleteFeatures=function(e){var t=this;if($.isArray(e)){var r=e.map(function(e){return e.wrap.feature});$.when(t.parent.layer.wrap.getLayer()).then(function(e){for(var a=t.selectInteraction?t.selectInteraction.getFeatures():null,n=0,o=r.length;o>n;n++){var i=r[n];a&&(a.remove(i),t.parent.$events.trigger($.Event(TC.Consts.event.FEATURESUNSELECT,{feature:i._wrap.parent}))),e.getSource().removeFeature(i),t.parent.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:i._wrap.parent}))}})}},TC.wrap.Feature.prototype.toGML=function(t,r){var a=new e.format.GML,n=a.writeGeometryNode(this.feature.getGeometry());return(new XMLSerializer).serializeToString(n.firstChild)},e});