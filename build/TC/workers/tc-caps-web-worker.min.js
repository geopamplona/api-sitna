function tXml(t,e){"use strict";function r(){for(var e=[];t[u];){if(t.charCodeAt(u)==s){if(t.charCodeAt(u+1)===d)return u=t.indexOf(c,u),e;if(t.charCodeAt(u+1)===m){var r=t.charCodeAt(u+2);if(r!=C){if(r==g){for(;-1!==u&&(t.charCodeAt(u)!==h||t.charCodeAt(u-1)!=g||t.charCodeAt(u-2)!=g||-1==u);)u=t.indexOf(c,u+1);-1===u&&(u=t.length)}else for(u+=2;t.charCodeAt(u)!==h;)u++;u++;continue}}var i=n();e.push(i)}else{var o=a();o.trim().length>0&&e.push(o)}u++}return e}function a(){var e=u;return u=t.indexOf(f,u)-1,-2===u&&(u=t.length),t.slice(e,u+1)}function i(){for(var e=u,r=t[u];-1===y.indexOf(r);)r=t[++u],":"===r&&(u++,e=u);return t.slice(e,u)}function n(){var e={};if(u++,t.charCodeAt(u)===m&&t.charCodeAt(u+1)===C){for(var a=u+8;t.charCodeAt(u)!==h||t.charCodeAt(u-1)!==x||t.charCodeAt(u-2)!==x;)u++;return t.slice(a,u-2)}e.tagName=i();for(var n=!1;t.charCodeAt(u)!==h;){var l=t.charCodeAt(u);if(l>64&&91>l||l>96&&123>l){for(var f=i(),s=t.charCodeAt(u);s!==p&&s!==v&&!(s>64&&91>s||s>96&&123>s)&&s!==h;)u++,s=t.charCodeAt(u);if(n||(e.attributes={},n=!0),s===p||s===v)var c=o();else c=null,u--;e.attributes[f]=c}u++}if(t.charCodeAt(u-1)!==d)if("script"==e.tagName){var a=u+1;u=t.indexOf("</script>",u),e.children=[t.slice(a,u-1)],u+=8}else if("style"==e.tagName){var a=u+1;u=t.indexOf("</style>",u),e.children=[t.slice(a,u-1)],u+=7}else-1==S.indexOf(e.tagName)&&(u++,e.children=r(f));return e}function o(){var e=t[u],r=++u;return u=t.indexOf(e,r),t.slice(r,u)}function l(){var r=new RegExp("\\s"+e.attrName+"\\s*=['\"]"+e.attrValue+"['\"]").exec(t);return r?r.index:-1}e=e||{};var u=0,f="<",s="<".charCodeAt(0),c=">",h=">".charCodeAt(0),g="-".charCodeAt(0),d="/".charCodeAt(0),m="!".charCodeAt(0),p="'".charCodeAt(0),v='"'.charCodeAt(0),C="[".charCodeAt(0),x="]".charCodeAt(0),y="\n	>/= ",S=["img","br","input","meta","link"],A=null;if(void 0!==e.attrValue){e.attrName=e.attrName||"id";for(var A=[];-1!==(u=l());)u=t.lastIndexOf("<",u),-1!==u&&A.push(n()),t=t.substr(u),u=0}else A=r();return e.filter&&(A=tXml.filter(A,e.filter)),e.simplify&&(A=tXml.simplify(A)),A}tXml.simplify=function(t){var e={};if(!t||!t.length)return"";if(1===t.length&&"string"==typeof t[0])return t[0];t.forEach(function(t){if("object"==typeof t){e[t.tagName]||(e[t.tagName]=[]);var r=tXml.simplify(t.children);e[t.tagName].push(r),t.attributes&&(r._attributes=t.attributes)}});for(var r in e)1==e[r].length&&(e[r]=e[r][0]);return e},tXml.filter=function(t,e){var r=[];return t.forEach(function(t){if("object"==typeof t&&e(t)&&r.push(t),t.children){var a=tXml.filter(t.children,e);r=r.concat(a)}}),r},tXml.stringify=function(t){function e(t){if(t)for(var e=0;e<t.length;e++)"string"==typeof t[e]?a+=t[e].trim():r(t[e])}function r(t){a+="<"+t.tagName;for(var r in t.attributes)a+=null===t.attributes[r]?" "+r:-1===t.attributes[r].indexOf('"')?" "+r+'="'+t.attributes[r].trim()+'"':" "+r+"='"+t.attributes[r].trim()+"'";a+=">",e(t.children),a+="</"+t.tagName+">"}var a="";return e(t),a},tXml.toContentString=function(t){if(Array.isArray(t)){var e="";return t.forEach(function(t){e+=" "+tXml.toContentString(t),e=e.trim()}),e}return"object"==typeof t?tXml.toContentString(t.children):" "+t},tXml.getElementById=function(t,e,r){var a=tXml(t,{attrValue:e,simplify:r});return r?a:a[0]},tXml.getElementsByClassName=function(t,e,r){return tXml(t,{attrName:"class",attrValue:"[a-zA-Z0-9-s ]*"+e+"[a-zA-Z0-9-s ]*",simplify:r})},"object"==typeof module&&(module.exports=tXml),function(){var t=function d(t,e){var r={};if(!(t&&t.length||e))return"";if(t=t||[],1===t.length&&"string"==typeof t[0])return t[0];t.forEach(function(t){if("object"==typeof t){var e=t.tagName.indexOf("ows:"),a=0>e?t.tagName:t.tagName.substr(e+4);r[a]||(r[a]=[]);var i=d(t.children,t.attributes);if(r[a].push(i),t.attributes)for(var n in t.attributes)i[n]=t.attributes[n]}});for(var a in r)1==r[a].length&&(r[a]=r[a][0]);return r},e=function(t){return t.href},r=function(t,r){if(t.hasOwnProperty(r)){for(var a=t[r],i=a.length?a:[a],n=0,o=i.length;o>n;n++){var l=i[n];l.OnlineResource=e(l.OnlineResource)}t[r]=i}},a=function(t){if(t){for(var r=t.DCPType.length?t.DCPType:[t.DCPType],a=0,i=r.length;i>a;a++){var n=r[a];for(var o in n){var l=n[o];for(var u in l){var f=l[u];f.OnlineResource=e(f.OnlineResource)}}}t.DCPType=r}},i=[!1,!0],n=function m(t,a){t.hasOwnProperty("queryable")&&(t.queryable=i[t.queryable]);var n;if(t.hasOwnProperty("EX_GeographicBoundingBox")&&(n=t.EX_GeographicBoundingBox,t.EX_GeographicBoundingBox=[parseFloat(n.westBoundLongitude),parseFloat(n.southBoundLatitude),parseFloat(n.eastBoundLongitude),parseFloat(n.northBoundLatitude)]),t.hasOwnProperty("BoundingBox")&&(n=t.BoundingBox,n=t.BoundingBox.length?t.BoundingBox:[t.BoundingBox],t.BoundingBox=n.map(function(t){return{crs:t.CRS,extent:[parseFloat(t.minx),parseFloat(t.miny),parseFloat(t.maxx),parseFloat(t.maxy)],res:new Array(2)}})),t.hasOwnProperty("Attribution")&&(t.Attribution.OnlineResource=e(t.Attribution.OnlineResource)),r(t,"AuthorityURL"),r(t,"MetadataURL"),t.Style){t.Style.length||(t.Style=[t.Style]);for(var o=0,l=t.Style.length;l>o;o++)r(t.Style[o],"LegendURL")}var u="string"==typeof t.CRS?[t.CRS]:t.CRS;if(a&&t.CRS&&(t.CRS=u.concat(a)),t.Layer){var f=t.Layer[1]?t.Layer:[t.Layer];t.Layer=f;for(var o=0,l=f.length;l>o;o++)m(f[o],u)}},o=" ",l=function(t){return t.split(o).map(function(t){return parseFloat(t)})},u=function(t){t.Layer.length||(t.Layer=[t.Layer]);for(var e=t.Layer,r=0,a=e.length;a>r;r++){var i=e[r];"string"==typeof i.Format&&(i.Format=[i.Format]),i.ResourceURL&&!i.ResourceURL.length&&(i.ResourceURL=[i.ResourceURL]),i.Style.length||(i.Style=[i.Style]),i.TileMatrixSetLink.length||(i.TileMatrixSetLink=[i.TileMatrixSetLink]);for(var n=0,o=i.TileMatrixSetLink.length;o>n;n++){var u=i.TileMatrixSetLink[n];if(u.TileMatrixSetLimits){u.TileMatrixSetLimits=u.TileMatrixSetLimits.TileMatrixLimits;for(var f=0,s=u.TileMatrixSetLimits.length;s>f;f++){var c=u.TileMatrixSetLimits[f];c.MaxTileCol=parseInt(c.MaxTileCol),c.MaxTileRow=parseInt(c.MaxTileRow),c.MinTileCol=parseInt(c.MinTileCol),c.MinTileRow=parseInt(c.MinTileRow)}}else u.TileMatrixSetLimits=[]}if(i.WGS84BoundingBox){var h=l(i.WGS84BoundingBox.LowerCorner),g=l(i.WGS84BoundingBox.UpperCorner);i.WGS84BoundingBox=[h[0],h[1],g[0],g[1]]}}},f=function(t){t.TileMatrixSet.length||(t.TileMatrixSet=[t.TileMatrixSet]);for(var e=t.TileMatrixSet,r=0,a=e.length;a>r;r++)for(var i=e[r],n=0,o=i.TileMatrix.length;o>n;n++){var u=i.TileMatrix[n];u.MatrixHeight=parseInt(u.MatrixHeight),u.MatrixWidth=parseInt(u.MatrixWidth),u.TileHeight=parseInt(u.TileHeight),u.TileWidth=parseInt(u.TileWidth),u.ScaleDenominator=parseFloat(u.ScaleDenominator),u.TopLeftCorner=l(u.TopLeftCorner)}},s=function(t){for(var e=t.length?t:[t],r=new Array(e.length),a=0,i=e.length;i>a;a++){var n=e[a];if(!n.Constraint.length){n.Constraint=[n.Constraint];for(var o=0,l=n.Constraint.length;l>o;o++){var u=n.Constraint[o].AllowedValues;"string"==typeof u.Value&&(u.Value=[u.Value])}}r[a]={Constraint:n.Constraint,href:n.href}}return r},c=function(t){for(var e=t.Operation.length?t.Operation:[t.Operation],r=0,a=e.length;a>r;r++){var i=e[r];for(var n in i.DCP){var o=i.DCP[n];for(var l in o)o[l]=s(o[l])}t[i.name]={DCP:i.DCP}}delete t.Operation},h=function(t){var e=t["?xml"]&&(t["?xml"].WMS_Capabilities||t["?xml"].WMT_MS_Capabilities);if(e){n(e.Capability.Layer);var r=e.Capability.Request;a(r.GetMap),r.GetFeatureInfo&&(r.GetFeatureInfo.Format="string"==typeof r.GetFeatureInfo.Format?[r.GetFeatureInfo.Format]:r.GetFeatureInfo.Format)}return e},g=function(t){var e=t["?xml"]&&t["?xml"].Capabilities;return e&&(u(e.Contents),f(e.Contents),c(e.OperationsMetadata)),e};onmessage=function(e){var r=t(tXml(e.data.text)),a="WMTS"===e.data.type?g(r):h(r);postMessage({state:a?"success":"error",capabilities:a})}}();