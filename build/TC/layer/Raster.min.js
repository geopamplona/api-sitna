TC.layer=TC.layer||{},TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer"),TC.Consts.BLANK_IMAGE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAQAIBRAA7",function(){var e=function(){this.strategy,this.setStrategy=function(e){this.strategy=e},this.query=function(e,t,r,a){return this.strategy.query(e,t,r,a)}},t=function(){this.query=function(e,t,r,i){t.usesSSL=TC.Util.isSecureURL(e),a(e).then(r,function(n,s,o){n.status?i(t,s+"]["+o):(t.usesProxy=!0,a(e,!0).then(function(e){r(e)},function(e,r,a){i(t,r+"]["+a)}))})}},r=function(){var e=function(e){var t=$.Deferred();return $.ajax({type:"GET",url:e,dataType:"jsonp",success:function(e){t.resolve(!1)},error:function(e,r,a){t.resolve(e.status&&200===e.status&&"parsererror"!==r?!0:!1)}}),t};this.query=function(t,r,i,n){var s=t.replace(/^(f|ht)tp?:\/\//i,"https://");a(s).then(function(e){r.usesSSL=!0,i(e)},function(o,l,p){o.status?a(t,!0).then(function(e){r.usesProxy=!0,r.usesSSL=!0,i(e)},function(e,t,a){n(r,t+"]["+a)}):TC.isUsingServiceWorker&&TC.isUsingServiceWorker()?a(t,!0).then(function(e){r.usesProxy=!0,r.usesSSL=!1,i(e)},function(e,t,a){n(r,t+"]["+a)}):e(s).then(function(e){e?a(t,!0).then(function(e){r.usesProxy=!0,r.usesSSL=TC.Util.isSecureURL(t),i(e)},function(e,t,a){n(r,t+"]["+a)}):a(t,!0).then(function(e){r.usesProxy=!1,r.usesSSL=!1,i(e)},function(e,t,a){n(r,t+"]["+a)})})})}},a=function(e,t){var r=TC._capabilitiesRequests[e]=!t&&TC._capabilitiesRequests[e]||$.ajax({url:t?TC.proxify(e):e,type:"GET",dataType:n?"text":"xml"});return r},i={},n=window.hasOwnProperty("Worker"),s=$.Deferred();if(n){var o=TC.apiLocation+"TC/workers/tc-caps-web-worker.js";TC.Util.isSameOrigin(TC.apiLocation)?s.resolve(o):$.ajax({url:o,type:"GET",dataType:"text"}).then(function(e){var t=new Blob([e],{type:"text/javascript"}),r=window.URL.createObjectURL(t);s.resolve(r)},function(e){s.reject()})}var l=function(e,t,r){var a=e.url,n=!1,s=i[a];if(s?(e._capabilitiesPromise=s,n=!0):e._capabilitiesPromise=s=i[a]=$.Deferred(),s.then(function(t){if(t.error)return void c(e,t.error);e.capabilities=e.capabilities||t;var r=e.getGetMapUrl();TC.capabilities[e.options.url]=TC.capabilities[e.options.url]||t,TC.capabilities[r]=TC.capabilities[r]||t,t.usesProxy&&(e.usesProxy=!0),t.usesSSL&&(e.usesSSL=!0),y(e)}),!n){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(e.CAPABILITIES_STORE_KEY_PREFIX+a).then(function(t){t&&i[e.url].resolve(t)})});var o,l={};if(e.type===TC.Consts.layerType.WMTS)if(e.options.encoding===TC.Consts.WMTSEncoding.RESTFUL){var u="/1.0.0/WMTSCapabilities.xml";a.indexOf(u)<a.length-u.length?("/"===a[a.length-1]&&(u=u.substr(1)),o=a+u):o=a}else o=a,l.SERVICE="WMTS",l.VERSION="1.0.0",l.REQUEST="GetCapabilities";else o=a,l.SERVICE="WMS",l.VERSION="1.3.0",l.REQUEST="GetCapabilities";if(o=o+"?"+$.param(l),TC._capabilitiesRequests=TC._capabilitiesRequests||{},TC.isUsingServiceWorker=null,!TC.isUsingServiceWorker){var f=e.map||$("#map").data("map"),g=f?f.getControlsByClass("TC.control.SWCacheClient"):null;TC.isUsingServiceWorker=g&&g.length>0?function(){return"pending"!==g[0].getServiceWorker().state()?g[0].serviceWorkerEnabled:!1}:function(){return!1}}p(o,e,t,r)}},p=function(a,i,n,s){var o=new e,l=function(e){n(i,e)};o.setStrategy(TC.Util.isSecureURL(document.location.href)&&!TC.Util.isSecureURL(a)?new r:new t),o.query(a,i,l,s)},c=function(e,t){var r="No se pudo obtener el documento de capacidades de servicio "+e.url+": ["+t+"]";e._capabilitiesPromise.reject(r),TC.error(r),e.map&&e.map.$events.trigger($.Event(TC.Consts.event.LAYERERROR,{layer:e,reason:"couldNotGetCapabilities"})),e.wrap.setLayer(null)},u=function(e,t){TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var r=e.CAPABILITIES_STORE_KEY_PREFIX+e.options.url,a=function(){localforage.setItem(r,t)};e.map?e.map.loaded(a):a()})},f=function(e,t){var r;if(t.documentElement){if($(t).find("ServiceException").length>0)r={error:$(t).find("ServiceException").text()};else{var a=e.type===TC.Consts.layerType.WMTS?new e.wrap.WmtsParser:new e.wrap.WmsParser;r=a.read(t),e.type===TC.Consts.layerType.WMTS&&r.Contents&&r.Contents.Layer&&$("Layer",t).each(function(e,t){var a=TC.Util.getElementByNodeName(t,"ows:Identifier")[0],i=a.firstChild.data,n=$(t),s=r.Contents.Layer.filter(function(e){return e.Identifier==i});if(s.length){s=s[0];for(var o=0;o<s.TileMatrixSetLink.length;o++){var l=s.TileMatrixSetLink[o];matrixId=l.TileMatrixSet,xmlLink=n.find("TileMatrixSetLink").each(function(e,t){return $(t).find("TileMatrixSet:first").text()==matrixId}),xmlLink.length&&(xmlLink=xmlLink[0],l.TileMatrixSetLimits=[],$(xmlLink).find("TileMatrixLimits").each(function(e,t){var r=$(t);l.TileMatrixSetLimits.push({TileMatrix:r.find("TileMatrix").text(),MinTileRow:parseInt(r.find("MinTileRow").text()),MinTileCol:parseInt(r.find("MinTileCol").text()),MaxTileRow:parseInt(r.find("MaxTileRow").text()),MaxTileCol:parseInt(r.find("MaxTileCol").text())})}))}}})}e.usesProxy&&(r.usesProxy=!0),i[e.url].resolve(r),u(e,r)}else n&&"string"==typeof t?s.then(function(a){var n=new Worker(a);n.onmessage=function(t){r="success"===t.data.state?t.data.capabilities:{error:"Web worker error"},e.usesProxy&&(r.usesProxy=!0),e.usesSSL&&(r.usesSSL=!0),i[e.url].resolve(r),n.terminate(),u(e,r)},n.postMessage({type:e.type,text:t})}):(r=t,e.usesProxy&&(r.usesProxy=!0),i[e.url].resolve(r))},y=function(e){var t;if(!e.wrap.layer){switch(e.type){case TC.Consts.layerType.GROUP:break;case TC.Consts.layerType.WMTS:t=m(e);break;default:t=g(e)}e.wrap.setLayer(t)}},g=function(e){var t=$.isArray(e.names)?e.names.join(","):e.names,r=e.options.format,a=e.options,i={LAYERS:t,FORMAT:r,TRANSPARENT:e.transparent,VERSION:e.capabilities.version||"1.3.0"};e.params&&$.extend(i,e.params);var n=e.getPreferredInfoFormat();return null!==n&&(i.INFO_FORMAT=n),e.wrap.createWmsLayer(e.url,i,a)},m=function(e){return e.wrap.createWmtsLayer(e.options.matrixSet,e.names[0],e.options)},T=function E(e,t){var r=$.inArray(t.name,e.availableNames);if(-1===r)for(var a=0,i=t.children.length;i>a&&(r=E(e,t.children[a]),-1===r);a++);return r},v=function P(e,t){var r=function(t,r){return T(e,r)-T(e,t)};t.children.sort(r);for(var a=0,i=t.children.length;i>a;a++)P(e,t.children[a])},h=function M(e,t,r){var a=!1;if(r.count=r.count+1,e.name===t)a=!0;else for(var i=e.children.length-1;i>=0;i--)if(M(e.children[i],t,r)){a=!0;break}return a};TC.layer.Raster=function(){var e=this;if(this._capabilitiesPromise=null,TC.Layer.apply(e,arguments),e.wrap=new TC.wrap.layer.Raster(e),e.transparent=e.options.transparent===!1?!1:!0,e.url=e.options.url,e.params=e.options.params,"string"==typeof e.options.layerNames)e.names=e.availableNames=e.options.layerNames.split(",");else if(e.names=[],e.availableNames=[],$.isArray(e.options.layerNames))for(var t=0;t<e.options.layerNames.length;t++){var r=e.options.layerNames[t];"string"==typeof r?(e.names.push(r),e.availableNames.push(r)):r.hasOwnProperty("name")&&(e.availableNames.push(r.name),(void 0===r.isVisible||r.isVisible)&&e.names.push(r.name))}else{var a=e.options.params?e.options.params.sld_body:null;if(a){var i=$.parseXML(a),n=TC.Util.getElementByNodeName(i,"sld:NamedLayer");if(n&&n.length>0){var s=TC.Util.getElementByNodeName(n[0],"sld:Name");if(s&&s.length>0){var r=$(s[0]).text();e.names.push(r),e.availableNames.push(r)}}}}e.ignorePrefixes=void 0===e.options.ignorePrefixes?!0:e.options.ignorePrefixes,e._capabilitiesNodes={},l(e,f,c),e._disgregatedLayerNames=null,TC.Consts.layerType.WMTS==e.type&&e.wrap.setWMTSUrl()},TC.inherit(TC.layer.Raster,TC.Layer),TC.layer.Raster.prototype.CAPABILITIES_STORE_KEY_PREFIX="TC.capabilities.",TC.layer.Raster.prototype.setVisibility=function(e){var t=this;t.tree=null,t._cache.visibilityStates={},TC.Layer.prototype.setVisibility.call(t,e)};var d=function(e){var t=e.layerNames,r=e.matrixSet,a=e.capabilities,i=[],n=a.Contents.TileMatrixSet.filter(function(e){return e.Identifier==r});if(n.length){n=n[0];var s=a.Contents.Layer.filter(function(e){return e.Identifier==t})[0];if(s.TileMatrixSetLink&&s.TileMatrixSetLink.length&&s.TileMatrixSetLink[0].TileMatrixSetLimits){for(var o,l=s.TileMatrixSetLink[0].TileMatrixSetLimits,p=0;p<l.length;p++){o=l[p];var c=n.TileMatrix.filter(function(e){return e.Identifier==o.TileMatrix});if(c.length){var u=$.extend({matrixIndex:n.TileMatrix.indexOf(c[0])},c[0],o);i.push(u)}}return i}return n.TileMatrix}return null},C=function(e,t){if(e.type!==TC.Consts.layerType.WMS)return t;var r=t.slice();return S(e,r,e.wrap.getRootLayerNode()),r},S=function I(e,t,r){var a=!1,i=e.wrap.getLayerNodes(r);if(i.length){for(var n=0,s=i.length;s>n;n++)I(e,t,i[n])&&(a=!0);var o,l,p=$.map(i,function(t){return e.wrap.getName(t)}).reverse(),c=!1;if(l=o=$.inArray(p[0],t),0>o)c=!0;else for(var n=1,s=p.length;s>n;n++)if(p[n]!=t[++o]){c=!0;break}if(!c){var u=e.wrap.getName(r);u&&p.length>1&&(t.splice(l,p.length,u),a=!0)}}return a},L=function(e,t){for(var r=[],a=t.slice(),i=e.wrap.getRootLayerNode(),n=0,s=a.length;s>n;n++)r=r.concat(b(e,a[n],i));return r},b=function W(e,t,r,a){for(var i=[],n=e.wrap.getName(r),s=e.compareNames(t,n),o=!1,l=e.wrap.getLayerNodes(r),p=0;p<l.length;p++){var c=W(e,t,l[p],a||s);c.length?i=i.concat(c):o=!0}return(!l.length||o)&&(a||s)&&(i=[n]),i},w=function(e){return $.extend({aggregate:!0,lazy:!1},e)},N=function(e,t,r){var a,i,n,s=[];a=e?e:[],i=t?t:[],n=r?r:[];for(var o=a.concat(i),l=0;l<o.length;l++)$.inArray(o[l],o)===l&&-1===$.inArray(o[l],n)&&(s[s.length]=o[l]);return s},x=function(e,t){var r="string"==typeof t?t.split(","):t;if(e.capabilities){var a=e.getTree();r.sort(function(e,t){var r={count:0},i={count:0};return h(a,e,r),h(a,t,i),r.count-i.count})}return r},R=function(e,t,r,a){return $.grep(r,function(r){return e.compareNames(t,r,a)}).length>0};TC.layer.Raster.prototype.getLimitedMatrixSet=function(){return d(this)},TC.layer.Raster.prototype.setLayerNames=function(e,t){var r=this,a=new $.Deferred;return $.when(r.wrap.getLayer()).then(function(){var i=$.isArray(e)?e:e.split(",");r.names=i;var n=w(t);n.aggregate&&(i=C(r,i)),r._disgregatedLayerNames=null;var s={LAYERS:i.join(","),TRANSPARENT:!0};if(i.length||r.setVisibility(!1),n.lazy){var o=r._newParams||r.wrap.getParams();r._newParams=$.extend(o,s)}else r.map&&r.map.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATEPARAMS,{layer:r})),r.tree=null,r._cache.visibilityStates={},r.wrap.setParams(s),(n.reset||!r.map)&&(r.availableNames=r.names),r.map&&r.map.$events.trigger($.Event(TC.Consts.event.UPDATEPARAMS,{layer:r}));a.resolve(r.names)}),a},TC.layer.Raster.prototype.addLayerNames=function(e,t){var r=this,a=new $.Deferred;return $.when(r.wrap.getLayer()).then(function(){var i=w(t),n=$.isArray(e)?e:e.split(","),s=r.wrap.getParams().LAYERS;i.aggregate&&(n=L(r,n),s=r.getDisgregatedLayerNames()),$.when(r.setLayerNames(x(r,N(s,n,null)),t)).then(function(e){a.resolve(e)})}),a},TC.layer.Raster.prototype.removeLayerNames=function(e,t){var r=this,a=new $.Deferred;return $.when(r.wrap.getLayer()).then(function(){var i=w(t),n=$.isArray(e)?e:e.split(","),s=r.wrap.getParams().LAYERS;i.aggregate&&(n=L(r,n),s=r.getDisgregatedLayerNames()),$.when(r.setLayerNames(x(r,N(s,null,n)),t)).then(function(e){a.resolve(e)})}),a},TC.layer.Raster.prototype.toggleLayerNames=function(e,t){var r=this,a=new $.Deferred;return $.when(r.wrap.getLayer()).then(function(){var i=w(t),n=$.isArray(e)?e:e.split(","),s=r.wrap.getParams().LAYERS;i.aggregate&&(n=L(r,n),s=r.getDisgregatedLayerNames());for(var o=[],l=[],p=0;p<n.length;p++){var c=n[p];$.inArray(c,s)<0?o[o.length]=c:l[l.length]=c}var u=[];o.length>0&&u.push(r.addLayerNames(o,i)),l.length>0&&u.push(r.removeLayerNames(l,i)),$.when.apply(this,u).then(function(e,t){a.resolve(e?t?e.concat(t):e:[])})}),a},TC.layer.Raster.prototype.getDisgregatedLayerNames=function(){var e=this,t=e.wrap.getLayer();if(e.wrap.isNative(t)&&e.type===TC.Consts.layerType.WMS){if(!e._disgregatedLayerNames){var r=e.wrap.getParams().LAYERS;r=$.isArray(r)?r:r.split(","),e._disgregatedLayerNames=L(e,r)}}else e._disgregatedLayerNames=e.names;return e._disgregatedLayerNames.slice()},TC.layer.Raster.prototype.isValidFromNames=function(){for(var e=this,t=!0,r=0,a=e.names.length;a>r;r++)if(!e.getLayerNodeByName(e.names[r])){t=!1;break}return t},TC.layer.Raster.prototype.isCompatible=function(e){var t=this,r=!1;switch(t.type){case TC.Consts.layerType.WMTS:case TC.Consts.layerType.WMS:r=t.wrap.isCompatible(e)}return r},TC.layer.Raster.prototype.isVisibleByScale=function(e,t){var r,a,i,n=this,s=function(){return n.map.wrap.getResolution()/28e-5};switch(n.type){case TC.Consts.layerType.WMTS:r=!1;var o=n.wrap.getTileMatrix(n.options.matrixSet);if(o)for(a=s(),i=0;i<o.length;i++){var l=n.wrap.getScaleDenominators(o[i]);if(l[0]===a){r=!0;break}}break;case TC.Consts.layerType.WMS:r=!0;var p=n.wrap.getAllLayerNodes();if(p.length>0){a=s();var c;if("number"==typeof e)c=n._capabilitiesNodes[e];else for(i=0;i<p.length;i++){var u=p[i];if(n.compareNames(n.wrap.getName(u),e,t)){c=u;break}}if(c){var l=n.wrap.getScaleDenominators(c);r=!(parseFloat(l[1])>a||parseFloat(l[0])<a)}}break;default:r=!0}return r},TC.layer.Raster.prototype.isVisibleByName=function(e,t){var r=this,a=!1;switch(r.type){case TC.Consts.layerType.WMTS:if(r.wrap.getWMTSLayer()){a=!0;break}break;case TC.Consts.layerType.WMS:var i=function(e){return n(e,r.wrap.getRootLayerNode())},n=function l(e,a){var i=null,n=r.wrap.getName(a);if(r.compareNames(n,e,t))i=[n];else for(var s=r.wrap.getLayerNodes(a),o=0;o<s.length;o++){var p=s[o],c=l(e,p);if(c){TC.Util.fastUnshift(c,n),i=c;break}}return i},s=i(e);if(s)for(var o=0;o<s.length;o++)if(R(r,s[o],r.names)){a=!0;break}break;default:a=!0}return a},TC.layer.Raster.prototype.getTree=function(){var e=this,t=e.tree,r=function(t,r){e.options.inverseTree?TC.Util.fastUnshift(t.children,r):t.children[t.children.length]=r};if(!t){var a,i=function o(t,i,n){var s;for(var l in e._capabilitiesNodes)if(e._capabilitiesNodes[l]===t){s=l;break}s||(s=TC.getUID(),e._capabilitiesNodes[s]=t);var p={name:e.wrap.getName(t),title:t.title||t.Title,uid:s,children:[]};if(n&&(a=p),R(e,p.name,e.availableNames)&&(i=!0),e.options.isBase)p.name=e.names.join(","),p.title=e.title||p.title,p.isBase=e.isDefault,e.options.thumbnail&&(p.legend={src:e.options.thumbnail});else{p.isVisible=p===a?e.getVisibility():e.isVisibleByName(p.name);var c,u=e.wrap.getLayerNodes(t);for(c=0;c<u.length;c++){var f=o(u[c],i);f&&r(p,f)}p.legend=e.wrap.getLegend(t),i||n||(a.children=a.children.concat(p.children),p=null)}return p};switch(e.type){case TC.Consts.layerType.WMTS:t=i(e.wrap.getWMTSLayer(),!e.options.hideTree,!0);break;case TC.Consts.layerType.WMS:if(e.capabilities){t=i(e.wrap.getRootLayerNode(),!e.options.hideTree,!0);var n=e._cache.visibilityStates,s=function l(e){var t=TC.Consts.visibility.NOT_VISIBLE;if(e){if(void 0!==n[e.uid])t=n[e.uid];else{if(e.children)for(var r=!1,a=!1,i=0,s=e.children.length;s>i;i++){var o=l(e.children[i]);switch(o){case TC.Consts.visibility.VISIBLE:r=!0;break;case TC.Consts.visibility.NOT_VISIBLE:a=!0;break;case TC.Consts.visibility.HAS_VISIBLE:r=!0,a=!0}r&&(t=a?TC.Consts.visibility.HAS_VISIBLE:TC.Consts.visibility.VISIBLE)}e.isVisible&&(t=TC.Consts.visibility.VISIBLE),n[e.uid]=t}e.visibilityState=t}return t};s(t),e.options.hideTree&&v(e,t)}}t||(t={name:e.name,title:e.title}),t.title=e.title||t.title,e.tree=t}return t},TC.layer.Raster.prototype.setNodeVisibility=function(e,t){var r=this;r.tree||(r.tree=r.getTree());var a=function s(e){var t=[];if(e.name)t[0]=e.name;else for(var r=0;r<e.children.length;r++)t=t.concat(s(e.children[r]));return t},i=r.findNode(e,r.tree);if(i===r.tree)t&&0===r.names.length?r.addLayerNames(r.availableNames).then(function(){r.setVisibility(!0)}):r.setVisibility(t);else{var n=a(i);t?r.addLayerNames(n):r.removeLayerNames(n)}},TC.layer.Raster.prototype.getNodeVisibility=function(e){var t=this;return t.tree||(t.tree=t.getTree()),t._cache.visibilityStates[e]},TC.layer.Raster.prototype.getNodePath=function(e,t){var r=this,a=[];if(r.type===TC.Consts.layerType.WMS&&r.capabilities){e=e||r.names[0];var i=function n(a){var i=[],s=r.wrap.getName(a);if(r.compareNames(s,e,t))i.push(a);else for(var o=r.wrap.getLayerNodes(a),l=0;l<o.length;l++){var p=n(o[l]);if(p.length){i=p,TC.Util.fastUnshift(i,a);break}}return i};a=i(r.wrap.getRootLayerNode())}return a},TC.layer.Raster.prototype.getPath=function(e,t){return $.map(this.getNodePath(e,t),function(e){return e.title||e.Title})},TC.layer.Raster.prototype.getLayerNodeByName=function(e){for(var t=null,r=this,a=r.wrap.getServiceType()===TC.Consts.layerType.WMTS?r.wrap.getIdentifier:r.wrap.getName,i=r.wrap.getAllLayerNodes(),n=0,s=i.length;s>n;n++)if(r.compareNames(a(i[n]),e)){t=i[n];break}return t},TC.layer.Raster.prototype.getChildrenLayers=function(e){var t=[],r=function(e,t){if(e&&e.Layer&&e.Layer.length)for(var a=0;a<e.Layer.length;a++)t[t.length]=e.Layer[a],r(e.Layer[a],t)};return r(e,t),t},TC.layer.Raster.prototype.compareNames=function(e,t,r){var a=e===t,i=this,n=void 0!==r?r:i.ignorePrefixes;if(!a&&n&&e&&t){var s=e.indexOf(":"),o=t.indexOf(":");s>=0&&0>o?a=e.substr(s+1)===t:o>=0&&0>s&&(a=e===t.substr(o+1))}return a},TC.layer.Raster.prototype.getCapabilitiesPromise=function(){return this._capabilitiesPromise},TC.layer.Raster.prototype.getResolutions=function(){return this.wrap.getResolutions()},TC.layer.Raster.prototype.searchSubLayers=function(e){if(this.patternFn||(this.patternFn=function(e){return e=e.replace(/[^a-z\u00e1\u00e9\u00ed\u00f3\u00fa\u00fc\u00f1 ]/gi,"\\$&"),e=e.replace(/(a|\u00e1)/gi,"(a|á)"),e=e.replace(/(e|\u00e9)/gi,"(e|é)"),e=e.replace(/(i|\u00ed)/gi,"(i|í)"),e=e.replace(/(o|\u00f3)/gi,"(o|ó)"),e=e.replace(/(u|\u00fa|\u00fc)/gi,"(u|ú|ü)"),e=e.replace(/(n|\u00f1)/gi,"(n|ñ)")}),e&&e.length&&e.length>=3){var t=this,r=null;if(this.lastPattern&&e.indexOf(this.lastPattern)>=0)r=this.lastMatches;else if(t.availableNames&&t.availableNames.length>0){r=[];for(var a=0;a<t.availableNames.length;a++){var i=t.getLayerNodeByName(t.availableNames[a]);i&&(r[r.length]=i,r=r.concat(t.getChildrenLayers(i)))}}else r=t.wrap.getAllLayerNodes();var n=this.patternFn(e),s=new RegExp(n,"i"),o=r.map(function(e,r){delete e.tcScore,e.tcPosition=r,t.wrap.normalizeLayerNode(e);var a=e.Title.trim(),i=s.exec(a),n=i?i.index:-1,o=-1;if(e.Abstract){var l=e.Abstract.trim(),p=s.exec(l);o=p?p.index:-1}return i&&a==i[0]?e.tcScore=20:0==n?e.tcScore=15:n>-1?e.tcScore=10:0==o?e.tcScore=5:o>-1&&(e.tcScore=1),e.tcScore?e:null}).filter(function(e){return null!=e}).sort(function(e,t){if(t.tcScore===e.tcScore){var r=TC.Util.replaceAccent(e.Title),a=TC.Util.replaceAccent(t.Title);return a>r?-1:r>a?1:0}return t.tcScore-e.tcScore});return this.lastPattern=e,this.lastMatches=o,o}return[]};var A=function(e){var t=e;if(e){var r=e.match(/\??SERVICE=\w+&/i);r&&(t=t.replace(r[0],""))}return t};TC.layer.Raster.prototype.getGetMapUrl=function(){return A(this.wrap.getGetMapUrl())},TC.layer.Raster.prototype.getPreferredInfoFormat=function(){for(var e=this,t=null,r=e.wrap.getInfoFormats(),a=0;a<TC.wrap.layer.Raster.infoFormatPreference.length;a++){var i=TC.wrap.layer.Raster.infoFormatPreference[a];if($.inArray(i,r)>=0){t=i;break}}return t},TC.layer.Raster.prototype.getLegendGraphicImage=function(){var e=this,t=$.Deferred();if(e.options.params.base64LegendSrc)return t.resolve(e.options.params.base64LegendSrc);if("function"==typeof window.btoa){for(var r=e.names[0],a=e.wrap.getInfo(r),i=new XMLHttpRequest,n=a.legend[0].src.split("?"),s=n[1].split("&"),o=e.options.params.sld_body?"sld_body="+e.options.params.sld_body:"",l=0;l<s.length;l++){var p=s[l].split("=");p&&p.length>1&&p[1]&&(o+="&"+s[l])}e.options.params.env&&(o+="&"+e.options.params.env),i.open("POST",n[0],!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.responseType="arraybuffer",i.onload=function(r){if(200===this.status){for(var a=new Uint8Array(this.response),n=a.length,s=new Array(n);n--;)s[n]=String.fromCharCode(a[n]);var o=s.join(""),l=i.getResponseHeader("content-type");if(0===l.indexOf("image")){var p;p="data:"+l+";base64,"+window.btoa(o),e.options.params.base64LegendSrc=p,t.resolve(p)}}},i.send(o)}else t.reject("Función window.btoa no soportada por el navegador");return t.promise()}}();var esriParser={parse:function(e){var t=[],r=(new DOMParser).parseFromString(e,"text/xml");if("FeatureInfoResponse"===r.documentElement.tagName)for(var a=r.documentElement.getElementsByTagName("FeatureInfoCollection"),i=0,n=a.length;n>i;i++)for(var s=a[i],o=s.getAttribute("layername"),l=s.getElementsByTagName("FeatureInfo"),p=0,c=l.length;c>p;p++){for(var u=l[p].getElementsByTagName("Field"),f={},y=0,g=u.length;g>y;y++){var m=u[y];f[getElementText(m.getElementsByTagName("FieldName")[0])]=getElementText(m.getElementsByTagName("FieldValue")[0])}var T=new ol.Feature(f);T.setId(o+"."+TC.getUID()),t[t.length]=T}return t}};TC.layer.Raster.prototype.getWFSCapabilitiesPromise=function(){"undefined"==typeof WFSCapabilities&&TC.syncLoadJS(TC.apiLocation+"TC/layer/WFSCapabilitiesParser");var e=this.options.url.replace(/service=wms/i,"service=wfs").replace(/\/wms(\/|\?|\b)/i,"$'/wfs/"),t=$.Deferred(),r=e.substring(e.indexOf("://")<0?0:e.indexOf("://")+3);if(TC.WFScapabilities[r])return setTimeout(function(){t.resolve(TC.WFScapabilities[r])},100),t;var a={};return a.SERVICE="WFS",a.VERSION="2.0.0",a.REQUEST="GetCapabilities",$.ajax({url:this.usesProxy?TC.proxify(e+"?"+$.param(a)):this.usesSSL?e.replace(/^(f|ht)tp?:\/\//i,"https://")+"?"+$.param(a):e+"?"+$.param(a),type:"GET"}).then(function(){var e,a;a=jQuery.isXMLDoc(arguments[0])?arguments[0]:(new DOMParser).parseFromString(arguments[0],"text/xml");var i=$(a).find("ServiceException");if(0===i.length&&(i=$(a).find("ExceptionText")),i.length>0)return void t.reject(null,"error",i.html());try{e=WFSCapabilities.Parse(a)}catch(n){return void t.reject(n)}if(!e.Operations)return void t.reject(null);var s=e.Operations.GetCapabilities.DCP&&e.Operations.GetCapabilities.DCP.HTTP.Get["xlink:href"]||e.Operations.GetCapabilities.DCPType[0].HTTP.Get.onlineResource;TC.WFScapabilities[s]=e,TC.WFScapabilities[r]=e,t.resolve(e)},function(e,r,a){t.reject(e,r,a)}),t};